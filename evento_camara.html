<div class="row">
    <div id="panel-filters">
        <div class="col-md-10">
            <div class="panel panel-filled panel-c-accent" id="panel-filters">
                <div class="panel-heading">
                    Filtros
                </div>
                <div class="panel-body">
                    <div class="row">
                        <div class="col-lg-3">
                            <div class=form-group>
                                <input id="txcamera" type="text" class="form-control" placeholder="Cámara">
                            </div>
                        </div>
                        <div class="col-lg-3">
                            <div class=form-group>
                                <button id="btnbuscar" type="button" href="#" class="btn btn-w-md btn-primary btn-rounded">Buscar</button>
                            </div>
                        </div>
                    </div>
    
                </div>
            </div>
        </div>    
        <div class="col-md-2">
            <div class="panel panel-filled  panel-c-accent">
                <div class="panel-heading">
                    Total de Cámaras
                </div>
                <div class="panel-body text-center">
                    <h2 class="m-b-none " id="totalcamaras"></h2>
                </div>
            </div>
        </div>
    </div>
    
    
    <div id="panel-events-camera">
        <div class="col-md-1 text-left">
            <button class="btn btn-link " type="button" id="btnatras" ><i class="pe-7s-angle-left-circle"></i> <span class="bold">Atras</span></button>    
        </div>
        <div class="col-md-5">
            <div class="panel panel-filled panel-c-accent" id="panel-events-camera">
                <div class="panel-body">
                    <div style="font-size:80%;height:auto">
                        <div><span class="c-white" style="float:right" id="info-camera-nombre"></span>Nombre de Cámara:</div>
                        <div><span class="c-white" style="float:right" id="info-camera-localidad"></span>Localidad:</div>
                        <div><span class="c-white" style="float:right" id="info-camera-zona"></span>Zona:</div>
                        <div><span class="c-white" style="float:right" id="info-camera-SubZ"></span>Subzona:</div>
                        <div><span class="c-white" style="float:right" id="info-camera-Objetivo"></span>Objetivo:</div>                    
                    </div>
                </div>
            </div>
        </div>    
        <div class="col-md-2">
            <div class="panel panel-filled  panel-c-accent">
                <div class="panel-heading">
                    Total de Detecciones
                </div>
                <div class="panel-body text-center">
                    <h2 class="m-b-none " id="totaleventos"></h2>
                </div>
            </div>
        </div>    
        <div class="col-md-2">
            <div class="panel panel-filled  panel-c-accent">
                <div class="panel-heading">
                    Total de Personas
                </div>
                <div class="panel-body text-center">
                    <h2 class="m-b-none " id="totalpersonas"></h2>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="panel panel-filled  panel-c-accent">
                <div class="panel-heading">
                    Total de Vehiculos
                </div>
                <div class="panel-body text-center">
                    <h2 class="m-b-none " id="totalvehiculos"></h2>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row" id="result-list"></div>

<div class="row" id="result-list-events-camera">
    <div class="panel-body">
   <div class="col-md-12">
       <div class="table-responsive">
            <table class="table">
                <thead style="border-radius:20px; overflow:hidden;">
                  <tr>
                      <th>Id</th>
                      <th>Detección</th>
                      <th>Fecha y Hora</th>
                      <th>Tipo de Objeto</th>
                      <th>Emoción</th>
                      <th>Placa o Documento</th>
                      <th>Foto</th>
                      <th>Precisión</th>
                  </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
        
    </div>
</div>

<div id="panelTemplate" class="d-none" style="display:none">
    <div class="col-md-2">
        <div class="panel panel-c-accent">
            <div class="panel-body">
                <div style="font-size:80%;height:120px">
                    
                    <div><span class="c-white" style="float:right">@id</span>ID Cámara:</div>
                    <div><span class="c-white" style="float:right">@camera_id</span>Cámara:</div>
                    <div><span class="c-white" style="float:right">@nombre_zona</span>Zona:</div>
                    <div><span class="c-white" style="float:right">@nombre_subzona</span>Subzona:</div>
                    <div><span class="c-white" style="float:right">@nombre_objetivo</span>Objetivo:</div>                    
                    <small >@location</small>                                      
                </div>
            </div>
            <div class="panel-footer">
                <button style="width:100%;font-size:0.8rem;" class="btn btn-w-md btn-success btn-rounded">Ver Detecciones</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="showVideoModal" tabindex="-1" role="dialog" aria-hidden="true">
      <div class="modal-dialog">
            <div class="modal-content">
                  <div class="modal-header text-left">
                        <span class="c-white" style="float:right" id="showtime"></span>
                        Camara : <span class="c-white" id="showcamera"></span>
                        <div id="showlocation"></div>
                  </div>

                  <div class="modal-body" style="height:400px">
                  </div>
                  <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
                  </div>
            </div>
      </div>
</div>



<script>
var videoPlayer=null;
var rows_data=[]   
var rows_data_person=[]   


const panel_filters = $('#panel-filters')
const panel_events_camera = $('#panel-events-camera')
panel_events_camera.css("display", "none")

const result_list = $('#result-list');
const result_list_events_camera = $('#result-list-events-camera');
result_list_events_camera.css("display", "none")

function getEmotionName(emotionCode) {
  let emotionText = "unknown";

  switch (emotionCode) {
    case "1":
      emotionText = "Enojo";
      break;
    case "2":
      emotionText = "Disgusto";
      break;
    case "3":
      emotionText = "Miedo";
      break;
    case "4":
      emotionText = "Felicidad";
      break;
    case "5":
      emotionText = "Tristeza";
      break;
    case "6":
      emotionText = "Sorpresa";
      break;
    case "7":
      emotionText = "Neutral";
      break;
  }

  return emotionText;
}


function render_camaras(loc, data, info_camera) {
    let html = "";
    let i = 1;

    for (let r of data) {
        const epoch_date = new Date(r.epoch_frame);
        r.epoch_date_name = epoch_date.toLocaleString('es-PE'); 
        r.info_camera = info_camera
        const category_upper = (r.category || "").toUpperCase();
        
        let identificacion = "";
        r.nombre_completo = "";
        if (r.category == "persona"){
            identificacion_prof = findById(rows_data_person, r.documento)
            log("identificacion_prof",identificacion_prof)
            if (!identificacion_prof) {
                // Skip this row if identificacion_prof is undefined or null
                continue;
            }
            identificacion = identificacion_prof.nombres + " " +  identificacion_prof.apellidos;
            r.nombre_completo = identificacion;
        }else{
            identificacion = r.plate;
        }
        
        const containerW = 80; // ancho de la celda de la tabla
        const containerH = 80; // alto de la celda de la tabla

        // Calcular coordenadas como en showresultsearch
        const [xf1, yf1, xf2, yf2] = (r.coords_plate || "0,0,1,1").split(",").map(Number);
        const [xb1, yb1] = (r.coords_obj || "0,0").split(",").map(Number);
        

        const x1 = xf1 + xb1;
        const y1 = yf1 + yb1;
        const w = xf2 - xf1;
        const h = yf2 - yf1;


        const [xo1, yo1, xo2, yo2] = (r.coords_obj || "0,0,1,1").split(",").map(Number);
        const w_obj = xo2 - xo1;
        const h_obj = yo2 - yo1;


        // Generamos un ID único para luego aplicar el fondo
        const cropId_obj = `crop-${i}-${Date.now()}-obj`;
        const cropId = `crop-${i}-${Date.now()}`;
        log("rrrr",r)
        let emotion=getEmotionName(r.emotion);
        
        
        let row = `<tr onclick='onClickListRow(${JSON.stringify(r)})' style="cursor:pointer;">
                <th>${i}</th>
                <th>
                    <div id="${cropId_obj}" style="width:${containerW}px; height:${containerH}px; border-radius:5px; overflow:hidden; background:#000;"></div>
                </th>
                <th>${r.epoch_date_name}</th>
                <td>${category_upper}</td>
                <td>${emotion}</td>
                <td>${identificacion}</td>
                <th>
                    <div id="${cropId}" style="width:${containerW}px; height:${containerH}px; border-radius:5px; overflow:hidden; background:#000;"></div>
                </th>
                <td>${r.accuracy_detection} %</td>
            </tr>`;
        html += row;
        
        //foto_persona = `url(/personimages/inputs/${r.foto}.jpg)`
        const img = new Image();
        img.src = r.foto;
        img.onload = () => {
            const imgW = img.naturalWidth;
            const imgH = img.naturalHeight;
            
            if (r.category == "persona"){
                var scale = Math.min(containerW / w, containerH / h);
                var bgW = imgW * scale;
                var bgH = imgH * scale;
    
                var bgX = (containerW - w * scale) / 2 - x1 * scale;
                var bgY = (containerH - h * scale) / 2 - y1 * scale;
    
                document.getElementById(cropId_obj).style.backgroundImage = `url(${r.foto})`;
                document.getElementById(cropId_obj).style.backgroundSize = `${bgW}px ${bgH}px`;
                document.getElementById(cropId_obj).style.backgroundPosition = `${bgX}px ${bgY}px`;
                document.getElementById(cropId_obj).style.backgroundRepeat = "no-repeat";
                
                
                document.getElementById(cropId).style.backgroundImage =  `url(/personimages/inputs/${r.documento}.jpg)`;
                //document.getElementById(cropId).style.backgroundSize = `${containerW}px ${containerH}px`;
                document.getElementById(cropId).style.backgroundSize = `${containerW}px ${containerH}px`;
                
            }else{
                var scale = Math.min(containerW / w, containerH / h);
                var bgW = imgW * scale;
                var bgH = imgH * scale;
    
                var bgX = (containerW - w * scale) / 2 - x1 * scale;
                var bgY = (containerH - h * scale) / 2 - y1 * scale;
    
                document.getElementById(cropId).style.backgroundImage = `url(${r.foto})`;
                document.getElementById(cropId).style.backgroundSize = `${bgW}px ${bgH}px`;
                document.getElementById(cropId).style.backgroundPosition = `${bgX}px ${bgY}px`;
                document.getElementById(cropId).style.backgroundRepeat = "no-repeat";
                
                var scale_ = Math.min(containerW / w_obj, containerH / h_obj);
                var bgW_ = imgW * scale_;
                var bgH_ = imgH * scale_;
        
                var bgX_ = (containerW - w_obj * scale_) / 2 - xo1 * scale_;
                var bgY_ = (containerH - h_obj * scale_) / 2 - yo1 * scale_;
    
                document.getElementById(cropId_obj).style.backgroundImage = `url(${r.foto})`;
                document.getElementById(cropId_obj).style.backgroundSize = `${bgW_}px ${bgH_}px`;
                document.getElementById(cropId_obj).style.backgroundPosition = `${bgX_}px ${bgY_}px`;
                document.getElementById(cropId_obj).style.backgroundRepeat = "no-repeat";
                
            }
        };
        

        loc.html(html);
        i++;
    }

    rows_data = data;
}

    

function imageprocess(obj,time){
    var btn=obj.parentElement.parentElement.parentElement.querySelector('button')
    btn.setAttribute('disabled',1);
    btn.className="btn btn-w-md btn-secondary btn-rounded"
    //obj.setAttribute('errorload',1);
    setTimeout(
        ()=>{
            obj.src='/public/images/logowin.png'
            obj.style.filter='grayscale(100%)'
            obj.style.opacity='0.1'
        },
        time
    );
}

function showVideoModal() {
  videoOvl.style.display = 'flex';
}

function closeVideoModal() {
  videoOvl.style.display = 'none';

  if (videoPlayer) {
    try {
      videoPlayer.stop();
    } catch (e) {
      log("Error al detener video player:", e);
    }
    videoPlayer = null;
  }
}


function onClickListRow(row){
    "#showcamera".qs().innerHTML = row.info_camera.camera_id
    "#showtime".qs().innerHTML = row.epoch_date_name
    "#showlocation".qs().innerHTML = row.info_camera.location
    log("onClickListRow")
    log(row)
    if (row.category == "persona"){
        callAPI({
            method: 'gestion/getframesperson',
            
            params: {
                camara: row.camera_id,
                tracking_id: row.tracking_id,
                documento: row.documento,
                epoch: row.epoch_frame
                
            },
            ok: function (data) {
                log(data)
                videoPlayer = new videoplay("#showVideoModal .modal-body".qs());
                setTimeout(() => {
                    $('#showVideoModal').modal('show');
                    
                    const frames = data;
                    const grouped = Object.values(
                        frames.reduce((acc, item) => {
                            
                            if (!item.coords_obj) return data;
    
                            if (!acc[item.foto]) {
                                acc[item.foto] = {
                                    foto: item.foto,
                                    coords_obj: []
                                };
                            }
    
                            acc[item.foto].coords_obj.push({
                                categoria: item.category,
                                
                                accuracy_obj: item.acc_parecido,
                                colorupper: item.color_name_upper,
                                colorlower: item.color_name_lower,
                                coords: (item.coords_obj || '').split(","),
                                coordsplate: (item.coords_face || '').split(","),
                                plate: row.nombre_completo+" - "+getEmotionName(row.emotion)
                            });
    
                            return acc;
                        }, {})
                    ).sort((a, b) => a.foto.localeCompare(b.foto));
    
                    videoPlayer.update(grouped, "foto", "coords_obj")
                    setTimeout(() => { videoPlayer.play() }, 100)
    
                }, 100)
            }
        });
        
    }else{
        
            callAPI({
            method: 'gestion/dolistimgbytrackid',
            params: { 
                cameraid: row.camera_id ,
                tracking_id: row.tracking_id
            },                                                                                                                 
            ok: function(data) {     
                log(data)                        
                videoPlayer=new videoplay("#showVideoModal .modal-body".qs());
                setTimeout(()=>{
                    $('#showVideoModal').modal('show');                    
                    //log("DATA")
                    //log(data[1])
                    
                    const frames = data[2];

                    // Reducimos SOLO ese array
                    const grouped = Object.values(
                        frames.reduce((acc, item) => {
                            // si no hay coords, lo ignoramos
                            if (!item.coords_obj) return data[2];
        
                            if (!acc[item.foto]) {
                                acc[item.foto] = {
                                    foto: item.foto,
                                    coords_obj: []
                                };
                            }
        
                            acc[item.foto].coords_obj.push({
                                categoria:   item.category,
                                colorupper:  item.color_name_upper,
                                colorlower:  item.color_name_lower,
                                plate:       item.plate,
                                accuracy_obj: item.accuracy_plate,
                                coords:      item.coords_obj.split(","),
                                coordsplate: item.coords_plate
                                              ? item.coords_plate.split(",")
                                              : ['']
                            });
        
                            return acc;
                        }, {})
                    ).sort((a, b) => a.foto.localeCompare(b.foto));

                    videoPlayer.update(grouped,"foto","coords_obj")
                    setTimeout(()=>{videoPlayer.play()},100)

                },100)
            }
    });
        
    };
    

}
   
function showresultsearch(data){

    $("#result-list").html("")
    var paneltemplate = $("#panelTemplate").html();
    var itime=1
    let ident = 1;
    $("#totalcamaras").html(data.length)
    for(x of data){        
        var panel=paneltemplate;
        var d  = new Date(x.date_start);
        x.nombre_zona = x.nombre_zona || "";
        x.nombre_subzona = x.nombre_subzona || "";
        x.nombre_objetivo = x.nombre_objetivo || "";
        x.ident = x.ident || ident;
        ident+=1;
        itime+5;
        
        for( y in x){panel=panel.replaceAll("@"+y,x[y])}

        
        panel=panel.replaceAll("@time",itime)
        panel=$(panel)   

        var anchor=$(panel).find('button')
        
        anchor.attr("data",JSON.stringify(x));        
        anchor.on('click', function(){            
            listResultEvents(JSON.parse($(this).attr("data")))            
        });

        $("#result-list").append(panel)
    }
}

function findById(list, idBuscado) {
    log("findById");
    log(list);
    log(idBuscado);
    return list.find(item => item.id == idBuscado);
}


function listResultEvents(row){

    "#info-camera-nombre".qs().innerHTML = row.camera_id
    "#info-camera-localidad".qs().innerHTML = row.location
    "#info-camera-zona".qs().innerHTML = row.nombre_zona
    "#info-camera-SubZ".qs().innerHTML = row.nombre_subzona
    "#info-camera-Objetivo".qs().innerHTML = row.nombre_objetivo
    
    callAPI({
        method: 'gestion/geteventoscamara',
        params: {cameraid: row.id ,},                                                                                                                 
        ok:(data)=>{
            log(data)
            if (data.length > 0){
                results = data[2]
                log(results)

                render_camaras($(".table-responsive tbody"),results,row);
                
                "#totaleventos".qs().innerHTML = results.length
                const totalPersonas = results.filter(e => e.category === "persona").length;
                "#totalpersonas".qs().innerHTML = totalPersonas;
    
                // Total vehículos (autos, bus)
                const totalVehiculos = results.filter(e => ["auto", "bus", "camion"].includes(e.category)).length;
                "#totalvehiculos".qs().innerHTML = totalVehiculos;
            
                result_list_events_camera.css("display", "");
                panel_events_camera.css("display", "");    
                
                result_list.css("display", "none");    
                panel_filters.css("display", "none");    
            }
        }
    });
}

{
    $("#btnatras").on("click", function () {
        result_list.css("display", "");    
        panel_filters.css("display", "");
        
        result_list_events_camera.css("display", "none");
        panel_events_camera.css("display", "none");    
    }); 
}


$(document).ready(function () {

    callAPI({
        method:"gestion/getcamaras",            
        params:{camera:$("#txtcamera").val()},
        ok:(data)=>{
            showresultsearch(data)
        }
    });


    callAPI({
        method:"gestion/getlistperson",
        ok:(data)=>{
            log(data);
            rows_data_person = data
        }
    });




    
    $("#txcamera").keyup( function (ev) {
        //videoPlayer.stop();  
        //log(ev)
        var value=$("#txcamera").val().toLowerCase();
        var list=$("#result-list")[0].childNodes
        for(x of list){
            x.style.display="";
            var data=x.innerHTML.toLowerCase()
            if(data.indexOf(value)==-1){
                x.style.display="none";
            }
        }
        
        log(list)

    });

    
$("#showVideoModal").on("hidden.bs.modal", function () {
    videoPlayer.stop();
});

});


</script>
