<div class="row col-lg-12  col-md-12  col-sm-12" id="list">
    <div class="col-lg-10  col-md-10  col-sm-10">
        <div class="panel panel-filled panel-c-accent">
            <div class="panel-heading">
                Filtros
            </div>
            <div class="panel-body">

                <div class="col-lg-10 col-md-10 col-sm-12">
                    <div class=form-group>
                        <input id="txtsearch" type="text" class="form-control" placeholder="Buscar ticket por N° de Ticket, Origen, Nombre de Informante, N° de Doc de Identidad, etc.">
                    </div>
                </div>

                <div class="col-lg-2 col-md-2 col-sm-12">
                    <div class=form-group>
                        <button id="btn-rownew" type="button" href="#" class="btn btn-w-md btn-primary btn-rounded"
                            >Nuevo Ticket</button>
                    </div>
                </div>

            </div>
        </div>
    </div>
    <div class="col-lg-2  col-md-2  col-sm-2">
        <div class="panel panel-filled  panel-c-accent">
            <div class="panel-heading">
                Total de Tickets
            </div>
            <div class="panel-body text-center">
                <h2 class="m-b-none " id="totalnodos"></h2>
            </div>
        </div>
    </div>


    <div class="col-lg-12  col-md-12  col-sm-12">
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>N° de Ticket</th>
                        <th>Origen</th>
                        <th>Nombre de Informante</th>
                        <th>N° Doc Identidad</th>
                        <th>Fecha de Registro</th>
                        <th>Nombre Operador</th>
                        <th>General</th>
                        <th>Tipo</th>
                        <th>Incidencia</th>
                        <th>Ubicacion</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>
</div>


<div class="modal fade " id="modal-person" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header text-left" style="background-color: #252525;">
                <h4 class="modal-title mb-0">Registro de Nueva Ticket</h4>
                <h7 class="mb-0">Persona</h7>
            </div>

            <div class="modal-body">
                <div class="row" style="overflow-y:auto;height:400px;scrollbar-width: thin;">
                    <div class="col-lg-12 m-0" id="columna-informacion-estructurada">
                        <div class="panel panel-filled panel-c-accent">
                            <div class="panel-heading">
                                <div class="panel-tools">
                                    <a class="panel-toggle"><i class="fa fa-chevron-up"></i></a>
                                </div>
                                <h5 class="panel-toggle" style="cursor:pointer;">INFORMACION TICKET</h5>
                            </div>
                            <div class="panel-body">
                                
                                <div class="col-lg-6">
                                    <label>F. de Registro</label>
                                    <div class="form-group">
                                        <input id="fecha_registro" type="date" class="form-control" placeholder="Fecha de Registro">
                                    </div>
                                </div>

                                <div class="col-lg-6">
                                    <label>Origen</label>
                                    <div class="form-group">
                                        <select id="origen_ticket" class="form-control">
                                            <option value="" disabled selected>Seleccione método</option>
                                            <option value="0">Llamada a la Central</option>
                                            <option value="1">Denuncia por RRSS</option>
                                            <option value="2">Whatsapp / Telegram</option>
                                            <option value="3">App</option>
                                            <option value="4">Agente de serenazgo</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="col-lg-6">
                                    <label>Nombre de denunciante</label>
                                    <div class="form-group">
                                        <input id="nombre_denunciante" type="text" class="form-control" placeholder="Ingrese nombre">
                                    </div>
                                </div>

                                <div class="col-lg-6">
                                    <label>N° de contacto</label>
                                    <div class="form-group">
                                        <input id="numero_contacto" type="tel" class="form-control" placeholder="00000000">
                                    </div>
                                </div>

                                <div class="col-lg-6">
                                    <div class="form-group">
                                        <label>Tipo de documento</label>
                                        <select id="tipo_doc_ticket" class="form-control">
                                            <option value="" disabled selected>Seleccione tipo de doc</option>
                                            <option value="DNI" selected>DNI</option>
                                            <option value="CE">Carnet Extranjeria</option>
                                            <option value="PA">Pasaporte</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="col-lg-6">
                                    <div class="form-group">
                                        <label>Número de documento</label>
                                        <input id="numero_doc_ticket" type="text" class="form-control" placeholder="00000000">
                                    </div>
                                </div>

                                <div class="col-lg-6">
                                    <div class="form-group">
                                        <label>General</label>
                                        <select id="categoria_general" class="form-control">
                                            <option value="" disabled selected>Seleccione categoría</option>
                                            <option value="MT">Movilidad y Tránsito</option>
                                            <option value="SC">Seguridad Ciudadana</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="col-lg-6">
                                    <div class="form-group">
                                        <label>Tipo</label>
                                        <select id="tipo_incidente" class="form-control">
                                            <option value="" disabled selected>Seleccione tipo</option>
                                            <option value="AV">Accidente Vehicular</option>
                                            <option value="CV">Congestion Vehicular</option>
                                            <option value="IZ">Intrusión en zona de interés</option>
                                            <option value="VR">Vehículo robado</option>
                                            <option value="PC">Persona caída</option>
                                            <option value="VS">Vehículo sospechoso</option>
                                            <option value="EV">Exceso de velocidad</option>
                                            <option value="VA">Vehículo abandonado</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="col-lg-6">
                                    <div class="form-group">
                                        <label>Ubicación de la incidencia</label>
                                        <input id="ubicacion_incidente" type="text" class="form-control" placeholder="Ingrese ubicación">
                                    </div>
                                </div>

                                <div class="col-lg-6">
                                    <div class="form-group">
                                        <label>Referencia</label>
                                        <input id="referencia_incidente" type="text" class="form-control" placeholder="Ingrese referencia">
                                    </div>
                                </div>

                                <div class="col-lg-6">
                                    <div class="form-group">
                                        <label>Coordenadas</label>
                                        <input id="coordenadas_incidente" type="text" class="form-control" placeholder="Lat, Long">
                                    </div>
                                </div>

                                <div class="col-lg-6">
                                    <div class="form-group">
                                        <label>Cámara Asociada</label>
                                        <input id="camara_asociada" type="text" class="form-control" placeholder="Ingrese referencia">
                                    </div>
                                </div>

                                <div class="col-lg-6">
                                    <div class="form-group">
                                        <label>Motivo de Cierre</label>
                                        <select id="motivo_cierre" class="form-control">
                                            <option value="" disabled selected>Seleccione motivo de cierre</option>
                                            <option value="CC">Caso Cerrado</option>
                                            <option value="CD">Caso Desestimado</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="col-lg-6">
                                    <div class="form-group">
                                        <label>Video Adjunto</label>
                                        <input id="video_adjunto" type="url" class="form-control" placeholder="URL del video">
                                    </div>
                                </div>

                                <div class="col-lg-12">
                                    <div class="form-group">
                                        <label>Descripción</label>
                                        <textarea id="descripcion_adicional" class="form-control" rows="4" style="resize: none;"></textarea>
                                    </div>
                                </div>

                                <div class="" id="list-history"></div>

                            </div>
                        </div>
                        
                        <div class="panel panel-filled panel-c-accent"> 
                            <div class="panel-heading">
                                <div class="panel-tools">
                                    <a class="panel-toggle"><i class="fa fa-chevron-up"></i></a>
                                </div>
                                <h5 class="panel-toggle" style="cursor:pointer;">INFORMACIÓN ADICIONAL</h5>
                            </div>
                            <div class="panel-body">
                                <div class="col-lg-6">
                                    <div class="form-group">
                                        <label>Apoyo serenazgo</label>
                                        <input id="apoyo_serenazgo" type="text" class="form-control" placeholder="Sí / No">
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="form-group">
                                        <label># Vehículos impactados</label>
                                        <input id="vehiculos_impactados" type="number" class="form-control" placeholder="Cantidad">
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="form-group">
                                        <label>Agente PNP</label>
                                        <input id="agente_pnp" type="text" class="form-control" placeholder="Sí / No">
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="form-group">
                                        <label>Número de heridos</label>
                                        <input id="numero_heridos" type="number" class="form-control" placeholder="Cantidad">
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="form-group">
                                        <label>Bomberos</label>
                                        <input id="bomberos" type="text" class="form-control" placeholder="Sí / No">
                                    </div>
                                </div>
                                
                                <div class="col-lg-6">
                                    <div class="form-group">
                                        <label>Decesos</label>
                                        <input id="decesos" type="number" class="form-control" placeholder="Cantidad">
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>

                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-default btn-rounded" data-dismiss="modal">Cerrar</button>
                    <button id="btnSendNew" type="button" class="btn btn-success btn-rounded">Enviar</button>
                    <button id="btnSendEdit" type="button" class="btn btn-warning btn-rounded">Modificar</button>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
    
    $("#modal_edit").hide();
    var rows_data = [];

    function render_table(loc, data) {
        let html = "";
        let i = 0;

        for (r of data) {

            let row = `<tr  onclick="onClickListRow('` + r.idnode + `') ">
                <th>`+ r.node_name + `</th>
                <th>`+ r.ipnode + `</th>
                <td>Disco ${r.tipo_disco} de ${r.disco}TB, ${r.memoria} de RAM GB</td>
                <td>`+ r.capacidad + `</td>
                <td>`+ "30" + `</td>
                <td>`+ "70" + `</td>
                <td>`+ r.fechareg + `</td>
            </tr>`

            html += row;
            i++;
        }

        loc.html(html)
        rows_data = data;
    };

    function load_data() {
        callAPI({
            method: "cluster/getnodosall",
            params: {},
            ok: (data) => {
                render_table(
                    $(".table-responsive tbody"),
                    data
                )
                $("#totalnodos").html(data.length)
            }
        });
    };


    $("#txtsearch").keyup(function (ev) {
        var value = $("#txtsearch").val().toLowerCase();
        var list = $(".table-responsive tbody")[0].childNodes
        for (x of list) {
            x.style.display = "";
            var data = x.innerHTML.toLowerCase()
            if (data.indexOf(value) == -1) {
                log("encnotrado")
                x.style.display = "none";
            }
        }

    });

    $("#btn-rownew").on("click", () => {
        $('#modal-person').modal('show');
        //$('#modal_person').modal('show');

    });

    $("#btnenviarnew").on("click", () => {

        var objetivoSeleccionado = $('#id_objetivo').find(':selected').text();

        callAPI({
            method: "cluster/clusternew",
            post: 1,
            params: {
                "node_name": $("#modal_person #node_name").val(),
                "ipnode": $("#modal_person #ipnode").val(),
                "portnode": $("#modal_person #portnode").val(),
                "capacidad": $("#modal_person #capacidad").val(),
                "fps": $("#modal_person #fps").val(),
                "tipo_disco": $("#modal_person #tipo_disco").val(),
                "disco": $("#modal_person #disco").val(),
                "memoria": $("#modal_person #memoria").val(),
                "amqp": $("#modal_person #amqp").val(),
                "imagedocker": $("#modal_person #imagedocker").val(),
                "redishost": $("#modal_person #redishost").val(),
                "exchangename": $("#modal_person #exchangename").val(),
                "exchangeerror": $("#modal_person #exchangeerror").val(),
                "redisport": $("#modal_person #redisport").val(),
                "target": $("#modal_person #target").val(),
                "corecount": $("#modal_person #corecount").val()
            },
            ok: (data) => {
                $('#modal_person').modal('hide');
                render_table(
                    $(".table-responsive tbody"),
                    data
                );
            }
        });


    });

    //RENDERROW TO EDIT
    let idnode = 0;
    function onClickListRow(index) {

        idnode = index;
        const numCores = 32; // número total de cores

        for (let i = 0; i < numCores; i += 2) {
            const core_primary = i;
            const core_secondary = i + 1;
            const camera_count = 0; // puedes cambiarlo si deseas

            const sql = `INSERT INTO node_core (idnode, core_primary, core_secondary, camera_count) VALUES (${idnode}, ${core_primary}, ${core_secondary}, ${camera_count});`;
            console.log(sql);
        }



        $("#modal_edit").show();
        $('#modal_edit').modal('show');
        // $("#list").hide();
        //carga_combo_edit();
        log("id: " + index)
        callAPI({
            method: 'cluster/getnodobyid',
            params: {
                idnode: index
            },
            ok: function (vals) {

                vals.forEach(obj => {

                    // log("obj");
                    //log(obj);
                    $('#modal_edit #node_name').val(obj.node_name);
                    $('#modal_edit #ipnode').val(obj.ipnode);
                    $('#modal_edit #portnode').val(obj.portnode);
                    $('#modal_edit #fps').val(obj.fps);
                    $('#modal_edit #capacidad').val(obj.capacidad);
                    $('#modal_edit #memoria').val(obj.memoria);
                    $('#modal_edit #tipo_disco').val(obj.tipo_disco);
                    $('#modal_edit #disco').val(obj.disco);
                    $('#modal_edit #imagedocker').val(obj.imagedocker);
                    $('#modal_edit #amqp').val(obj.amqp);
                    $('#modal_edit #target').val(obj.target);
                    $('#modal_edit #redisport').val(obj.redisport);
                    $('#modal_edit #redishost').val(obj.redishost);
                    $('#modal_edit #exchangename').val(obj.exchangename);
                    $('#modal_edit #exchangeerror').val(obj.exchangeerror);
                    $('#modal_edit #corecount').val(obj.corecount);

                });
            },
            error: function () {
                $('#id_cuadrante').html('<option value="">Error al cargar</option>');
            }
        });

     

    };

    $("#cancelBtn").on("click", function () {
        if (confirm("¿Estás seguro de que deseas cancelar el registro?")) {
            $("#cameraForm")[0].reset();
        }
    });


    $(document).ready(function () {

        load_data()

    });

</script>