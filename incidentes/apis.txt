[
    {
        "id": "d46893cfffb15d18",
        "type": "subflow",
        "name": "mysqlRoutine",
        "info": "",
        "category": "",
        "in": [
            {
                "x": 200,
                "y": 320,
                "wires": [
                    {
                        "id": "e5381649b2fcb619"
                    },
                    {
                        "id": "0b31bdc9297bfb6a"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 760,
                "y": 320,
                "wires": [
                    {
                        "id": "e5381649b2fcb619",
                        "port": 0
                    }
                ]
            }
        ],
        "env": [],
        "meta": {},
        "color": "#DDAA99",
        "status": {
            "x": 160,
            "y": 60,
            "wires": []
        }
    },
    {
        "id": "bb44682b71f60665",
        "type": "debug",
        "z": "d46893cfffb15d18",
        "name": "mySql-Routine-Result",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 620,
        "y": 180,
        "wires": []
    },
    {
        "id": "55696358c8c15d5f",
        "type": "catch",
        "z": "d46893cfffb15d18",
        "name": "mySql-Routine-Error",
        "scope": null,
        "uncaught": false,
        "x": 610,
        "y": 460,
        "wires": [
            [
                "f39e06790c95705e",
                "3fa742c81bc4efd6"
            ]
        ]
    },
    {
        "id": "f39e06790c95705e",
        "type": "debug",
        "z": "d46893cfffb15d18",
        "name": "mySql-Routine-Error",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 820,
        "y": 540,
        "wires": []
    },
    {
        "id": "0b31bdc9297bfb6a",
        "type": "debug",
        "z": "d46893cfffb15d18",
        "name": "mySql-Routine-In",
        "active": true,
        "tosidebar": false,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 370,
        "y": 160,
        "wires": []
    },
    {
        "id": "3fa742c81bc4efd6",
        "type": "function",
        "z": "d46893cfffb15d18",
        "name": "http statusCode",
        "func": "msg.statusCode = 400; // Ã³ el cÃ³digo que necesites   \nmsg.payload=[msg.error];\n\n//throw new Error(\"Campo 'usuario' obligatorio\");\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 840,
        "y": 460,
        "wires": [
            []
        ]
    },
    {
        "id": "e5381649b2fcb619",
        "type": "mysql",
        "z": "d46893cfffb15d18",
        "mydb": "7533ec265cf2a6ba",
        "name": "${DBHOST}",
        "x": 390,
        "y": 320,
        "wires": [
            [
                "bb44682b71f60665"
            ]
        ]
    },
    {
        "id": "7533ec265cf2a6ba",
        "type": "MySQLdatabase",
        "z": "d46893cfffb15d18",
        "name": "mysql",
        "host": "${DBHOST}",
        "port": "3306",
        "db": "${DBNAME}",
        "tz": "",
        "charset": "UTF8"
    },
    {
        "id": "7465e3d6e3434036",
        "type": "subflow:d46893cfffb15d18",
        "z": "e488fa7b5082d501",
        "name": "",
        "x": 2340,
        "y": 160,
        "wires": [
            []
        ]
    },
    {
        "id": "3fb6c1e706584f7b",
        "type": "debug",
        "z": "e488fa7b5082d501",
        "name": "debug 47",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 2090,
        "y": 60,
        "wires": []
    },
    {
        "id": "e9a5cf4759f88af1",
        "type": "function",
        "z": "e488fa7b5082d501",
        "name": "pythonFuncional",
        "func": "const q = (msg.req && msg.req.method === 'GET') ? (msg.req.query || {}) : (msg.payload || {});\n\n// 0 = Todos â†’ NULL\nconst normCombo = v => {\n  const s = (v ?? '').toString().trim();\n  if (s === '' || s === '0') return null;\n  const n = Number(s);\n  return Number.isFinite(n) ? n : null;\n};\nconst normStr = v => {\n  const s = (v ?? '').toString().trim();\n  return s === '' ? null : s;\n};\n\n// complainant: nombre exacto o celular (dÃ­gitos exactos)\nconst rawComp = normStr(q.complainant);\nconst compDigits = rawComp ? rawComp.replace(/[^\\d]/g, '') : null;\nconst compIsNum = compDigits && compDigits.length >= 6 ? 1 : 0;\n\n// fecha: â€œYYYY-MM-DDâ€ o â€œYYYY-MM-DD - YYYY-MM-DDâ€\nlet date_from = null, date_to = null;\nconst rawDate = normStr(q.incidence_date);\nif (rawDate) {\n  const parts = rawDate.split(/\\s*-\\s*/);\n  if (parts.length === 2 && parts[0] && parts[1]) {\n    date_from = parts[0] + ' 00:00:00';\n    const d = new Date(parts[1] + 'T00:00:00'); d.setDate(d.getDate() + 1);\n    date_to = d.toISOString().slice(0, 19).replace('T', ' ');\n  } else {\n    date_from = rawDate + ' 00:00:00';\n    const d = new Date(rawDate + 'T00:00:00'); d.setDate(d.getDate() + 1);\n    date_to = d.toISOString().slice(0, 19).replace('T', ' ');\n  }\n}\n\n// SQL con ?\nmsg.topic = `\nSELECT\n  ti.incidence_id,\n  ti.incidence_date,\n  ti.description_incidence,\n  ti.reason,\n  ti.location,\n  ti.location_reference,\n  ti.complainant,\n  ti.contact_number,\n  o.origin_name,\n  u.unit_name,\n  ic.incidence_classification_name,\n  it.incidence_type_name,\n  ist.incidence_subtype_name,\n  st.incidence_state_name AS state_name,\n  m.mode_name,\n  g.guardpost_name\nFROM a2c.trx_incidence AS ti\nLEFT JOIN a2c.mstr_origin                   AS o   ON o.origin_id = ti.origin_id\nLEFT JOIN a2c.mstr_unit                     AS u   ON u.unit_id = ti.unit_id\nLEFT JOIN a2c.mstr_incidence_classification AS ic  ON ic.incidence_classification_id = ti.incidence_classification_id\nLEFT JOIN a2c.mstr_incidence_type           AS it  ON it.incidence_type_id          = ti.incidence_type_id\nLEFT JOIN a2c.mstr_incidence_subtype        AS ist ON ist.incidence_subtype_id      = ti.incidence_subtype_id\nLEFT JOIN a2c.mstr_incidence_state          AS st  ON st.incidence_state_id         = ti.incidence_state_id\nLEFT JOIN a2c.mstr_mode                     AS m   ON m.mode_id                     = ti.mode_id\nLEFT JOIN a2c.mstr_guardpost                AS g   ON g.guardpost_id                = ti.cuadrante_id\nWHERE\n  ti.origin_id                   = COALESCE(?, ti.origin_id)\n  AND ti.incidence_subtype_id    = COALESCE(?, ti.incidence_subtype_id)\n  AND ti.incidence_type_id       = COALESCE(?, ti.incidence_type_id)\n  AND ti.incidence_classification_id = COALESCE(?, ti.incidence_classification_id)\n  AND ti.incidence_state_id      = COALESCE(?, ti.incidence_state_id)\n  AND ti.unit_id                 = COALESCE(?, ti.unit_id)\n  AND ti.document_number         = COALESCE(?, ti.document_number)\n  AND (\n        ? IS NULL\n        OR ( ? = 0 AND ti.complainant = ? )\n        OR ( ? = 1 AND REPLACE(REPLACE(REPLACE(ti.contact_number,'-',''),' ',''),'+','') = ? )\n      )\n  AND ( ? IS NULL OR ti.location = ? OR ti.location_reference = ? )\n  AND ( ? IS NULL OR ti.reason   = ? OR ti.description_incidence = ? )\n  AND ( ? IS NULL OR ti.incidence_date >= ? )\n  AND ( ? IS NULL OR ti.incidence_date <  ? )\nORDER BY ti.incidence_date DESC\nLIMIT ? OFFSET ?;\n`;\n\n// Array en el mismo orden de los ?\nconst params = [\n  normCombo(q.origin_id),\n  normCombo(q.incidence_subtype_id),\n  normCombo(q.incidence_type_id),\n  normCombo(q.incidence_classification_id),\n  normCombo(q.incidence_state_id),\n  normCombo(q.unit_id),\n  normStr(q.document_number),\n\n  rawComp ? rawComp : null,     // ? IS NULL\n  compIsNum,                    // ? = 0/1\n  compIsNum ? null : rawComp,   // nombre cuando 0\n  compIsNum,                    // =1 para rama telÃ©fono\n  compIsNum ? compDigits : null,// dÃ­gitos cuando 1\n\n  normStr(q.location), normStr(q.location), normStr(q.location),\n  normStr(q.reason), normStr(q.reason), normStr(q.reason),\n\n  date_from, date_from,\n  date_to, date_to,\n\n  Number(q.limit) || 50,\n  Number(q.offset) || 0\n];\n\n// Para compatibilidad: algunos nodos usan payload como params.\nmsg.params = params;\nmsg.payload = params;\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1960,
        "y": 720,
        "wires": [
            []
        ]
    },
    {
        "id": "e2cd0f15c9c4594f",
        "type": "debug",
        "z": "e488fa7b5082d501",
        "name": "debug 50",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 2660,
        "y": 520,
        "wires": []
    },
    {
        "id": "441b9a2d7f4e5463",
        "type": "function",
        "z": "e488fa7b5082d501",
        "name": "function 4",
        "func": "// Function ANTES de sqlstring-format\nconst q = (msg.req && msg.req.query) ? msg.req.query : (msg.payload || {});\n\nconst normCombo = v => {\n  const s = (v ?? '').toString().trim();\n  if (s === '' || s === '0') return null;\n  const n = Number(s);\n  return Number.isFinite(n) ? n : null;\n};\nconst normStr = v => {\n  const s = (v ?? '').toString().trim();\n  return s === '' ? null : s;\n};\n\n// complainant â†’ nombre exacto o celular (dÃ­gitos)\nconst rawComp = normStr(q.complainant);\nconst compDigits = rawComp ? rawComp.replace(/[^\\d]/g,'') : null;\nconst compIsNum = compDigits && compDigits.length >= 6 ? 1 : 0;\n\n// fechas: date_start/date_end tiene prioridad; si no, incidence_date (un dÃ­a)\nlet date_from = null, date_to = null;\nconst ds = normStr(q.date_start);\nconst de = normStr(q.date_end);\nif (ds || de) {\n  if (ds) date_from = ds + ' 00:00:00';\n  if (de) { const d = new Date(de + 'T00:00:00'); d.setDate(d.getDate() + 1);\n            date_to = d.toISOString().slice(0,19).replace('T',' '); }\n} else {\n  const day = normStr(q.incidence_date);\n  if (day) { date_from = day + ' 00:00:00';\n             const d = new Date(day + 'T00:00:00'); d.setDate(d.getDate() + 1);\n             date_to = d.toISOString().slice(0,19).replace('T',' '); }\n}\n\nconst params = [\n  normCombo(q.origin_id),\n  normCombo(q.incidence_subtype_id),\n  normCombo(q.incidence_type_id),\n  normCombo(q.incidence_classification_id),\n  normCombo(q.incidence_state_id),\n  normCombo(q.unit_id),\n  normStr(q.document_number),\n\n  rawComp ? rawComp : null,\n  compIsNum,\n  compIsNum ? null : rawComp,\n  compIsNum,\n  compIsNum ? compDigits : null,\n\n  normStr(q.location), normStr(q.location), normStr(q.location),\n\n  date_from, date_from,\n  date_to,   date_to,\n\n  Number(q.limit)  || 50,\n  Number(q.offset) || 0\n];\n\nmsg.params  = params;\n// ðŸ‘‡ CLAVE: que sqlstring-format lea los valores\nmsg.payload = params;   // NO lo borres ni lo dejes {}\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1820,
        "y": 160,
        "wires": [
            [
                "fd248e6856300bb1"
            ]
        ]
    },
    {
        "id": "5cb913ec3d712d4b",
        "type": "function",
        "z": "e488fa7b5082d501",
        "name": "function 1",
        "func": "const q = (msg.req && msg.req.method === 'GET') ? (msg.req.query || {}) : (msg.payload || {});\n\n// Helpers\nconst normCombo = v => {\n    const s = (v ?? '').toString().trim();\n    if (s === '' || s === '0') return null;\n    const n = Number(s);\n    return Number.isFinite(n) ? n : null;\n};\nconst normStr = v => {\n    const s = (v ?? '').toString().trim();\n    return s === '' ? null : s;\n};\nconst toInt = (v, dflt, minv) => {\n    const n = parseInt(v, 10);\n    if (!Number.isFinite(n) || n < minv) return dflt;\n    return n;\n};\n\n// complainant: nombre exacto o celular (>=6 dÃ­gitos)\nconst rawComp = normStr(q.complainant);\nconst compDigits = rawComp ? rawComp.replace(/[^\\d]/g, '') : null;\nconst compIsNum = compDigits && compDigits.length >= 6 ? 1 : 0;\n\n// fecha: â€œYYYY-MM-DDâ€ o â€œYYYY-MM-DD - YYYY-MM-DDâ€\nlet date_from = null, date_to = null;\nconst rawDate = normStr(q.incidence_date);\nif (rawDate) {\n    const parts = rawDate.split(/\\s*-\\s*/);\n    if (parts.length === 2 && parts[0] && parts[1]) {\n        date_from = parts[0] + ' 00:00:00';\n        const d = new Date(parts[1] + 'T00:00:00'); d.setDate(d.getDate() + 1);\n        date_to = d.toISOString().slice(0, 19).replace('T', ' ');\n    } else {\n        date_from = rawDate + ' 00:00:00';\n        const d = new Date(rawDate + 'T00:00:00'); d.setDate(d.getDate() + 1);\n        date_to = d.toISOString().slice(0, 19).replace('T', ' ');\n    }\n}\n\n// LIMIT/OFFSET seguros\nconst limitVal = toInt(q.limit, 100, 1);\nconst offsetVal = toInt(q.offset, 0, 0);\n\n// SQL: solo trx_incidence (nombres denormalizados) + guardpost + agregados de documentos\nmsg.topic = `\nSELECT\n  ti.incidence_id,\n  ti.incidence_date,\n  ti.description_incidence,\n  ti.reason,\n  ti.location,\n  ti.location_reference,\n  ti.complainant,\n  ti.contact_number,\n\n  -- NOMBRES SIN 'incidence_': vienen de trx_incidence\n  ti.origin_name,\n  ti.unit_name,\n  ti.classification_name,\n  ti.type_name,\n  ti.subtype_name,\n  ti.state_name,\n  ti.mode_name,\n\n  g.guardpost_name,\n\n  d.doc_count,\n  d.first_doc_path,\n  d.ext_list\n\nFROM a2c.trx_incidence AS ti\n\nLEFT JOIN a2c.mstr_guardpost AS g\n       ON g.guardpost_id = ti.cuadrante_id\n\nLEFT JOIN (\n  SELECT\n    tid.incidence_id,\n    COUNT(CASE WHEN tid.is_active = 1 THEN tid.incidence_document_id END) AS doc_count,\n    MIN(CASE WHEN tid.is_active = 1 THEN tid.ruta END) AS first_doc_path,\n    GROUP_CONCAT(DISTINCT CASE WHEN tid.is_active = 1 THEN tid.extension_document END ORDER BY tid.extension_document) AS ext_list\n  FROM a2c.trx_incidence_document AS tid\n  GROUP BY tid.incidence_id\n) AS d ON d.incidence_id = ti.incidence_id\n\nWHERE\n  ti.origin_id                   = COALESCE(?, ti.origin_id)\n  AND ti.incidence_subtype_id    = COALESCE(?, ti.incidence_subtype_id)\n  AND ti.incidence_type_id       = COALESCE(?, ti.incidence_type_id)\n  AND ti.incidence_classification_id = COALESCE(?, ti.incidence_classification_id)\n  AND ti.incidence_state_id      = COALESCE(?, ti.incidence_state_id)\n  AND ti.unit_id                 = COALESCE(?, ti.unit_id)\n  AND ti.document_number         = COALESCE(?, ti.document_number)\n\n  AND (\n        ? IS NULL\n        OR ( ? = 0 AND ti.complainant = ? )\n        OR ( ? = 1 AND REPLACE(REPLACE(REPLACE(ti.contact_number,'-',''),' ',''),'+','') =\n             REPLACE(REPLACE(REPLACE(?, '-',''),' ',''),'+','') )\n      )\n\n  AND ( ? IS NULL OR ti.location = ? OR ti.location_reference = ? )\n  AND ( ? IS NULL OR ti.reason   = ? OR ti.description_incidence = ? )\n\n  AND ( ? IS NULL OR ti.incidence_date >= ? )\n  AND ( ? IS NULL OR ti.incidence_date  <  ? )\n\nORDER BY ti.incidence_date DESC\nLIMIT ? OFFSET ?;\n`;\n\n// Params en el MISMO orden que los ?\nconst params = [\n    // IDs/catÃ¡logos\n    normCombo(q.origin_id),\n    normCombo(q.incidence_subtype_id),\n    normCombo(q.incidence_type_id),\n    normCombo(q.incidence_classification_id),\n    normCombo(q.incidence_state_id),\n    normCombo(q.unit_id),\n    normStr(q.document_number),\n\n    // complainant / phone\n    rawComp ? rawComp : null,     // ? IS NULL\n    compIsNum,                    // ? = 0/1\n    compIsNum ? null : rawComp,   // nombre exacto cuando 0\n    compIsNum,                    // =1 para rama telÃ©fono\n    compIsNum ? compDigits : null,// dÃ­gitos cuando 1\n\n    // location / location_reference\n    normStr(q.location), normStr(q.location), normStr(q.location),\n\n    // reason / description_incidence\n    normStr(q.reason), normStr(q.reason), normStr(q.reason),\n\n    // fechas [desde, hasta)\n    date_from, date_from,\n    date_to, date_to,\n\n    // paginaciÃ³n\n    limitVal,\n    offsetVal\n];\n\nmsg.params = params;\nmsg.payload = params; // por compatibilidad\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1540,
        "y": 620,
        "wires": [
            []
        ]
    },
    {
        "id": "adf763418d924541",
        "type": "function",
        "z": "e488fa7b5082d501",
        "name": "function 5",
        "func": "const q = (msg.req && msg.req.method === 'GET') ? (msg.req.query || {}) : (msg.payload || {});\n\n// Helpers\nconst normCombo = v => {\n  const s = (v ?? '').toString().trim();\n  if (s === '' || s === '0') return null;\n  const n = Number(s);\n  return Number.isFinite(n) ? n : null;\n};\nconst normStr = v => {\n  const s = (v ?? '').toString().trim();\n  return s === '' ? null : s;\n};\nconst toInt = (v, dflt, minv) => {\n  const n = parseInt(v, 10);\n  if (!Number.isFinite(n) || n < minv) return dflt;\n  return n;\n};\n\n// complainant: nombre exacto o celular (>=6 dÃ­gitos)\nconst rawComp = normStr(q.complainant);\nconst compDigits = rawComp ? rawComp.replace(/[^\\d]/g, '') : null;\nconst compIsNum = compDigits && compDigits.length >= 6 ? 1 : 0;\n\n// fecha: â€œYYYY-MM-DDâ€ o â€œYYYY-MM-DD - YYYY-MM-DDâ€\nlet date_from = null, date_to = null;\nconst rawDate = normStr(q.incidence_date);\nif (rawDate) {\n  const parts = rawDate.split(/\\s*-\\s*/);\n  if (parts.length === 2 && parts[0] && parts[1]) {\n    date_from = parts[0] + ' 00:00:00';\n    const d = new Date(parts[1] + 'T00:00:00'); d.setDate(d.getDate() + 1);\n    date_to = d.toISOString().slice(0, 19).replace('T', ' ');\n  } else {\n    date_from = rawDate + ' 00:00:00';\n    const d = new Date(rawDate + 'T00:00:00'); d.setDate(d.getDate() + 1);\n    date_to = d.toISOString().slice(0, 19).replace('T', ' ');\n  }\n}\n\n// LIMIT/OFFSET seguros\nconst limitVal = toInt(q.limit, 100, 1);\nconst offsetVal = toInt(q.offset, 0, 0);\n\n// SQL: trx_incidence (nombres denormalizados) + operator + guardpost + documentos\nmsg.topic = `\nSELECT\n  ti.incidence_id,\n  ti.incidence_date,\n  ti.description_incidence,\n  ti.reason,\n  ti.location,\n  ti.location_reference,\n  ti.complainant,\n  ti.contact_number,\n  ti.operator,                -- ðŸ‘ˆ agregado\n  ti.origin_name,\n  ti.unit_name,\n  ti.classification_name,\n  ti.type_name,\n  ti.subtype_name,\n  ti.state_name,\n  ti.mode_name,\n  g.guardpost_name,\n  d.doc_count,\n  d.first_doc_path,\n  d.ext_list\nFROM a2c.trx_incidence AS ti\nLEFT JOIN a2c.mstr_guardpost AS g\n       ON g.guardpost_id = ti.cuadrante_id\nLEFT JOIN (\n  SELECT\n    tid.incidence_id,\n    COUNT(CASE WHEN tid.is_active = 1 THEN tid.incidence_document_id END) AS doc_count,\n    MIN(CASE WHEN tid.is_active = 1 THEN tid.ruta END) AS first_doc_path,\n    GROUP_CONCAT(DISTINCT CASE WHEN tid.is_active = 1 THEN tid.extension_document END ORDER BY tid.extension_document) AS ext_list\n  FROM a2c.trx_incidence_document AS tid\n  GROUP BY tid.incidence_id\n) AS d ON d.incidence_id = ti.incidence_id\nWHERE\n  ti.origin_id                   = COALESCE(?, ti.origin_id)\n  AND ti.incidence_subtype_id    = COALESCE(?, ti.incidence_subtype_id)\n  AND ti.incidence_type_id       = COALESCE(?, ti.incidence_type_id)\n  AND ti.incidence_classification_id = COALESCE(?, ti.incidence_classification_id)\n  AND ti.incidence_state_id      = COALESCE(?, ti.incidence_state_id)\n  AND ti.unit_id                 = COALESCE(?, ti.unit_id)\n  AND ti.document_number         = COALESCE(?, ti.document_number)\n  AND (\n        ? IS NULL\n        OR ( ? = 0 AND ti.complainant = ? )\n        OR ( ? = 1 AND REPLACE(REPLACE(REPLACE(ti.contact_number,'-',''),' ',''),'+','') =\n             REPLACE(REPLACE(REPLACE(?, '-',''),' ',''),'+','') )\n      )\n  AND ( ? IS NULL OR ti.location = ? OR ti.location_reference = ? )\n  AND ( ? IS NULL OR ti.reason   = ? OR ti.description_incidence = ? )\n  AND ( ? IS NULL OR ti.incidence_date >= ? )\n  AND ( ? IS NULL OR ti.incidence_date  <  ? )\nORDER BY ti.incidence_date DESC\nLIMIT ? OFFSET ?;\n`;\n\n// Params en el mismo orden\nconst params = [\n  normCombo(q.origin_id),\n  normCombo(q.incidence_subtype_id),\n  normCombo(q.incidence_type_id),\n  normCombo(q.incidence_classification_id),\n  normCombo(q.incidence_state_id),\n  normCombo(q.unit_id),\n  normStr(q.document_number),\n  rawComp ? rawComp : null,\n  compIsNum,\n  compIsNum ? null : rawComp,\n  compIsNum,\n  compIsNum ? compDigits : null,\n  normStr(q.location), normStr(q.location), normStr(q.location),\n  normStr(q.reason), normStr(q.reason), normStr(q.reason),\n  date_from, date_from,\n  date_to, date_to,\n  limitVal,\n  offsetVal\n];\n\nmsg.params = params;\nmsg.payload = params;\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1720,
        "y": 640,
        "wires": [
            []
        ]
    },
    {
        "id": "e1efa036ccab2fb5",
        "type": "subflow:d46893cfffb15d18",
        "z": "e488fa7b5082d501",
        "name": "",
        "x": 760,
        "y": 1460,
        "wires": [
            [
                "5235398bcd262056"
            ]
        ]
    },
    {
        "id": "843222c263b5500e",
        "type": "function",
        "z": "e488fa7b5082d501",
        "name": "validate",
        "func": "let v=global.get(\"val\");\nlet err=[];\n\nconst errors = [];\n\n// Validar varios campos\n\nv('unit_id', msg.payload, errors, ['required']);\nv('incidence_classification_id', msg.payload, errors, ['required']);\n//v('incidence_state_id', msg.payload, errors, ['required']);\n//v('detener', msg.payload, errors, ['required']);\n\nmsg.originalData = msg.payload;  // Preserve original data in a new property\n\nif (errors.length){\n    msg.payload=errors;    \n    throw new Error(\"\");\n}\n\n\n//msg.payload.id=Date.now();\n//msg.filename=\"/data/uploads/\"+msg.payload.id+\".jpeg\";\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 360,
        "y": 1460,
        "wires": [
            [
                "4161c49dfa558888"
            ]
        ]
    },
    {
        "id": "511d567b6201d295",
        "type": "http in",
        "z": "e488fa7b5082d501",
        "name": "",
        "url": "incidencederivated",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 170,
        "y": 1460,
        "wires": [
            [
                "843222c263b5500e"
            ]
        ]
    },
    {
        "id": "fd248e6856300bb1",
        "type": "sqlstring-format",
        "z": "e488fa7b5082d501",
        "name": "incidences",
        "query": "SELECT\n  ti.incidence_id,\n  ti.incidence_date,\n  ti.description_incidence,\n  ti.reason,\n  ti.location,\n  ti.location_reference,\n  ti.complainant,\n  ti.contact_number,\n  o.origin_name,\n  u.unit_name,\n  ic.incidence_classification_name,\n  it.incidence_type_name,\n  ist.incidence_subtype_name,\n  st.incidence_state_name AS state_name,\n  m.mode_name,\n  g.guardpost_name\nFROM a2c.trx_incidence AS ti\nLEFT JOIN a2c.mstr_origin                   AS o   ON o.origin_id = ti.origin_id\nLEFT JOIN a2c.mstr_unit                     AS u   ON u.unit_id = ti.unit_id\nLEFT JOIN a2c.mstr_incidence_classification AS ic  ON ic.incidence_classification_id = ti.incidence_classification_id\nLEFT JOIN a2c.mstr_incidence_type           AS it  ON it.incidence_type_id          = ti.incidence_type_id\nLEFT JOIN a2c.mstr_incidence_subtype        AS ist ON ist.incidence_subtype_id      = ti.incidence_subtype_id\nLEFT JOIN a2c.mstr_incidence_state          AS st  ON st.incidence_state_id         = ti.incidence_state_id\nLEFT JOIN a2c.mstr_mode                     AS m   ON m.mode_id                     = ti.mode_id\nLEFT JOIN a2c.mstr_guardpost                AS g   ON g.guardpost_id                = ti.cuadrante_id\nWHERE\n  ti.origin_id                   = COALESCE(?, ti.origin_id)\n  AND ti.incidence_subtype_id    = COALESCE(?, ti.incidence_subtype_id)\n  AND ti.incidence_type_id       = COALESCE(?, ti.incidence_type_id)\n  AND ti.incidence_classification_id = COALESCE(?, ti.incidence_classification_id)\n  AND ti.incidence_state_id      = COALESCE(?, ti.incidence_state_id)\n  AND ti.unit_id                 = COALESCE(?, ti.unit_id)\n  AND ti.document_number         = COALESCE(?, ti.document_number)\n  AND (\n        ? IS NULL\n        OR ( ? = 0 AND ti.complainant = ? )\n        OR ( ? = 1 AND REPLACE(REPLACE(REPLACE(ti.contact_number,'-',''),' ',''),'+','') = ? )\n      )\n  AND ( ? IS NULL OR ti.location = ? OR ti.location_reference = ? )\n  AND ( ? IS NULL OR ti.incidence_date >= ? )\n  AND ( ? IS NULL OR ti.incidence_date <  ? )\nORDER BY ti.incidence_date DESC\nLIMIT ? OFFSET ?;\n",
        "vars": "payload",
        "outField": "topic",
        "x": 2090,
        "y": 160,
        "wires": [
            [
                "7465e3d6e3434036",
                "3fb6c1e706584f7b"
            ]
        ]
    },
    {
        "id": "6381acb3831ebe7b",
        "type": "sqlstring-format",
        "z": "e488fa7b5082d501",
        "name": "",
        "query": "SELECT\n  ti.incidence_id,\n  ti.incidence_date,\n  ti.description_incidence,\n  ti.reason,\n  ti.location,\n  ti.location_reference,\n  ti.complainant,\n  ti.contact_number,\n  o.origin_name,\n  u.unit_name,\n  ic.incidence_classification_name,\n  it.incidence_type_name,\n  ist.incidence_subtype_name,\n  st.incidence_state_name AS state_name,\n  m.mode_name,\n  g.guardpost_name\nFROM a2c.trx_incidence AS ti\nLEFT JOIN a2c.mstr_origin                   AS o   ON o.origin_id = ti.origin_id\nLEFT JOIN a2c.mstr_unit                     AS u   ON u.unit_id = ti.unit_id\nLEFT JOIN a2c.mstr_incidence_classification AS ic  ON ic.incidence_classification_id = ti.incidence_classification_id\nLEFT JOIN a2c.mstr_incidence_type           AS it  ON it.incidence_type_id          = ti.incidence_type_id\nLEFT JOIN a2c.mstr_incidence_subtype        AS ist ON ist.incidence_subtype_id      = ti.incidence_subtype_id\nLEFT JOIN a2c.mstr_incidence_state          AS st  ON st.incidence_state_id         = ti.incidence_state_id\nLEFT JOIN a2c.mstr_mode                     AS m   ON m.mode_id                     = ti.mode_id\nLEFT JOIN a2c.mstr_guardpost                AS g   ON g.guardpost_id                = ti.cuadrante_id\nWHERE\n  ti.origin_id                   = COALESCE(?, ti.origin_id)\n  AND ti.incidence_subtype_id    = COALESCE(?, ti.incidence_subtype_id)\n  AND ti.incidence_type_id       = COALESCE(?, ti.incidence_type_id)\n  AND ti.incidence_classification_id = COALESCE(?, ti.incidence_classification_id)\n  AND ti.incidence_state_id      = COALESCE(?, ti.incidence_state_id)\n  AND ti.unit_id                 = COALESCE(?, ti.unit_id)\n  AND ti.document_number         = COALESCE(?, ti.document_number)\n  AND (\n        ? IS NULL\n        OR ( ? = 0 AND ti.complainant = ? )\n        OR ( ? = 1 AND REPLACE(REPLACE(REPLACE(ti.contact_number,'-',''),' ',''),'+','') = ? )\n      )\n  AND ( ? IS NULL OR ti.location = ? OR ti.location_reference = ? )\n  AND ( ? IS NULL OR ti.incidence_date >= ? )\n  AND ( ? IS NULL OR ti.incidence_date <  ? )\nORDER BY ti.incidence_date DESC\nLIMIT ? OFFSET ?;\n",
        "vars": "",
        "outField": "topic",
        "x": 2310,
        "y": 100,
        "wires": [
            []
        ]
    },
    {
        "id": "4161c49dfa558888",
        "type": "sqlstring-format",
        "z": "e488fa7b5082d501",
        "name": "incidence derivated",
        "query": "INSERT INTO a2c.trx_incidence_derivative\n(incidence_id,\nincidence_derivative_id,\nunit_id_old,\nunit_name_old,\nunit_id,\nunit_name,\nincidence_classification_id_old,\nincidence_classification_name_old,\nincidence_classification_id,\nincidence_classification_name,\nincidence_state_id_old,\nincidence_state_name_old,\nincidence_state_id,\nincidence_state_name,\noperator)\nVALUES\n(:incidence_id,\n:incidence_derivative_id,\n:unit_id_old,\n:unit_name_old,\n:unit_id,\n:unit_name,\n:incidence_classification_id_old,\n:incidence_classification_name_old,\n:incidence_classification_id,\n:incidence_classification_name,\n:incidence_state_id_old,\n:incidence_state_name_old,\n:incidence_state_id,\n:incidence_state_name,\n:operator);",
        "vars": "",
        "outField": "topic",
        "x": 550,
        "y": 1460,
        "wires": [
            [
                "e1efa036ccab2fb5"
            ]
        ]
    },
    {
        "id": "f001b6896ba0bece",
        "type": "group",
        "z": "e488fa7b5082d501",
        "name": "control de errores",
        "style": {
            "label": true,
            "color": "#000000",
            "fill": "#ffefbf"
        },
        "nodes": [
            "0e5509e76587fc8f",
            "e460b1635ea4c18f",
            "7340bd57a32ad168",
            "a6b4eaeb6c1b0641"
        ],
        "x": 214,
        "y": 79,
        "w": 522,
        "h": 142
    },
    {
        "id": "0e5509e76587fc8f",
        "type": "catch",
        "z": "e488fa7b5082d501",
        "g": "f001b6896ba0bece",
        "name": "",
        "scope": null,
        "uncaught": false,
        "x": 310,
        "y": 120,
        "wires": [
            [
                "7340bd57a32ad168",
                "a6b4eaeb6c1b0641"
            ]
        ]
    },
    {
        "id": "e460b1635ea4c18f",
        "type": "link out",
        "z": "e488fa7b5082d501",
        "g": "f001b6896ba0bece",
        "name": "link out 66",
        "mode": "link",
        "links": [
            "173e7e5a5c238c74"
        ],
        "x": 695,
        "y": 120,
        "wires": []
    },
    {
        "id": "7340bd57a32ad168",
        "type": "debug",
        "z": "e488fa7b5082d501",
        "g": "f001b6896ba0bece",
        "name": "debug 31",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 510,
        "y": 180,
        "wires": []
    },
    {
        "id": "a6b4eaeb6c1b0641",
        "type": "function",
        "z": "e488fa7b5082d501",
        "g": "f001b6896ba0bece",
        "name": "format errors",
        "func": "msg.statusCode = 400; // Ã³ el cÃ³digo que necesites   \nnode.warn(Array.isArray(msg.payload))\n\nif(!Array.isArray(msg.payload))\n    if(typeof(msg.error)!=\"undefined\")\n        msg.payload=[msg.error];\n\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 520,
        "y": 120,
        "wires": [
            [
                "e460b1635ea4c18f"
            ]
        ]
    },
    {
        "id": "d631bc76cc734a91",
        "type": "group",
        "z": "e488fa7b5082d501",
        "name": "",
        "style": {
            "stroke": "#7f7f7f",
            "label": true,
            "color": "#000000",
            "fill": "#bfbfbf"
        },
        "nodes": [
            "2d1325c1b1c3b8e8",
            "7242e2aff3fd6dec",
            "f7c29a0761788ce1",
            "39c2d5be9b07b43c",
            "0834838a7691f34b",
            "372ed1411a787784",
            "b4742df92b069893",
            "1912384bbeeae048",
            "71167abaf3e2db9d"
        ],
        "x": 34,
        "y": 299,
        "w": 942,
        "h": 162
    },
    {
        "id": "2d1325c1b1c3b8e8",
        "type": "http in",
        "z": "e488fa7b5082d501",
        "g": "d631bc76cc734a91",
        "name": "",
        "url": "getincidence",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 150,
        "y": 340,
        "wires": [
            [
                "7242e2aff3fd6dec"
            ]
        ]
    },
    {
        "id": "7242e2aff3fd6dec",
        "type": "sqlstring-format",
        "z": "e488fa7b5082d501",
        "g": "d631bc76cc734a91",
        "name": "incidence",
        "query": "SELECT trx_incidence.incidence_id,\n    trx_incidence.origin_id,\n    trx_incidence.complainant,\n    trx_incidence.description_incidence,\n    trx_incidence.unit_id,\n    trx_incidence.mode_id,\n    trx_incidence.incidence_classification_id,\n    trx_incidence.incidence_subtype_id,\n    trx_incidence.incidence_type_id,\n    trx_incidence.cuadrante_id,\n    trx_incidence.operator,\n    trx_incidence.operator_id,\n    trx_incidence.incidence_date,\n    trx_incidence.location,\n    trx_incidence.location_reference,\n    trx_incidence.contact_number,\n    trx_incidence.document_number,\n    trx_incidence.created_at,\n    trx_incidence.created_by,\n    trx_incidence.updated_at,\n    trx_incidence.updated_by,\n    trx_incidence.incidence_state_id,\n    trx_incidence.classification_name,\n    trx_incidence.type_name,\n    trx_incidence.unit_name,\n    trx_incidence.subtype_name,\n    trx_incidence.origin_name,\n    trx_incidence.state_name,\n    trx_incidence.mode_name,\n    trx_incidence.reason,\n    trx_incidence.latitude,\n    trx_incidence.longitude,\n    trx_incidence.camera_civix_id,\n    trx_incidence.camera_civix_name,\n    trx_incidence.epoch_civix,\n    trx_incidence.alert_civix_id\nFROM a2c.trx_incidence\nwhere trx_incidence.incidence_id=:incidence_id;",
        "vars": "",
        "outField": "topic",
        "x": 440,
        "y": 340,
        "wires": [
            [
                "f7c29a0761788ce1"
            ]
        ]
    },
    {
        "id": "f7c29a0761788ce1",
        "type": "subflow:d46893cfffb15d18",
        "z": "e488fa7b5082d501",
        "g": "d631bc76cc734a91",
        "name": "",
        "x": 740,
        "y": 340,
        "wires": [
            [
                "39c2d5be9b07b43c"
            ]
        ]
    },
    {
        "id": "39c2d5be9b07b43c",
        "type": "link out",
        "z": "e488fa7b5082d501",
        "g": "d631bc76cc734a91",
        "name": "link out 67",
        "mode": "link",
        "links": [
            "173e7e5a5c238c74"
        ],
        "x": 935,
        "y": 340,
        "wires": []
    },
    {
        "id": "0834838a7691f34b",
        "type": "link out",
        "z": "e488fa7b5082d501",
        "g": "d631bc76cc734a91",
        "name": "link out 68",
        "mode": "link",
        "links": [
            "173e7e5a5c238c74"
        ],
        "x": 935,
        "y": 420,
        "wires": []
    },
    {
        "id": "372ed1411a787784",
        "type": "subflow:d46893cfffb15d18",
        "z": "e488fa7b5082d501",
        "g": "d631bc76cc734a91",
        "name": "",
        "x": 740,
        "y": 420,
        "wires": [
            [
                "0834838a7691f34b"
            ]
        ]
    },
    {
        "id": "b4742df92b069893",
        "type": "sqlstring-format",
        "z": "e488fa7b5082d501",
        "g": "d631bc76cc734a91",
        "name": "incidences",
        "query": "SELECT trx_incidence.incidence_id,\n    trx_incidence.origin_id,\n    trx_incidence.complainant,\n    trx_incidence.description_incidence,\n    trx_incidence.unit_id,\n    trx_incidence.mode_id,\n    trx_incidence.incidence_classification_id,\n    trx_incidence.incidence_subtype_id,\n    trx_incidence.incidence_type_id,\n    trx_incidence.cuadrante_id,\n    trx_incidence.operator,\n    trx_incidence.operator_id,\n    trx_incidence.incidence_date,\n    trx_incidence.location,\n    trx_incidence.location_reference,\n    trx_incidence.contact_number,\n    trx_incidence.document_number,\n    trx_incidence.created_at,\n    trx_incidence.created_by,\n    trx_incidence.updated_at,\n    trx_incidence.updated_by,\n    trx_incidence.incidence_state_id,\n    trx_incidence.classification_name,\n    trx_incidence.type_name,\n    trx_incidence.unit_name,\n    trx_incidence.subtype_name,\n    trx_incidence.origin_name,\n    trx_incidence.state_name,\n    trx_incidence.mode_name,\n    trx_incidence.reason,\n    trx_incidence.latitude,\n    trx_incidence.longitude,\n    trx_incidence.camera_civix_id,\n    trx_incidence.camera_civix_name,\n    trx_incidence.epoch_civix,\n    trx_incidence.alert_civix_id\nFROM a2c.trx_incidence\nWHERE incidence_date BETWEEN CURRENT_DATE - INTERVAL 30 DAY AND NOW();\n\n\n",
        "vars": "",
        "outField": "topic",
        "x": 450,
        "y": 420,
        "wires": [
            [
                "372ed1411a787784"
            ]
        ]
    },
    {
        "id": "1912384bbeeae048",
        "type": "http in",
        "z": "e488fa7b5082d501",
        "g": "d631bc76cc734a91",
        "name": "",
        "url": "getincidences",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 150,
        "y": 420,
        "wires": [
            [
                "b4742df92b069893"
            ]
        ]
    },
    {
        "id": "71167abaf3e2db9d",
        "type": "link in",
        "z": "e488fa7b5082d501",
        "g": "d631bc76cc734a91",
        "name": "link in 5",
        "links": [
            "5235398bcd262056",
            "34653abafd75592c",
            "e5b608144d6fab06"
        ],
        "x": 315,
        "y": 380,
        "wires": [
            [
                "b4742df92b069893"
            ]
        ]
    },
    {
        "id": "70cf1ad6b95a93c2",
        "type": "group",
        "z": "e488fa7b5082d501",
        "name": "Combos de la incidencia",
        "style": {
            "fill": "#bfbfbf",
            "label": true,
            "color": "#000000"
        },
        "nodes": [
            "0cc151bffd8b2df3",
            "ac4bca37d32b2966",
            "f10877354f5eb81d",
            "513f09971f5c9202",
            "0d827bfeb938a496",
            "7a963c08be63e3b6",
            "75b6b81227190910",
            "adada75b1f50fe22",
            "0eecda02acf648a0",
            "122d869649fe8a25",
            "9137955922db17c0",
            "64be798eee45b8bb",
            "99fe6eaa1c258092",
            "6d50ddd479a7ea41",
            "5922dff477352c98",
            "bd572d258d35bb51",
            "4828a90d643dd185",
            "188893334438c746",
            "bfc3fb3654db6b85",
            "9c92d0b7f4a234cd",
            "20f64a40829a8a25",
            "23ff3674db4da276",
            "c4db80589e4df9c3",
            "ac103a3056a1203e",
            "e993411821e965c5",
            "0e4ca582c27f359e",
            "49778cd89beec40e",
            "ddc85eec51acc719"
        ],
        "x": 34,
        "y": 519,
        "w": 942,
        "h": 542
    },
    {
        "id": "0cc151bffd8b2df3",
        "type": "http in",
        "z": "e488fa7b5082d501",
        "g": "70cf1ad6b95a93c2",
        "name": "",
        "url": "getclassification",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 160,
        "y": 560,
        "wires": [
            [
                "ac4bca37d32b2966"
            ]
        ]
    },
    {
        "id": "ac4bca37d32b2966",
        "type": "sqlstring-format",
        "z": "e488fa7b5082d501",
        "g": "70cf1ad6b95a93c2",
        "name": "classification",
        "query": "SELECT mstr_incidence_classification.incidence_classification_id,\n    mstr_incidence_classification.incidence_classification_name,\n    mstr_incidence_classification.created_at,\n    mstr_incidence_classification.created_by,\n    mstr_incidence_classification.is_active\nFROM a2c.mstr_incidence_classification;\n",
        "vars": "",
        "outField": "topic",
        "x": 450,
        "y": 560,
        "wires": [
            [
                "f10877354f5eb81d"
            ]
        ]
    },
    {
        "id": "f10877354f5eb81d",
        "type": "subflow:d46893cfffb15d18",
        "z": "e488fa7b5082d501",
        "g": "70cf1ad6b95a93c2",
        "name": "",
        "x": 740,
        "y": 560,
        "wires": [
            [
                "513f09971f5c9202"
            ]
        ]
    },
    {
        "id": "513f09971f5c9202",
        "type": "link out",
        "z": "e488fa7b5082d501",
        "g": "70cf1ad6b95a93c2",
        "name": "link out 78",
        "mode": "link",
        "links": [
            "173e7e5a5c238c74"
        ],
        "x": 935,
        "y": 560,
        "wires": []
    },
    {
        "id": "0d827bfeb938a496",
        "type": "http in",
        "z": "e488fa7b5082d501",
        "g": "70cf1ad6b95a93c2",
        "name": "",
        "url": "getorigin",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 130,
        "y": 640,
        "wires": [
            [
                "7a963c08be63e3b6"
            ]
        ]
    },
    {
        "id": "7a963c08be63e3b6",
        "type": "sqlstring-format",
        "z": "e488fa7b5082d501",
        "g": "70cf1ad6b95a93c2",
        "name": "origin",
        "query": "SELECT mstr_origin.origin_id,\n    mstr_origin.origin_name,\n    mstr_origin.created_at,\n    mstr_origin.created_by,\n    mstr_origin.is_active,\n    mstr_origin.origin_type\nFROM a2c.mstr_origin;",
        "vars": "",
        "outField": "topic",
        "x": 430,
        "y": 640,
        "wires": [
            [
                "75b6b81227190910"
            ]
        ]
    },
    {
        "id": "75b6b81227190910",
        "type": "subflow:d46893cfffb15d18",
        "z": "e488fa7b5082d501",
        "g": "70cf1ad6b95a93c2",
        "name": "",
        "x": 740,
        "y": 640,
        "wires": [
            [
                "adada75b1f50fe22"
            ]
        ]
    },
    {
        "id": "adada75b1f50fe22",
        "type": "link out",
        "z": "e488fa7b5082d501",
        "g": "70cf1ad6b95a93c2",
        "name": "link out 79",
        "mode": "link",
        "links": [
            "173e7e5a5c238c74"
        ],
        "x": 935,
        "y": 640,
        "wires": []
    },
    {
        "id": "0eecda02acf648a0",
        "type": "http in",
        "z": "e488fa7b5082d501",
        "g": "70cf1ad6b95a93c2",
        "name": "",
        "url": "gettypeincidence",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 160,
        "y": 720,
        "wires": [
            [
                "122d869649fe8a25"
            ]
        ]
    },
    {
        "id": "122d869649fe8a25",
        "type": "sqlstring-format",
        "z": "e488fa7b5082d501",
        "g": "70cf1ad6b95a93c2",
        "name": "typeincidence",
        "query": "SELECT mstr_incidence_type.incidence_type_id,\n    mstr_incidence_type.incidence_type_name,\n    mstr_incidence_type.created_at,\n    mstr_incidence_type.created_by,\n    mstr_incidence_type.is_active\nFROM a2c.mstr_incidence_type;",
        "vars": "",
        "outField": "topic",
        "x": 460,
        "y": 720,
        "wires": [
            [
                "9137955922db17c0"
            ]
        ]
    },
    {
        "id": "9137955922db17c0",
        "type": "subflow:d46893cfffb15d18",
        "z": "e488fa7b5082d501",
        "g": "70cf1ad6b95a93c2",
        "name": "",
        "x": 740,
        "y": 720,
        "wires": [
            [
                "64be798eee45b8bb"
            ]
        ]
    },
    {
        "id": "64be798eee45b8bb",
        "type": "link out",
        "z": "e488fa7b5082d501",
        "g": "70cf1ad6b95a93c2",
        "name": "link out 80",
        "mode": "link",
        "links": [
            "173e7e5a5c238c74"
        ],
        "x": 935,
        "y": 720,
        "wires": []
    },
    {
        "id": "99fe6eaa1c258092",
        "type": "http in",
        "z": "e488fa7b5082d501",
        "g": "70cf1ad6b95a93c2",
        "name": "",
        "url": "getsubtypeincidence",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 170,
        "y": 800,
        "wires": [
            [
                "6d50ddd479a7ea41"
            ]
        ]
    },
    {
        "id": "6d50ddd479a7ea41",
        "type": "sqlstring-format",
        "z": "e488fa7b5082d501",
        "g": "70cf1ad6b95a93c2",
        "name": "subtypeincidence",
        "query": "SELECT mstr_incidence_subtype.incidence_subtype_id,\n    mstr_incidence_subtype.incidence_subtype_name,\n    mstr_incidence_subtype.create_at,\n    mstr_incidence_subtype.created_by,\n    mstr_incidence_subtype.is_active\nFROM a2c.mstr_incidence_subtype;\n\n\n",
        "vars": "",
        "outField": "topic",
        "x": 470,
        "y": 800,
        "wires": [
            [
                "5922dff477352c98"
            ]
        ]
    },
    {
        "id": "5922dff477352c98",
        "type": "subflow:d46893cfffb15d18",
        "z": "e488fa7b5082d501",
        "g": "70cf1ad6b95a93c2",
        "name": "",
        "x": 740,
        "y": 800,
        "wires": [
            [
                "bd572d258d35bb51"
            ]
        ]
    },
    {
        "id": "bd572d258d35bb51",
        "type": "link out",
        "z": "e488fa7b5082d501",
        "g": "70cf1ad6b95a93c2",
        "name": "link out 81",
        "mode": "link",
        "links": [
            "173e7e5a5c238c74"
        ],
        "x": 935,
        "y": 800,
        "wires": []
    },
    {
        "id": "4828a90d643dd185",
        "type": "http in",
        "z": "e488fa7b5082d501",
        "g": "70cf1ad6b95a93c2",
        "name": "",
        "url": "getunit",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 130,
        "y": 880,
        "wires": [
            [
                "188893334438c746"
            ]
        ]
    },
    {
        "id": "188893334438c746",
        "type": "sqlstring-format",
        "z": "e488fa7b5082d501",
        "g": "70cf1ad6b95a93c2",
        "name": "unit",
        "query": "SELECT mstr_unit.unit_id,\n    mstr_unit.unit_name,\n    mstr_unit.created_at,\n    mstr_unit.created_by,\n    mstr_unit.is_active\nFROM a2c.mstr_unit;",
        "vars": "",
        "outField": "topic",
        "x": 430,
        "y": 880,
        "wires": [
            [
                "bfc3fb3654db6b85"
            ]
        ]
    },
    {
        "id": "bfc3fb3654db6b85",
        "type": "subflow:d46893cfffb15d18",
        "z": "e488fa7b5082d501",
        "g": "70cf1ad6b95a93c2",
        "name": "",
        "x": 740,
        "y": 880,
        "wires": [
            [
                "9c92d0b7f4a234cd"
            ]
        ]
    },
    {
        "id": "9c92d0b7f4a234cd",
        "type": "link out",
        "z": "e488fa7b5082d501",
        "g": "70cf1ad6b95a93c2",
        "name": "link out 82",
        "mode": "link",
        "links": [
            "173e7e5a5c238c74"
        ],
        "x": 935,
        "y": 880,
        "wires": []
    },
    {
        "id": "20f64a40829a8a25",
        "type": "http in",
        "z": "e488fa7b5082d501",
        "g": "70cf1ad6b95a93c2",
        "name": "",
        "url": "getmode",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 130,
        "y": 960,
        "wires": [
            [
                "23ff3674db4da276"
            ]
        ]
    },
    {
        "id": "23ff3674db4da276",
        "type": "sqlstring-format",
        "z": "e488fa7b5082d501",
        "g": "70cf1ad6b95a93c2",
        "name": "mode",
        "query": "SELECT mstr_mode.mode_id,\n    mstr_mode.mode_name,\n    mstr_mode.created_at,\n    mstr_mode.created_by,\n    mstr_mode.is_active\nFROM a2c.mstr_mode;\n",
        "vars": "",
        "outField": "topic",
        "x": 430,
        "y": 960,
        "wires": [
            [
                "c4db80589e4df9c3"
            ]
        ]
    },
    {
        "id": "c4db80589e4df9c3",
        "type": "subflow:d46893cfffb15d18",
        "z": "e488fa7b5082d501",
        "g": "70cf1ad6b95a93c2",
        "name": "",
        "x": 740,
        "y": 960,
        "wires": [
            [
                "ac103a3056a1203e"
            ]
        ]
    },
    {
        "id": "ac103a3056a1203e",
        "type": "link out",
        "z": "e488fa7b5082d501",
        "g": "70cf1ad6b95a93c2",
        "name": "link out 83",
        "mode": "link",
        "links": [
            "173e7e5a5c238c74"
        ],
        "x": 935,
        "y": 960,
        "wires": []
    },
    {
        "id": "e993411821e965c5",
        "type": "http in",
        "z": "e488fa7b5082d501",
        "g": "70cf1ad6b95a93c2",
        "name": "",
        "url": "getincidencestate",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 160,
        "y": 1020,
        "wires": [
            [
                "0e4ca582c27f359e"
            ]
        ]
    },
    {
        "id": "0e4ca582c27f359e",
        "type": "sqlstring-format",
        "z": "e488fa7b5082d501",
        "g": "70cf1ad6b95a93c2",
        "name": "state",
        "query": "SELECT mstr_incidence_state.incidence_state_id,\n    mstr_incidence_state.incidence_state_name,\n    mstr_incidence_state.create_at,\n    mstr_incidence_state.created_by,\n    mstr_incidence_state.is_active\nFROM a2c.mstr_incidence_state;\n\n",
        "vars": "",
        "outField": "topic",
        "x": 430,
        "y": 1020,
        "wires": [
            [
                "49778cd89beec40e"
            ]
        ]
    },
    {
        "id": "49778cd89beec40e",
        "type": "subflow:d46893cfffb15d18",
        "z": "e488fa7b5082d501",
        "g": "70cf1ad6b95a93c2",
        "name": "",
        "x": 740,
        "y": 1020,
        "wires": [
            [
                "ddc85eec51acc719"
            ]
        ]
    },
    {
        "id": "ddc85eec51acc719",
        "type": "link out",
        "z": "e488fa7b5082d501",
        "g": "70cf1ad6b95a93c2",
        "name": "link out 85",
        "mode": "link",
        "links": [
            "173e7e5a5c238c74"
        ],
        "x": 935,
        "y": 1020,
        "wires": []
    },
    {
        "id": "97cbc6de869127d0",
        "type": "group",
        "z": "e488fa7b5082d501",
        "name": "Seguridad ciudadana",
        "style": {
            "fill": "#bfc7d7",
            "label": true,
            "color": "#000000"
        },
        "nodes": [
            "6f4ef45772326eba",
            "05ee27d1a7a5ee30",
            "5f2c82e3fefa917e",
            "162bb9a837ccb2ec",
            "2b49f440d8b1815e",
            "accc84388880fe4d",
            "2ddf449a2847ba7c",
            "427250594915ece0",
            "f03b95f9e5e71d78",
            "40dd24f85501819b",
            "a6efb13f3b592f03",
            "8d4f006e9141e240"
        ],
        "x": 34,
        "y": 1099,
        "w": 942,
        "h": 222
    },
    {
        "id": "6f4ef45772326eba",
        "type": "http in",
        "z": "e488fa7b5082d501",
        "g": "97cbc6de869127d0",
        "name": "",
        "url": "getagent",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 130,
        "y": 1220,
        "wires": [
            [
                "05ee27d1a7a5ee30"
            ]
        ]
    },
    {
        "id": "05ee27d1a7a5ee30",
        "type": "sqlstring-format",
        "z": "e488fa7b5082d501",
        "g": "97cbc6de869127d0",
        "name": "agent",
        "query": "SELECT mstr_agent.agent_id,\n    mstr_agent.document_number,\n    mstr_agent.agent_name,\n    mstr_agent.agent_last_name,\n    mstr_agent.fk_document_type_id,\n    mstr_agent.created_at,\n    mstr_agent.created_by,\n    mstr_agent.latitude,\n    mstr_agent.longitude,\n    mstr_agent.unit_id,\n    mstr_agent.is_active,\n    mstr_agent.is_assigned,\n    mstr_agent.phone_number,\n    mstr_unit.unit_name\nFROM a2c.mstr_agent\ninner join a2c.mstr_unit on mstr_agent.unit_id=mstr_unit.unit_id\n;\n\n\n",
        "vars": "",
        "outField": "topic",
        "x": 430,
        "y": 1220,
        "wires": [
            [
                "5f2c82e3fefa917e"
            ]
        ]
    },
    {
        "id": "5f2c82e3fefa917e",
        "type": "subflow:d46893cfffb15d18",
        "z": "e488fa7b5082d501",
        "g": "97cbc6de869127d0",
        "name": "",
        "x": 740,
        "y": 1220,
        "wires": [
            [
                "162bb9a837ccb2ec"
            ]
        ]
    },
    {
        "id": "162bb9a837ccb2ec",
        "type": "link out",
        "z": "e488fa7b5082d501",
        "g": "97cbc6de869127d0",
        "name": "link out 84",
        "mode": "link",
        "links": [
            "173e7e5a5c238c74"
        ],
        "x": 935,
        "y": 1220,
        "wires": []
    },
    {
        "id": "2b49f440d8b1815e",
        "type": "http in",
        "z": "e488fa7b5082d501",
        "g": "97cbc6de869127d0",
        "name": "",
        "url": "getguardpost",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 150,
        "y": 1140,
        "wires": [
            [
                "accc84388880fe4d"
            ]
        ]
    },
    {
        "id": "accc84388880fe4d",
        "type": "sqlstring-format",
        "z": "e488fa7b5082d501",
        "g": "97cbc6de869127d0",
        "name": "guardpost",
        "query": "    mstr_guardpost.created_by,\n    mstr_guardpost.is_active\nFROM a2c.mstr_guardpost;",
        "vars": "",
        "outField": "topic",
        "x": 440,
        "y": 1140,
        "wires": [
            [
                "2ddf449a2847ba7c"
            ]
        ]
    },
    {
        "id": "2ddf449a2847ba7c",
        "type": "subflow:d46893cfffb15d18",
        "z": "e488fa7b5082d501",
        "g": "97cbc6de869127d0",
        "name": "",
        "x": 740,
        "y": 1140,
        "wires": [
            [
                "427250594915ece0"
            ]
        ]
    },
    {
        "id": "427250594915ece0",
        "type": "link out",
        "z": "e488fa7b5082d501",
        "g": "97cbc6de869127d0",
        "name": "link out 86",
        "mode": "link",
        "links": [
            "173e7e5a5c238c74"
        ],
        "x": 935,
        "y": 1140,
        "wires": []
    },
    {
        "id": "f03b95f9e5e71d78",
        "type": "http in",
        "z": "e488fa7b5082d501",
        "g": "97cbc6de869127d0",
        "name": "",
        "url": "getincidenceagent",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 160,
        "y": 1280,
        "wires": [
            [
                "40dd24f85501819b"
            ]
        ]
    },
    {
        "id": "40dd24f85501819b",
        "type": "sqlstring-format",
        "z": "e488fa7b5082d501",
        "g": "97cbc6de869127d0",
        "name": "incidence agent",
        "query": "SELECT mstr_agent.agent_id,\n    mstr_agent.document_number,\n    mstr_agent.agent_name,\n    mstr_agent.agent_last_name,\n    mstr_agent.fk_document_type_id,\n    mstr_agent.created_at,\n    mstr_agent.created_by,\n    mstr_agent.latitude,\n    mstr_agent.longitude,\n    mstr_agent.unit_id,\n    mstr_agent.is_active,\n    mstr_agent.is_assigned,\n    mstr_agent.phone_number,\n    mstr_unit.unit_name\nFROM a2c.mstr_agent\ninner join a2c.mstr_unit on mstr_agent.unit_id=mstr_unit.unit_id\ninner join a2c.trx_incidence_agent on trx_incidence_agent.agent_id=mstr_agent.agent_id\nwhere trx_incidence_agent.incidence_id=:incidence_id\n;",
        "vars": "",
        "outField": "topic",
        "x": 460,
        "y": 1280,
        "wires": [
            [
                "a6efb13f3b592f03"
            ]
        ]
    },
    {
        "id": "a6efb13f3b592f03",
        "type": "subflow:d46893cfffb15d18",
        "z": "e488fa7b5082d501",
        "g": "97cbc6de869127d0",
        "name": "",
        "x": 740,
        "y": 1280,
        "wires": [
            [
                "8d4f006e9141e240"
            ]
        ]
    },
    {
        "id": "8d4f006e9141e240",
        "type": "link out",
        "z": "e488fa7b5082d501",
        "g": "97cbc6de869127d0",
        "name": "link out 90",
        "mode": "link",
        "links": [
            "173e7e5a5c238c74"
        ],
        "x": 915,
        "y": 1240,
        "wires": []
    },
    {
        "id": "7bc7227afd64003e",
        "type": "group",
        "z": "e488fa7b5082d501",
        "name": "inciddencia registro",
        "style": {
            "label": true,
            "stroke": "#7f7f7f",
            "color": "#000000",
            "fill": "#7fb7df"
        },
        "nodes": [
            "6486be491a690894",
            "144930355dbdf6b2",
            "d579a4a881887716",
            "2e50f2978826644c",
            "5235398bcd262056",
            "a7f4edd1933d7f87",
            "26f9b06cfbe52f56",
            "76ebd72e006143a1",
            "b51269d5a2c0e90d"
        ],
        "x": 34,
        "y": 1359,
        "w": 942,
        "h": 202,
        "info": "Este contenedor agrupa los nodos para la creaciÃ³n de una cÃ¡mara y levantar su contenedor."
    },
    {
        "id": "6486be491a690894",
        "type": "http in",
        "z": "e488fa7b5082d501",
        "g": "7bc7227afd64003e",
        "name": "",
        "url": "incidencenew",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 150,
        "y": 1400,
        "wires": [
            [
                "144930355dbdf6b2"
            ]
        ]
    },
    {
        "id": "144930355dbdf6b2",
        "type": "function",
        "z": "e488fa7b5082d501",
        "g": "7bc7227afd64003e",
        "name": "validate",
        "func": "let v=global.get(\"val\");\nlet err=[];\n\nconst errors = [];\n\n// Validar varios campos\nv('origin_id', msg.payload, errors, ['required']);\nv('complainant', msg.payload, errors, ['required']);\nv('location', msg.payload, errors, ['required']);\nv('unit_id', msg.payload, errors, ['required']);\nv('incidence_classification_id', msg.payload, errors, ['required']);\n//v('latitud', msg.payload, errors, ['required']);\n//v('longitud', msg.payload, errors, ['required']);\nv('incidence_subtype_id', msg.payload, errors, ['required']);\nv('incidence_type_id', msg.payload, errors, ['required']);\nv('incidence_date', msg.payload, errors, ['required']);\nv('latitude', msg.payload, errors, ['required']);\nv('longitude', msg.payload, errors, ['required']);\nv('incidence_state_id', msg.payload, errors, ['required']);\n//v('detener', msg.payload, errors, ['required']);\n\n\n//v('mode_id', msg.payload, errors, ['required']);\n//v('cuadrante_id', msg.payload, errors, ['required']);\n//v('operator', msg.payload, errors, ['required']);\n//v('document_number', msg.payload, errors, ['required']);\n//v('contact_number', msg.payload, errors, ['required']);\n//v('operator', msg.payload, errors, ['required']);\n\n\nmsg.originalData = msg.payload;  // Preserve original data in a new property\n\nif (errors.length){\n    msg.payload=errors;    \n    throw new Error(\"\");\n}\n\n\n//msg.payload.id=Date.now();\n//msg.filename=\"/data/uploads/\"+msg.payload.id+\".jpeg\";\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 360,
        "y": 1400,
        "wires": [
            [
                "2e50f2978826644c"
            ]
        ]
    },
    {
        "id": "d579a4a881887716",
        "type": "subflow:d46893cfffb15d18",
        "z": "e488fa7b5082d501",
        "g": "7bc7227afd64003e",
        "name": "",
        "x": 760,
        "y": 1400,
        "wires": [
            [
                "5235398bcd262056"
            ]
        ]
    },
    {
        "id": "2e50f2978826644c",
        "type": "sqlstring-format",
        "z": "e488fa7b5082d501",
        "g": "7bc7227afd64003e",
        "name": "incidence new",
        "query": "INSERT INTO a2c.trx_incidence\n(\norigin_id,\ncomplainant,\ndescription_incidence,\nunit_id,\nmode_id,\nincidence_classification_id,\nincidence_subtype_id,\nincidence_type_id,\ncuadrante_id,\noperator,\noperator_id,\nincidence_date,\nlocation,\nlocation_reference,\ncontact_number,\ndocument_number,\nincidence_state_id,\nclassification_name,\ntype_name,\nunit_name,\nsubtype_name,\norigin_name,\nstate_name,\nmode_name,\n-- reason,\nlatitude,\nlongitude,\ncamera_civix_id,\ncamera_civix_name,\nepoch_civix,\nalert_civix_id)\nVALUES\n(\n:origin_id,\n:complainant,\n:description_incidence,\n:unit_id,\n:mode_id,\n:incidence_classification_id,\n:incidence_subtype_id,\n:incidence_type_id,\n:cuadrante_id,\n:operator,\n:operator_id,\n:incidence_date,\n:location,\n:location_reference,\n:contact_number,\n:document_number,\n:incidence_state_id,\n:classification_name,\n:type_name,\n:unit_name,\n:subtype_name,\n:origin_name,\n:state_name,\n:mode_name,\n-- :reason,\n:latitude,\n:longitude,\n:camera_civix_id,\n:camera_civix_name,\n:epoch_civix,\n:alert_civix_id);\n\n",
        "vars": "",
        "outField": "topic",
        "x": 540,
        "y": 1400,
        "wires": [
            [
                "d579a4a881887716"
            ]
        ]
    },
    {
        "id": "5235398bcd262056",
        "type": "link out",
        "z": "e488fa7b5082d501",
        "g": "7bc7227afd64003e",
        "name": "link out 88",
        "mode": "link",
        "links": [
            "71167abaf3e2db9d"
        ],
        "x": 935,
        "y": 1460,
        "wires": []
    },
    {
        "id": "a7f4edd1933d7f87",
        "type": "function",
        "z": "e488fa7b5082d501",
        "g": "7bc7227afd64003e",
        "name": "validate",
        "func": "let v=global.get(\"val\");\nlet err=[];\n\nconst errors = [];\n\n// Validar varios campos\n\n\nv('unit_id', msg.payload, errors, ['required']);\nv('incidence_classification_id', msg.payload, errors, ['required']);\n//v('latitud', msg.payload, errors, ['required']);\n//v('longitud', msg.payload, errors, ['required']);\nv('incidence_state_id', msg.payload, errors, ['required']);\n//v('detener', msg.payload, errors, ['required']);\n\n\n//v('mode_id', msg.payload, errors, ['required']);\n//v('cuadrante_id', msg.payload, errors, ['required']);\n//v('operator', msg.payload, errors, ['required']);\n//v('document_number', msg.payload, errors, ['required']);\n//v('contact_number', msg.payload, errors, ['required']);\n//v('operator', msg.payload, errors, ['required']);\n\n\nmsg.originalData = msg.payload;  // Preserve original data in a new property\n\nif (errors.length){\n    msg.payload=errors;    \n    throw new Error(\"\");\n}\n\n\n//msg.payload.id=Date.now();\n//msg.filename=\"/data/uploads/\"+msg.payload.id+\".jpeg\";\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 360,
        "y": 1520,
        "wires": [
            [
                "76ebd72e006143a1"
            ]
        ]
    },
    {
        "id": "26f9b06cfbe52f56",
        "type": "http in",
        "z": "e488fa7b5082d501",
        "g": "7bc7227afd64003e",
        "name": "",
        "url": "incidenceupt",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 150,
        "y": 1520,
        "wires": [
            [
                "a7f4edd1933d7f87"
            ]
        ]
    },
    {
        "id": "76ebd72e006143a1",
        "type": "sqlstring-format",
        "z": "e488fa7b5082d501",
        "g": "7bc7227afd64003e",
        "name": "incidence update",
        "query": "UPDATE a2c.trx_incidence\nSET\ndescription_incidence = :description_incidence,\nunit_id = :unit_id,\nclassification_name = :classification_name,\nincidence_classification_id = :incidence_classification_id,\ncontact_number = :contact_number,\ndocument_number = :document_number,\nincidence_state_id = :incidence_state_id,\n\nunit_name = :unit_name,\nstate_name = :state_name\nWHERE incidence_id = :incidence_id;",
        "vars": "",
        "outField": "topic",
        "x": 550,
        "y": 1520,
        "wires": [
            [
                "b51269d5a2c0e90d"
            ]
        ]
    },
    {
        "id": "b51269d5a2c0e90d",
        "type": "subflow:d46893cfffb15d18",
        "z": "e488fa7b5082d501",
        "g": "7bc7227afd64003e",
        "name": "",
        "x": 760,
        "y": 1520,
        "wires": [
            [
                "5235398bcd262056"
            ]
        ]
    },
    {
        "id": "b76989076c5a9657",
        "type": "group",
        "z": "e488fa7b5082d501",
        "style": {
            "stroke": "#999999",
            "stroke-opacity": "1",
            "fill": "none",
            "fill-opacity": "1",
            "label": true,
            "label-position": "nw",
            "color": "#a4a4a4"
        },
        "nodes": [
            "47f76a3da4ed87e5",
            "3386f6cd3c45ad21",
            "92ca07924cc7c2e4",
            "c67cf918a17de748",
            "5a4f279a1cce606a",
            "cb2904b1e5bf522d"
        ],
        "x": 1174,
        "y": 279,
        "w": 952,
        "h": 182
    },
    {
        "id": "47f76a3da4ed87e5",
        "type": "http in",
        "z": "e488fa7b5082d501",
        "g": "b76989076c5a9657",
        "name": "",
        "url": "getincidencesfilter",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 1300,
        "y": 380,
        "wires": [
            [
                "5a4f279a1cce606a"
            ]
        ]
    },
    {
        "id": "3386f6cd3c45ad21",
        "type": "mysql",
        "z": "e488fa7b5082d501",
        "g": "b76989076c5a9657",
        "mydb": "mysql-config",
        "name": "",
        "x": 1830,
        "y": 380,
        "wires": [
            [
                "92ca07924cc7c2e4",
                "c67cf918a17de748"
            ]
        ]
    },
    {
        "id": "92ca07924cc7c2e4",
        "type": "debug",
        "z": "e488fa7b5082d501",
        "g": "b76989076c5a9657",
        "name": "debug 68",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 2020,
        "y": 420,
        "wires": []
    },
    {
        "id": "c67cf918a17de748",
        "type": "link out",
        "z": "e488fa7b5082d501",
        "g": "b76989076c5a9657",
        "name": "link out 89",
        "mode": "link",
        "links": [
            "173e7e5a5c238c74"
        ],
        "x": 2075,
        "y": 380,
        "wires": []
    },
    {
        "id": "5a4f279a1cce606a",
        "type": "function",
        "z": "e488fa7b5082d501",
        "g": "b76989076c5a9657",
        "name": "function 3",
        "func": "const q = (msg.req && msg.req.method === 'GET') ? (msg.req.query || {}) : (msg.payload || {});\n\n// Helpers\nconst normCombo = v => {\n  const s = (v ?? '').toString().trim();\n  if (s === '' || s === '0') return null;\n  const n = Number(s);\n  return Number.isFinite(n) ? n : null;\n};\nconst normStr = v => {\n  const s = (v ?? '').toString().trim();\n  return s === '' ? null : s;\n};\nconst toInt = (v, dflt, minv) => {\n  const n = parseInt(v, 10);\n  if (!Number.isFinite(n) || n < minv) return dflt;\n  return n;\n};\n\n// complainant: nombre exacto o celular (>=6 dÃ­gitos)\nconst rawComp = normStr(q.complainant);\nconst compDigits = rawComp ? rawComp.replace(/[^\\d]/g, '') : null;\nconst compIsNum = compDigits && compDigits.length >= 6 ? 1 : 0;\n\n// fecha: â€œYYYY-MM-DDâ€ o â€œYYYY-MM-DD - YYYY-MM-DDâ€\nlet date_from = null, date_to = null;\nconst rawDate = normStr(q.incidence_date);\nif (rawDate) {\n  const parts = rawDate.split(/\\s*-\\s*/);\n  if (parts.length === 2 && parts[0] && parts[1]) {\n    date_from = parts[0] + ' 00:00:00';\n    const d = new Date(parts[1] + 'T00:00:00'); d.setDate(d.getDate() + 1);\n    date_to = d.toISOString().slice(0, 19).replace('T', ' ');\n  } else {\n    date_from = rawDate + ' 00:00:00';\n    const d = new Date(rawDate + 'T00:00:00'); d.setDate(d.getDate() + 1);\n    date_to = d.toISOString().slice(0, 19).replace('T', ' ');\n  }\n}\n\n// LIMIT/OFFSET seguros\nconst limitVal = toInt(q.limit, 100, 1);\nconst offsetVal = toInt(q.offset, 0, 0);\n\n// SQL: TODO de trx_incidence (ti.*) + extras opcionales\nmsg.topic = `\nSELECT\n  ti.*,\n  g.guardpost_name                                     AS guardpost_name,   -- extra (opcional)\n  d.doc_count, d.first_doc_path, d.ext_list            -- extras de documentos (opcionales)\nFROM a2c.trx_incidence AS ti\nLEFT JOIN a2c.mstr_guardpost AS g\n       ON g.guardpost_id = ti.cuadrante_id\nLEFT JOIN (\n  SELECT\n    tid.incidence_id,\n    COUNT(CASE WHEN tid.is_active = 1 THEN tid.incidence_document_id END) AS doc_count,\n    MIN(CASE WHEN tid.is_active = 1 THEN tid.ruta END) AS first_doc_path,\n    GROUP_CONCAT(DISTINCT CASE WHEN tid.is_active = 1 THEN tid.extension_document END ORDER BY tid.extension_document) AS ext_list\n  FROM a2c.trx_incidence_document AS tid\n  GROUP BY tid.incidence_id\n) AS d ON d.incidence_id = ti.incidence_id\nWHERE\n  ti.origin_id                   = COALESCE(?, ti.origin_id)\n  AND ti.incidence_subtype_id    = COALESCE(?, ti.incidence_subtype_id)\n  AND ti.incidence_type_id       = COALESCE(?, ti.incidence_type_id)\n  AND ti.incidence_classification_id = COALESCE(?, ti.incidence_classification_id)\n  AND ti.incidence_state_id      = COALESCE(?, ti.incidence_state_id)\n  AND ti.unit_id                 = COALESCE(?, ti.unit_id)\n  AND ti.document_number         = COALESCE(?, ti.document_number)\n  AND (\n        ? IS NULL\n        OR ( ? = 0 AND ti.complainant = ? )\n        OR ( ? = 1 AND REPLACE(REPLACE(REPLACE(ti.contact_number,'-',''),' ',''),'+','') =\n             REPLACE(REPLACE(REPLACE(?, '-',''),' ',''),'+','') )\n      )\n  AND ( ? IS NULL OR ti.location = ? OR ti.location_reference = ? )\n  AND ( ? IS NULL OR ti.reason   = ? OR ti.description_incidence = ? )\n  AND ( ? IS NULL OR ti.incidence_date >= ? )\n  AND ( ? IS NULL OR ti.incidence_date  <  ? )\nORDER BY ti.incidence_date DESC\nLIMIT ? OFFSET ?;\n`;\n\n// Params exactamente en el orden de los ?\nconst params = [\n  // IDs/catÃ¡logos\n  normCombo(q.origin_id),\n  normCombo(q.incidence_subtype_id),\n  normCombo(q.incidence_type_id),\n  normCombo(q.incidence_classification_id),\n  normCombo(q.incidence_state_id),\n  normCombo(q.unit_id),\n  normStr(q.document_number),\n\n  // complainant / phone\n  rawComp ? rawComp : null,     // ? IS NULL\n  compIsNum,                    // ? = 0/1\n  compIsNum ? null : rawComp,   // nombre exacto cuando 0\n  compIsNum,                    // =1 para rama telÃ©fono\n  compIsNum ? compDigits : null,// dÃ­gitos cuando 1\n\n  // location / location_reference\n  normStr(q.location), normStr(q.location), normStr(q.location),\n\n  // reason / description_incidence\n  normStr(q.reason), normStr(q.reason), normStr(q.reason),\n\n  // fechas [desde, hasta)\n  date_from, date_from,\n  date_to, date_to,\n\n  // paginaciÃ³n\n  limitVal, offsetVal\n];\n\nmsg.params = params;\nmsg.payload = params; // por compatibilidad\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1580,
        "y": 380,
        "wires": [
            [
                "3386f6cd3c45ad21"
            ]
        ]
    },
    {
        "id": "cb2904b1e5bf522d",
        "type": "inject",
        "z": "e488fa7b5082d501",
        "g": "b76989076c5a9657",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 1320,
        "y": 320,
        "wires": [
            [
                "5a4f279a1cce606a"
            ]
        ]
    },
    {
        "id": "mysql-config",
        "type": "MySQLdatabase",
        "name": "MySQL dev",
        "host": "10.23.62.102",
        "port": "3306",
        "db": "a2c",
        "tz": "",
        "charset": "UTF8"
    },
    {
        "id": "f0e0bd33a71deae3",
        "type": "group",
        "z": "e488fa7b5082d501",
        "name": "inciddencia agentes registro",
        "style": {
            "label": true,
            "stroke": "#7f7f7f",
            "color": "#000000",
            "fill": "#7fb7df"
        },
        "nodes": [
            "134d8f73f2f42edb",
            "fdddb9d9998a57e4",
            "ea1c5ca048ea74cd",
            "afe1a0e64375b32b",
            "34653abafd75592c"
        ],
        "x": 34,
        "y": 1599,
        "w": 942,
        "h": 142,
        "info": "Este contenedor agrupa los nodos para la creaciÃ³n de una cÃ¡mara y levantar su contenedor."
    },
    {
        "id": "134d8f73f2f42edb",
        "type": "http in",
        "z": "e488fa7b5082d501",
        "g": "f0e0bd33a71deae3",
        "name": "",
        "url": "incidenceagents",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 160,
        "y": 1680,
        "wires": [
            [
                "ea1c5ca048ea74cd"
            ]
        ]
    },
    {
        "id": "fdddb9d9998a57e4",
        "type": "subflow:d46893cfffb15d18",
        "z": "e488fa7b5082d501",
        "g": "f0e0bd33a71deae3",
        "name": "",
        "x": 680,
        "y": 1680,
        "wires": [
            [
                "34653abafd75592c",
                "afe1a0e64375b32b"
            ]
        ]
    },
    {
        "id": "ea1c5ca048ea74cd",
        "type": "sqlstring-format",
        "z": "e488fa7b5082d501",
        "g": "f0e0bd33a71deae3",
        "name": "incidence agents",
        "query": "INSERT INTO a2c.trx_incidence_agent\n(agent_id,\nincidence_id)\nVALUES\n(:agent_id,\n:incidence_id);\n\nUPDATE a2c.mstr_agent\n    set is_assigned=1\nWHERE mstr_agent.agent_id=:agent_id\n",
        "vars": "",
        "outField": "topic",
        "x": 430,
        "y": 1680,
        "wires": [
            [
                "fdddb9d9998a57e4"
            ]
        ]
    },
    {
        "id": "afe1a0e64375b32b",
        "type": "debug",
        "z": "e488fa7b5082d501",
        "g": "f0e0bd33a71deae3",
        "name": "debug 72",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 860,
        "y": 1640,
        "wires": []
    },
    {
        "id": "34653abafd75592c",
        "type": "link out",
        "z": "e488fa7b5082d501",
        "g": "f0e0bd33a71deae3",
        "name": "link out 87",
        "mode": "link",
        "links": [
            "71167abaf3e2db9d"
        ],
        "x": 935,
        "y": 1700,
        "wires": []
    },
    {
        "id": "2889cef301985b75",
        "type": "group",
        "z": "e488fa7b5082d501",
        "name": "inciddencia agentes libera",
        "style": {
            "label": true,
            "stroke": "#7f7f7f",
            "color": "#000000",
            "fill": "#7fb7df"
        },
        "nodes": [
            "8dd839c488f9991f",
            "40cc6958977c4db6",
            "babbfd6f1d12046a",
            "3fe7a4cd56a5f8d4",
            "e5b608144d6fab06"
        ],
        "x": 34,
        "y": 1779,
        "w": 942,
        "h": 142,
        "info": "Este contenedor agrupa los nodos para la creaciÃ³n de una cÃ¡mara y levantar su contenedor."
    },
    {
        "id": "8dd839c488f9991f",
        "type": "http in",
        "z": "e488fa7b5082d501",
        "g": "2889cef301985b75",
        "name": "",
        "url": "incidenceagentsupt",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 170,
        "y": 1860,
        "wires": [
            [
                "babbfd6f1d12046a"
            ]
        ]
    },
    {
        "id": "40cc6958977c4db6",
        "type": "subflow:d46893cfffb15d18",
        "z": "e488fa7b5082d501",
        "g": "2889cef301985b75",
        "name": "",
        "x": 680,
        "y": 1860,
        "wires": [
            [
                "e5b608144d6fab06",
                "3fe7a4cd56a5f8d4"
            ]
        ]
    },
    {
        "id": "babbfd6f1d12046a",
        "type": "sqlstring-format",
        "z": "e488fa7b5082d501",
        "g": "2889cef301985b75",
        "name": "incidence agents free",
        "query": "UPDATE a2c.mstr_agent\n    set is_assigned=0\nWHERE mstr_agent.agent_id=:agent_id",
        "vars": "",
        "outField": "topic",
        "x": 440,
        "y": 1860,
        "wires": [
            [
                "40cc6958977c4db6"
            ]
        ]
    },
    {
        "id": "3fe7a4cd56a5f8d4",
        "type": "debug",
        "z": "e488fa7b5082d501",
        "g": "2889cef301985b75",
        "name": "debug 73",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 860,
        "y": 1820,
        "wires": []
    },
    {
        "id": "e5b608144d6fab06",
        "type": "link out",
        "z": "e488fa7b5082d501",
        "g": "2889cef301985b75",
        "name": "link out 91",
        "mode": "link",
        "links": [
            "71167abaf3e2db9d"
        ],
        "x": 935,
        "y": 1880,
        "wires": []
    },
    {
        "id": "821a0e1419cbc656",
        "type": "group",
        "z": "e488fa7b5082d501",
        "name": "",
        "style": {
            "stroke": "#7f7f7f",
            "label": true,
            "color": "#000000",
            "fill": "#bfbfbf"
        },
        "nodes": [
            "e62e39465473fbf3",
            "d101e1c833ee5d99",
            "0594de558daea52f",
            "2552475fd2d46884"
        ],
        "x": 34,
        "y": 1959,
        "w": 942,
        "h": 82
    },
    {
        "id": "e62e39465473fbf3",
        "type": "http in",
        "z": "e488fa7b5082d501",
        "g": "821a0e1419cbc656",
        "name": "",
        "url": "getderivatedcount",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 160,
        "y": 2000,
        "wires": [
            [
                "d101e1c833ee5d99"
            ]
        ]
    },
    {
        "id": "d101e1c833ee5d99",
        "type": "sqlstring-format",
        "z": "e488fa7b5082d501",
        "g": "821a0e1419cbc656",
        "name": "derivative",
        "query": "SELECT COUNT(incidence_id)+1 as numero\nFROM a2c.trx_incidence_derivative\nWHERE incidence_id=:incidence_id;",
        "vars": "",
        "outField": "topic",
        "x": 440,
        "y": 2000,
        "wires": [
            [
                "0594de558daea52f"
            ]
        ]
    },
    {
        "id": "0594de558daea52f",
        "type": "subflow:d46893cfffb15d18",
        "z": "e488fa7b5082d501",
        "g": "821a0e1419cbc656",
        "name": "",
        "x": 740,
        "y": 2000,
        "wires": [
            [
                "2552475fd2d46884"
            ]
        ]
    },
    {
        "id": "2552475fd2d46884",
        "type": "link out",
        "z": "e488fa7b5082d501",
        "g": "821a0e1419cbc656",
        "name": "link out 92",
        "mode": "link",
        "links": [
            "173e7e5a5c238c74"
        ],
        "x": 935,
        "y": 2000,
        "wires": []
    },
    {
        "id": "60a11ac065e8bd8e",
        "type": "global-config",
        "env": [],
        "modules": {
            "node-red-node-mysql": "2.0.0",
            "node-red-contrib-sqlstring": "0.1.1"
        }
    }
]