<!-- ============================================ -->
<!-- MODAL: SELECTOR INTELIGENTE DE INCIDENCIA -->
<!-- ============================================ -->

<!-- Modal HTML -->
<div class="modal fade" id="incidenceTypeModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-xl" role="document" style="max-width: 95%; width: 1400px;">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="pe-7s-search" aria-hidden="true"></i> Seleccionar Tipo de Incidencia
        </h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" style="padding: 20px;">

        <!-- Filtro de b√∫squeda -->
        <div class="panel panel-filled panel-c-accent">
          <div class="panel-heading">
            Seleccionar Tipo de Incidencia
          </div>
          <div class="panel-body">
            <div class="col-lg-6 col-md-6 col-sm-6">
              <div class="form-group">
                <input id="txtSearchIncidence"
                       type="text"
                       class="form-control"
                       placeholder="Buscar incidencia...">
              </div>
            </div>
          </div>
        </div>

        <!-- Tabla de Incidencias -->
        <div class="col-md-12">
          <div class="table-responsive">
            <table class="table table-hover-1">
              <thead style="border-radius:20px; overflow:hidden;">
                <tr>
                  <th>Subtipo</th>
                  <th>Tipo</th>
                  <th>Clasificaci√≥n</th>
                  <th>Unidad</th>
                </tr>
              </thead>
              <tbody id="incidenceTableBody">
                <!-- Se llenar√° din√°micamente -->
              </tbody>
            </table>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- Script del selector -->
<script>
  // Variables globales
  var allIncidenceTypes = [];
  var allIncidenceTypesData = []; // Guardar los datos originales sin filtro
  var hierarchyBuilt = false; // Flag para saber si ya se construy√≥ la jerarqu√≠a
  var currentSelection = {
    unit_id: null,
    classification_id: null,
    type_id: null,
    subtype_id: null
  };

  // Funci√≥n para cargar y combinar todos los datos
  function loadIncidenceHierarchy() {
    // ‚úÖ Si ya se construy√≥ la jerarqu√≠a, usar la cach√©
    if (hierarchyBuilt && allIncidenceTypes.length > 0) {
      console.log('‚ö° Usando jerarqu√≠a en cach√© (' + allIncidenceTypes.length + ' opciones)');
      renderIncidenceTable(allIncidenceTypesData);
      return;
    }

    console.log('üì¶ Construyendo jerarqu√≠a de incidencias por primera vez...');
    console.log('üîç Verificando datos maestros disponibles:');
    console.log('  - masterDataUnits:', window.masterDataUnits ? 'SI (' + window.masterDataUnits.length + ')' : 'NO');
    console.log('  - masterDataClassifications:', window.masterDataClassifications ? 'SI (' + window.masterDataClassifications.length + ')' : 'NO');
    console.log('  - masterDataTypes:', window.masterDataTypes ? 'SI (' + window.masterDataTypes.length + ')' : 'NO');
    console.log('  - masterDataSubtypes:', window.masterDataSubtypes ? 'SI (' + window.masterDataSubtypes.length + ')' : 'NO');

    // Esperar a que todos los datos maestros est√©n cargados
    var attempts = 0;
    var maxAttempts = 50; // 5 segundos m√°ximo
    var checkDataInterval = setInterval(function() {
      attempts++;

      if (window.masterDataUnits &&
          window.masterDataClassifications &&
          window.masterDataTypes &&
          window.masterDataSubtypes) {

        clearInterval(checkDataInterval);
        console.log('‚úÖ Todos los datos maestros est√°n disponibles despu√©s de ' + (attempts * 100) + 'ms');
        buildIncidenceHierarchy();
      } else if (attempts >= maxAttempts) {
        clearInterval(checkDataInterval);
        console.error('‚ùå Timeout esperando datos maestros despu√©s de ' + (attempts * 100) + 'ms');
        console.log('Datos faltantes:');
        if (!window.masterDataUnits) console.log('  - masterDataUnits');
        if (!window.masterDataClassifications) console.log('  - masterDataClassifications');
        if (!window.masterDataTypes) console.log('  - masterDataTypes');
        if (!window.masterDataSubtypes) console.log('  - masterDataSubtypes');

        // Mostrar mensaje de error
        var tbody = document.getElementById('incidenceTableBody');
        if (tbody) {
          tbody.innerHTML =
            '<tr><td colspan="4" style="color: #ef4444; padding: 20px; text-align: center;">Error: Datos maestros no cargados</td></tr>';
        }
      }
    }, 100);
  }

  // Construir la jerarqu√≠a completa
  function buildIncidenceHierarchy() {
    allIncidenceTypes = [];

    console.log('üî® Construyendo jerarqu√≠a...');
    console.log('Units:', window.masterDataUnits.length);
    console.log('Classifications:', window.masterDataClassifications.length);
    console.log('Types:', window.masterDataTypes.length);
    console.log('Subtypes:', window.masterDataSubtypes.length);

    var stats = {
      total_subtypes: window.masterDataSubtypes.length,
      type_not_found: 0,
      classification_not_found: 0,
      unit_not_found: 0,
      successful: 0
    };

    // Recorrer todos los subtipos (nivel m√°s bajo)
    window.masterDataSubtypes.forEach(function(subtype, index) {
      // Encontrar el tipo padre
      var type = window.masterDataTypes.find(function(t) {
        return t.incidence_type_id === subtype.incidence_type_id;
      });

      if (!type) {
        stats.type_not_found++;
        if (stats.type_not_found === 1) {
          console.warn('‚ö†Ô∏è Primer subtipo sin tipo padre:', subtype);
        }
        return;
      }

      // Encontrar la clasificaci√≥n padre
      var classification = window.masterDataClassifications.find(function(c) {
        return c.incidence_classification_id === type.incidence_classification_id;
      });

      if (!classification) {
        stats.classification_not_found++;
        if (stats.classification_not_found === 1) {
          console.warn('‚ö†Ô∏è Primer tipo sin clasificaci√≥n padre:', type);
        }
        return;
      }

      // Encontrar la unidad padre usando el unit_id de la clasificaci√≥n
      var unit = window.masterDataUnits.find(function(u) {
        return u.unit_id === classification.unit_id;
      });

      if (!unit) {
        stats.unit_not_found++;
        if (stats.unit_not_found === 1) {
          console.warn('‚ö†Ô∏è Primera clasificaci√≥n sin unidad padre:', classification);
          console.warn('   unit_id buscado:', classification.unit_id);
        }
        return;
      }

      stats.successful++;

      // Crear el objeto completo
      allIncidenceTypes.push({
        // IDs
        unit_id: unit.unit_id,
        classification_id: classification.incidence_classification_id,
        type_id: type.incidence_type_id,
        subtype_id: subtype.incidence_subtype_id,

        // Nombres
        unit_name: unit.unit_name,
        classification_name: classification.incidence_classification_name,
        type_name: type.incidence_type_name,
        subtype_name: subtype.incidence_subtype_name,

        // Ruta visual
        path: unit.unit_name + ' > ' +
              classification.incidence_classification_name + ' > ' +
              type.incidence_type_name + ' > ' +
              subtype.incidence_subtype_name
      });
    });

    console.log('üìä Estad√≠sticas de construcci√≥n:');
    console.log('  Total subtipos procesados:', stats.total_subtypes);
    console.log('  Sin tipo padre:', stats.type_not_found);
    console.log('  Sin clasificaci√≥n padre:', stats.classification_not_found);
    console.log('  Sin unidad padre:', stats.unit_not_found);
    console.log('  Exitosos:', stats.successful);
    console.log('‚úÖ Jerarqu√≠a construida:', allIncidenceTypes.length, 'opciones disponibles');

    // Guardar copia de los datos
    allIncidenceTypesData = allIncidenceTypes.slice();

    // ‚úÖ Marcar como construida para usar cach√© en siguientes aperturas
    hierarchyBuilt = true;
    console.log('üíæ Jerarqu√≠a guardada en cach√© para futuras consultas');

    // Renderizar la tabla
    renderIncidenceTable(allIncidenceTypes);
  }

  // Funci√≥n para renderizar la tabla
  function renderIncidenceTable(data) {
    var tbody = document.getElementById('incidenceTableBody');

    if (!data || data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: #999;">No se encontraron resultados</td></tr>';
      return;
    }

    var html = '';
    data.forEach(function(item) {
      html += '<tr class="incidence-row" onclick="selectIncidenceRowById(\'' +
              item.unit_id + '\', \'' +
              item.classification_id + '\', \'' +
              item.type_id + '\', \'' +
              item.subtype_id + '\', \'' +
              escapeHtml(item.unit_name).replace(/'/g, "\\'") + '\', \'' +
              escapeHtml(item.classification_name).replace(/'/g, "\\'") + '\', \'' +
              escapeHtml(item.type_name).replace(/'/g, "\\'") + '\', \'' +
              escapeHtml(item.subtype_name).replace(/'/g, "\\'") + '\')" ' +
              'data-unit-id="' + item.unit_id + '" ' +
              'data-classification-id="' + item.classification_id + '" ' +
              'data-type-id="' + item.type_id + '" ' +
              'data-subtype-id="' + item.subtype_id + '" ' +
              'data-unit-name="' + escapeHtml(item.unit_name) + '" ' +
              'data-classification-name="' + escapeHtml(item.classification_name) + '" ' +
              'data-type-name="' + escapeHtml(item.type_name) + '" ' +
              'data-subtype-name="' + escapeHtml(item.subtype_name) + '">' +
              '<th>' + escapeHtml(item.subtype_name) + '</th>' +
              '<td>' + escapeHtml(item.type_name) + '</td>' +
              '<td>' + escapeHtml(item.classification_name) + '</td>' +
              '<td>' + escapeHtml(item.unit_name) + '</td>' +
              '</tr>';
    });

    tbody.innerHTML = html;
  }

  // Funci√≥n auxiliar para onclick inline
  function selectIncidenceRowById(unitId, classificationId, typeId, subtypeId, unitName, classificationName, typeName, subtypeName) {
    // Buscar la fila en el DOM
    var row = document.querySelector('.incidence-row[data-subtype-id="' + subtypeId + '"]');
    if (row) {
      selectIncidenceRow(row);
    }
  }

  // Funci√≥n para seleccionar una fila
  function selectIncidenceRow(row) {
    // Guardar la selecci√≥n
    currentSelection = {
      unit_id: row.getAttribute('data-unit-id'),
      classification_id: row.getAttribute('data-classification-id'),
      type_id: row.getAttribute('data-type-id'),
      subtype_id: row.getAttribute('data-subtype-id'),
      unit_name: row.getAttribute('data-unit-name'),
      classification_name: row.getAttribute('data-classification-name'),
      type_name: row.getAttribute('data-type-name'),
      subtype_name: row.getAttribute('data-subtype-name')
    };

    console.log('‚úÖ Selecci√≥n realizada:', currentSelection);

    // Confirmar autom√°ticamente la selecci√≥n y cerrar el modal
    confirmIncidenceSelection();
  }

  // Funci√≥n para confirmar la selecci√≥n
  function confirmIncidenceSelection() {
    if (!currentSelection.subtype_id) {
      // showNotification('‚ö†Ô∏è Debe seleccionar un subtipo de incidencia', 'warning');
      return;
    }

    console.log('üíæ Guardando selecci√≥n en el formulario...');

    // Verificar si estamos en modo "cierre" (desde el modal de cerrar ticket)
    var isCloseMode = window.incidenceTypeSelectorMode === 'close';

    if (isCloseMode) {
      console.log('üö™ Modo cierre - Actualizando tipo de incidencia para cierre');

      // Actualizar los campos ocultos del modal de cierre
      $('#closeTicketNewUnitId').val(currentSelection.unit_id);
      $('#closeTicketNewClassificationId').val(currentSelection.classification_id);
      $('#closeTicketNewTypeId').val(currentSelection.type_id);
      $('#closeTicketNewSubtypeId').val(currentSelection.subtype_id);

      // Auto-seleccionar el radio button "cambiar"
      $('input[name="closeIncidenceAction"][value="change"]').prop('checked', true);

      // Actualizar el label del status
      var statusLabel = document.getElementById('closeIncidenceStatusLabel');
      if (statusLabel) {
        statusLabel.textContent = 'nuevo';
      }

      // Actualizar el display visual en el modal de cierre
      var pathElement = document.getElementById('closeTicketIncidencePath');
      if (pathElement) {
        pathElement.innerHTML =
          '<strong style="color: #4a90e2;">' + currentSelection.unit_name + '</strong> ‚Üí ' +
          '<strong style="color: #4a90e2;">' + currentSelection.classification_name + '</strong> ‚Üí ' +
          '<strong style="color: #4a90e2;">' + currentSelection.type_name + '</strong> ‚Üí ' +
          '<strong style="color: #4a90e2;">' + currentSelection.subtype_name + '</strong>' +
          ' <span style="color: #28a745; font-size: 11px; font-weight: 600;">(NUEVO)</span>';
      }

      // Limpiar el flag
      window.incidenceTypeSelectorMode = null;

      // Cerrar el modal del selector
      if (typeof window.$ !== 'undefined') {
        window.$('#incidenceTypeModal').modal('hide');
      }

      return; // Salir aqu√≠ para no actualizar el formulario principal
    }

    // Modo normal: actualizar el formulario principal
    // ESTRATEGIA: Primero cargar opciones con eventos change, LUEGO establecer valores finales
    setTimeout(function() {
      var unitSelect = document.getElementById('formUnit');
      var classificationSelect = document.getElementById('formClassification');
      var typeSelect = document.getElementById('formIncidentType');
      var subtypeSelect = document.getElementById('formIncidentSubtype');

      console.log('üíæ Guardando selecci√≥n en el formulario...');
      console.log('   üéØ IDs seleccionados:', {
        unit_id: currentSelection.unit_id,
        classification_id: currentSelection.classification_id,
        type_id: currentSelection.type_id,
        subtype_id: currentSelection.subtype_id
      });

      // PASO 1: Establecer valores y disparar eventos para cargar opciones en cascada
      if (unitSelect) {
        unitSelect.value = currentSelection.unit_id;
        var event = new Event('change', { bubbles: true });
        unitSelect.dispatchEvent(event);
      }

      // PASO 2: Esperar a que se carguen las clasificaciones, luego establecer y disparar
      setTimeout(function() {
        if (classificationSelect) {
          classificationSelect.value = currentSelection.classification_id;
          var event = new Event('change', { bubbles: true });
          classificationSelect.dispatchEvent(event);
        }

        // PASO 3: Esperar a que se carguen los tipos, luego establecer y disparar
        setTimeout(function() {
          if (typeSelect) {
            typeSelect.value = currentSelection.type_id;
            var event = new Event('change', { bubbles: true });
            typeSelect.dispatchEvent(event);
          }

          // PASO 4: Esperar a que se carguen los subtipos, LUEGO establecer el valor final
          setTimeout(function() {
            // ‚úÖ AHORA S√ç: Establecer todos los valores finales sin disparar eventos
            // Esto sobrescribe cualquier reseteo que hayan hecho los listeners
            if (unitSelect) unitSelect.value = currentSelection.unit_id;
            if (classificationSelect) classificationSelect.value = currentSelection.classification_id;
            if (typeSelect) typeSelect.value = currentSelection.type_id;
            if (subtypeSelect) subtypeSelect.value = currentSelection.subtype_id;

            console.log('‚úÖ Valores finales establecidos:');
            console.log('   - Unit:', unitSelect ? unitSelect.value : 'N/A');
            console.log('   - Classification:', classificationSelect ? classificationSelect.value : 'N/A');
            console.log('   - Type:', typeSelect ? typeSelect.value : 'N/A');
            console.log('   - Subtype:', subtypeSelect ? subtypeSelect.value : 'N/A');

            // Cerrar el modal
            if (typeof window.$ !== 'undefined') {
              window.$('#incidenceTypeModal').modal('hide');
            }

            // ‚úÖ GUARDAR INMEDIATAMENTE
            setTimeout(function() {
              console.log('üíæ Iniciando guardado...');

              // Obtener el ticket activo
              var ticket = null;
              if (window.ticketsState && window.ticketsState.tickets && window.ticketsState.activeTicketId) {
                ticket = window.ticketsState.tickets.find(function(t) {
                  return t.id === window.ticketsState.activeTicketId;
                });
              }

              if (!ticket) {
                console.warn('‚ö†Ô∏è No hay ticket activo');
                return;
              }

              if (!ticket.incidence_id) {
                console.warn('‚ö†Ô∏è Ticket nuevo - debe usar bot√≥n "Guardar Cambios" manualmente');
                if (typeof window.autoSaveState !== 'undefined') {
                  window.autoSaveState.hasUnsavedChanges = true;
                }
                if (typeof window.updateSaveIndicator === 'function') {
                  window.updateSaveIndicator('unsaved');
                }
                return;
              }

              // ‚úÖ Actualizar el ticket local con los nombres para mostrar en el tab
              ticket.unit_name = currentSelection.unit_name;
              ticket.classification_name = currentSelection.classification_name;
              ticket.type_name = currentSelection.type_name;
              ticket.subtype_name = currentSelection.subtype_name;
              ticket.classification = currentSelection.classification_name; // Fallback

              console.log('‚úÖ Ticket local actualizado con nombres:', {
                type_name: ticket.type_name,
                subtype_name: ticket.subtype_name
              });

              // ‚úÖ Actualizar la UI de los tabs inmediatamente
              if (typeof window.renderTicketTabs === 'function') {
                window.renderTicketTabs();
                console.log('‚úÖ Tabs actualizados con nuevo tipo');
              }

              // ‚úÖ Resetear el hash para forzar detecci√≥n de cambios
              if (typeof window.autoSaveState !== 'undefined') {
                window.autoSaveState.lastSavedData = null;
                window.autoSaveState.hasUnsavedChanges = true;
              }

              // ‚úÖ Ticket existente - guardar inmediatamente
              if (typeof window.autoSaveTicket === 'function') {
                window.autoSaveTicket();
                console.log('‚úÖ Guardado disparado');
              } else {
                console.warn('‚ö†Ô∏è Funci√≥n autoSaveTicket no disponible');
              }
            }, 200);

          }, 150);
        }, 150);
      }, 150);
    }, 100);
  }

  // Funci√≥n para escapar HTML y prevenir XSS
  function escapeHtml(text) {
    if (!text) return '';
    var map = {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#039;'
    };
    return text.toString().replace(/[&<>"']/g, function(m) { return map[m]; });
  }

  // Filtro de b√∫squeda
  $('#txtSearchIncidence').on('keyup', function() {
    var searchValue = $(this).val().toLowerCase();

    if (searchValue === '') {
      // Mostrar todos
      renderIncidenceTable(allIncidenceTypesData);
    } else {
      // Filtrar
      var filtered = allIncidenceTypesData.filter(function(item) {
        return item.subtype_name.toLowerCase().indexOf(searchValue) !== -1 ||
               item.type_name.toLowerCase().indexOf(searchValue) !== -1 ||
               item.classification_name.toLowerCase().indexOf(searchValue) !== -1 ||
               item.unit_name.toLowerCase().indexOf(searchValue) !== -1;
      });
      renderIncidenceTable(filtered);
    }
  });

  // Inicializar cuando se abre el modal
  $('#incidenceTypeModal').on('shown.bs.modal', function() {
    console.log('üîç Modal de selector abierto');

    // Limpiar el buscador
    $('#txtSearchIncidence').val('');

    // ‚úÖ Usar cach√© si ya est√° construida
    if (hierarchyBuilt && allIncidenceTypes.length > 0) {
      console.log('‚ö° Usando datos en cach√© (' + allIncidenceTypes.length + ' opciones) - SIN peticiones API');
      renderIncidenceTable(allIncidenceTypesData);
    } else {
      console.log('üì¶ Primera apertura - construyendo jerarqu√≠a...');
      loadIncidenceHierarchy();
    }
  });

  // ‚úÖ OPTIMIZACI√ìN: Cargar y cachear la jerarqu√≠a al inicio de la p√°gina
  // Esto se hace UNA SOLA VEZ cuando carga la p√°gina
  // Las siguientes aperturas del modal usar√°n la cach√© (SIN peticiones API)
  $(document).ready(function() {
    console.log('üöÄ Iniciando precarga de jerarqu√≠a de incidencias...');

    // Esperar un poco para que los datos maestros terminen de cargarse
    setTimeout(function() {
      loadIncidenceHierarchy();
    }, 500); // 500ms de delay para asegurar que catalogos.html cargue los datos maestros
  });
</script>

<style>
  #incidenceTypeModal .incidence-row {
    cursor: pointer;
  }
</style>
<script>


          const userid = __MAINDOCUMENT['userid'];

            const fullname = __MAINDOCUMENT['fullname'];

            log("userid",userid)
</script>
