<!-- ============================================ -->
<!-- M√ìDULO 5: SISTEMA DE TICKETS - ESTADO       -->
<!-- ============================================ -->
<script>
  // Estado global de tickets
  var ticketsState = {
    nextTicketId: 1,
    activeTicketId: null,
    tickets: []
  };

  // ‚úÖ Funci√≥n helper para obtener el ID del operador actual (userid = correo)
  function getCurrentOperatorId() {
    console.log('üîç getCurrentOperatorId - Verificando __MAINDOCUMENT:', typeof __MAINDOCUMENT);

    // Intentar obtener desde __MAINDOCUMENT (variable global del sistema)
    if (typeof __MAINDOCUMENT !== 'undefined' && __MAINDOCUMENT['userid']) {
      console.log('‚úÖ operator_id obtenido de __MAINDOCUMENT:', __MAINDOCUMENT['userid']);
      return __MAINDOCUMENT['userid']; // Retorna el correo del usuario
    }

    // Fallback: Intentar obtener desde sessionStorage o localStorage
    var operatorId = sessionStorage.getItem('operator_id') || localStorage.getItem('operator_id');
    if (operatorId) {
      console.log('‚úÖ operator_id obtenido de storage:', operatorId);
      return operatorId;
    }

    // Si no hay operador, retornar null
    console.warn('‚ö†Ô∏è No se pudo obtener operator_id');
    console.log('__MAINDOCUMENT disponible:', typeof __MAINDOCUMENT !== 'undefined');
    if (typeof __MAINDOCUMENT !== 'undefined') {
      console.log('__MAINDOCUMENT.userid:', __MAINDOCUMENT['userid']);
      console.log('Todas las claves de __MAINDOCUMENT:', Object.keys(__MAINDOCUMENT));
    }
    return null;
  }

  // ‚úÖ Funci√≥n helper para obtener el nombre completo del operador actual
  function getCurrentOperatorName() {
    console.log('üîç getCurrentOperatorName - Verificando __MAINDOCUMENT:', typeof __MAINDOCUMENT);

    // Intentar obtener desde __MAINDOCUMENT (variable global del sistema)
    if (typeof __MAINDOCUMENT !== 'undefined' && __MAINDOCUMENT['fullname']) {
      console.log('‚úÖ operator obtenido de __MAINDOCUMENT:', __MAINDOCUMENT['fullname']);
      return __MAINDOCUMENT['fullname']; // Retorna el nombre completo del usuario
    }

    // Fallback: Intentar obtener desde sessionStorage o localStorage
    var operatorName = sessionStorage.getItem('operator_name') || localStorage.getItem('operator_name');
    if (operatorName) {
      console.log('‚úÖ operator obtenido de storage:', operatorName);
      return operatorName;
    }

    // Si no hay nombre, retornar string vac√≠o
    console.warn('‚ö†Ô∏è No se pudo obtener operator');
    console.log('__MAINDOCUMENT disponible:', typeof __MAINDOCUMENT !== 'undefined');
    if (typeof __MAINDOCUMENT !== 'undefined') {
      console.log('__MAINDOCUMENT.fullname:', __MAINDOCUMENT['fullname']);
      console.log('Todas las claves de __MAINDOCUMENT:', Object.keys(__MAINDOCUMENT));
    }
    return '';
  }
</script>

<!-- ============================================ -->
<!-- M√ìDULO 6: SISTEMA DE TICKETS - API Y DATOS  -->
<!-- ============================================ -->
<script>
  // Funci√≥n para cargar incidencias desde la API
  function loadIncidencesFromAPI() {
    callAPI({
      method: 'gestincidencias/getincidences',
      params: {}, // Sin par√°metros para obtener todas
      ok: function (data) {
        // Validar que data sea un array
        if (!Array.isArray(data)) {
          loadMockTickets();
          return;
        }

        // Convertir incidencias a formato de tickets
        ticketsState.tickets = data.map(function (incidence) {
          return convertIncidenceToTicket(incidence);
        });

        // Renderizar tickets en la UI
        renderTicketTabs();

        // Seleccionar el primer ticket si existe
        if (ticketsState.tickets.length > 0) {
          selectTicket(ticketsState.tickets[0].id);
        }
      },
      error: function (error) {
        // Ignorar AbortError silenciosamente
        if (error && (error.name === 'AbortError' || error.message?.includes('aborted') || error.status === 0)) {
          console.log('‚ö†Ô∏è Petici√≥n cancelada (loadIncidencesFromAPI)');
          return;
        }

        showNotification('‚ö†Ô∏è Error al cargar tickets. Usando datos de ejemplo.', 'warning');

        // Cargar tickets de ejemplo si falla la API
        loadMockTickets();
      }
    });
  }

  // Funci√≥n para convertir incidencia de BD a formato de ticket del frontend
  function convertIncidenceToTicket(incidence) {
    // Mapear alert_level_code a valores del formulario (si existe)
    var alertLevel = 'media';
    if (incidence.alert_level_code) {
      var alertMap = {
        'low': 'baja',
        'medium': 'media',
        'high': 'alta'
      };
      alertLevel = alertMap[incidence.alert_level_code] || 'media';
    }

    // Detectar si es un borrador (incidence_state_id = 6)
    var isDraft = incidence.incidence_state_id === 6;

    return {
      // ========== IDs ==========
      id: incidence.incidence_code,                    // INC-20251215-000016
      incidence_id: incidence.incidence_id,            // 15 (num√©rico para detalle)

      // ========== ESTADO Y ALERTA ==========
      alertLevel: alertLevel,                          // baja, media, alta
      status: incidence.state_name || 'Pendiente',     // Pendiente, En proceso, Borrador, etc.
      state_name: incidence.state_name || 'Pendiente',
      incidence_state_id: incidence.incidence_state_id || 1,

      // ========== FECHAS ==========
      created: incidence.created_at || incidence.incidence_date,
      lastModified: incidence.updated_at || incidence.created_at,

      // ========== INFORMACI√ìN B√ÅSICA (para mostrar en lista) ==========
      reporterName: incidence.complainant || '',
      location: incidence.location || '',

      // ========== CLASIFICACI√ìN ==========
      classification: incidence.classification_name || '',    // A. TURISTICO-APOYO CIUDADANO
      type_name: incidence.type_name || '',                   // HECHO CONTRA EL PATRIMONIO
      subtype_name: incidence.subtype_name || '',             // ABANDONO Y ACTOS DE CRUELDAD

      // ========== ORIGEN ==========
      origin: incidence.origin_name || '',                    // Aplicativo M√≥vil, CIVIX, etc.
      origin_id: incidence.origin_id || 8,                    // ID del origen (por defecto 8: Tel√©fono-PBX)

      // ========== OPERADOR ==========
      operator: incidence.operator || null,
      operator_id: incidence.operator_id || null,

      // ========== FLAGS ==========
      isNew: false,           // NO es nuevo (ya existe en BD)
      isDraft: isDraft,       // TRUE si es borrador (estado 6)
      detailLoaded: false,    // A√∫n no se carg√≥ el detalle completo

      // ========== CHAT ==========
      chatMessages: [],
      unreadCount: 0
    };
  }

  // Cargar informaci√≥n COMPLETA de un ticket espec√≠fico usando getincidence
  function loadIncidenceDetail(incidenceId, callback) {
    callAPI({
      method: 'gestincidencias/getincidence',
      params: { incidence_id: incidenceId },
      ok: function (data) {
        // La API devuelve un array con un objeto, extraer el primer elemento
        var detailData = Array.isArray(data) && data.length > 0 ? data[0] : data;

        if (callback) {
          callback(detailData);
        }
      },
      error: function (error) {
        // Ignorar AbortError silenciosamente
        if (error && (error.name === 'AbortError' || error.message?.includes('aborted') || error.status === 0)) {
          console.log('‚ö†Ô∏è Petici√≥n cancelada (loadIncidenceDetail)');
          return;
        }

        if (callback) {
          callback(null);
        }
      }
    });
  }

  // üéØ Poblar formulario directamente desde API
  function populateFormDirectlyFromAPI(apiData) {
    if (!apiData) {
      return;
    }

    // ========== ENCABEZADO DEL TICKET ==========
    var formTicketHeader = document.getElementById('formTicketHeader');
    var formIncidentId = document.getElementById('formIncidentId');

    var ticketId = apiData.incidence_code || '#' + apiData.incidence_id;
    var ticketDate = apiData.created_at || apiData.incidence_date || 'Sin fecha';

    if (formTicketHeader) {
      formTicketHeader.innerHTML = 'Ticket ' + ticketId + ' ‚Ä¢ ' + ticketDate;
    }
    if (formIncidentId) {
      formIncidentId.value = ticketId;
    }

    // ========== NIVEL DE ALERTA ==========
    var formAlertLevel = document.getElementById('formAlertLevel');
    if (formAlertLevel) {
      // La API devuelve: alert_level_code = "low", "medium", "high"
      // El formulario usa: baja, media, alta
      var alertLevelMap = {
        'low': 'baja',
        'medium': 'media',
        'high': 'alta'
      };
      var alertValue = alertLevelMap[apiData.alert_level_code] || 'media';
      formAlertLevel.value = alertValue;
    }

    // ========== CLASIFICACI√ìN DE INCIDENCIA ==========
    // Cargar Origen
    var formOrigin = document.getElementById('formOrigin');
    if (formOrigin && apiData.origin_id) {
      formOrigin.value = apiData.origin_id;
    }

    // Cargar Unidad y disparar evento para cascada
    var formUnit = document.getElementById('formUnit');
    if (formUnit && apiData.unit_id) {
      formUnit.value = apiData.unit_id;
      // Disparar evento change para cargar clasificaciones
      var event = new Event('change');
      formUnit.dispatchEvent(event);
    }

    // Cargar Clasificaci√≥n (despu√©s de que se carguen por el evento de unidad)
    setTimeout(function() {
      var formClassification = document.getElementById('formClassification');
      if (formClassification && apiData.incidence_classification_id) {
        formClassification.value = apiData.incidence_classification_id;
        // Disparar evento change para cargar tipos
        var event = new Event('change');
        formClassification.dispatchEvent(event);
      }

      // Cargar Tipo (despu√©s de que se carguen por el evento de clasificaci√≥n)
      setTimeout(function() {
        var formIncidentType = document.getElementById('formIncidentType');
        if (formIncidentType && apiData.incidence_type_id) {
          formIncidentType.value = apiData.incidence_type_id;
          // Disparar evento change para cargar subtipos
          var event = new Event('change');
          formIncidentType.dispatchEvent(event);
        }

        // Cargar Subtipo (despu√©s de que se carguen por el evento de tipo)
        setTimeout(function() {
          var formIncidentSubtype = document.getElementById('formIncidentSubtype');
          if (formIncidentSubtype && apiData.incidence_subtype_id) {
            formIncidentSubtype.value = apiData.incidence_subtype_id;
          }
        }, 100);
      }, 100);
    }, 100);

    // ========== DATOS DEL DENUNCIANTE ==========
    var formReporterName = document.getElementById('formReporterName');
    var formReporterDNI = document.getElementById('formReporterDNI');
    var formReporterPhone = document.getElementById('formReporterPhone');
    var formReporterEmail = document.getElementById('formReporterEmail');
    var formReporterRelation = document.getElementById('formReporterRelation');

    if (formReporterName) formReporterName.value = apiData.complainant || '';
    if (formReporterDNI) formReporterDNI.value = apiData.document_number || '';
    if (formReporterPhone) formReporterPhone.value = apiData.contact_number || '';
    if (formReporterEmail) formReporterEmail.value = apiData.reporter_email || '';
    if (formReporterRelation) formReporterRelation.value = apiData.reporter_relation || 'victima';

    // ========== UBICACI√ìN ==========
    var formLocationAddress = document.getElementById('formLocationAddress');
    var formLocationDistrict = document.getElementById('formLocationDistrict');
    var formLocationProvince = document.getElementById('formLocationProvince');
    var formLocationReference = document.getElementById('formLocationReference');
    var formLocationCoordinates = document.getElementById('formLocationCoordinates');

    if (formLocationAddress) formLocationAddress.value = apiData.location || '';
    if (formLocationDistrict) formLocationDistrict.value = apiData.district || '';
    if (formLocationProvince) formLocationProvince.value = apiData.province || '';
    if (formLocationReference) formLocationReference.value = apiData.location_reference || '';

    // Coordenadas
    var lat = apiData.latitude ? parseFloat(apiData.latitude) : null;
    var lon = apiData.longitude ? parseFloat(apiData.longitude) : null;

    if (formLocationCoordinates && lat && lon) {
      formLocationCoordinates.value = lat + ', ' + lon;
    }

    // ========== MAPA: Marcar ubicaci√≥n ==========
    if (lat && lon && cadMap) {
      // Remover marcador previo
      if (currentLocationMarker) {
        cadMap.removeLayer(currentLocationMarker);
      }

      var incidentIcon = L.divIcon({
        className: 'incident-marker-icon',
        html: '<div style="background: #ef4444; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 16px; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.4);">üìç</div>',
        iconSize: [36, 36],
        iconAnchor: [18, 18]
      });

      currentLocationMarker = L.marker([lat, lon], {
        icon: incidentIcon,
        draggable: true  // ‚Üê Permitir arrastrar el pin
      })
        .addTo(cadMap)
        .bindPopup('<b>Ubicaci√≥n del incidente</b><br>' + (apiData.location || 'Sin direcci√≥n') + '<br><small>Arrastra el pin para cambiar la ubicaci√≥n</small>');

      // Evento: Cuando el usuario mueve el pin
      currentLocationMarker.on('dragend', function(e) {
        var newLatLng = e.target.getLatLng();
        console.log('üìç Pin movido a:', newLatLng.lat, newLatLng.lng);
        updateLocationFromCoordinates(newLatLng.lat, newLatLng.lng);
        regenerateAgentsAroundIncident(newLatLng.lat, newLatLng.lng);
        renderAgentsOnMap();
      });

      // Centrar mapa en la ubicaci√≥n
      cadMap.setView([lat, lon], 16);

      // Regenerar agentes alrededor de esta ubicaci√≥n
      regenerateAgentsAroundIncident(lat, lon);

      // Mostrar agentes cercanos disponibles
      showNearbyAgents(lat, lon);
    }

    // ========== DESCRIPCI√ìN ==========
    var formDescription = document.getElementById('formDescription');
    if (formDescription) {
      formDescription.value = apiData.description_incidence || '';
    }
  }

  // Funci√≥n para cargar tickets de ejemplo (fallback)
  function loadMockTickets() {
    // ‚ùå NO CARGAR DATOS EN DURO - La API debe ser la fuente de verdad
    ticketsState.tickets = [];

    renderTicketTabs();
    if (ticketsState.tickets.length > 0) {
      selectTicket(ticketsState.tickets[0].id);
    }
  }
</script>

<!-- ============================================ -->
<!-- M√ìDULO 7: SISTEMA DE TICKETS - UI Y FORMULARIO -->
<!-- ============================================ -->
<script>
  // Funci√≥n para renderizar los tabs de tickets
  function renderTicketTabs() {
    var container = document.getElementById('incidentTabs');
    var countEl = document.getElementById('ticketsCount');

    if (!container) return;

    // Limpiar contenedor
    container.innerHTML = '';

    // Crear bot√≥n de crear ticket con createElement para mantener event listeners
    var addTicketBtn = document.createElement('button');
    addTicketBtn.id = 'addticket';
    addTicketBtn.type = 'button';
    addTicketBtn.className = 'btn btn-warning';
    addTicketBtn.style.cssText = 'align-items: center; gap: 8px; padding: 12px 18px; border-radius: 8px; font-size: 0.9rem; font-weight: 600; transition: all 0.3s ease;';

    var icon = document.createElement('i');
    icon.className = 'pe-7s-plus';
    icon.setAttribute('aria-hidden', 'true');
    icon.style.fontSize = '2.5rem';

    var span = document.createElement('span');
    span.textContent = '';

    addTicketBtn.appendChild(icon);
    addTicketBtn.appendChild(span);

    // Efectos hover
    addTicketBtn.addEventListener('mouseenter', function () {
      this.style.transform = 'translateY(-2px)';
      this.style.boxShadow = '0 4px 12px rgba(59, 130, 246, 0.4)';
    });
    addTicketBtn.addEventListener('mouseleave', function () {
      this.style.transform = 'translateY(0)';
      this.style.boxShadow = 'none';
    });

    // Asignar evento click para crear nuevo ticket
    addTicketBtn.addEventListener('click', function () {
      if (typeof window.$ !== 'undefined' && window.$('#newTicketModal').length) {
        window.$('#newTicketModal').modal('show');
      }
    });

    container.appendChild(addTicketBtn);

    // ‚úÖ FILTRAR TICKETS: Solo mostrar Pendientes (1), En proceso (2) y m√°ximo 2 Borradores (6)
    var drafts = [];
    var activeTickets = [];

    ticketsState.tickets.forEach(function (ticket) {
      var stateId = ticket.incidence_state_id;

      // Separar borradores de tickets activos
      if (stateId === 6 || ticket.isDraft === true) {
        drafts.push(ticket);
      } else if (stateId === 1 || stateId === 2) {
        // 1 = Pendiente, 2 = En proceso
        activeTickets.push(ticket);
      }
      // Otros estados (cerrado, cancelado, etc.) NO se muestran
    });

    // Limitar borradores a m√°ximo 2
    var visibleDrafts = drafts.slice(0, 2);

    // Combinar: primero borradores, luego tickets activos
    var visibleTickets = visibleDrafts.concat(activeTickets);

    // Actualizar contador con tickets visibles
    if (countEl) {
      countEl.textContent = visibleTickets.length + ' ticket' + (visibleTickets.length !== 1 ? 's' : '');
    }

    // Renderizar cada ticket visible
    visibleTickets.forEach(function (ticket) {
      var button = document.createElement('button');
      button.type = 'button';

      var isActive = ticket.id === ticketsState.activeTicketId;
      button.className = isActive ? 'btn btn-accent ticket-tab' : 'btn btn-default ticket-tab';

      // Determinar color del c√≠rculo seg√∫n nivel de alerta
      var circleClass = 'alert-circle alert-circle-baja';
      if (ticket.alertLevel === 'critica') {
        circleClass = 'alert-circle alert-circle-critica';
      } else if (ticket.alertLevel === 'alta') {
        circleClass = 'alert-circle alert-circle-alta';
      } else if (ticket.alertLevel === 'media') {
        circleClass = 'alert-circle alert-circle-media';
      }

      // Obtener nombre del tipo de incidencia desde el API
      var incidentTypeName = ticket.type_name || ticket.classification || 'Sin tipo';

      // Agregar clase de ticket con mensajes sin leer
      if (ticket.unread > 0 && !isActive) {
        button.classList.add('ticket-has-unread');
      }

      // Badge de mensajes sin leer en esquina superior derecha
      var unreadBadge = '';
      if (ticket.unread > 0 && !isActive) {
        unreadBadge = '<span class="unread-badge">' + ticket.unread + '</span>';
      }

      button.innerHTML =
        unreadBadge +
        '<div style="display: flex; align-items: center; margin-bottom: 4px;">' +
        '<span class="' + circleClass + '"></span>' +
        '<h5 style="margin: 0; font-size: 14px; font-weight: 600;">' + ticket.id + '</h5>' +
        '</div>' +
        '<p style="margin: 0; font-size: 12px; color: #9ca3af; padding-left: 20px;">' + incidentTypeName + '</p>';

      button.addEventListener('click', function () {
        selectTicket(ticket.id);
      });

      container.appendChild(button);
    });
  }

  // Funci√≥n para seleccionar un ticket
  function selectTicket(ticketId) {
    // üíæ Guardar cambios del ticket actual antes de cambiar
    var currentTicket = ticketsState.tickets.find(function (t) { return t.id === ticketsState.activeTicketId; });
    if (currentTicket && currentTicket.incidence_id && autoSaveState.hasUnsavedChanges) {
      console.log('üíæ Guardando cambios antes de cambiar de ticket...');
      autoSaveTicket();
    }

    ticketsState.activeTicketId = ticketId;
    var ticket = ticketsState.tickets.find(function (t) { return t.id === ticketId; });

    if (!ticket) return;

    // Marcar mensajes como le√≠dos
    ticket.unread = 0;

    // Actualizar tabs
    renderTicketTabs();

    // üéØ NIVEL 2: Si no se ha cargado el detalle completo, cargarlo ahora
    if (!ticket.detailLoaded && ticket.incidence_id) {
      loadIncidenceDetail(ticket.incidence_id, function (detailData) {
        if (detailData) {
          // ‚úÖ POBLAR FORMULARIO DIRECTAMENTE DESDE LA API
          var apiResponse = Array.isArray(detailData) && detailData.length > 0 ? detailData[0] : detailData;

          // ‚úÖ GUARDAR los datos de la API en el ticket para usarlos despu√©s
          ticket.apiData = apiResponse;
          ticket.detailLoaded = true;

          // Poblar el formulario con los datos
          populateFormDirectlyFromAPI(apiResponse);
        } else {
          // Si falla, cargar lo que tenemos (fallback)
          loadTicketToForm(ticket);
        }
      });
    } else if (ticket.apiData) {
      // ‚úÖ Si ya est√° cargado Y tiene datos de la API guardados, usarlos
      populateFormDirectlyFromAPI(ticket.apiData);
    } else {
      // Fallback: usar loadTicketToForm si no hay datos de API
      loadTicketToForm(ticket);
    }

    // Cargar chat del ticket
    loadTicketChat(ticket);

    // Cargar agentes asignados a este ticket
    renderTicketAssignedAgents();

    // Actualizar el texto del bot√≥n de guardar
    updateSaveButtonText();
  }

  // Funci√≥n para cargar datos del ticket en el formulario
  function loadTicketToForm(ticket) {
    var formTicketHeader = document.getElementById('formTicketHeader');
    var formIncidentId = document.getElementById('formIncidentId');
    var formAlertLevel = document.getElementById('formAlertLevel');
    var formIncidentType = document.getElementById('formIncidentType');
    var formReporterName = document.getElementById('formReporterName');
    var formReporterDNI = document.getElementById('formReporterDNI');
    var formReporterPhone = document.getElementById('formReporterPhone');
    var formReporterEmail = document.getElementById('formReporterEmail');
    var formReporterRelation = document.getElementById('formReporterRelation');

    // ‚úÖ Formatear fecha correctamente
    var dateStr = 'Creado ahora';
    if (ticket.created) {
      try {
        var date = new Date(ticket.created);
        dateStr = date.toLocaleString('es-ES', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      } catch (e) {
        dateStr = ticket.created;
      }
    }

    // ‚úÖ Mostrar c√≥digo del ticket + estado
    if (formTicketHeader) {
      formTicketHeader.innerHTML = '<strong>' + ticket.id + '</strong> ‚Ä¢ <span style="color: #9ca3af;">' + dateStr + '</span>';
    }

    // ‚úÖ Mostrar c√≥digo en campo de ID
    if (formIncidentId) formIncidentId.value = ticket.id;
    if (formAlertLevel) formAlertLevel.value = ticket.alertLevel;
    if (formIncidentType) formIncidentType.value = ticket.incidentType;
    if (formReporterName) formReporterName.value = ticket.reporterName;
    if (formReporterDNI) formReporterDNI.value = ticket.reporterDNI;
    if (formReporterPhone) formReporterPhone.value = ticket.reporterPhone;
    if (formReporterEmail) formReporterEmail.value = ticket.reporterEmail;
    if (formReporterRelation) formReporterRelation.value = ticket.reporterRelation;

    // Cargar campos de ubicaci√≥n
    var formLocationAddress = document.getElementById('formLocationAddress');
    var formLocationDistrict = document.getElementById('formLocationDistrict');
    var formLocationProvince = document.getElementById('formLocationProvince');
    var formLocationReference = document.getElementById('formLocationReference');
    var formLocationCoordinates = document.getElementById('formLocationCoordinates');

    if (ticket.location) {
      if (formLocationAddress) formLocationAddress.value = ticket.location.address || '';
      if (formLocationDistrict) formLocationDistrict.value = ticket.location.district || '';
      if (formLocationProvince) formLocationProvince.value = ticket.location.province || '';
      if (formLocationReference) formLocationReference.value = ticket.location.reference || '';
      if (formLocationCoordinates) formLocationCoordinates.value = ticket.location.coordinates || '';

      // Si hay coordenadas, actualizar marcador en el mapa
      if (ticket.location.lat && ticket.location.lon && cadMap) {
        // Remover marcador previo
        if (currentLocationMarker) {
          cadMap.removeLayer(currentLocationMarker);
        }

        var incidentIcon = L.divIcon({
          className: 'incident-marker-icon',
          html: '<div style="background: #ef4444; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 16px; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.4);">üìç</div>',
          iconSize: [36, 36],
          iconAnchor: [18, 18]
        });

        currentLocationMarker = L.marker([ticket.location.lat, ticket.location.lon], { icon: incidentIcon })
          .addTo(cadMap)
          .bindPopup('<b>Ubicaci√≥n del incidente</b><br>' + (ticket.location.address || 'Sin direcci√≥n'));

        // Centrar mapa en la ubicaci√≥n
        cadMap.setView([ticket.location.lat, ticket.location.lon], 16);

        // üî• REGENERAR agentes alrededor de esta ubicaci√≥n
        regenerateAgentsAroundIncident(ticket.location.lat, ticket.location.lon);

        // Mostrar agentes cercanos disponibles
        showNearbyAgents(ticket.location.lat, ticket.location.lon);
      }
    } else {
      // Limpiar campos si no hay ubicaci√≥n
      if (formLocationAddress) formLocationAddress.value = '';
      if (formLocationDistrict) formLocationDistrict.value = '';
      if (formLocationProvince) formLocationProvince.value = '';
      if (formLocationReference) formLocationReference.value = '';
      if (formLocationCoordinates) formLocationCoordinates.value = '';

      // Ocultar secci√≥n de agentes cercanos
      var nearbySection = document.getElementById('nearbyAgentsSection');
      if (nearbySection) nearbySection.style.display = 'none';
    }

    // Mostrar/ocultar secciones seg√∫n tipo de incidencia
    handleIncidentTypeChange(ticket.incidentType);

    // Cargar evidencia del ticket
    renderEvidenceList(ticket);
  }

  // Funci√≥n para actualizar el texto del bot√≥n de guardar seg√∫n el estado del ticket
  function updateSaveButtonText() {
    var saveBtn = document.getElementById('saveTicketBtn');
    if (!saveBtn) return;

    // Obtener el ticket activo
    var ticket = ticketsState.activeTicketId
      ? ticketsState.tickets.find(function (t) { return t.id === ticketsState.activeTicketId; })
      : null;

    if (!ticket) {
      // No hay ticket activo
      saveBtn.innerHTML = '<i class="pe-7s-diskette" aria-hidden="true"></i> Guardar Cambios';
      saveBtn.className = 'btn btn-accent';
      saveBtn.style.cssText = 'width: 100%; padding: 12px; font-size: 15px; font-weight: 600;';
      saveBtn.disabled = true;
      return;
    }

    // Habilitar el bot√≥n
    saveBtn.disabled = false;

    if (ticket.isNew === true) {
      // Ticket nuevo local (sin ID de BD)
      saveBtn.innerHTML = '<i class="pe-7s-plus" aria-hidden="true"></i> Crear Ticket';
      saveBtn.className = 'btn btn-accent';
      saveBtn.style.cssText = 'width: 100%; padding: 12px; font-size: 15px; font-weight: 600;';
    } else {
      // Para borradores y tickets existentes: mismo bot√≥n "Guardar Cambios"
      var labelText = ticket.isDraft ? 'üíæ Guardar Cambios' : 'üíæ Guardar Cambios';
      saveBtn.innerHTML = labelText;
      saveBtn.className = 'btn btn-accent';
      saveBtn.style.cssText = 'width: 100%; padding: 12px; font-size: 15px; font-weight: 600;';
    }
  }
</script>

<!-- ============================================ -->
<!-- M√ìDULO 8: SISTEMA DE CHAT DE TICKETS        -->
<!-- ============================================ -->
<script>
  // Funci√≥n para cargar chat del ticket
  function loadTicketChat(ticket) {
    var chatTimeline = document.getElementById('chatTimeline');
    var chatTicketId = document.getElementById('chatTicketId');
    var chatTicketStatus = document.getElementById('chatTicketStatus');
    var chatAgentName = document.getElementById('chatAgentName');

    if (chatTicketId) chatTicketId.textContent = ticket.id;
    if (chatTicketStatus) chatTicketStatus.textContent = ticket.status;

    // Actualizar nombre del agente
    if (chatAgentName) {
      if (ticket.assignedAgent) {
        chatAgentName.textContent = ticket.assignedAgent;
      } else {
        chatAgentName.textContent = 'No asignado';
      }
    }

    if (!chatTimeline) return;

    chatTimeline.innerHTML = '';

    // Si no tiene mensajes, mostrar solo el evento de creaci√≥n
    if (!ticket.chatMessages || ticket.chatMessages.length === 0) {
      var eventDiv = buildChatEvent({
        icon: '‚ö°Ô∏è',
        title: 'Incidente creado',
        detail: 'Registrado por operador',
        timestamp: ticket.created ? (ticket.created.split(',')[1] || ticket.created) : 'Sin fecha'
      });
      chatTimeline.appendChild(eventDiv);
      return;
    }

    // Renderizar todos los mensajes del ticket
    ticket.chatMessages.forEach(function (msg) {
      var msgElement = msg.type === 'event'
        ? buildChatEvent(msg)
        : buildChatMessage(msg);
      chatTimeline.appendChild(msgElement);
    });

    // Auto scroll al final
    setTimeout(function () {
      var chatContainer = chatTimeline.parentElement;
      if (chatContainer) {
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }
    }, 100);
  }

  // Funci√≥n para construir un evento del chat
  function buildChatEvent(event) {
    var div = document.createElement('div');
    div.className = 'chat-event';
    div.innerHTML =
      '<span style="font-size: 14px;">' + (event.icon || '‚ö°Ô∏è') + '</span>' +
      '<span style="font-weight: 500; color: #d1d5db;">' + event.title + '</span>' +
      '<span style="color: #6b7280;">‚Ä¢</span>' +
      '<span style="color: #9ca3af; font-size: 11px;">' + event.timestamp + '</span>';
    return div;
  }

  // Funci√≥n para construir un mensaje del chat
  function buildChatMessage(message) {
    var div = document.createElement('div');
    var isOperator = message.from === 'operator';
    div.className = 'chat-message ' + (isOperator ? 'from-operator' : 'from-agent');

    var attachmentsHtml = '';
    if (message.attachments && message.attachments.length > 0) {
      attachmentsHtml = '<div class="chat-attachments">';
      message.attachments.forEach(function (att) {
        attachmentsHtml += '<span class="chat-attachment">üìé ' + att.name + '</span>';
      });
      attachmentsHtml += '</div>';
    }

    div.innerHTML =
      '<div class="chat-message-author">' +
      '<span>' + message.name + '</span>' +
      '<span class="chat-message-role"> ‚Ä¢ ' + message.role + '</span>' +
      '</div>' +
      '<div class="chat-message-text">' + message.text + '</div>' +
      attachmentsHtml +
      '<div class="chat-message-meta">' + message.timestamp + '</div>';

    return div;
  }

  // Funci√≥n para enviar un mensaje
  function sendChatMessage() {
    if (!ticketsState.activeTicketId) return;

    var ticket = ticketsState.tickets.find(function (t) { return t.id === ticketsState.activeTicketId; });
    if (!ticket) return;

    var chatInput = document.getElementById('chatComposerInput');
    if (!chatInput || !chatInput.value.trim()) return;

    var messageText = chatInput.value.trim();
    var now = new Date();
    var timeString = now.getHours() + ':' + String(now.getMinutes()).padStart(2, '0');

    // Crear el mensaje
    var newMessage = {
      type: 'message',
      from: 'operator',
      name: 'Operador',
      role: 'CAD',
      text: messageText,
      timestamp: timeString
    };

    // Inicializar array de mensajes si no existe
    if (!ticket.chatMessages) {
      ticket.chatMessages = [];
      // Agregar evento de creaci√≥n si es el primer mensaje
      ticket.chatMessages.push({
        type: 'event',
        icon: '‚ö°Ô∏è',
        title: 'Incidente creado',
        detail: 'Registrado por operador',
        timestamp: ticket.created ? (ticket.created.split(',')[1] || ticket.created) : 'Sin fecha'
      });
    }

    // Agregar el mensaje al ticket
    ticket.chatMessages.push(newMessage);

    // Limpiar input
    chatInput.value = '';

    // Recargar el chat
    loadTicketChat(ticket);

    // Simular respuesta del agente despu√©s de 2-5 segundos
    simulateAgentResponse(ticket);
  }

  // Funci√≥n para simular respuesta de agente (solo para demo)
  function simulateAgentResponse(ticket) {
    var responses = [
      'Recibido, en camino al lugar.',
      'Entendido, llegando en 5 minutos.',
      'Confirmado, ubicaci√≥n identificada.',
      'Roger, procediendo seg√∫n protocolo.',
      'Afirmativo, contactando con el reportante.'
    ];

    var randomDelay = 2000 + Math.random() * 3000; // 2-5 segundos

    setTimeout(function () {
      var now = new Date();
      var timeString = now.getHours() + ':' + String(now.getMinutes()).padStart(2, '0');

      var agentMessage = {
        type: 'message',
        from: 'agent',
        name: 'Agente',
        role: 'En ruta',
        text: responses[Math.floor(Math.random() * responses.length)],
        timestamp: timeString
      };

      ticket.chatMessages.push(agentMessage);

      // Si este ticket no est√° activo, incrementar contador de no le√≠dos
      if (ticketsState.activeTicketId !== ticket.id) {
        ticket.unread++;
        renderTicketTabs();
      } else {
        // Si est√° activo, recargar el chat
        loadTicketChat(ticket);
      }
    }, randomDelay);
  }
</script>

<!-- ============================================ -->
<!-- M√ìDULO 9: CREACI√ìN Y GESTI√ìN DE TICKETS     -->
<!-- ============================================ -->
<script>
  // Funci√≥n para mostrar modal de confirmaci√≥n para crear ticket
  function showNewTicketModal() {
    $('#newTicketModal').modal('show');
  }

  // Funci√≥n para cerrar modal de crear ticket
  function closeNewTicketModal() {
    $('#newTicketModal').modal('hide');
    $('.modal-backdrop').remove();
  }

  // Funci√≥n para confirmar creaci√≥n de ticket desde el modal
  function confirmCreateTicket() {
    // Cerrar modal
    $('#newTicketModal').modal('hide');
    $('.modal-backdrop').remove();

    // Crear borrador en la BD
    createDraftIncidence();
  }

  // Funci√≥n auxiliar para contar tickets activos
  function countActiveTickets() {
    var activeCount = 0;

    ticketsState.tickets.forEach(function(ticket) {
      // Contar tickets pendientes y en proceso (incidence_state_id = 1 o 2)
      if (ticket.incidence_state_id === 1 || ticket.incidence_state_id === 2) {
        activeCount++;
      }
    });

    return {
      total: activeCount
    };
  }

  // Funci√≥n para crear un borrador de incidencia en la BD
  function createDraftIncidence() {
    // VALIDACI√ìN: Verificar l√≠mites de tickets
    var counts = countActiveTickets();

    // Regla: M√°ximo 7 tickets totales
    if (counts.total >= 7) {
      showNotification('‚ùå L√≠mite de tickets alcanzado (m√°ximo 7 tickets activos). Cierre algunos tickets antes de crear uno nuevo.', 'error');
      return;
    }

    // ‚úÖ Obtener informaci√≥n del operador
    var operatorId = getCurrentOperatorId();
    var operatorName = getCurrentOperatorName();

    console.log('üìù Creando ticket con operador:', {
      operator_id: operatorId,
      operator: operatorName
    });

    // Llamar al API para crear nuevo ticket
    callAPI({
      method: 'gestincidencias/incidencenewdraft',
      post: 1,
      params: {
        // ‚úÖ Enviar informaci√≥n del operador que crea el ticket
        operator_id: operatorId,    // Correo del operador (userid)
        operator: operatorName      // Nombre completo del operador (fullname)
      },
      ok: function (response) {
        // ‚úÖ La API puede devolver un array con un objeto, extraer el primer elemento
        var data = Array.isArray(response) && response.length > 0 ? response[0] : response;

        // ‚úÖ Validar que tengamos los datos necesarios
        if (!data || !data.incidence_code || !data.incidence_id) {
          showNotification('‚ùå Error: La API no devolvi√≥ los datos esperados', 'error');
          console.error('Response inv√°lido:', response);
          return;
        }

        // Crear ticket local como EN PROCESO (sin flag de borrador)
        var newTicket = {
          id: data.incidence_code,                   // INC-2025-000009
          incidence_id: data.incidence_id,           // 28
          isDraft: false,                            // ‚úÖ NO es borrador
          alertLevel: 'media',                       // Por defecto
          status: 'En proceso',                      // Estado: En proceso
          state_name: 'En proceso',
          incidence_state_id: 2,                     // Estado 2 = En proceso
          created: new Date().toISOString(),
          lastModified: new Date().toISOString(),
          reporterName: '',
          location: '',
          type_name: '',
          classification: '',
          origin: 'Manual',
          operator_id: getCurrentOperatorId(),       // ‚úÖ Correo del operador
          operator: getCurrentOperatorName(),        // ‚úÖ Nombre del operador
          detailLoaded: true,                        // Ya est√° "cargado" porque est√° vac√≠o
          chatMessages: [],
          unreadCount: 0
        };

        // Agregar ticket al estado
        ticketsState.tickets.unshift(newTicket); // unshift para agregarlo al inicio

        // Actualizar la UI
        renderTicketTabs();

        // Activar el nuevo ticket
        selectTicket(newTicket.id);

        // Actualizar el texto del bot√≥n
        updateSaveButtonText();

        // Limpiar formulario
        clearFormFields();

        // ‚úÖ Resaltar el campo de nombre del denunciante para que el usuario comience a escribir
        setTimeout(function() {
          var reporterNameField = document.getElementById('formReporterName');
          if (reporterNameField) {
            reporterNameField.focus();
            reporterNameField.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        }, 300);
      },
      error: function (error) {
        // Ignorar errores de cancelaci√≥n (AbortError)
        if (error && (error.name === 'AbortError' || error.message?.includes('aborted') || error.status === 0)) {
          console.log('‚ö†Ô∏è Petici√≥n cancelada (createDraftIncidence)');
          return;
        }
        showNotification('‚ùå Error al crear ticket: ' + (error.message || 'Error desconocido'), 'error');
      }
    });
  }

  // Funci√≥n para limpiar todos los campos del formulario
  function clearFormFields() {
    // Limpiar campos de denunciante
    var formReporterName = document.getElementById('formReporterName');
    var formReporterDNI = document.getElementById('formReporterDNI');
    var formReporterPhone = document.getElementById('formReporterPhone');
    var formReporterEmail = document.getElementById('formReporterEmail');
    var formReporterRelation = document.getElementById('formReporterRelation');

    if (formReporterName) formReporterName.value = '';
    if (formReporterDNI) formReporterDNI.value = '';
    if (formReporterPhone) formReporterPhone.value = '';
    if (formReporterEmail) formReporterEmail.value = '';
    if (formReporterRelation) formReporterRelation.value = 'victima';

    // Limpiar campos de ubicaci√≥n
    var formLocationAddress = document.getElementById('formLocationAddress');
    var formLocationDistrict = document.getElementById('formLocationDistrict');
    var formLocationProvince = document.getElementById('formLocationProvince');
    var formLocationReference = document.getElementById('formLocationReference');
    var formLocationCoordinates = document.getElementById('formLocationCoordinates');

    if (formLocationAddress) formLocationAddress.value = '';
    if (formLocationDistrict) formLocationDistrict.value = '';
    if (formLocationProvince) formLocationProvince.value = '';
    if (formLocationReference) formLocationReference.value = '';
    if (formLocationCoordinates) formLocationCoordinates.value = '';

    // Limpiar descripci√≥n
    var formDescription = document.getElementById('formDescription');
    if (formDescription) formDescription.value = '';

    // Resetear origen a "Tel√©fono-PBX" (PHONE) - origin_id: 8 (origen del sistema)
    var formOrigin = document.getElementById('formOrigin');
    if (formOrigin) formOrigin.value = '8';

    // Resetear unidad
    var formUnit = document.getElementById('formUnit');
    if (formUnit) formUnit.value = '';

    // Resetear clasificaci√≥n
    var formClassification = document.getElementById('formClassification');
    if (formClassification) {
      formClassification.value = '';
      formClassification.disabled = true;
      formClassification.innerHTML = '<option value="">Primero seleccione una unidad</option>';
    }

    // Resetear tipo de incidencia
    var formIncidentType = document.getElementById('formIncidentType');
    if (formIncidentType) {
      formIncidentType.value = '';
      formIncidentType.disabled = true;
      formIncidentType.innerHTML = '<option value="">Primero seleccione una clasificaci√≥n</option>';
    }

    // Resetear subtipo de incidencia
    var formIncidentSubtype = document.getElementById('formIncidentSubtype');
    if (formIncidentSubtype) {
      formIncidentSubtype.value = '';
      formIncidentSubtype.disabled = true;
      formIncidentSubtype.innerHTML = '<option value="">Primero seleccione un tipo</option>';
    }

    // Resetear nivel de alerta a media
    var formAlertLevel = document.getElementById('formAlertLevel');
    if (formAlertLevel) formAlertLevel.value = 'media';

    // Limpiar marcador del mapa
    if (currentLocationMarker && cadMap) {
      cadMap.removeLayer(currentLocationMarker);
      currentLocationMarker = null;
    }
  }

  // Funci√≥n para crear un nuevo ticket usando el API desde el formulario
  function createNewTicketFromForm() {
    // VALIDACI√ìN: Verificar l√≠mites de tickets
    var counts = countActiveTickets();

    // Regla 1: M√°ximo 6 tickets pendientes
    if (counts.pending >= 6) {
      showNotification('‚ùå L√≠mite de tickets pendientes alcanzado (m√°ximo 6). Cierre algunos tickets pendientes antes de crear uno nuevo.', 'error');
      return;
    }

    // Regla 2: M√°ximo 7 tickets totales
    if (counts.total >= 7) {
      showNotification('‚ùå L√≠mite de tickets alcanzado (m√°ximo 7 tickets activos). Cierre algunos tickets antes de crear uno nuevo.', 'error');
      return;
    }

    // Recolectar datos del formulario actual
    var formAlertLevel = document.getElementById('formAlertLevel');
    var formIncidentType = document.getElementById('formIncidentType');
    var formReporterName = document.getElementById('formReporterName');
    var formReporterDNI = document.getElementById('formReporterDNI');
    var formReporterPhone = document.getElementById('formReporterPhone');
    var formReporterEmail = document.getElementById('formReporterEmail');
    var formReporterRelation = document.getElementById('formReporterRelation');
    var formLocationAddress = document.getElementById('formLocationAddress');
    var formLocationDistrict = document.getElementById('formLocationDistrict');
    var formLocationProvince = document.getElementById('formLocationProvince');
    var formLocationReference = document.getElementById('formLocationReference');
    var formLocationCoordinates = document.getElementById('formLocationCoordinates');
    var formDescription = document.getElementById('formDescription');

    // Obtener coordenadas
    var coordinates = formLocationCoordinates ? formLocationCoordinates.value.split(',') : [];
    var lat = coordinates.length > 0 ? parseFloat(coordinates[0].trim()) : null;
    var lon = coordinates.length > 1 ? parseFloat(coordinates[1].trim()) : null;

    // Validar campos obligatorios
    if (!formReporterName || !formReporterName.value.trim()) {
      showNotification('‚ùå El nombre del denunciante es obligatorio', 'error');
      return;
    }
    if (!formLocationAddress || !formLocationAddress.value.trim()) {
      showNotification('‚ùå La ubicaci√≥n es obligatoria', 'error');
      return;
    }
    if (!lat || !lon) {
      showNotification('‚ùå Las coordenadas son obligatorias. Use el mapa para seleccionar la ubicaci√≥n', 'error');
      return;
    }

    // Validar nuevos campos obligatorios
    var formDescription = document.getElementById('formDescription');
    if (!formDescription || !formDescription.value.trim()) {
      showNotification('‚ùå La descripci√≥n de la incidencia es obligatoria', 'error');
      return;
    }

    var formOrigin = document.getElementById('formOrigin');
    if (!formOrigin || !formOrigin.value) {
      showNotification('‚ùå El origen de la incidencia es obligatorio', 'error');
      return;
    }

    var formUnit = document.getElementById('formUnit');
    if (!formUnit || !formUnit.value) {
      showNotification('‚ùå La unidad es obligatoria', 'error');
      return;
    }

    var formClassification = document.getElementById('formClassification');
    if (!formClassification || !formClassification.value) {
      showNotification('‚ùå La clasificaci√≥n es obligatoria', 'error');
      return;
    }

    if (!formIncidentType || !formIncidentType.value) {
      showNotification('‚ùå El tipo de incidencia es obligatorio', 'error');
      return;
    }

    var formIncidentSubtype = document.getElementById('formIncidentSubtype');
    if (!formIncidentSubtype || !formIncidentSubtype.value) {
      showNotification('‚ùå El subtipo de incidencia es obligatorio', 'error');
      return;
    }

    // Mapear alert_level de formulario a alert_level_id de la API
    var alertLevelValue = formAlertLevel ? formAlertLevel.value : 'media';
    var alertLevelIdMap = {
      'baja': 3,    // low
      'media': 2,   // medium
      'alta': 1     // high
    };
    var alertLevelId = alertLevelIdMap[alertLevelValue] || 2;

    // Preparar datos para el API seg√∫n estructura en respuesta_api.txt
    var newIncidenceData = {
      // ========== CAMPOS OBLIGATORIOS ==========
      origin_id: formOrigin && formOrigin.value ? parseInt(formOrigin.value) : 8,  // Usar valor seleccionado o por defecto 8
      complainant: formReporterName.value.trim(),
      location: formLocationAddress.value.trim(),
      unit_id: formUnit && formUnit.value ? parseInt(formUnit.value) : 1,
      incidence_type_id: parseInt(formIncidentType.value),
      incidence_classification_id: formClassification && formClassification.value ? parseInt(formClassification.value) : null,
      incidence_subtype_id: formIncidentSubtype && formIncidentSubtype.value ? parseInt(formIncidentSubtype.value) : null,
      incidence_date: new Date().toISOString(),
      latitude: lat,
      longitude: lon,
      incidence_state_id: 1,  // Estado: Pendiente

      // ========== CAMPOS OPCIONALES ==========
      description_incidence: formDescription ? formDescription.value.trim() : '',
      contact_number: formReporterPhone ? formReporterPhone.value.trim() : '',
      document_number: formReporterDNI ? formReporterDNI.value.trim() : '',
      reporter_email: formReporterEmail ? formReporterEmail.value.trim() : null,
      reporter_relation: formReporterRelation ? formReporterRelation.value : 'third_party',
      alert_level_id: alertLevelId,
      district: formLocationDistrict ? formLocationDistrict.value.trim() : null,
      province: formLocationProvince ? formLocationProvince.value.trim() : null,
      location_reference: formLocationReference ? formLocationReference.value.trim() : '',
      telegram_chat_id: null,
      created_by: getCurrentOperatorId() || null,

      // ‚úÖ Informaci√≥n del operador que crea el ticket
      operator_id: getCurrentOperatorId(),          // Correo del operador (userid)
      operator: getCurrentOperatorName()            // Nombre completo del operador (fullname)
    };

    // Llamar al API para crear la incidencia usando callAPI
    callAPI({
      method: 'gestincidencias/incidencenew',
      post: 1,  // ‚úÖ Indica que es un POST
      params: newIncidenceData,
      ok: function (response) {
        // La API devuelve: { incidence_id: 123, incidence_code: "INC-20251211-000123" }

        // Crear ticket local con los datos de respuesta
        var newTicket = convertIncidenceToTicket({
          incidence_id: response.incidence_id,
          incidence_code: response.incidence_code,
          complainant: newIncidenceData.complainant,
          location: newIncidenceData.location,
          latitude: newIncidenceData.latitude,
          longitude: newIncidenceData.longitude,
          contact_number: newIncidenceData.contact_number,
          document_number: newIncidenceData.document_number,
          reporter_email: newIncidenceData.reporter_email,
          reporter_relation: newIncidenceData.reporter_relation,
          description_incidence: newIncidenceData.description_incidence,
          alert_level_code: alertLevelValue === 'baja' ? 'low' : (alertLevelValue === 'alta' ? 'high' : 'medium'),
          incidence_type_id: newIncidenceData.incidence_type_id,
          state_name: 'Pendiente',
          created_at: newIncidenceData.incidence_date
        });

        // Agregar ticket al estado
        ticketsState.tickets.push(newTicket);

        // Actualizar la UI
        renderTicketTabs();

        // Activar el nuevo ticket
        selectTicket(newTicket.id);
      },
      error: function (error) {
        // Ignorar errores de cancelaci√≥n (AbortError)
        if (error && (error.name === 'AbortError' || error.message?.includes('aborted') || error.status === 0)) {
          console.log('‚ö†Ô∏è Petici√≥n cancelada (createNewTicketFromForm)');
          return;
        }
        showNotification('‚ùå Error al crear el ticket: ' + (error.message || 'Error desconocido'), 'error');
      }
    });
  }
</script>

<!-- ============================================ -->
<!-- M√ìDULO 10: GUARDADO DE TICKETS (PATCH)      -->
<!-- ============================================ -->
<script>
  // Funci√≥n para limpiar objeto patch (eliminar valores undefined, strings vac√≠os, NaN)
  function cleanPatch(obj) {
    var out = {};
    Object.keys(obj).forEach(function (k) {
      var v = obj[k];

      // ignora undefined
      if (v === undefined) return;

      // ignora strings vac√≠os o solo espacios
      if (typeof v === "string" && v.trim() === "") return;

      // ignora NaN
      if (typeof v === "number" && Number.isNaN(v)) return;

      // ok
      out[k] = v;
    });
    return out;
  }

  // Funci√≥n para recolectar datos del formulario
  function collectFormData() {
    // Obtener elementos del formulario
    var formReporterName = document.getElementById('formReporterName');
    var formReporterDNI = document.getElementById('formReporterDNI');
    var formReporterPhone = document.getElementById('formReporterPhone');
    var formReporterEmail = document.getElementById('formReporterEmail');
    var formReporterRelation = document.getElementById('formReporterRelation');
    var formLocationAddress = document.getElementById('formLocationAddress');
    var formLocationDistrict = document.getElementById('formLocationDistrict');
    var formLocationProvince = document.getElementById('formLocationProvince');
    var formLocationReference = document.getElementById('formLocationReference');
    var formLocationCoordinates = document.getElementById('formLocationCoordinates');
    var formDescription = document.getElementById('formDescription');
    var formIncidentType = document.getElementById('formIncidentType');
    var formAlertLevel = document.getElementById('formAlertLevel');

    // Parsear coordenadas
    var lat = null;
    var lon = null;
    if (formLocationCoordinates && formLocationCoordinates.value) {
      var coords = formLocationCoordinates.value.split(',');
      if (coords.length === 2) {
        lat = parseFloat(coords[0].trim());
        lon = parseFloat(coords[1].trim());
      }
    }

    // Mapear alert_level de formulario a alert_level_id de la API
    var alertLevelValue = formAlertLevel ? formAlertLevel.value : 'media';
    var alertLevelIdMap = {
      'baja': 3,    // low
      'media': 2,   // medium
      'alta': 1     // high
    };
    var alertLevelId = alertLevelIdMap[alertLevelValue] || 2;

    // Obtener valores de los nuevos campos
    var formOrigin = document.getElementById('formOrigin');
    var formUnit = document.getElementById('formUnit');
    var formClassification = document.getElementById('formClassification');
    var formIncidentSubtype = document.getElementById('formIncidentSubtype');

    // Obtener el origin_id del ticket actual (si est√° editando uno existente)
    var currentTicket = ticketsState.tickets.find(t => t.id === ticketsState.activeTicketId);
    var originId = 8; // Por defecto: Tel√©fono-PBX
    if (currentTicket && currentTicket.origin_id) {
      // Si est√° editando un ticket existente, mantener su origin_id original
      originId = currentTicket.origin_id;
    }

    return {
      // Campos del formulario
      complainant: formReporterName ? formReporterName.value.trim() : '',
      document_number: formReporterDNI ? formReporterDNI.value.trim() : '',
      contact_number: formReporterPhone ? formReporterPhone.value.trim() : '',
      reporter_email: formReporterEmail ? formReporterEmail.value.trim() : '',
      reporter_relation: formReporterRelation ? formReporterRelation.value : 'victima',
      location: formLocationAddress ? formLocationAddress.value.trim() : '',
      district: formLocationDistrict ? formLocationDistrict.value.trim() : '',
      province: formLocationProvince ? formLocationProvince.value.trim() : '',
      location_reference: formLocationReference ? formLocationReference.value.trim() : '',
      latitude: lat,
      longitude: lon,
      description_incidence: formDescription ? formDescription.value.trim() : '',
      incidence_type_id: formIncidentType && formIncidentType.value ? parseInt(formIncidentType.value) : null,
      incidence_subtype_id: formIncidentSubtype && formIncidentSubtype.value ? parseInt(formIncidentSubtype.value) : null,
      alert_level_id: alertLevelId,

      // ‚úÖ CAMPOS CON VALORES DEL FORMULARIO
      unit_id: formUnit && formUnit.value ? parseInt(formUnit.value) : 1,
      incidence_classification_id: formClassification && formClassification.value ? parseInt(formClassification.value) : null,
      origin_id: originId,  // Mantiene el origen original del ticket, o usa 8 si es nuevo

      // Campos para el endpoint incidenceupt
      updated_by: getCurrentOperatorId() || 1
    };
  }

  // ‚úÖ Ya no hay guardado autom√°tico de borradores
  // El guardado se hace manualmente con el bot√≥n "Guardar Cambios"

  // Funci√≥n para activar una incidencia (cambiar de borrador a pendiente)
  function activateIncidence() {
    var ticket = ticketsState.tickets.find(function (t) {
      return t.id === ticketsState.activeTicketId;
    });

    if (!ticket || !ticket.isDraft) {
      showNotification('‚ùå No hay un borrador activo para activar', 'error');
      return;
    }

    // Validar campos obligatorios
    var formIncidentType = document.getElementById('formIncidentType');
    var formDescription = document.getElementById('formDescription');
    var formAlertLevel = document.getElementById('formAlertLevel');

    if (!formIncidentType || !formIncidentType.value) {
      showNotification('‚ùå El tipo de incidencia es obligatorio para activar', 'error');
      return;
    }

    if (!formDescription || !formDescription.value.trim()) {
      showNotification('‚ùå La descripci√≥n es obligatoria para activar', 'error');
      return;
    }

    // Recolectar datos del formulario y limpiar
    var formData = collectFormData();
    var patchData = cleanPatch(formData);

    // Agregar campos obligatorios para activar
    patchData.incidence_id = ticket.incidence_id;
    patchData.incidence_state_id = 1; // Cambiar a Pendiente

    // Llamar al API con PATCH para actualizar y activar
    callAPI({
      method: 'gestincidencias/incidenceupt',
      post: 1,
      params: patchData,
      ok: function (response) {
        // Actualizar ticket local
        Object.assign(ticket, patchData);
        ticket.isDraft = false;
        ticket.incidence_state_id = 1;
        ticket.status = 'Pendiente';
        ticket.state_name = 'Pendiente';
        ticket.lastModified = new Date().toISOString();

        // Actualizar UI
        renderTicketTabs();
        updateSaveButtonText();

        // showNotification('‚úÖ Incidencia activada correctamente', 'success');
      },
      error: function (error) {
        // üëá Ignorar AbortError
        if (error && (error.name === 'AbortError' || error.message?.includes('aborted'))) {
          return;
        }
        showNotification('‚ùå Error al activar incidencia: ' + (error.message || 'Error desconocido'), 'error');
      }
    });
  }

  // ‚úÖ Ya no es necesario - guardado solo manual con bot√≥n
</script>

<!-- ============================================ -->
<!-- M√ìDULO 11: CIERRE DE TICKETS                -->
<!-- ============================================ -->
<script>
  // Funci√≥n para mostrar modal de cierre de ticket
  function closeTicketWithReason() {
    if (!ticketsState.activeTicketId) {
      showNotification('No hay ning√∫n ticket activo para cerrar', 'warning');
      return;
    }

    var ticket = ticketsState.tickets.find(function (t) { return t.id === ticketsState.activeTicketId; });
    if (!ticket) return;

    // Verificar que el ticket no est√© ya cerrado
    if (ticket.status === 'cerrado') {
      showNotification('Este ticket ya est√° cerrado', 'info');
      return;
    }

    // Actualizar informaci√≥n del ticket en el modal
    var modalInfo = document.getElementById('closeTicketModalInfo');
    if (modalInfo) {
      modalInfo.textContent = 'Ticket ' + ticket.id + ' - ' + ticket.incidentType;
    }

    // Limpiar campos
    $('#closeTicketReason').val('');
    $('#closeTicketObservations').val('');

    // Resetear radio buttons a "mantener tipo actual"
    $('input[name="closeIncidenceAction"][value="keep"]').prop('checked', true);

    // Ocultar el bot√≥n de cambiar tipo
    var buttonContainer = document.getElementById('changeIncidenceButtonContainer');
    if (buttonContainer) {
      buttonContainer.style.display = 'none';
    }

    // Resetear label de status
    var statusLabel = document.getElementById('closeIncidenceStatusLabel');
    if (statusLabel) {
      statusLabel.textContent = 'actual';
    }

    // Mostrar tipo de incidencia actual
    displayCurrentIncidenceTypeForClose(ticket);

    // Limpiar campos ocultos de nuevo tipo
    $('#closeTicketNewUnitId').val('');
    $('#closeTicketNewClassificationId').val('');
    $('#closeTicketNewTypeId').val('');
    $('#closeTicketNewSubtypeId').val('');

    // Mostrar modal
    $('#closeTicketModal').modal('show');
  }

  // Funci√≥n para mostrar el tipo de incidencia actual en el modal de cierre
  function displayCurrentIncidenceTypeForClose(ticket) {
    var pathElement = document.getElementById('closeTicketIncidencePath');
    if (!pathElement) return;

    // Obtener los valores actuales del formulario
    var unitSelect = document.getElementById('formIncidentUnit');
    var classificationSelect = document.getElementById('formIncidentClassification');
    var typeSelect = document.getElementById('formIncidentType');
    var subtypeSelect = document.getElementById('formIncidentSubtype');

    var unitText = unitSelect && unitSelect.options[unitSelect.selectedIndex]
      ? unitSelect.options[unitSelect.selectedIndex].text
      : 'N/A';
    var classificationText = classificationSelect && classificationSelect.options[classificationSelect.selectedIndex]
      ? classificationSelect.options[classificationSelect.selectedIndex].text
      : 'N/A';
    var typeText = typeSelect && typeSelect.options[typeSelect.selectedIndex]
      ? typeSelect.options[typeSelect.selectedIndex].text
      : 'N/A';
    var subtypeText = subtypeSelect && subtypeSelect.options[subtypeSelect.selectedIndex]
      ? subtypeSelect.options[subtypeSelect.selectedIndex].text
      : 'N/A';

    // Mostrar la ruta completa
    pathElement.innerHTML =
      '<strong>' + unitText + '</strong> ‚Üí ' +
      '<strong>' + classificationText + '</strong> ‚Üí ' +
      '<strong>' + typeText + '</strong> ‚Üí ' +
      '<strong>' + subtypeText + '</strong>';
  }

  // Funci√≥n para abrir el selector de tipo de incidencia desde el modal de cierre
  function openIncidenceTypeSelectorForClose() {
    // Guardar un flag para saber que estamos en modo "cierre"
    window.incidenceTypeSelectorMode = 'close';

    // Abrir el modal del selector
    $('#incidenceTypeModal').modal('show');
  }

  // Funci√≥n para manejar el cambio de radio button (mantener o cambiar tipo)
  function toggleIncidenceTypeChange() {
    var selectedAction = $('input[name="closeIncidenceAction"]:checked').val();
    var buttonContainer = document.getElementById('changeIncidenceButtonContainer');
    var statusLabel = document.getElementById('closeIncidenceStatusLabel');

    if (selectedAction === 'change') {
      // Mostrar el bot√≥n para seleccionar nuevo tipo
      buttonContainer.style.display = 'block';
      statusLabel.textContent = 'actual';
    } else {
      // Ocultar el bot√≥n y limpiar los campos ocultos
      buttonContainer.style.display = 'none';
      statusLabel.textContent = 'actual';

      // Limpiar los valores seleccionados anteriormente
      $('#closeTicketNewUnitId').val('');
      $('#closeTicketNewClassificationId').val('');
      $('#closeTicketNewTypeId').val('');
      $('#closeTicketNewSubtypeId').val('');

      // Restaurar la vista del tipo actual
      var ticket = ticketsState.tickets.find(function (t) {
        return t.id === ticketsState.activeTicketId;
      });
      if (ticket) {
        displayCurrentIncidenceTypeForClose(ticket);
      }
    }
  }

  // Funci√≥n para cancelar cierre de ticket
  function cancelCloseTicket() {
    $('#closeTicketModal').modal('hide');
    $('.modal-backdrop').remove();
  }

  // Funci√≥n para confirmar cierre de ticket desde el modal
  function confirmCloseTicket() {
    var reason = $('#closeTicketReason').val();
    var observations = $('#closeTicketObservations').val().trim();

    // Validar campos
    if (!reason) {
      showNotification('Debe seleccionar un motivo de cierre', 'warning');
      return;
    }

    if (!observations) {
      showNotification('Debe ingresar observaciones', 'warning');
      return;
    }

    var ticket = ticketsState.tickets.find(function (t) { return t.id === ticketsState.activeTicketId; });
    if (ticket) {
      var fullReason = reason + ': ' + observations;

      // Verificar si el usuario eligi√≥ cambiar el tipo de incidencia
      var selectedAction = $('input[name="closeIncidenceAction"]:checked').val();
      var incidenceTypeChanged = false;
      var newIncidenceType = null;

      if (selectedAction === 'change') {
        // El usuario quiere cambiar el tipo - verificar que haya seleccionado uno nuevo
        var newUnitId = $('#closeTicketNewUnitId').val();
        var newClassificationId = $('#closeTicketNewClassificationId').val();
        var newTypeId = $('#closeTicketNewTypeId').val();
        var newSubtypeId = $('#closeTicketNewSubtypeId').val();

        if (!newSubtypeId) {
          showNotification('Debe seleccionar un nuevo tipo de incidencia o elegir "cerrar con tipo actual"', 'warning');
          return;
        }

        incidenceTypeChanged = true;
        newIncidenceType = {
          unit_id: newUnitId,
          classification_id: newClassificationId,
          type_id: newTypeId,
          subtype_id: newSubtypeId
        };
        console.log('üìù Tipo de incidencia cambiado al cerrar:', newIncidenceType);
      } else {
        console.log('üìù Cerrando con tipo de incidencia actual');
      }

      closeTicket(ticket, fullReason, incidenceTypeChanged, newIncidenceType);
      $('#closeTicketModal').modal('hide');
      $('.modal-backdrop').remove();
    }
  }

  // Funci√≥n para cerrar el ticket
  function closeTicket(ticket, reason, incidenceTypeChanged, newIncidenceType) {
    if (!ticket || !ticket.incidence_id) {
      showNotification('‚ùå Error: No se puede cerrar el ticket', 'error');
      return;
    }

    // Recolectar datos del formulario actual
    var formData = collectFormData();
    var patchData = cleanPatch(formData);

    // Agregar campos espec√≠ficos para el cierre
    patchData.incidence_id = ticket.incidence_id;
    patchData.incidence_state_id = 3;  // Estado 3 = Cerrado/Concluido
    patchData.close_reason = reason;   // Motivo del cierre

    // Si se cambi√≥ el tipo de incidencia, actualizar los campos
    if (incidenceTypeChanged && newIncidenceType) {
      patchData.unit_id = newIncidenceType.unit_id;
      patchData.incidence_classification_id = newIncidenceType.classification_id;
      patchData.incidence_type_id = newIncidenceType.type_id;
      patchData.incidence_subtype_id = newIncidenceType.subtype_id;
      console.log('‚úÖ Tipo de incidencia actualizado en el cierre');
    }

    // Llamar al API para cerrar el ticket en el backend
    callAPI({
      method: 'gestincidencias/incidenceupt',
      post: 1,
      params: patchData,
      ok: function(response) {
        console.log('‚úÖ Ticket cerrado en el backend:', response);

        // Actualizar estado del ticket localmente
        ticket.status = 'Cerrado';
        ticket.state_name = 'Cerrado';
        ticket.incidence_state_id = 3;
        ticket.closedAt = new Date().toLocaleString('es-ES');
        ticket.closeReason = reason;

        // Agregar evento de cierre al chat
        var now = new Date();
        var timeString = now.getHours() + ':' + String(now.getMinutes()).padStart(2, '0');

        var closeEvent = {
          type: 'event',
          icon: '‚úÖ',
          title: 'Ticket cerrado',
          detail: 'Motivo: ' + reason,
          timestamp: timeString
        };

        if (!ticket.chatMessages) {
          ticket.chatMessages = [];
        }
        ticket.chatMessages.push(closeEvent);

        // Remover el ticket de la lista (ya que est√° cerrado)
        var ticketIndex = ticketsState.tickets.findIndex(function (t) { return t.id === ticket.id; });
        if (ticketIndex !== -1) {
          ticketsState.tickets.splice(ticketIndex, 1);
        }

        // Actualizar tabs
        renderTicketTabs();

        // Si no hay m√°s tickets, limpiar formulario y chat
        if (ticketsState.tickets.length === 0) {
          ticketsState.activeTicketId = null;
          clearFormAndChat();
        } else {
          // Seleccionar el primer ticket disponible
          selectTicket(ticketsState.tickets[0].id);
        }

        // showNotification('‚úÖ Ticket ' + ticket.id + ' cerrado exitosamente', 'success');
      },
      error: function(error) {
        // Ignorar AbortError
        if (error && (error.name === 'AbortError' || error.message?.includes('aborted') || error.status === 0)) {
          console.log('‚ö†Ô∏è Petici√≥n cancelada (closeTicket)');
          return;
        }
        console.error('‚ùå Error al cerrar ticket:', error);
        showNotification('‚ùå Error al cerrar el ticket: ' + (error.message || 'Error desconocido'), 'error');
      }
    });
  }

  // Funci√≥n para limpiar formulario y chat cuando no hay tickets
  function clearFormAndChat() {
    // Limpiar formulario
    var formTicketHeader = document.getElementById('formTicketHeader');
    if (formTicketHeader) formTicketHeader.textContent = 'Sin ticket activo';

    var formIncidentId = document.getElementById('formIncidentId');
    if (formIncidentId) formIncidentId.value = '';

    // Limpiar chat
    var chatTimeline = document.getElementById('chatTimeline');
    if (chatTimeline) {
      chatTimeline.innerHTML = '<div style="text-align: center; padding: 40px; color: #9ca3af;">No hay mensajes</div>';
    }

    var chatTicketId = document.getElementById('chatTicketId');
    if (chatTicketId) chatTicketId.textContent = '-';

    var chatTicketStatus = document.getElementById('chatTicketStatus');
    if (chatTicketStatus) chatTicketStatus.textContent = '-';
  }
</script>

<!-- ============================================ -->
<!-- M√ìDULO 16: GUARDADO DE TICKETS (BOT√ìN)      -->
<!-- ============================================ -->
<script>
  // ‚úÖ Funci√≥n para guardar cambios del ticket (SOLO MANUAL - al presionar bot√≥n)
  // ‚úÖ SIN VALIDACIONES - Permite guardar en cualquier momento con cualquier dato
  function saveTicketChanges() {
    if (!ticketsState.activeTicketId) {
      showNotification('No hay ning√∫n ticket activo para guardar', 'warning');
      return;
    }

    var ticket = ticketsState.tickets.find(function (t) { return t.id === ticketsState.activeTicketId; });
    if (!ticket) return;

    // 1Ô∏è‚É£ Si es un ticket nuevo (sin ID de BD), crear con incidencenew
    if (ticket.isNew === true) {
      createNewTicketFromForm();
      return;
    }

    // 2Ô∏è‚É£ Si tiene incidence_id, actualizar con incidenceupt
    if (ticket.incidence_id) {
      var formData = collectFormData();
      var patchData = cleanPatch(formData);

      // ‚úÖ Siempre agregar incidence_id, incluso si no hay cambios
      patchData.incidence_id = ticket.incidence_id;

      // üîí Deshabilitar bot√≥n mientras guarda
      var saveBtn = document.getElementById('saveTicketBtn');
      if (saveBtn) {
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="pe-7s-refresh-2" style="animation: spin 1s linear infinite;"></i> Guardando...';
      }

      // ‚úÖ Funci√≥n helper para resetear el bot√≥n SIEMPRE
      function resetSaveButton() {
        if (saveBtn) {
          saveBtn.disabled = false;
          saveBtn.innerHTML = '<i class="pe-7s-diskette"></i> Guardar Cambios';
        }
      }

      // üì§ Llamar a incidenceupt
      callAPI({
        method: 'gestincidencias/incidenceupt',
        post: 1,
        params: patchData,
        ok: function (response) {
          // ‚úÖ Actualizar ticket local con los campos enviados
          Object.assign(ticket, patchData);
          ticket.lastModified = new Date().toISOString();

          // ‚úÖ Actualizar alertLevel en el formato del frontend (baja/media/alta)
          var formAlertLevel = document.getElementById('formAlertLevel');
          if (formAlertLevel && formAlertLevel.value) {
            ticket.alertLevel = formAlertLevel.value;
          }

          // ‚úÖ Actualizar UI (esto refrescar√° los tabs con el nuevo nivel de alerta)
          renderTicketTabs();

          // üîì Rehabilitar bot√≥n SIEMPRE
          resetSaveButton();

          // ‚úÖ Notificaci√≥n de guardado exitoso
          // showNotification('‚úÖ Cambios guardados correctamente', 'success');
        },
        error: function (error) {
          // üîì Rehabilitar bot√≥n SIEMPRE (incluso si hay error)
          resetSaveButton();

          // ‚ö†Ô∏è Verificar si realmente es un error o si los datos se guardaron
          console.log('Error al guardar (verificar si datos se guardaron):', error);

          // Ignorar AbortError (no deber√≠a ocurrir sin auto-guardado, pero por si acaso)
          if (error && (error.name === 'AbortError' || error.message?.includes('aborted') || error.status === 0)) {
            console.warn('‚ö†Ô∏è Petici√≥n cancelada - Datos pueden haberse guardado');
            // ‚úÖ Actualizar ticket de todas formas por si acaso se guard√≥
            Object.assign(ticket, patchData);
            renderTicketTabs();
            return;
          }

          // ‚ö†Ô∏è Mostrar advertencia en lugar de error (porque los datos pueden haberse guardado)
          showNotification('‚ö†Ô∏è Respuesta inesperada del servidor. Verifique si los datos se guardaron.', 'warning');

          // ‚úÖ Actualizar ticket localmente de todas formas
          Object.assign(ticket, patchData);
          renderTicketTabs();
        }
      });
      return;
    }

    // 3Ô∏è‚É£ Fallback: Si no tiene incidence_id (caso raro), guardar solo localmente
    ticket.alertLevel = document.getElementById('formAlertLevel')?.value || ticket.alertLevel;
    ticket.incidentType = document.getElementById('formIncidentType')?.value || ticket.incidentType;
    ticket.reporterName = document.getElementById('formReporterName')?.value || ticket.reporterName;
    ticket.lastModified = new Date().toLocaleString('es-ES');
    renderTicketTabs();
    showNotification('‚ö†Ô∏è Guardado solo localmente (sin ID de BD)', 'warning');
  }
</script>


<!-- ============================================ -->
<!-- M√ìDULO 18: SISTEMA DE AUTOGUARDADO          -->
<!-- ============================================ -->
<script>
  // üî• SISTEMA DE AUTOGUARDADO INTELIGENTE
  // - Debounce: Guarda 5 segundos despu√©s de dejar de escribir
  // - Peri√≥dico: Guarda cada 30 segundos si hay cambios
  // - Indicador visual de estado

  var autoSaveState = {
    debounceTimer: null,
    periodicTimer: null,
    lastSavedData: null,
    hasUnsavedChanges: false,
    isSaving: false,
    lastSaveTime: null
  };

  /**
   * Funci√≥n para obtener un hash simple de los datos del formulario
   * Esto nos permite detectar cambios sin comparar objeto por objeto
   */
  function getFormDataHash() {
    var formData = collectFormData();
    var cleanedData = cleanPatch(formData);
    return JSON.stringify(cleanedData);
  }

  /**
   * Funci√≥n para detectar si hay cambios no guardados
   */
  function hasFormChanges() {
    var currentHash = getFormDataHash();
    return currentHash !== autoSaveState.lastSavedData;
  }

  /**
   * Actualizar indicador visual de estado de guardado
   */
  function updateSaveIndicator(status) {
    var saveBtn = document.getElementById('saveTicketBtn');
    if (!saveBtn) return;

    var icon = '<i class="pe-7s-diskette"></i>';
    var text = 'Guardar Cambios';
    var extraClass = '';

    if (status === 'saving') {
      icon = '<i class="pe-7s-refresh-2" style="animation: spin 1s linear infinite;"></i>';
      text = 'Guardando...';
      saveBtn.disabled = true;
    } else if (status === 'saved') {
      icon = '<i class="pe-7s-check"></i>';
      text = 'Guardado ‚úì';
      saveBtn.disabled = false;
      extraClass = ' btn-success';

      // Volver a estado normal despu√©s de 2 segundos
      setTimeout(function() {
        if (!autoSaveState.isSaving) {
          updateSaveIndicator('idle');
        }
      }, 2000);
    } else if (status === 'unsaved') {
      icon = '<i class="pe-7s-diskette"></i>';
      text = 'Guardar Cambios ‚óè';
      saveBtn.disabled = false;
    } else { // idle
      icon = '<i class="pe-7s-diskette"></i>';
      text = 'Guardar Cambios';
      saveBtn.disabled = false;
    }

    saveBtn.innerHTML = icon + ' ' + text;
    saveBtn.className = 'btn btn-accent' + extraClass;
  }

  /**
   * Funci√≥n principal de autoguardado
   */
  function autoSaveTicket() {
    // Verificar que hay un ticket activo
    if (!ticketsState.activeTicketId) {
      console.log('‚ö†Ô∏è No hay ticket activo para autoguardar');
      return;
    }

    var ticket = ticketsState.tickets.find(function(t) { return t.id === ticketsState.activeTicketId; });
    if (!ticket) return;

    // No autoguardar tickets nuevos sin ID de BD
    if (ticket.isNew === true || !ticket.incidence_id) {
      console.log('‚ö†Ô∏è Ticket nuevo - autoguardado deshabilitado (use bot√≥n manual)');
      return;
    }

    // Verificar si hay cambios
    if (!hasFormChanges()) {
      console.log('‚úì Sin cambios - autoguardado omitido');
      autoSaveState.hasUnsavedChanges = false;
      return;
    }

    // Evitar guardados concurrentes
    if (autoSaveState.isSaving) {
      console.log('‚è≥ Ya hay un guardado en proceso - omitiendo');
      return;
    }

    console.log('üíæ Autoguardando ticket...');
    autoSaveState.isSaving = true;
    updateSaveIndicator('saving');

    // Recolectar y limpiar datos
    var formData = collectFormData();
    var patchData = cleanPatch(formData);
    patchData.incidence_id = ticket.incidence_id;

    // Si es borrador, cambiar a "En proceso" al autoguardar
    var wasActivated = false;
    if (ticket.incidence_state_id === 6 || ticket.isDraft === true) {
      patchData.incidence_state_id = 2;
      patchData.operator_id = getCurrentOperatorId();      // ‚úÖ Correo del operador
      patchData.operator = getCurrentOperatorName();       // ‚úÖ Nombre del operador
      wasActivated = true;
    }

    // Llamar a la API
    callAPI({
      method: 'gestincidencias/incidenceupt',
      post: 1,
      params: patchData,
      ok: function(response) {
        console.log('‚úÖ Autoguardado exitoso');

        // Actualizar ticket local
        Object.assign(ticket, patchData);
        ticket.lastModified = new Date().toISOString();

        if (wasActivated) {
          ticket.isDraft = false;
          ticket.incidence_state_id = 2;
          ticket.state_name = 'En proceso';
          ticket.status = 'En proceso';
        }

        // Actualizar estado de autoguardado
        autoSaveState.lastSavedData = getFormDataHash();
        autoSaveState.hasUnsavedChanges = false;
        autoSaveState.isSaving = false;
        autoSaveState.lastSaveTime = new Date();

        // Actualizar UI
        renderTicketTabs();
        updateSaveIndicator('saved');
      },
      error: function(error) {
        console.error('‚ùå Error en autoguardado:', error);
        autoSaveState.isSaving = false;

        // Ignorar AbortError
        if (error && (error.name === 'AbortError' || error.message?.includes('aborted') || error.status === 0)) {
          console.warn('‚ö†Ô∏è Petici√≥n cancelada - Datos pueden haberse guardado');
          autoSaveState.lastSavedData = getFormDataHash();
          autoSaveState.hasUnsavedChanges = false;
          Object.assign(ticket, patchData);
          renderTicketTabs();
          updateSaveIndicator('saved');
          return;
        }

        // En caso de error, marcar como no guardado
        updateSaveIndicator('unsaved');
      }
    });
  }

  /**
   * Debounce: Guardar despu√©s de 5 segundos de inactividad
   */
  function triggerDebounceAutoSave() {
    // Limpiar timer anterior
    if (autoSaveState.debounceTimer) {
      clearTimeout(autoSaveState.debounceTimer);
    }

    // Marcar como cambios no guardados
    autoSaveState.hasUnsavedChanges = true;
    updateSaveIndicator('unsaved');

    // Crear nuevo timer de 5 segundos
    autoSaveState.debounceTimer = setTimeout(function() {
      console.log('‚è±Ô∏è Debounce activado - autoguardando...');
      autoSaveTicket();
    }, 5000); // 5 segundos
  }

  /**
   * Guardado peri√≥dico cada 30 segundos
   */
  function startPeriodicAutoSave() {
    // Limpiar timer anterior si existe
    if (autoSaveState.periodicTimer) {
      clearInterval(autoSaveState.periodicTimer);
    }

    // Crear nuevo interval de 30 segundos
    autoSaveState.periodicTimer = setInterval(function() {
      // Solo guardar si hay cambios no guardados
      if (autoSaveState.hasUnsavedChanges && !autoSaveState.isSaving) {
        console.log('‚è∞ Guardado peri√≥dico activado...');
        autoSaveTicket();
      }
    }, 30000); // 30 segundos

    console.log('‚úÖ Autoguardado peri√≥dico iniciado (cada 30s)');
  }

  /**
   * Detener autoguardado
   */
  function stopAutoSave() {
    if (autoSaveState.debounceTimer) {
      clearTimeout(autoSaveState.debounceTimer);
    }
    if (autoSaveState.periodicTimer) {
      clearInterval(autoSaveState.periodicTimer);
    }
    console.log('üõë Autoguardado detenido');
  }

  /**
   * Inicializar autoguardado en todos los campos del formulario
   */
  function initializeAutoSave() {
    // Lista de todos los campos que disparan autoguardado
    var formFields = [
      'formReporterName',
      'formReporterDNI',
      'formReporterPhone',
      'formReporterEmail',
      'formReporterRelation',
      'formAlertLevel',
      'formOrigin',
      'formUnit',
      'formClassification',
      'formIncidentType',
      'formIncidentSubtype',
      'formLocationAddress',
      'formLocationDistrict',
      'formLocationProvince',
      'formLocationReference',
      'formLocationCoordinates',
      'formDescription',
      'formMissingName',
      'formMissingAge',
      'formMissingGender',
      'formMissingDNI',
      'formMissingLastSeen',
      'formMissingLastLocation',
      'formMissingDescription',
      'formMissingMedical',
      'formSuspiciousName',
      'formSuspiciousAlias',
      'formSuspiciousDescription',
      'formSuspiciousReason',
      'formSuspiciousLocation',
      'formSuspiciousLinked',
      'formSuspVehiclePlate',
      'formSuspVehicleType',
      'formSuspVehicleColor',
      'formSuspVehicleDetails',
      'formSuspVehicleLocation',
      'formSuspVehicleTime',
      'formSuspVehicleBehavior',
      'formVehicleType',
      'formVehicleBrand',
      'formVehiclePlate',
      'formVehicleColor',
      'formVehicleYear',
      'formVehicleLocation',
      'formVehicleDateTime',
      'formVehicleGPS'
    ];

    // Agregar listeners a todos los campos
    formFields.forEach(function(fieldId) {
      var field = document.getElementById(fieldId);
      if (field) {
        // Para inputs y selects
        field.addEventListener('input', triggerDebounceAutoSave);
        field.addEventListener('change', triggerDebounceAutoSave);
      }
    });

    // Iniciar guardado peri√≥dico
    startPeriodicAutoSave();

    // Guardar hash inicial
    setTimeout(function() {
      autoSaveState.lastSavedData = getFormDataHash();
    }, 1000);

    console.log('‚úÖ Sistema de autoguardado inicializado');
    console.log('   - Debounce: 5 segundos despu√©s de escribir');
    console.log('   - Peri√≥dico: cada 30 segundos si hay cambios');
  }

  /**
   * Modificar saveTicketChanges para actualizar el hash despu√©s de guardado manual
   */
  var originalSaveTicketChanges = saveTicketChanges;
  saveTicketChanges = function() {
    originalSaveTicketChanges();

    // Actualizar hash despu√©s de guardado manual
    setTimeout(function() {
      autoSaveState.lastSavedData = getFormDataHash();
      autoSaveState.hasUnsavedChanges = false;
      updateSaveIndicator('saved');
    }, 1000);
  };

  // Inicializar cuando el DOM est√© listo
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(initializeAutoSave, 2000);
    });
  } else {
    setTimeout(initializeAutoSave, 2000);
  }

  // Exponer funciones globalmente
  window.autoSaveTicket = autoSaveTicket;
  window.stopAutoSave = stopAutoSave;
  window.startPeriodicAutoSave = startPeriodicAutoSave;
  window.triggerDebounceAutoSave = triggerDebounceAutoSave;

  /**
   * üö™ GUARDAR ANTES DE SALIR DE LA P√ÅGINA
   * Detecta cuando el usuario abandona la p√°gina (cambia de m√≥dulo, cierra pesta√±a, etc.)
   */
  window.addEventListener('beforeunload', function(event) {
    var activeTicket = ticketsState.tickets.find(function(t) {
      return t.id === ticketsState.activeTicketId;
    });

    // Si hay cambios sin guardar en el ticket activo
    if (activeTicket && activeTicket.incidence_id && autoSaveState.hasUnsavedChanges) {
      console.log('üö™ Guardando cambios antes de salir de la p√°gina...');

      // Recopilar datos del formulario
      var formData = collectFormData();
      var patchData = cleanPatch(formData);
      patchData.incidence_id = activeTicket.incidence_id;

      // Usar sendBeacon si est√° disponible (m√©todo recomendado para beforeunload)
      if (navigator.sendBeacon) {
        var apiUrl = window.location.origin + '/api.php';
        var payload = new FormData();
        payload.append('method', 'gestincidencias/incidenceupt');
        payload.append('params', JSON.stringify(patchData));

        // sendBeacon env√≠a los datos de forma as√≠ncrona pero garantiza que se env√≠en
        navigator.sendBeacon(apiUrl, payload);
        console.log('‚úÖ Datos enviados con sendBeacon');
      } else {
        // Fallback: AJAX sincr√≥nico (menos recomendado pero funcional)
        var xhr = new XMLHttpRequest();
        xhr.open('POST', window.location.origin + '/api.php', false); // false = s√≠ncrono
        xhr.setRequestHeader('Content-Type', 'application/json');

        try {
          xhr.send(JSON.stringify({
            method: 'gestincidencias/incidenceupt',
            params: patchData
          }));
          console.log('‚úÖ Datos guardados s√≠ncronamente');
        } catch (e) {
          console.error('‚ùå Error al guardar:', e);
        }
      }

      // Marcar como guardado para evitar m√∫ltiples guardados
      autoSaveState.hasUnsavedChanges = false;

      // Opcional: Mostrar mensaje al usuario (los navegadores modernos pueden ignorarlo)
      // event.preventDefault();
      // event.returnValue = '';
    }
  });

  console.log('‚úÖ M√≥dulo de autoguardado cargado (con protecci√≥n al salir)');
</script>

<style>
  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }
</style>
