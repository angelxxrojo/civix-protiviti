<!-- ============================================ -->
<!-- MÃ“DULO 20: MENSAJE DE TELEGRAM              -->
<!-- ============================================ -->
<script>
  // FunciÃ³n para generar el mensaje de Telegram basado en el formulario
  function generateTelegramMessage() {
    // Obtener valores del formulario
    var ticketId = document.getElementById('formIncidentId')?.value || 'Nuevo';
    var alertLevel = document.getElementById('formAlertLevel')?.value || 'media';
    var incidentTypeEl = document.getElementById('formIncidentType');
    var incidentType = incidentTypeEl?.options[incidentTypeEl.selectedIndex]?.text || 'Sin especificar';

    var reporterName = document.getElementById('formReporterName')?.value || '';
    var reporterPhone = document.getElementById('formReporterPhone')?.value || '';
    var reporterDNI = document.getElementById('formReporterDNI')?.value || '';

    var locationAddress = document.getElementById('formLocationAddress')?.value || '';
    var locationDistrict = document.getElementById('formLocationDistrict')?.value || '';
    var locationReference = document.getElementById('formLocationReference')?.value || '';
    var locationCoords = document.getElementById('formLocationCoordinates')?.value || '';

    var description = document.getElementById('formDescription')?.value || '';

    // Mapear nivel de alerta a emoji y texto
    var alertEmoji = 'ğŸŸ¡';
    var alertText = 'MEDIA';
    if (alertLevel === 'critica') {
      alertEmoji = 'ğŸ”´';
      alertText = 'CRÃTICA';
    } else if (alertLevel === 'alta') {
      alertEmoji = 'ğŸŸ ';
      alertText = 'ALTA';
    } else if (alertLevel === 'baja') {
      alertEmoji = 'ğŸŸ¢';
      alertText = 'BAJA';
    }

    // Parsear coordenadas para Google Maps
    var googleMapsLink = '';
    if (locationCoords) {
      var coords = locationCoords.split(',');
      if (coords.length === 2) {
        var lat = coords[0].trim();
        var lon = coords[1].trim();
        googleMapsLink = 'https://maps.google.com/?q=' + lat + ',' + lon;
      }
    }

    // Obtener hora actual
    var now = new Date();
    var timeString = String(now.getHours()).padStart(2, '0') + ':' + String(now.getMinutes()).padStart(2, '0');

    // Construir el mensaje
    var message = '';
    message += 'ğŸš¨ EMERGENCIA - ALERTA ' + alertText + ' ' + alertEmoji + '\n';
    message += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n';

    // Tipo de incidente
    if (incidentType && incidentType !== 'Sin especificar' && incidentType !== 'Seleccionar') {
      message += 'ğŸ“‹ TIPO: ' + incidentType + '\n\n';
    }

    // InformaciÃ³n del denunciante
    if (reporterName) {
      message += 'ğŸ‘¤ DENUNCIANTE: ' + reporterName;
      if (reporterDNI) {
        message += ' | DNI: ' + reporterDNI;
      }
      message += '\n';
      if (reporterPhone) {
        message += 'ğŸ“ Contacto: ' + reporterPhone + '\n';
      }
      message += '\n';
    }

    // UbicaciÃ³n
    if (locationAddress || locationDistrict) {
      message += 'ğŸ“ UBICACIÃ“N: ';
      if (locationAddress) {
        message += locationAddress;
        if (locationDistrict) {
          message += ', ' + locationDistrict;
        }
        message += '\n';
      }
      if (locationReference) {
        message += 'ğŸ”– Ref: ' + locationReference + '\n';
      }
      if (googleMapsLink) {
        message += 'ğŸ—ºï¸ Mapa: ' + googleMapsLink + '\n';
      }
      message += '\n';
    }

    // DescripciÃ³n
    if (description) {
      message += 'ğŸ“ DESCRIPCIÃ“N:\n';
      message += description + '\n\n';
    }

    // InformaciÃ³n adicional
    message += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n';
    message += 'â° Hora: ' + timeString + '\n';
    message += 'ğŸ†” Ticket: ' + ticketId;

    return message;
  }

  // FunciÃ³n para llenar el input del chat con el mensaje de Telegram
  function fillTelegramMessage() {
    var chatInput = document.getElementById('chatComposerInput');
    if (!chatInput) {
      showNotification('âš ï¸ No se encontrÃ³ el Ã¡rea de chat', 'warning');
      return;
    }

    // Generar el mensaje
    var message = generateTelegramMessage();

    // Validar que hay suficiente informaciÃ³n
    var reporterName = document.getElementById('formReporterName')?.value || '';
    var locationAddress = document.getElementById('formLocationAddress')?.value || '';

    if (!reporterName || !locationAddress) {
      showNotification('âš ï¸ Complete al menos el nombre del denunciante y la ubicaciÃ³n', 'warning');
      return;
    }

    // Llenar el input
    chatInput.value = message;

    // Ajustar altura del textarea automÃ¡ticamente
    chatInput.style.height = 'auto';
    chatInput.style.height = Math.min(chatInput.scrollHeight, 120) + 'px';

    // Enfocar el input
    chatInput.focus();

    // showNotification('âœ… Mensaje de emergencia generado', 'success');
  }

  // Exponer funciones globalmente
  window.generateTelegramMessage = generateTelegramMessage;
  window.fillTelegramMessage = fillTelegramMessage;
</script>

<script>
  // Auto-ajustar altura del textarea cuando se escribe
  document.addEventListener('DOMContentLoaded', function() {
    var chatInput = document.getElementById('chatComposerInput');
    if (chatInput) {
      chatInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
      });

      // Restablecer altura cuando se vacÃ­a
      chatInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          setTimeout(function() {
            chatInput.style.height = '42px';
          }, 100);
        }
      });
    }
  });
</script>
