<!-- SweetAlert2 (requerido por la consola CAD) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- Leaflet -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Tu app CAD -->



<style>
  :root {
    --pane-height: 864px;
  }
  .col-lg-3 {
    background: #111111;
    border-left: 4px solid #22c55e;
    padding: 0.5rem 0.75rem 0.75rem;
  }
  .col-lg-3 .tabs-container {
    background: transparent;
    border: 1px solid #3a3a3a;
    border-radius: 0;
    padding: 0 0.75rem 0.75rem;
  }
  .tabs-context-text {
    margin: 0.25rem 0 0.75rem;
    font-size: 0.95rem;
    font-weight: 600;
    color: #f3f4f6;
    letter-spacing: 0.04em;
    text-transform: uppercase;
  }
  .col-lg-3 .tabs-container .nav-tabs {
    border-bottom: 1px solid #3a3a3a;
    background: transparent;
    display: flex;
    flex-wrap: wrap;
  }
  .col-lg-3 .tabs-container .nav-tabs > li {
    width: 50%;
    margin-bottom: 0.2rem;
  }
  .col-lg-3 .tabs-container .nav-tabs > li > a {
    color: #a6adbb;
    border: none;
    background: transparent;
  }
  .col-lg-3 .tabs-container .nav-tabs > li.active > a,
  .col-lg-3 .tabs-container .nav-tabs > li.active > a:focus,
  .col-lg-3 .tabs-container .nav-tabs > li.active > a:hover {
    background: transparent;
    color: #ffffff;
    border: none;
    border-bottom: 2px solid #22c55e;
  }
  .col-lg-3 .tabs-container .tab-content {
    background: transparent;
    border: none;
    padding: 0.75rem 0;
  }
  .tabs-container input:focus,
  .tabs-container select:focus,
  .tabs-container textarea:focus {
    outline: none;
    border-color: #ff3600;
    box-shadow: 0 0 0 1px rgba(255, 54, 0, 0.4);
  }
  .btn-rounded {
    border-radius: 999px;
  }
  .btn-success {
    background: #22c55e;
    border: 1px solid #16a34a;
    color: #04160a;
    font-weight: 600;
    letter-spacing: 0.03em;
    text-transform: uppercase;
    transition: background 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
  }
  .btn-success:hover {
    background: #16a34a;
    border-color: #15803d;
    color: #f0fdf4;
    box-shadow: 0 10px 26px rgba(22, 163, 74, 0.35);
  }
  .btn-success:focus {
    outline: none;
    box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.4);
  }
  .new-incident-wrapper {
    text-align: center;
    margin-bottom: 1.5rem;
  }
  .new-incident-wrapper #addticket {
    font-size: 1.78rem;
    padding: 0.75rem 1.5rem;
    min-width: 338px;
    border-radius: 12px;
  }
  @media (max-width: 768px) {
    .new-incident-wrapper #addticket {
      font-size: 1rem;
      padding: 0.6rem 1rem;
      min-width: 70%;
    }
  }
  .three-pane-row {
    display: flex;
    gap: 1rem;
  }
  .three-pane-row > [class*='col-'].pane {
    display: flex;
  }
  .three-pane-row > [class*='col-'].pane > * {
    flex: 1;
    display: flex;
    flex-direction: column;
    height: var(--pane-height);
    min-height: var(--pane-height);
  }
  .three-pane-row .tabs-container,
  .three-pane-row .tab-content,
  .three-pane-row .tab-pane {
    flex: 1;
    display: flex;
    flex-direction: column;
  }
  .three-pane-row .tab-content .tab-pane:not(.active) {
    display: none;
  }
  .three-pane-row .tab-content .tab-pane.active {
    display: flex;
  }
  .three-pane-row .panel {
    flex: 1;
    display: flex;
    flex-direction: column;
  }
  .three-pane-row .panel-body {
    flex: 1;
  }
  .map-panel-body {
    display: flex;
    padding: 0.9rem;
    flex: none;
    min-height: 420px;
    height: 420px;
  }
  #mapCAD {
    flex: 1;
    min-height: 100%;
    border-radius: 12px;
    overflow: hidden;
  }
  .map-filters {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    padding: 0.75rem 1.25rem 1rem;
    color: #e5e7eb;
    font-size: 0.9rem;
  }
  .map-filter-section {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    border: 1px solid #262626;
    border-radius: 10px;
    padding: 0.85rem 0.9rem;
    background: #121212;
  }
  .map-filter-title {
    font-size: 0.78rem;
    letter-spacing: 0.12em;
    font-weight: 700;
    color: #e5e7eb;
    text-transform: uppercase;
  }
  .map-filter-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 0.5rem 1rem;
  }
  .map-filter-separator {
    width: 100%;
    height: 1px;
    background: #1f1f1f;
    margin-top: 0.25rem;
  }
  .map-filter-item {
    display: flex;
    align-items: center;
    gap: 0.45rem;
  }
  .map-filter-item input {
    width: 18px;
    height: 18px;
    accent-color: #22c55e;
  }
  .gestion-tab-content {
    flex: 1;
    padding: 0.75rem 0.25rem;
    color: #e5e7eb;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }
  .gestion-tab-content p {
    margin: 0;
    color: #a6adbb;
    font-size: 0.95rem;
  }
  .gestion-section {
    display: flex;
    flex-direction: column;
    gap: 0.6rem;
    background: transparent;
  }
  .gestion-section .section-label {
    color: #ffffff;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-size: 0.95rem;
  }
  .gestion-section .section-sep {
    width: 100%;
    height: 1px;
    background: #3a3f4b;
  }
  .gestion-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    justify-content: center;
  }
  .gestion-actions .estado-btn {
    min-width: 150px;
    padding: 0.85rem 1.5rem;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    font-size: 1rem;
    font-weight: 600;
  }
  .gestion-actions .estado-btn.is-active {
    background: #ff3600;
    border-color: #ff3600;
    color: #ffffff;
  }
  .gestion-form {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  .gestion-form .form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 1rem;
  }
  .gestion-form label {
    font-size: 0.9rem;
    color: #ffffff;
    font-weight: 600;
    margin-bottom: 0.4rem;
  }
  .gestion-form select,
  .gestion-form textarea {
    width: 100%;
    background: #151515;
    border: 1px solid #333333;
    color: #f3f4f6;
    border-radius: 4px;
    padding: 0.55rem 0.65rem;
    font-size: 0.95rem;
  }
  .gestion-form textarea {
    min-height: 110px;
    resize: vertical;
  }
  .gestion-close-wrapper {
    text-align: center;
    padding: 0.5rem 0;
  }
  .gestion-close-wrapper .btn-close-incident {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    max-width: 220px;
    padding: 0.6rem 1.25rem;
    text-transform: uppercase;
    border-radius: 30px;
  }
  @media (max-width: 991px) {
    .three-pane-row {
      flex-direction: column;
    }
  }
</style>

<div class="row">
  <div class="col-md-12">
    <div class="new-incident-wrapper">
      <button class="btn btn-accent btn-rounded" id="addticket" type="button">
        <i class="pe-7s-plus" aria-hidden="true"></i> Registrar nuevo incidente
      </button>
    </div>
  </div>
</div>

<div class="incident-tabs-container">
  <div class="incident-tabs" id="incidentTabs"></div>
</div>

<div class="row three-pane-row">
    <div class="col-lg-3 col-md-3 pane">
                    <div class="tabs-container">
                        <div class="tabs-context-text">Contexto del incidente</div>
                        <ul class="nav nav-tabs">
                            <li class="active"><a data-toggle="tab" href="#tab-3" aria-expanded="true"> <i class="fa fa-laptop"></i> Datos</a></li>
                            <li class=""><a data-toggle="tab" href="#tab-4" aria-expanded="false"><i class="fa fa-desktop"></i> Agentes</a></li>
                            <li class=""><a data-toggle="tab" href="#tab-5" aria-expanded="false"><i class="fa fa-database"></i> Personas</a></li>
                            <li class=""><a data-toggle="tab" href="#tab-6" aria-expanded="false"><i class="pe-7s-hammer"></i> Gesti√≥n</a></li>
                        </ul>
                        <div class="tab-content">
                            <div id="tab-3" class="tab-pane active">
                                <div class="panel panel-filled panel-c-accent" style="height:100%; display:flex; flex-direction:column;">
                                    <div class="panel-body" style="overflow:visible;">
                                        <style>
                                          #tab-3 .panel,
                                          #tab-4 .panel,
                                          #tab-5 .panel {
                                            background: transparent;
                                            border: none;
                                            box-shadow: none;
                                            border-radius: 0;
                                          }
                                          #tab-3 .panel-heading,
                                          #tab-4 .panel-heading,
                                          #tab-5 .panel-heading {
                                            background: transparent;
                                            border-bottom: 1px solid #2a3140;
                                            color: #ffffff;
                                          }
                                          #tab-3 .panel-body,
                                          #tab-4 .panel-body,
                                          #tab-5 .panel-body {
                                            background: transparent;
                                          }
                                          #tab-5 .panel-body {
                                            padding: 0;
                                          }
                                          #tab-3 .item {
                                            display:flex;
                                            flex-direction:column;
                                            align-items:flex-start;
                                            margin-bottom:14px;
                                            width:100%;
                                          }
                                          #tab-3 .label {
                                            display:block;
                                            color:#ffffff;
                                            font-weight:600;
                                            font-size:1.05rem;
                                            width:100%;
                                            text-align:left;
                                            padding:0;
                                            line-height:1.3;
                                            background:none;
                                            border-radius:0;
                                          }
                                          #tab-3 .sep {
                                            width:100%;
                                            height:1px;
                                            background:#3a3f4b;
                                            margin:4px 0 6px;
                                          }
                                          #tab-3 .value-box {
                                            display:block;
                                            background:transparent;
                                            border:none;
                                            color:#a6adbb;
                                            border-radius:0;
                                            padding:0;
                                            font-weight:500;
                                            font-size:1.05rem;
                                            width:100%;
                                            text-align:left;
                                          }
                                          #tab-3 .value-chart {
                                            display:flex;
                                            flex-direction:column;
                                            align-items:center;
                                            justify-content:center;
                                            gap:0.4rem;
                                            text-align:center;
                                          }
                                          #tab-3 .value-chart canvas {
                                            width:70px;
                                            height:70px;
                                          }
                                          #tab-3 #cg-sla-text {
                                            color:#f87171;
                                            font-weight:600;
                                          }
                                          #tab-3 #cg-desc { white-space:pre-wrap; }
                                          #tab-5 .personas-tab {
                                            display:flex;
                                            flex-direction:column;
                                            gap:1.5rem;
                                            color:#f3f4f6;
                                          }
                                          #tab-5 .personas-section {
                                            background:transparent;
                                            border:none;
                                            border-radius:0;
                                            padding:0.25rem 0 0.75rem;
                                            display:flex;
                                            flex-direction:column;
                                            gap:0.75rem;
                                          }
                                          #tab-5 .personas-section.personas-editor {
                                            background:transparent;
                                            border:none;
                                            border-radius:0;
                                            padding:0.25rem 0 0.75rem;
                                            gap:0.75rem;
                                          }
                                          #tab-5 .personas-section .section-label {
                                            color:#ffffff;
                                            font-size:1rem;
                                            font-weight:600;
                                            text-transform:uppercase;
                                            letter-spacing:0.04em;
                                            border-bottom:1px solid #2a3140;
                                            padding-bottom:0.35rem;
                                            margin:0;
                                          }
                                          #tab-5 .personas-section.personas-editor .section-label {
                                            border-bottom:1px solid #2a3140;
                                            padding-bottom:0.35rem;
                                          }
                                          #tab-5 .personas-section.denunciante {
                                            gap:0.5rem;
                                            padding-bottom:0.75rem;
                                            border-bottom:1px solid #262626;
                                          }
                                          #tab-5 .denunciante-name {
                                            font-size:1.1rem;
                                            font-weight:600;
                                            color:#ffffff;
                                          }
                                          #tab-5 .denunciante-meta {
                                            display:flex;
                                            flex-wrap:wrap;
                                            gap:1rem 2rem;
                                            margin-top:0.25rem;
                                          }
                                          #tab-5 .denunciante-field {
                                            min-width:160px;
                                          }
                                          #tab-5 .field-label {
                                            text-transform:uppercase;
                                            font-size:0.7rem;
                                            color:#9ca3af;
                                            letter-spacing:0.05em;
                                            margin-bottom:0.2rem;
                                          }
                                          #tab-5 .field-value {
                                            font-size:1rem;
                                            color:#f3f4f6;
                                            font-weight:500;
                                          }
                                          #tab-5 .personas-list {
                                            list-style:none;
                                            padding:0;
                                            margin:0;
                                            display:flex;
                                            flex-direction:column;
                                            gap:0;
                                          }
                                          #tab-5 .persona-row {
                                            display:flex;
                                            align-items:flex-start;
                                            justify-content:space-between;
                                            gap:1rem;
                                            padding:0.75rem 0;
                                            border-bottom:1px solid #262626;
                                          }
                                          #tab-5 .persona-row:last-child {
                                            border-bottom:none;
                                          }
                                          #tab-5 .persona-info-block {
                                            display:flex;
                                            flex-direction:column;
                                            gap:0.35rem;
                                            flex:1;
                                          }
                                          #tab-5 .persona-info-block .persona-name {
                                            font-weight:600;
                                            color:#ffffff;
                                            font-size:1.05rem;
                                          }
                                          #tab-5 .persona-meta-row {
                                            display:flex;
                                            flex-wrap:wrap;
                                            gap:0.35rem 0.85rem;
                                            align-items:center;
                                          }
                                          #tab-5 .persona-role-chip {
                                            font-size:0.8rem;
                                            letter-spacing:0.08em;
                                            text-transform:uppercase;
                                            color:#a3aed0;
                                          }
                                          #tab-5 .persona-meta {
                                            font-size:0.85rem;
                                            color:#9ca3af;
                                            font-weight:500;
                                          }
                                         
                                          #tab-5 .persona-form-grid {
                                            display:grid;
                                            grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
                                            gap:0.85rem 1.25rem;
                                          }
                                          #tab-5 .persona-form-field {
                                            display:flex;
                                            flex-direction:column;
                                            gap:0.35rem;
                                          }
                                          #tab-5 .persona-form-field label {
                                            font-size:0.8rem;
                                            text-transform:uppercase;
                                            letter-spacing:0.05em;
                                            color:#9ca3af;
                                            font-weight:600;
                                          }
                                          #tab-5 .persona-form-field input,
                                          #tab-5 .persona-form-field select {
                                            width:100%;
                                            border:1px solid #374151;
                                            background:#0f0f0f;
                                            color:#f3f4f6;
                                            border-radius:6px;
                                            padding:0.45rem 0.6rem;
                                            font-size:0.95rem;
                                          }
                                          #tab-5 .persona-form-field input:focus,
                                          #tab-5 .persona-form-field select:focus {
                                            outline:none;
                                            border-color:#22c55e;
                                            box-shadow:0 0 0 1px #22c55e33;
                                          }
                                          #tab-5 .persona-actions {
                                            display:flex;
                                            flex-wrap:wrap;
                                            justify-content:center;
                                            gap:0.75rem;
                                            margin-top:1rem;
                                          }
                                          #tab-5 .persona-actions .btn {
                                            flex:none;
                                            min-width:150px;
                                          }
                                          #tab-5 .persona-actions .persona-clear-btn {
                                            background:transparent;
                                            border-color:#374151;
                                            color:#9ca3af;
                                          }
                                          #tab-5 .persona-actions .persona-clear-btn:hover {
                                            color:#f3f4f6;
                                            border-color:#4b5563;
                                          }
                                          #tab-5 .persona-submit-btn {
                                            color:#ffffff;
                                            text-transform:none;
                                            letter-spacing:0.02em;
                                          }
                                          #tab-5 .persona-form-message {
                                            margin-top:0.5rem;
                                            font-size:0.85rem;
                                            color:#f59e0b;
                                          }
                                          .incident-tabs-container {
                                            margin:0.5rem 0 1rem 0;
                                            padding:0.75rem 0.25rem 0;
                                          }
                                          @media (min-width:992px){
                                            .incident-tabs-container {
                                              padding:0.75rem 0.5rem 0;
                                            }
                                          }
                                          .incident-tabs {
                                            display:flex;
                                            gap:0.65rem;
                                            padding:0.65rem;
                                            flex-wrap:wrap;
                                            background:#111111;
                                            border:1px solid #262626;
                                            border-radius:12px;
                                          }
                                          .incident-tab {
                                            background:#0f0f0f;
                                            border:1px solid #2f2f2f;
                                            border-radius:10px;
                                            padding:0.75rem 1rem;
                                            min-width:200px;
                                            display:flex;
                                            flex-direction:column;
                                            gap:0.25rem;
                                            color:#f3f4f6;
                                            cursor:pointer;
                                            transition:border 0.2s ease, background 0.2s ease, transform 0.2s ease;
                                            position:relative;
                                            text-align:left;
                                            font-size:0.95rem;
                                          }
                                          .incident-tab:hover {
                                            border-color:#22c55e;
                                            background:#151515;
                                            transform:translateY(-1px);
                                          }
                                          .incident-tab.active {
                                            border-color:#22c55e;
                                            background:#1d1d1d;
                                            box-shadow:0 0 0 1px #22c55e33;
                                          }
                                          .incident-tab .incident-id {
                                            font-weight:700;
                                            font-size:0.9rem;
                                            letter-spacing:0.05em;
                                            color:#9ca3af;
                                            text-transform:uppercase;
                                          }
                                          .incident-tab .incident-title {
                                            font-weight:600;
                                            color:#f3f4f6;
                                            font-size:1.05rem;
                                            line-height:1.3;
                                          }
                                          .incident-tab .incident-meta {
                                            font-size:0.85rem;
                                            color:#9ca3af;
                                          }
                                          .incident-tab .unread {
                                            position:absolute;
                                            top:0.5rem;
                                            right:0.5rem;
                                            background:#22c55e;
                                            color:#0b0b0b;
                                            font-weight:700;
                                            font-size:0.75rem;
                                            border-radius:999px;
                                            padding:0.1rem 0.5rem;
                                          }
                                          .chat-toolbar-context {
                                            font-size:0.85rem;
                                            color:#9ca3af;
                                            letter-spacing:0.04em;
                                            text-transform:uppercase;
                                            margin-top:0.15rem;
                                          }
                                          .chat-panel {
                                            background:#0f0f0f;
                                            border:1px solid #262626;
                                            border-left:4px solid #22c55e;
                                            border-radius:0;
                                            padding:1.25rem 1.5rem;
                                            display:flex;
                                            flex-direction:column;
                                            gap:1rem;
                                            height:var(--pane-height);
                                          }
                                          .chat-toolbar {
                                            display:flex;
                                            align-items:center;
                                            justify-content:space-between;
                                            gap:1rem;
                                            padding-bottom:0.5rem;
                                            border-bottom:1px solid #1d1d1f;
                                          }
                                          .chat-toolbar-title {
                                            font-size:1.1rem;
                                            font-weight:600;
                                            color:#f3f4f6;
                                          }
                                          .chat-search {
                                            background:#111111;
                                            border:1px solid #333333;
                                            border-radius:0;
                                            display:flex;
                                            align-items:center;
                                            padding:0.2rem 0.8rem;
                                            width:100%;
                                            flex:1;
                                          }
                                          .chat-search input {
                                            background:transparent;
                                            border:none;
                                            color:#e5e7eb;
                                            font-size:0.9rem;
                                            flex:1;
                                            width:100%;
                                          }
                                          .chat-search input:focus {
                                            outline:none;
                                          }
                                          .chat-stream {
                                            flex:1;
                                            border:1px solid #1f1f1f;
                                            border-radius:0;
                                            padding:1rem;
                                            background:#090909;
                                            overflow-y:auto;
                                            display:flex;
                                            flex-direction:column;
                                            gap:0.85rem;
                                          }
                                          .chat-stream-day {
                                            text-align:center;
                                          }
                                          .chat-stream-pill {
                                            display:inline-flex;
                                            padding:0.15rem 0.85rem;
                                            border-radius:999px;
                                            border:1px solid #2f2f2f;
                                            text-transform:uppercase;
                                            letter-spacing:0.05em;
                                            color:#9ca3af;
                                            font-size:0.75rem;
                                          }
                                          .chat-stream-empty {
                                            text-align:center;
                                            color:#9ca3af;
                                            font-style:italic;
                                            padding:1rem 0;
                                          }
                                          .chat-scroll-cta {
                                            display:none;
                                            justify-content:center;
                                            margin-top:auto;
                                          }
                                          .chat-scroll-cta .btn {
                                            border-radius:0;
                                            padding:0.4rem 1.25rem;
                                          }
                                          .chat-event {
                                            display:flex;
                                            gap:0.75rem;
                                            background:#111111;
                                            border:1px dashed #2f2f2f;
                                            border-radius:0;
                                            padding:0.65rem 0.85rem;
                                            align-items:flex-start;
                                          }
                                          .chat-event .event-icon {
                                            font-size:1.1rem;
                                            width:32px;
                                            height:32px;
                                            border-radius:999px;
                                            background:#1d1d1d;
                                            display:flex;
                                            align-items:center;
                                            justify-content:center;
                                          }
                                          .chat-event .event-title {
                                            font-weight:600;
                                            color:#f3f4f6;
                                          }
                                          .chat-event .event-detail {
                                            font-size:0.9rem;
                                            color:#d1d5db;
                                          }
                                          .chat-event .event-meta {
                                            font-size:0.75rem;
                                            color:#9ca3af;
                                            text-transform:uppercase;
                                            letter-spacing:0.05em;
                                          }
                                          .chat-message {
                                            display:flex;
                                            flex-direction:column;
                                            gap:0.3rem;
                                            border-radius:0;
                                            padding:0.85rem;
                                            position:relative;
                                          }
                                          .chat-message.from-operator {
                                            background:#101828;
                                            border:1px solid #1d2a44;
                                            align-self:flex-end;
                                            max-width:80%;
                                          }
                                          .chat-message.from-agent {
                                            background:#111111;
                                            border:1px solid #1f1f1f;
                                            align-self:flex-start;
                                            max-width:80%;
                                          }
                                          .chat-message-author {
                                            font-weight:600;
                                            color:#f3f4f6;
                                            display:flex;
                                            gap:0.3rem;
                                            align-items:center;
                                          }
                                          .chat-message-role {
                                            font-size:0.8rem;
                                            color:#9ca3af;
                                            text-transform:uppercase;
                                            letter-spacing:0.05em;
                                          }
                                          .chat-message-text {
                                            font-size:0.95rem;
                                            line-height:1.45;
                                            color:#e5e7eb;
                                          }
                                          .chat-attachments {
                                            display:flex;
                                            flex-wrap:wrap;
                                            gap:0.35rem;
                                          }
                                          .chat-attachment {
                                            font-size:0.78rem;
                                            border:1px solid #3a3a3a;
                                            border-radius:0;
                                            padding:0.2rem 0.65rem;
                                            text-transform:uppercase;
                                            letter-spacing:0.05em;
                                            color:#d1d5db;
                                            background:#141414;
                                          }
                                          .chat-message-meta {
                                            font-size:0.75rem;
                                            color:#9ca3af;
                                            text-align:right;
                                            letter-spacing:0.05em;
                                          }
                                          .chat-composer {
                                            display:flex;
                                            gap:0.75rem;
                                            align-items:flex-end;
                                            border-top:1px solid #1e1e1e;
                                            padding-top:0.75rem;
                                          }
                                          .chat-composer textarea {
                                            flex:1;
                                            background:#0f0f0f;
                                            border:1px solid #333333;
                                            border-radius:0;
                                            resize:vertical;
                                            min-height:68px;
                                            max-height:140px;
                                            padding:0.75rem 0.85rem;
                                            color:#f3f4f6;
                                          }
                                          .chat-composer textarea:focus {
                                            outline:none;
                                            border-color:#22c55e;
                                            box-shadow:0 0 0 1px #22c55e33;
                                          }
                                          .chat-send-btn {
                                            align-self:stretch;
                                            min-width:110px;
                                          }
                                          .agents-section {
                                            background:transparent;
                                            border:none;
                                            border-radius:0;
                                            padding:0.5rem 0 0.75rem;
                                            display:flex;
                                            flex-direction:column;
                                            gap:1rem;
                                          }
                                          .agents-section .section-label {
                                            color:#ffffff;
                                            font-size:1rem;
                                            font-weight:600;
                                            text-transform:uppercase;
                                            letter-spacing:0.04em;
                                            border-bottom:1px solid #2a3140;
                                            padding-bottom:0.35rem;
                                            margin-bottom:0;
                                          }
                                          .agents {
                                            display:flex;
                                            flex-direction:column;
                                            gap:0;
                                          }
                                          .agent-tag {
                                            background:transparent;
                                            border:none;
                                            border-bottom:1px solid #262626;
                                            color:#f3f4f6;
                                            padding:0.65rem 0;
                                            font-size:1.05rem;
                                            display:flex;
                                            align-items:flex-start;
                                            justify-content:space-between;
                                          }
                                          .agent-tag:last-child {
                                            border-bottom:none;
                                          }
                                          .agent-tag:hover {
                                            background:none;
                                          }
                                          .agent-info-block {
                                            display:flex;
                                            flex-direction:column;
                                            gap:0.25rem;
                                            flex:1;
                                          }
                                          .agents .agent-name {
                                            font-weight:600;
                                            color:#ffffff;
                                            font-size:1.05rem;
                                          }
                                          .agent-meta-chip {
                                            color:#a3aed0;
                                            font-size:0.85rem;
                                            letter-spacing:0.05em;
                                            text-transform:uppercase;
                                          }
                                          .release-agent-btn,
                                          #tab-5 .persona-action-btn {
                                            background:#0f0f0f;
                                            border:1px solid #343a40;
                                            color:#f3f4f6;
                                            cursor:pointer;
                                            padding:0.45rem 1.35rem;
                                            font-size:0.9rem;
                                            border-radius:999px;
                                            text-transform:uppercase;
                                            letter-spacing:0.04em;
                                            font-weight:600;
                                          }
                                          .release-agent-btn:hover,
                                          #tab-5 .persona-action-btn:hover {
                                            background:#1c1c1c;
                                            border-color:#4b5563;
                                            color:#ffffff;
                                          }
                                          .btn-assign-agent {
                                            width:100%;
                                            margin-top:0.5rem;
                                            display:inline-flex;
                                            justify-content:center;
                                            align-items:center;
                                            gap:0.35rem;
                                            font-weight:600;
                                            font-size:1rem;
                                          }
                                          .btn-release-all {
                                            margin-top:0;
                                            background:#0f0f0f;
                                            border:1px solid #343a40;
                                            color:#f3f4f6;
                                            border-radius:999px;
                                            padding:0.75rem 1.5rem;
                                          }
                                          .btn-release-all:hover {
                                            background:#1c1c1c;
                                            border-color:#4b5563;
                                            color:#ffffff;
                                          }
                                          .modal-overlay {
                                            position:fixed;
                                            top:0;
                                            left:0;
                                            width:100%;
                                            height:100%;
                                            background-color:rgba(0,0,0,0.75);
                                            display:none;
                                            z-index:1000;
                                            align-items:center;
                                            justify-content:center;
                                          }
                                          .modal-overlay.active {
                                            display:flex;
                                          }
                                          .agent-modal {
                                            background-color:#0f0f0f;
                                            border:1px solid #2b2b2b;
                                            border-radius:14px;
                                            width:90%;
                                            max-width:520px;
                                            max-height:80vh;
                                            overflow:hidden;
                                            box-shadow:0 25px 80px rgba(0,0,0,0.65);
                                            color:#f3f4f6;
                                          }
                                          .agent-modal-header {
                                            padding:1.4rem 1.65rem;
                                            border-bottom:1px solid #262626;
                                            display:flex;
                                            justify-content:space-between;
                                            align-items:center;
                                          }
                                          .agent-modal-title {
                                            font-size:1.1rem;
                                            font-weight:600;
                                            color:#f3f4f6;
                                          }
                                          .agent-modal-close {
                                            background:none;
                                            border:none;
                                            font-size:1.25rem;
                                            cursor:pointer;
                                            color:#9ca3af;
                                            padding:0.25rem;
                                            transition:color 0.2s ease;
                                          }
                                          .agent-modal-close:hover {
                                            color:#ffffff;
                                          }
                                          .agent-modal-body {
                                            padding:1.25rem 1.65rem;
                                            max-height:60vh;
                                            overflow-y:auto;
                                          }
                                         .agent-modal-body::-webkit-scrollbar {
                                            width:8px;
                                          }
                                          .agent-modal-body::-webkit-scrollbar-thumb {
                                            background:#333;
                                            border-radius:4px;
                                          }
                                          .modal-search {
                                            margin-bottom:1rem;
                                          }
                                          .modal-search input {
                                            width:100%;
                                            padding:0.75rem 0.85rem;
                                            border:1px solid #333333;
                                            border-radius:10px;
                                            font-size:1rem;
                                            background:#141414;
                                            color:#f3f4f6;
                                            transition:border-color 0.2s ease,box-shadow 0.2s ease;
                                          }
                                          .modal-search input:focus {
                                            outline:none;
                                            border-color:#ff3600;
                                            box-shadow:0 0 0 1px #ff360033;
                                          }
                                          .agent-list-item {
                                            padding:0.85rem 1.1rem;
                                            margin-bottom:0.75rem;
                                            background:#111111;
                                            border:1px solid #2b2b2b;
                                            border-radius:12px;
                                            cursor:pointer;
                                            transition:background 0.2s ease,border 0.2s ease,transform 0.2s ease;
                                            display:flex;
                                            justify-content:space-between;
                                            align-items:center;
                                          }
                                          .agent-list-item:hover {
                                            background:#1f1f1f;
                                            border-color:#ff3600;
                                            transform:translateY(-1px);
                                          }
                                          .agent-info {
                                            display:flex;
                                            flex-direction:column;
                                            gap:0.25rem;
                                          }
                                          .agent-list-name {
                                            font-weight:600;
                                            color:#ffffff;
                                            font-size:1.05rem;
                                          }
                                          .agent-list-role {
                                            font-size:0.85rem;
                                            color:#a3aed0;
                                            letter-spacing:0.05em;
                                            text-transform:uppercase;
                                          }
                                          .agent-list-item:hover .agent-list-role {
                                            color:#d1d5db;
                                          }
                                          .agent-list-item.ocupado {
                                            opacity:0.55;
                                            cursor:default;
                                          }
                                          .agent-list-item.ocupado:hover {
                                            background:#111111;
                                            border-color:#2b2b2b;
                                          }
                                          .agent-list-item.ocupado .agent-list-role {
                                            color:#7c7c7c;
                                          }
                                          .agent-incident-tag {
                                            font-size:0.75rem;
                                            color:#9ca3af;
                                            font-style:italic;
                                          }
                                          .agent-distance {
                                            font-size:0.82rem;
                                            color:#e5e7eb;
                                            font-weight:600;
                                          }
                                          .no-results {
                                            text-align:center;
                                            padding:2rem;
                                            color:#9ca3af;
                                            font-style:italic;
                                          }
                                        </style>

                                        <div class="item">
                                          <div class="label">ID del incidente</div>
                                          <div class="sep"></div>
                                          <div class="value-box" id="cg-id">‚Äî</div>
                                        </div>
                                        <div class="item">
                                          <div class="label">T√≠tulo</div>
                                          <div class="sep"></div>
                                          <div class="value-box" id="cg-title">‚Äî</div>
                                        </div>
                                        <div class="item">
                                          <div class="label">Descripci√≥n</div>
                                          <div class="sep"></div>
                                          <div class="value-box" id="cg-desc">‚Äî</div>
                                        </div>
                                        <div class="item">
                                          <div class="label">Direcci√≥n</div>
                                          <div class="sep"></div>
                                          <div class="value-box" id="cg-direccion">‚Äî</div>
                                        </div>
                                        <div class="item">
                                          <div class="label">Estado</div>
                                          <div class="sep"></div>
                                          <div class="value-box" id="cg-estado">‚Äî</div>
                                        </div>
                                        <div class="item">
                                          <div class="label">Clasificaci√≥n</div>
                                          <div class="sep"></div>
                                          <div class="value-box"><span id="cg-clasificacion">‚Äî</span></div>
                                        </div>
                                        <div class="item">
                                          <div class="label">Tipo</div>
                                          <div class="sep"></div>
                                          <div class="value-box" id="cg-tipo">‚Äî</div>
                                        </div>
                                        <div class="item">
                                          <div class="label">Subtipo</div>
                                          <div class="sep"></div>
                                          <div class="value-box" id="cg-subtipo">‚Äî</div>
                                        </div>
                                        <div class="item">
                                          <div class="label">Fecha y hora de creaci√≥n</div>
                                          <div class="sep"></div>
                                          <div class="value-box" id="cg-creacion">‚Äî</div>
                                        </div>
                                        <div class="item">
                                          <div class="label">Tiempo transcurrido en horas</div>
                                          <div class="sep"></div>
                                          <div class="value-box" id="cg-tiempo">‚Äî</div>
                                        </div>
                                        <div class="item">
                                          <div class="label">Porcentaje del tiempo del SLA</div>
                                          <div class="sep"></div>
                                          <div class="value-box value-chart">
                                            <canvas id="cg-sla-pie" width="80" height="80" aria-hidden="true"></canvas>
                                            <div id="cg-sla-text">‚Äî</div>
                                          </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="tab-4" class="tab-pane">
                                <div class="panel-body">
                                        <div class="agents-section">
                                            <div class="section-label">Agentes asignados</div>
                                            <div class="agents" id="assignedAgentsContainer"></div>
                                            <button type="button" class="btn btn-default btn-rounded btn-release-all" onclick="releaseAllAgents()">Liberar a todos</button>
                                        <button type="button" class="btn btn-success btn-rounded btn-assign-agent" onclick="openAssignAgentModal()">+ Asignar agente</button>
                                        </div>
                                    </div>
                                </div>
                            <div id="tab-5" class="tab-pane">
                                <div class="panel-body personas-tab" id="personas-tab">
                                    <div class="personas-section denunciante" id="denunciante-section">
                                        <div class="section-label">Denunciante</div>
                                        <div class="denunciante-name" id="denunciante-nombre">‚Äî</div>
                                        <div class="denunciante-meta">
                                            <div class="denunciante-field">
                                                <div class="field-label">Tel√©fono</div>
                                                <div class="field-value" id="denunciante-telefono">‚Äî</div>
                                            </div>
                                            <div class="denunciante-field">
                                                <div class="field-label">Documento</div>
                                                <div class="field-value" id="denunciante-documento">‚Äî</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="personas-section" id="personas-section">
                                        <div class="section-label">Personas involucradas</div>
                                        <ul class="personas-list" id="personas-list">
                                            <li class="persona-row">
                                                <div class="persona-info-block">
                                                    <div class="persona-name">Juan P√©rez</div>
                                                    <div class="persona-meta-row">
                                                        <span class="persona-role-chip">Afectado ‚Ä¢ DNI 45678901</span>
                                                        <span class="persona-meta">Masculino</span>
                                                    </div>
                                                </div>
                                                <button type="button" class="btn btn-default btn-rounded persona-action-btn" aria-label="Quitar a Juan P√©rez">Quitar</button>
                                            </li>
                                            <li class="persona-row">
                                                <div class="persona-info-block">
                                                    <div class="persona-name">Mar√≠a L√≥pez</div>
                                                    <div class="persona-meta-row">
                                                        <span class="persona-role-chip">Testigo ‚Ä¢ CE X123456</span>
                                                        <span class="persona-meta">Femenino</span>
                                                    </div>
                                                </div>
                                                <button type="button" class="btn btn-default btn-rounded persona-action-btn" aria-label="Quitar a Mar√≠a L√≥pez">Quitar</button>
                                            </li>
                                      </ul>
                                      <div class="personas-section personas-editor">
                                        <div class="section-label">Registrar persona involucrada</div>
                                        <div class="persona-form-grid">
                                            <div class="persona-form-field">
                                                <label for="persona-nombre">Nombre completo</label>
                                                <input type="text" id="persona-nombre" placeholder="Ej. Juan P√©rez">
                                            </div>
                                            <div class="persona-form-field">
                                                <label for="persona-genero">G√©nero</label>
                                                <select id="persona-genero">
                                                    <option value="">Seleccionar</option>
                                                    <option value="Masculino">Masculino</option>
                                                    <option value="Femenino">Femenino</option>
                                                    <option value="Otro">Otro</option>
                                                </select>
                                            </div>
                                            <div class="persona-form-field">
                                                <label for="persona-tipo-doc">Tipo documento</label>
                                                <select id="persona-tipo-doc">
                                                    <option value="">Seleccionar</option>
                                                    <option value="DNI">DNI</option>
                                                    <option value="CE">Carnet de Extranjer√≠a</option>
                                                    <option value="Pasaporte">Pasaporte</option>
                                                </select>
                                            </div>
                                            <div class="persona-form-field">
                                                <label for="persona-numero-doc">N√∫mero</label>
                                                <input type="text" id="persona-numero-doc" placeholder="Documento">
                                            </div>
                                            <div class="persona-form-field">
                                                <label for="persona-rol">Rol en el incidente</label>
                                                <input type="text" id="persona-rol" placeholder="Ej. Testigo, afectado">
                                            </div>
                                        </div>
                                        <div class="persona-actions">
                                            <button type="button" class="btn btn-default btn-rounded persona-clear-btn">Limpiar</button>
                                            <button type="button" class="btn btn-w-md btn-success btn-rounded persona-submit-btn">Registrar persona</button>
                                        </div>
                                        <div class="persona-form-message"></div>
                                    </div>
                                    </div>
                                </div>
                            </div>
                            <div id="tab-6" class="tab-pane">
                                <div class="gestion-tab-content">
                                    <div class="gestion-section">
                                        <div class="section-label">CIERRE DE INCIDENTE</div>
                                        <div class="section-sep"></div>
                                        <div class="gestion-form">
                                            <div class="form-grid">
                                                <div class="form-field">
                                                    <label for="cierre-clasificacion">Clasificaci√≥n</label>
                                                    <select id="cierre-clasificacion">
                                                        <option value="tr√°nsito" selected>Tr√°nsito</option>
                                                        <option value="seguridad">Seguridad</option>
                                                        <option value="servicios">Servicios p√∫blicos</option>
                                                    </select>
                                                </div>
                                                <div class="form-field">
                                                    <label for="cierre-tipo">Tipo</label>
                                                    <select id="cierre-tipo">
                                                        <option value="accidente" selected>Accidente</option>
                                                        <option value="incidente">Incidente</option>
                                                        <option value="emergencia">Emergencia</option>
                                                    </select>
                                                </div>
                                                <div class="form-field">
                                                    <label for="cierre-subtipo">Subtipo</label>
                                                    <select id="cierre-subtipo">
                                                        <option value="choque" selected>Choque</option>
                                                        <option value="alcance">Alcance</option>
                                                        <option value="peaton">Peat√≥n</option>
                                                    </select>
                                                </div>
                                                <div class="form-field">
                                                    <label for="cierre-severidad">Nivel de severidad</label>
                                                    <select id="cierre-severidad">
                                                        <option value="critica">Cr√≠tica</option>
                                                        <option value="alta">Alta</option>
                                                        <option value="media" selected>Media</option>
                                                        <option value="baja">Baja</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="form-field">
                                                <label for="cierre-detalle">Detalles del cierre</label>
                                                <textarea id="cierre-detalle" placeholder="Describe las acciones finales, responsables y evidencias de cierre."></textarea>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="gestion-close-wrapper">
                                        <button class="btn btn-accent btn-rounded btn-close-incident" type="button">
                                            Cerrar incidente
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
    
    

    <div class="col-md-5 col-lg-5 pane">
      <div class="chat-panel">
        <div class="chat-toolbar">
          <div class="chat-search">
            <span aria-hidden="true">üîç</span>
            <input type="text" id="chatSearchInput" placeholder="Buscar en este chat" aria-label="Buscar en el chat">
          </div>
        </div>
        <div class="chat-stream" id="chatStream">
          <div class="chat-stream-day">
            <span class="chat-stream-pill" id="chatDayPill">Hoy</span>
          </div>
          <div id="chatTimeline"></div>
          <div class="chat-scroll-cta" id="chatScrollCta">
            <button type="button" class="btn btn-default" id="chatGoBottom">Ver nuevos mensajes</button>
          </div>
        </div>
        <div class="chat-composer">
          <textarea id="chatComposerInput" placeholder="Escribe una actualizaci√≥n para los agentes‚Ä¶" aria-label="Escribe tu mensaje"></textarea>
          <button type="button" class="btn btn-accent chat-send-btn" id="chatSendButton">Enviar</button>
        </div>
      </div>
    </div>
    
    <div class="col-md-4 col-lg-4 pane">

        <div class="panel panel-filled panel-c-success">
            <div class="panel-heading">
                <div class="panel-tools">
                </div>
                Mapa situacional del incidente
            </div>
            <div class="panel-body map-panel-body">
                    <div id="mapCAD"></div>
            </div>
            <div class="map-filters">
              <div class="map-filter-section">
                <div class="map-filter-title">Por asignaci√≥n</div>
                <div class="map-filter-grid">
                  <label class="map-filter-item"><input type="checkbox" checked> Agentes en incidente</label>
                  <label class="map-filter-item"><input type="checkbox"> Agentes libres</label>
                  <label class="map-filter-item"><input type="checkbox"> Agentes en otros incidentes</label>
                </div>
                <div class="map-filter-separator"></div>
              </div>
              <div class="map-filter-section">
                <div class="map-filter-title">Por medio de transporte</div>
                <div class="map-filter-grid">
                  <label class="map-filter-item"><input type="checkbox"> A pie</label>
                  <label class="map-filter-item"><input type="checkbox"> En motocicleta</label>
                  <label class="map-filter-item"><input type="checkbox"> En bicicleta</label>
                  <label class="map-filter-item"><input type="checkbox"> En veh√≠culo</label>
                </div>
                <div class="map-filter-separator"></div>
              </div>
              <div class="map-filter-section">
                <div class="map-filter-title">Otros recursos</div>
                <div class="map-filter-grid">
                  <label class="map-filter-item"><input type="checkbox"> C√°maras</label>
                </div>
                <div class="map-filter-separator"></div>
              </div>
            </div>
        </div>

    </div>                    
    
</div>

<!-- Modal para asignar agente -->
<div class="modal-overlay" id="assignAgentModal">
  <div class="agent-modal">
    <div class="agent-modal-header">
      <h3 class="agent-modal-title">Asignar agente al incidente</h3>
      <button class="agent-modal-close" onclick="closeAssignAgentModal()" aria-label="Cerrar modal">&times;</button>
    </div>
    <div class="agent-modal-body">
      <div class="modal-search">
        <input
          type="text"
          id="agentSearchInput"
          placeholder="Buscar agente por nombre..."
          oninput="filterAgents()"
          aria-label="Buscar agente"
        />
      </div>
      <div id="agentListContainer"></div>
    </div>
  </div>
</div>

 {{modal_nuevo_incidente}}

<script>
  // Initialize Leaflet map for the operator chat view
  document.addEventListener('DOMContentLoaded', function () {
    var el = document.getElementById('mapCAD');
    if (!el || typeof L === 'undefined') return;

    var map = L.map('mapCAD', { zoomControl: true, attributionControl: true });
    // Center near Av. Primavera; adjust as needed
    var primavera = [-12.1175, -76.9990];
    map.setView(primavera, 14);

    // Mid-gray basemap for better contrast with overlays
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      maxZoom: 20,
      attribution: '&copy; OpenStreetMap contributors &copy; CARTO'
    }).addTo(map);

    // Incident marker and popup
    L.marker(primavera)
      .addTo(map)
      .bindPopup('<b>Incidente</b><br>Av. Primavera 123')
      .openPopup();

    // Ensure correct sizing in case of late layout/visibility changes
    setTimeout(function () { map.invalidateSize(); }, 300);
  });
</script>
<script>
  // General tab renderer (read-only context)
  (function(){
    function byId(id){ return document.getElementById(id); }
    var data = {
      id: 'INC-2025-001',
      titulo: 'Accidente de tr√°nsito en Av. Primavera',
      estado: 'Clasificado',
      origen: 'Llamada 105',
      severidad: 'Media',
      prioridad: 'Alta',
      fechaCreacion: '12/01/2025 10:30',
      tiempoTranscurrido: '18.50 h',
      slaPorcentaje: 82,
      direccion: 'Av. Primavera 123, Santiago de Surco',
      coords: '-12.117500, -76.999000',
      clasificacion: 'Tr√°nsito',
      tipo: 'Accidente de tr√°nsito',
      subtipo: 'Choque',
      descripcion: 'Colisi√≥n entre dos veh√≠culos. Sin heridos de gravedad reportados. Congesti√≥n en carril derecho.',
      denunciante: {
        nombre: 'Mario Salazar',
        telefono: '+51 999 123 456',
        documento: 'DNI 12345678'
      },
      agentes: [ { nombre:'A. Ram√≠rez' }, { nombre:'B. Torres' } ],
      personas: [ { nombre:'Juan P√©rez', rol:'Afectado' }, { nombre:'Mar√≠a L√≥pez', rol:'Testigo' } ],
      camaras: [
        { id:'CAM-014', estado:'online', ubicacion:'Primavera x Central', distancia:'120m' },
        { id:'CAM-021', estado:'offline', ubicacion:'Primavera x Velasco', distancia:'350m' }
      ]
    };
    const incidentTabsData = [
      { id: 'INC-2025-001', title: 'Accidente en Av. Primavera', summary: 'Colisi√≥n de veh√≠culos; tr√°nsito lento', unread: 3 },
      { id: 'INC-2025-014', title: 'Robo en Plaza Central', summary: 'Sospechoso huy√≥ hacia Av. Grau', unread: 1 },
      { id: 'INC-2025-022', title: 'Manifestaci√≥n no autorizada', summary: 'Grupo de 50 personas frente a municipalidad', unread: 0 },
      { id: 'INC-2025-027', title: 'Corte de electricidad', summary: 'Sector Los √Ålamos sin servicio', unread: 8 },
    ];
    let activeIncidentTab = incidentTabsData[0].id;

    const assignedAgents = [
      { shortName: 'A. Ram√≠rez', transporte: 'Camioneta', status: 'Disponible' },
      { shortName: 'B. Torres', transporte: 'Motocicleta', status: 'En ruta' },
    ];
    const availableAgents = [
      { id: 'ramirez', name: 'Agente Ram√≠rez', shortName: 'A. Ram√≠rez', transporte: 'Camioneta', status: 'Disponible', distancia: '0.8 km', incidenteActual: null },
      { id: 'vega', name: 'Agente Vega', shortName: 'C. Vega', transporte: 'Bicicleta', status: 'Disponible', distancia: '1.2 km', incidenteActual: null },
      { id: 'suarez', name: 'Agente Su√°rez', shortName: 'D. Su√°rez', transporte: 'Camioneta', status: 'Ocupado', distancia: '5.3 km', incidenteActual: '#2051' },
      { id: 'torres', name: 'Agente Torres', shortName: 'E. Torres', transporte: 'Camioneta', status: 'Ocupado', distancia: '3.7 km', incidenteActual: '#2053' },
      { id: 'lopez', name: 'Agente L√≥pez', shortName: 'F. L√≥pez', transporte: 'A pie', status: 'Disponible', distancia: '2.1 km', incidenteActual: null },
      { id: 'garcia', name: 'Agente Garc√≠a', shortName: 'G. Garc√≠a', transporte: 'Camioneta', status: 'Disponible', distancia: '0.5 km', incidenteActual: null },
      { id: 'martinez', name: 'Agente Mart√≠nez', shortName: 'H. Mart√≠nez', transporte: 'Bicicleta', status: 'Disponible', distancia: '1.8 km', incidenteActual: null },
      { id: 'fernandez', name: 'Agente Fern√°ndez', shortName: 'I. Fern√°ndez', transporte: 'Camioneta', status: 'Disponible', distancia: '4.2 km', incidenteActual: null },
      { id: 'diaz', name: 'Agente D√≠az', shortName: 'J. D√≠az', transporte: 'A pie', status: 'Ocupado', distancia: '8.1 km', incidenteActual: '#2048' }
    ];
    const chatTimelineByIncident = {
      'INC-2025-001': [
        { id: 'evt-001', type: 'event', icon: '‚ö°Ô∏è', title: 'Incidente creado', detail: 'Registrado v√≠a llamada 105', timestamp: '10:30' },
        { id: 'evt-002', type: 'event', icon: 'üëÆ', title: 'Agente A. Ram√≠rez asignado', detail: 'Camioneta ‚Ä¢ 0.8 km', timestamp: '10:32' },
        { id: 'evt-003', type: 'event', icon: 'üëÆ', title: 'Agente B. Torres asignado', detail: 'Motocicleta ‚Ä¢ 1.1 km', timestamp: '10:32' },
        { id: 'msg-001', type: 'message', from: 'operator', name: 'Operadora Carla Q.', role: 'CAD', text: 'Equipo, confirmen arribo y bloqueo del carril derecho.', timestamp: '10:33' },
        { id: 'msg-002', type: 'message', from: 'agent', name: 'A. Ram√≠rez', role: 'En ruta', text: 'Ingresando por Primavera. Congesti√≥n moderada, pido apoyo de tr√°nsito.', timestamp: '10:35', attachments: [{ type: 'foto', name: 'Congestion_Primavera.jpg' }] },
        { id: 'msg-003', type: 'message', from: 'agent', name: 'B. Torres', role: 'Motocicleta', text: 'Llego en 2 min. Tomo desv√≠o lateral para liberar carril izquierdo.', timestamp: '10:37' },
        { id: 'evt-004', type: 'event', icon: 'üìé', title: 'Evidencia cargada', detail: 'Unidad Ram√≠rez comparti√≥ 1 archivo.', timestamp: '10:38' },
        { id: 'msg-004', type: 'message', from: 'operator', name: 'Operadora Carla Q.', role: 'CAD', text: 'Listo, ambulancia privada en camino. Mantengan despejado.', timestamp: '10:39' }
      ],
      'INC-2025-014': [
        { id: 'evt-101', type: 'event', icon: '‚ö°Ô∏è', title: 'Incidente creado', detail: 'Robo en Plaza Central', timestamp: '09:10' },
        { id: 'evt-102', type: 'event', icon: 'üëÆ', title: 'Agente C. Vega asignado', detail: 'Bicicleta ‚Ä¢ 1.2 km', timestamp: '09:12' },
        { id: 'msg-101', type: 'message', from: 'agent', name: 'C. Vega', role: 'En patrullaje', text: 'Persiguiendo a sospechoso hacia Av. Grau, solicito cierre en la cuadra 4.', timestamp: '09:13' },
        { id: 'msg-102', type: 'message', from: 'operator', name: 'Operador Luis', role: 'CAD', text: 'Se coordin√≥ cerco con Serenazgo sector 2.', timestamp: '09:14' },
        { id: 'evt-103', type: 'event', icon: 'üìç', title: 'Testigo contactado', detail: 'Operador Jim√©nez en llamada con comerciante.', timestamp: '09:16' }
      ],
      'INC-2025-022': [
        { id: 'evt-201', type: 'event', icon: '‚ö°Ô∏è', title: 'Incidente creado', detail: 'Manifestaci√≥n no autorizada', timestamp: '07:45' },
        { id: 'evt-202', type: 'event', icon: 'üëÆ', title: 'Agente D. Su√°rez asignado', detail: 'Camioneta ‚Ä¢ 5.3 km', timestamp: '07:47' },
        { id: 'msg-201', type: 'message', from: 'operator', name: 'Operadora Elena', role: 'CAD', text: 'Recordatorio: documentar aforo y bloqueos.', timestamp: '07:51' },
        { id: 'msg-202', type: 'message', from: 'agent', name: 'D. Su√°rez', role: 'Jefe de patrulla', text: 'Grupo de 50 personas, sin disturbios. Env√≠o video corto.', timestamp: '07:53', attachments: [{ type: 'video', name: 'Manifestacion_022.mp4' }] }
      ],
      'INC-2025-027': [
        { id: 'evt-301', type: 'event', icon: '‚ö°Ô∏è', title: 'Incidente creado', detail: 'Corte de electricidad sector Los √Ålamos', timestamp: '06:05' },
        { id: 'msg-301', type: 'message', from: 'operator', name: 'Operador Luis', role: 'CAD', text: 'Se coordina con empresa el√©ctrica para restablecer servicio.', timestamp: '06:07' }
      ]
    };
    let chatFilterTerm = '';
    let chatAutoScroll = true;
    const chatStreamEl = byId('chatStream');
    const chatTimelineEl = byId('chatTimeline');
    const chatIncidentLabelEl = byId('chatIncidentLabel');
    const chatSearchInput = byId('chatSearchInput');
    const chatComposerInput = byId('chatComposerInput');
    const chatSendButton = byId('chatSendButton');
    const chatScrollCta = byId('chatScrollCta');
    const chatGoBottomBtn = byId('chatGoBottom');
    const chatDayPillEl = byId('chatDayPill');
    const chatKpiRefs = {
      mensajes: byId('chatKpiMensajes'),
      eventos: byId('chatKpiEventos'),
      archivos: byId('chatKpiArchivos'),
      agentes: byId('chatKpiAgentes')
    };

    try {
      if (byId('cg-id')) byId('cg-id').textContent = data.id;
      if (byId('cg-title')) byId('cg-title').textContent = data.titulo;
      if (byId('cg-estado')) byId('cg-estado').textContent = data.estado;
      if (byId('cg-prioridad')) byId('cg-prioridad').textContent = data.prioridad || data.severidad || '‚Äî';
      if (byId('cg-creacion')) byId('cg-creacion').textContent = data.fechaCreacion;
      if (byId('cg-tiempo')) byId('cg-tiempo').textContent = data.tiempoTranscurrido;
      if (byId('cg-sla-text')) byId('cg-sla-text').textContent = (data.slaPorcentaje ?? 0) + '%';
      const estadoBtns = document.querySelectorAll('.estado-btn');
      estadoBtns.forEach(btn => {
        if (btn.dataset.state === data.estado) btn.classList.add('is-active');
        else btn.classList.remove('is-active');
      });
      dibujarSlaPie(data.slaPorcentaje);
      if (byId('cg-direccion')) byId('cg-direccion').textContent = data.direccion;
      if (byId('cg-clasificacion')) byId('cg-clasificacion').textContent = data.clasificacion;
      if (byId('cg-tipo')) byId('cg-tipo').textContent = data.tipo;
      if (byId('cg-subtipo')) byId('cg-subtipo').textContent = data.subtipo;
      if (byId('cg-desc')) byId('cg-desc').textContent = data.descripcion;

      // Sections for agentes/personas/c√°maras are managed in dedicated tabs; omitted here.
      renderPersonasTab(data);
      renderIncidentTabs();
      renderAssignedAgents();
      renderChatTimeline();
    } catch(_) {}

    function dibujarSlaPie(porcentaje){
      var canvas = document.getElementById('cg-sla-pie');
      if (!canvas || !canvas.getContext) return;
      var ctx = canvas.getContext('2d');
      var pct = Math.max(0, Math.min(100, Number(porcentaje) || 0)) / 100;
      var cx = canvas.width / 2;
      var cy = canvas.height / 2;
      var radius = Math.min(canvas.width, canvas.height) / 2 - 4;

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      ctx.beginPath();
      ctx.arc(cx, cy, radius, 0, Math.PI * 2);
      ctx.fillStyle = '#3a3a3a';
      ctx.fill();

      ctx.beginPath();
      ctx.moveTo(cx, cy);
      ctx.arc(cx, cy, radius, -Math.PI / 2, (Math.PI * 2 * pct) - Math.PI / 2);
      ctx.closePath();
      ctx.fillStyle = '#ef4444';
      ctx.fill();

      ctx.beginPath();
      ctx.arc(cx, cy, radius - 6, 0, Math.PI * 2);
      ctx.fillStyle = '#2b2b2b';
      ctx.fill();
    }

    function renderPersonasTab(info){
      var denSection = byId('denunciante-section');
      if (!denSection) return;
      var denunciante = info && info.denunciante;
      if (denunciante) {
        var dn = byId('denunciante-nombre');
        var dt = byId('denunciante-telefono');
        var dd = byId('denunciante-documento');
        if (dn) dn.textContent = denunciante.nombre || '‚Äî';
        if (dt) dt.textContent = denunciante.telefono || '‚Äî';
        if (dd) dd.textContent = denunciante.documento || '‚Äî';
        denSection.style.display = '';
      } else {
        denSection.style.display = 'none';
      }
    }

    function formatTransportLabel(text){
      if (!text) return '';
      var upper = text.toString().trim().toUpperCase();
      if (upper.startsWith('A ') || upper.startsWith('EN ')) return upper;
      return 'EN ' + upper;
    }

    function renderIncidentTabs(){
      var container = byId('incidentTabs');
      if (!container) return;
      container.innerHTML = '';
      incidentTabsData.forEach(function(tab){
        var button = document.createElement('button');
        button.type = 'button';
        button.className = 'incident-tab' + (tab.id === activeIncidentTab ? ' active' : '');
        button.innerHTML = `
          <div class="incident-id">${tab.id}</div>
          <div class="incident-title">${tab.title}</div>
          <div class="incident-meta">${tab.summary}</div>
          ${tab.unread > 0 ? `<span class="unread">${tab.unread}</span>` : ''}
        `;
        button.addEventListener('click', function(){
          activeIncidentTab = tab.id;
          tab.unread = 0;
          chatAutoScroll = true;
          renderIncidentTabs();
          renderChatTimeline();
        });
        container.appendChild(button);
      });
      updateChatIncidentContext();
    }
    function updateChatIncidentContext(){
      if (!chatIncidentLabelEl) return;
      var active = incidentTabsData.find(function(tab){ return tab.id === activeIncidentTab; });
      chatIncidentLabelEl.textContent = active ? (active.id + ' ‚Ä¢ ' + active.title) : '‚Äî';
    }
    function getChatTimelineForIncident(incidentId){
      if (!chatTimelineByIncident[incidentId]) chatTimelineByIncident[incidentId] = [];
      return chatTimelineByIncident[incidentId];
    }
    function formatChatTime(date){
      return date.toLocaleTimeString('es-PE', { hour: '2-digit', minute: '2-digit' });
    }
    function buildChatEvent(item){
      var wrapper = document.createElement('div');
      wrapper.className = 'chat-event';
      var icon = document.createElement('div');
      icon.className = 'event-icon';
      icon.textContent = item.icon || '‚öôÔ∏è';
      var body = document.createElement('div');
      var title = document.createElement('div');
      title.className = 'event-title';
      title.textContent = item.title || 'Evento del sistema';
      var detail = document.createElement('div');
      detail.className = 'event-detail';
      detail.textContent = item.detail || '';
      var meta = document.createElement('div');
      meta.className = 'event-meta';
      meta.textContent = item.timestamp || formatChatTime(new Date());
      body.appendChild(title);
      if (item.detail) body.appendChild(detail);
      body.appendChild(meta);
      wrapper.appendChild(icon);
      wrapper.appendChild(body);
      return wrapper;
    }
    function buildChatMessage(item){
      var wrapper = document.createElement('div');
      wrapper.className = 'chat-message ' + (item.from === 'operator' ? 'from-operator' : 'from-agent');
      var author = document.createElement('div');
      author.className = 'chat-message-author';
      var authorName = document.createElement('span');
      authorName.className = 'chat-message-name';
      authorName.textContent = item.name || (item.from === 'operator' ? 'Operador CAD' : 'Agente de campo');
      author.appendChild(authorName);
      if (item.role){
        var role = document.createElement('span');
        role.className = 'chat-message-role';
        role.textContent = item.role;
        author.appendChild(role);
      }
      var text = document.createElement('div');
      text.className = 'chat-message-text';
      text.textContent = item.text || '';
      wrapper.appendChild(author);
      wrapper.appendChild(text);
      if (item.attachments && item.attachments.length){
        var attBox = document.createElement('div');
        attBox.className = 'chat-attachments';
        item.attachments.forEach(function(att){
          var tag = document.createElement('div');
          tag.className = 'chat-attachment';
          var typeLabel = att.type ? att.type.toString().toUpperCase() : 'ARCHIVO';
          tag.textContent = typeLabel + ' ¬∑ ' + (att.name || 'Adjunto');
          attBox.appendChild(tag);
        });
        wrapper.appendChild(attBox);
      }
      var meta = document.createElement('div');
      meta.className = 'chat-message-meta';
      meta.textContent = item.timestamp || formatChatTime(new Date());
      wrapper.appendChild(meta);
      return wrapper;
    }
    function renderChatTimeline(){
      if (!chatTimelineEl) return;
      var items = getChatTimelineForIncident(activeIncidentTab);
      var term = chatFilterTerm.trim().toLowerCase();
      chatTimelineEl.innerHTML = '';
      var hasVisible = false;
      items.forEach(function(item){
        var searchable = [
          item.title || '',
          item.detail || '',
          item.text || '',
          item.name || ''
        ].join(' ').toLowerCase();
        if (term && searchable.indexOf(term) === -1) return;
        hasVisible = true;
        chatTimelineEl.appendChild(item.type === 'event' ? buildChatEvent(item) : buildChatMessage(item));
      });
      if (!hasVisible){
        var empty = document.createElement('div');
        empty.className = 'chat-stream-empty';
        empty.textContent = 'No hay actividad que coincida con el filtro.';
        chatTimelineEl.appendChild(empty);
      }
      if (chatDayPillEl){
        var now = new Date();
        chatDayPillEl.textContent = 'Hoy ¬∑ ' + now.toLocaleDateString('es-PE', { day: '2-digit', month: 'short' });
      }
      updateChatKpis();
      if (chatAutoScroll && chatStreamEl){
        requestAnimationFrame(function(){
          chatStreamEl.scrollTop = chatStreamEl.scrollHeight;
          if (chatScrollCta) chatScrollCta.style.display = 'none';
        });
      } else if (chatScrollCta && chatStreamEl){
        var nearBottom = chatStreamEl.scrollHeight - chatStreamEl.scrollTop - chatStreamEl.clientHeight < 40;
        chatScrollCta.style.display = nearBottom ? 'none' : 'flex';
      }
    }
    function updateChatKpis(){
      var timeline = getChatTimelineForIncident(activeIncidentTab);
      var totalMensajes = timeline.filter(function(item){ return item.type === 'message'; }).length;
      var totalEventos = timeline.filter(function(item){ return item.type === 'event'; }).length;
      var totalArchivos = timeline.reduce(function(acc, item){
        return acc + ((item.attachments && item.attachments.length) || 0);
      }, 0);
      if (chatKpiRefs.mensajes) chatKpiRefs.mensajes.textContent = totalMensajes;
      if (chatKpiRefs.eventos) chatKpiRefs.eventos.textContent = totalEventos;
      if (chatKpiRefs.archivos) chatKpiRefs.archivos.textContent = totalArchivos;
      if (chatKpiRefs.agentes) chatKpiRefs.agentes.textContent = assignedAgents.length;
    }
    function addChatEntry(incidentId, entry){
      var timeline = getChatTimelineForIncident(incidentId);
      timeline.push(entry);
      if (incidentId === activeIncidentTab){
        renderChatTimeline();
      }
    }
    function addChatMessage(incidentId, payload){
      addChatEntry(incidentId, Object.assign({
        id: 'msg-' + Date.now(),
        type: 'message',
        timestamp: formatChatTime(new Date())
      }, payload));
    }
    function addChatEvent(incidentId, payload){
      addChatEntry(incidentId, Object.assign({
        id: 'evt-' + Date.now(),
        type: 'event',
        timestamp: formatChatTime(new Date()),
        icon: '‚öôÔ∏è'
      }, payload));
    }
    function handleChatSend(){
      if (!chatComposerInput) return;
      var message = chatComposerInput.value.trim();
      if (!message) return;
      chatComposerInput.value = '';
      chatAutoScroll = true;
      addChatMessage(activeIncidentTab, {
        from: 'operator',
        name: 'Operadora CAD',
        role: 'CAD',
        text: message
      });
      scheduleAgentResponse(activeIncidentTab);
    }
    function scheduleAgentResponse(targetIncident){
      if (!assignedAgents.length) return;
      var replies = [
        'Recibido, seguimos en el punto.',
        'Coordinando con tr√°nsito local.',
        'Atenci√≥n completada, pendientes de nueva indicaci√≥n.'
      ];
      var responder = assignedAgents[Math.floor(Math.random() * assignedAgents.length)];
      setTimeout(function(){
        addChatMessage(targetIncident, {
          from: 'agent',
          name: responder.shortName,
          role: responder.status || 'En campo',
          text: replies[Math.floor(Math.random() * replies.length)]
        });
      }, 1500);
    }

    function renderAssignedAgents(){
      var container = byId('assignedAgentsContainer');
      if (!container) return;
      container.innerHTML = '';
      if (!assignedAgents.length) {
        var empty = document.createElement('div');
        empty.className = 'personas-empty';
        empty.textContent = 'Sin agentes asignados.';
        container.appendChild(empty);
        updateChatKpis();
        return;
      }
      assignedAgents.forEach(function(agent){
        var tag = document.createElement('div');
        tag.className = 'agent-tag';
        var infoBlock = document.createElement('div');
        infoBlock.className = 'agent-info-block';
        var name = document.createElement('div');
        name.className = 'agent-name';
        name.textContent = agent.shortName;
        var meta = document.createElement('div');
        meta.className = 'agent-meta-chip';
        var transportText = formatTransportLabel(agent.transporte || '');
        var statusText = agent.status ? ' ‚Ä¢ ' + agent.status.toUpperCase() : '';
        meta.textContent = (transportText + statusText).trim();
        infoBlock.appendChild(name);
        if (meta.textContent) infoBlock.appendChild(meta);
        var btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'btn btn-default btn-rounded release-agent-btn';
        btn.textContent = 'Liberar';
        btn.addEventListener('click', function(){ releaseAgent(agent.shortName); });
        tag.appendChild(infoBlock);
        tag.appendChild(btn);
        container.appendChild(tag);
      });
      updateChatKpis();
    }

    function releaseAgent(agentName){
      var idx = assignedAgents.findIndex(function(agent){ return agent.shortName === agentName; });
      if (idx === -1) return;
      var removed = assignedAgents[idx];
      assignedAgents.splice(idx, 1);
      renderAssignedAgents();
      renderAgentList(currentAgentSearchTerm.length > 0, currentAgentSearchTerm);
      addChatEvent(activeIncidentTab, {
        icon: '‚Ü©Ô∏è',
        title: 'Agente liberado',
        detail: (removed ? removed.shortName : agentName) + ' sali√≥ del incidente.'
      });
    }

    let currentAgentSearchTerm = '';
    if (chatSearchInput){
      chatSearchInput.addEventListener('input', function(evt){
        chatFilterTerm = evt.target.value || '';
        chatAutoScroll = true;
        renderChatTimeline();
      });
    }
    if (chatSendButton){
      chatSendButton.addEventListener('click', handleChatSend);
    }
    if (chatComposerInput){
      chatComposerInput.addEventListener('keydown', function(evt){
        if (evt.key === 'Enter' && !evt.shiftKey){
          evt.preventDefault();
          handleChatSend();
        }
      });
    }
    if (chatStreamEl){
      chatStreamEl.addEventListener('scroll', function(){
        var nearBottom = chatStreamEl.scrollHeight - chatStreamEl.scrollTop - chatStreamEl.clientHeight < 40;
        chatAutoScroll = nearBottom;
        if (chatScrollCta) chatScrollCta.style.display = nearBottom ? 'none' : 'flex';
      });
    }
    if (chatGoBottomBtn){
      chatGoBottomBtn.addEventListener('click', function(){
        chatAutoScroll = true;
        if (chatStreamEl) chatStreamEl.scrollTo({ top: chatStreamEl.scrollHeight, behavior: 'smooth' });
        if (chatScrollCta) chatScrollCta.style.display = 'none';
      });
    }

    function openAssignAgentModal(){
      var modal = byId('assignAgentModal');
      if (!modal) return;
      currentAgentSearchTerm = '';
      var input = byId('agentSearchInput');
      if (input) input.value = '';
      renderAgentList(false, '');
      modal.classList.add('active');
      setTimeout(function(){ if (input) input.focus(); }, 100);
    }

    function closeAssignAgentModal(){
      var modal = byId('assignAgentModal');
      if (modal) modal.classList.remove('active');
    }

    function filterAgents(){
      var input = byId('agentSearchInput');
      currentAgentSearchTerm = input ? input.value.trim() : '';
      var includeOccupied = currentAgentSearchTerm.length > 0;
      renderAgentList(includeOccupied, currentAgentSearchTerm);
    }

    function renderAgentList(includeOccupied, searchTerm){
      if (includeOccupied === undefined) includeOccupied = false;
      if (searchTerm === undefined) searchTerm = '';
      var container = byId('agentListContainer');
      if (!container) return;
      var agentsToShow = availableAgents.filter(function(agent){
        return !assignedAgents.some(function(a){ return a.shortName === agent.shortName; });
      });
      if (!includeOccupied && !searchTerm) {
        agentsToShow = agentsToShow.filter(function(agent){ return agent.status === 'Disponible'; });
      }
      if (searchTerm) {
        agentsToShow = agentsToShow.filter(function(agent){
          return agent.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                 agent.transporte.toLowerCase().includes(searchTerm.toLowerCase());
        });
      }
      agentsToShow.sort(function(a,b){
        return parseFloat(a.distancia) - parseFloat(b.distancia);
      });
      container.innerHTML = '';
      if (!agentsToShow.length) {
        container.innerHTML = '<div class="no-results">No se encontraron agentes disponibles</div>';
        return;
      }
      agentsToShow.forEach(function(agent){
        var item = document.createElement('div');
        item.className = 'agent-list-item' + (agent.status === 'Ocupado' ? ' ocupado' : '');
        if (agent.status !== 'Ocupado') {
          item.addEventListener('click', function(){ assignAgent(agent); });
        }
        var info = document.createElement('div');
        info.className = 'agent-info';
        var name = document.createElement('div');
        name.className = 'agent-list-name';
        name.textContent = agent.name;
        var role = document.createElement('div');
        role.className = 'agent-list-role';
        role.textContent = formatTransportLabel(agent.transporte || '');
        info.appendChild(name);
        info.appendChild(role);
        if (agent.status === 'Ocupado' && agent.incidenteActual) {
          var tag = document.createElement('div');
          tag.className = 'agent-incident-tag';
          tag.textContent = 'Atendiendo incidente ' + agent.incidenteActual;
          info.appendChild(tag);
        }
        var meta = document.createElement('div');
        meta.style.textAlign = 'right';
        var statusMark = document.createElement('div');
        statusMark.style.fontSize = '1.2rem';
        statusMark.textContent = agent.status === 'Ocupado' ? '‚è∏' : '‚úì';
        if (agent.status === 'Ocupado') statusMark.style.color = '#999';
        var distance = document.createElement('div');
        distance.className = 'agent-distance';
        distance.textContent = 'üìç ' + agent.distancia;
        meta.appendChild(statusMark);
        meta.appendChild(distance);
        item.appendChild(info);
        item.appendChild(meta);
        container.appendChild(item);
      });
    }

    function assignAgent(agent){
      if (assignedAgents.some(function(a){ return a.shortName === agent.shortName; })) return;
      assignedAgents.push({
        shortName: agent.shortName,
        transporte: agent.transporte,
        status: agent.status
      });
      renderAssignedAgents();
      renderAgentList(currentAgentSearchTerm.length > 0, currentAgentSearchTerm);
      addChatEvent(activeIncidentTab, {
        icon: 'üëÆ',
        title: 'Agente asignado',
        detail: agent.shortName + ' (' + formatTransportLabel(agent.transporte || '') + ') incorporado.'
      });
      closeAssignAgentModal();
    }
    function releaseAllAgents(){
      if (!assignedAgents.length) return;
      var released = assignedAgents.length;
      assignedAgents.length = 0;
      renderAssignedAgents();
      renderAgentList(currentAgentSearchTerm.length > 0, currentAgentSearchTerm);
      addChatEvent(activeIncidentTab, {
        icon: '‚Ü©Ô∏è',
        title: 'Agentes liberados',
        detail: released + ' ' + (released === 1 ? 'agente liberado del incidente.' : 'agentes liberados del incidente.')
      });
    }

    document.addEventListener('click', function(e){
      if (e.target.classList && e.target.classList.contains('modal-overlay')) {
        closeAssignAgentModal();
      }
    });
    document.addEventListener('keydown', function(e){
      if (e.key === 'Escape') closeAssignAgentModal();
    });
    window.openAssignAgentModal = openAssignAgentModal;
    window.closeAssignAgentModal = closeAssignAgentModal;
    window.filterAgents = filterAgents;
    window.releaseAllAgents = releaseAllAgents;
  })();
</script>
<script>
  (function attachNuevoIncidenteModal(){
    function ensureLeaflet(cb){
      if (typeof L !== 'undefined') {
        if (cb) cb();
        return;
      }
      var existing = document.querySelector('script[data-leaflet]');
      if (existing) {
        if (cb) existing.addEventListener('load', cb, { once: true });
        return;
      }
      var script = document.createElement('script');
      script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
      script.defer = true;
      script.setAttribute('data-leaflet', '1');
      if (cb) script.addEventListener('load', cb, { once: true });
      document.head.appendChild(script);
    }

    function initNuevoIncidenteMap(){
      var modal = document.getElementById('modalIncidenteNuevo');
      if (!modal) return;
      var mapEl = modal.querySelector('#incn-inline-map');
      if (!mapEl || mapEl.dataset.leaflet === '1') return;
      var hint = modal.querySelector('#incn-map-hint');
      ensureLeaflet(function(){
        try {
          var latInput = modal.querySelector('#incn-lat');
          var lngInput = modal.querySelector('#incn-lng');
          var map = L.map(mapEl, { zoomControl: true, attributionControl: true });
          var center = [-12.1175, -76.9990];
          map.setView(center, 14);
          L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            maxZoom: 20,
            attribution: '&copy; OpenStreetMap contributors &copy; CARTO'
          }).addTo(map);
          var marker;
          function placeMarker(latlng){
            if (marker) marker.setLatLng(latlng);
            else marker = L.marker(latlng).addTo(map);
            if (latInput) latInput.value = latlng.lat.toFixed(6);
            if (lngInput) lngInput.value = latlng.lng.toFixed(6);
            if (hint) hint.style.display = 'none';
          }
          mapEl.addEventListener('mouseenter', function(){ if (hint) hint.style.display = 'none'; }, { once: true });
          map.on('click', function(evt){ placeMarker(evt.latlng); });
          var defaultLatLng = L.latLng(center[0], center[1]);
          marker = L.marker(defaultLatLng).addTo(map).bindPopup('<b>Incidente</b><br>Av. Primavera 123').openPopup();
          if (latInput) latInput.value = defaultLatLng.lat.toFixed(6);
          if (lngInput) lngInput.value = defaultLatLng.lng.toFixed(6);
          setTimeout(function(){ map.invalidateSize(); }, 60);
          mapEl.dataset.leaflet = '1';
          mapEl._leafletMap = map;
        } catch(error){
          console.error('Leaflet init error', error);
        }
      });
    }

    function showNuevoIncidenteModal(){
      var modal = document.getElementById('modalIncidenteNuevo');
      if (!modal) return;
      if (window.$ && typeof window.$('#modalIncidenteNuevo').modal === 'function') {
        window.$('#modalIncidenteNuevo')
          .one('shown.bs.modal', function(){ initNuevoIncidenteMap(); })
          .modal('show');
      } else {
        modal.style.display = 'block';
        modal.classList.add('in');
        modal.setAttribute('aria-hidden', 'false');
        setTimeout(initNuevoIncidenteMap, 50);
      }
    }

    function bindNuevoIncidenteButton(){
      var trigger = document.getElementById('addticket');
      if (!trigger || trigger.dataset.niBound === '1') return;
      trigger.dataset.niBound = '1';
      trigger.addEventListener('click', showNuevoIncidenteModal);
    }

    document.addEventListener('DOMContentLoaded', bindNuevoIncidenteButton);
  })();
</script>
