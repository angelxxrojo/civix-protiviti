<!-- SweetAlert2 (requerido por la consola CAD) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- Leaflet -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Tu app CAD -->



<style>

  /* Estilos espec√≠ficos para CAD */
  .cad-container {
    padding: 15px;
  }

  .cad-scrollable {
    max-height: calc(100vh - 200px);
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: #666 #222;
  }

  .cad-scrollable::-webkit-scrollbar {
    width: 6px;
  }

  .cad-scrollable::-webkit-scrollbar-track {
    background: #222;
  }

  .cad-scrollable::-webkit-scrollbar-thumb {
    background: #666;
    border-radius: 3px;
  }

  .cad-tab {
    padding-top: 16px;
    padding-bottom: 16px;
  }

  

  /* Tab activo - sobreescribe btn-accent para tener opacidad 75% */
  .cad-tab.btn-accent {
    background: rgba(246, 114, 0, 0.75) !important;
    border: 2px solid #f67200 !important;
    color: white !important;
  }

  .cad-tab.btn-accent:hover {
    background: rgba(246, 114, 0, 0.85) !important;
  }

  .cad-badge-critica { background: #dc3545; color: white; }
  .cad-badge-alta { background: #ff7a2f; color: white; }
  .cad-badge-media { background: #ffc107; color: #000; }
  .cad-badge-baja { background: #28a745; color: white; }

  /* C√≠rculos de alerta para tabs */
  .alert-circle {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 8px;
  }

  .alert-circle-critica {
    background: #dc3545;
    box-shadow: 0 0 8px rgba(220, 53, 69, 0.6);
  }

  .alert-circle-alta {
    background: #ff7a2f;
    box-shadow: 0 0 8px rgba(255, 122, 47, 0.6);
  }

  .alert-circle-media {
    background: #ffc107;
    box-shadow: 0 0 8px rgba(255, 193, 7, 0.6);
  }

  .alert-circle-baja {
    background: #28a745;
    box-shadow: 0 0 8px rgba(40, 167, 69, 0.6);
  }

  /* Badge de mensajes sin leer */
  .unread-badge {
    position: absolute;
    top: -6px;
    right: -6px;
    background: #dc3545;
    color: white;
    font-size: 10px;
    font-weight: 700;
    padding: 3px 7px;
    border-radius: 12px;
    min-width: 20px;
    text-align: center;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
    z-index: 10;
    border: 2px solid #1a1a1a;
  }

  /* Tab con mensajes sin leer - animaci√≥n de iluminaci√≥n */
  .ticket-has-unread {
    animation: pulse-glow 2s ease-in-out infinite;
    border: 2px solid rgba(246, 114, 0, 0.5) !important;
  }

  @keyframes pulse-glow {
    0%, 100% {
      box-shadow: 0 0 10px rgba(246, 114, 0, 0.3);
    }
    50% {
      box-shadow: 0 0 20px rgba(246, 114, 0, 0.6), 0 0 30px rgba(246, 114, 0, 0.4);
    }
  }

  /* Estilo para tabs de tickets */
  .ticket-tab {
    position: relative !important;
    padding: 12px 14px;
    min-width: 180px;
    text-align: left;
    border-radius: 8px;
    transition: all 0.3s ease;
    overflow: visible !important;
  }

  .ticket-tab:hover {
    transform: translateY(-2px);
  }

  .map-grid-cell {
    border: 1px solid #444;
    background: #1a1a1a;
  }

  .map-marker {
    position: absolute;
    width: 30px;
    height: 30px;
    background: #f67200;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 12px;
    cursor: pointer;
    transition: transform 0.2s;
  }

  .map-marker:hover {
    transform: scale(1.2);
  }

  .chat-message {
    padding: 10px 14px;
    border-radius: 12px;
    margin-bottom: 8px;
    max-width: 75%;
    position: relative;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
  }

  .chat-message.from-operator {
    background: #005c4b;
    margin-left: auto;
    margin-right: 8px;
    border-bottom-right-radius: 4px;
  }

  .chat-message.from-agent {
    background: #1f2937;
    margin-right: auto;
    margin-left: 8px;
    border-bottom-left-radius: 4px;
  }

  .chat-message-author {
    font-size: 12px;
    font-weight: 600;
    margin-bottom: 4px;
    color: #a7f3d0;
  }

  .chat-message.from-agent .chat-message-author {
    color: #fbbf24;
  }

  .chat-message-role {
    font-size: 11px;
    font-weight: 400;
    color: #9ca3af;
    margin-left: 6px;
  }

  .chat-message-text {
    font-size: 14px;
    line-height: 1.4;
    color: #ffffff;
    margin-bottom: 4px;
    word-wrap: break-word;
  }

  .chat-message-meta {
    font-size: 10px;
    color: rgba(255, 255, 255, 0.5);
    text-align: right;
    margin-top: 4px;
  }

  .chat-attachments {
    margin-top: 6px;
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
  }

  .chat-attachment {
    font-size: 11px;
    padding: 4px 8px;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    color: #a7f3d0;
    display: inline-block;
  }

  /* Estilo para el contenedor de mensajes (tipo WhatsApp) */
  #chatTimeline {
    padding: 8px 0;
  }

  .chat-event {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 8px 16px;
    margin: 12px auto;
    background: rgba(41, 41, 41, 0.6);
    border-radius: 20px;
    border: 1px solid rgb(111 111 111 / 50%);
    max-width: 85%;
    font-size: 12px;
    color: #9ca3af;
  }

  .event-icon {
    font-size: 20px;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #1e293b;
    border-radius: 6px;
    flex-shrink: 0;
  }

  .event-title {
    font-size: 14px;
    font-weight: 600;
    color: #e5e7eb;
    margin-bottom: 4px;
  }

  .event-detail {
    font-size: 13px;
    color: #9ca3af;
    margin-bottom: 4px;
  }

  .event-meta {
    font-size: 11px;
    color: #6b7280;
  }

  /* Badge parpadeante para mensajes no le√≠dos */
  @keyframes pulse-badge {
    0%, 100% {
      opacity: 1;
      transform: scale(1);
    }
    50% {
      opacity: 0.7;
      transform: scale(1.1);
    }
  }

  .badge-unread {
    animation: pulse-badge 2s infinite;
    background: #ef4444 !important;
    color: white !important;
    font-weight: 700;
  }

  /* Estilos para botones de ticket con mensajes sin leer */
  .ticket-has-unread {
    position: relative;
  }

  .ticket-has-unread::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 0;
    width: 4px;
    height: 60%;
    background: #ef4444;
    border-radius: 0 2px 2px 0;
    transform: translateY(-50%);
    animation: pulse-indicator 1.5s infinite;
  }

  @keyframes pulse-indicator {
    0%, 100% {
      opacity: 1;
    }
    50% {
      opacity: 0.5;
    }
  }

  /* Estilos para modal de asignaci√≥n de agentes */
  .modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    z-index: 9999;
    align-items: center;
    justify-content: center;
  }

  .modal-overlay.active {
    display: flex;
  }

  .agent-modal {
    background: #1a1a1a;
    border-radius: 12px;
    max-width: 600px;
    width: 90%;
    max-height: 80vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
  }

  .agent-modal-header {
    padding: 20px 24px;
    border-bottom: 1px solid #2d2d2d;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .agent-modal-title {
    font-size: 18px;
    font-weight: 600;
    color: #e5e7eb;
    margin: 0;
  }

  .agent-modal-close {
    background: none;
    border: none;
    color: #9ca3af;
    font-size: 28px;
    cursor: pointer;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    transition: background 0.2s;
  }

  .agent-modal-close:hover {
    background: #2d2d2d;
    color: #e5e7eb;
  }

  .agent-modal-body {
    padding: 20px 24px;
    overflow-y: auto;
    flex: 1;
  }

  .modal-search {
    margin-bottom: 20px;
  }

  .modal-search input {
    width: 100%;
    padding: 10px 14px;
    border: 1px solid #2d2d2d;
    border-radius: 8px;
    background: #0f0f0f;
    color: #e5e7eb;
    font-size: 14px;
  }

  .modal-search input:focus {
    outline: none;
    border-color: #f67200;
  }

  .btn{
    margin-right: 8px;
    }
    
  .dot{width:10px;height:10px;border-radius:50%}
  .ok{background:var(--ok)} .away{background:var(--away)} .busy{background:var(--busy)}
    

  .map-panel-body {
    display: flex;
    padding: 0.9rem;
    flex: none;
    min-height: 420px;
    height: 420px;
  }
  #mapCAD {
    flex: 1;
    min-height: 100%;
    height: calc(100vh - 280px);
    border-radius: 12px;
    overflow: hidden;
  }

  .map-panel-body {
    display: flex;
    flex-direction: column;
    height: calc(100vh - 280px);
    padding: 0 !important;
  }

  /* Animaci√≥n de pulso para c√°maras que detectaron placas */
  @keyframes pulse {
    0%, 100% {
      transform: scale(1);
      box-shadow: 0 0 20px rgba(239, 68, 68, 0.6);
    }
    50% {
      transform: scale(1.1);
      box-shadow: 0 0 30px rgba(239, 68, 68, 0.9);
    }
  }
  .map-filters {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    padding: 0.75rem 1.25rem 1rem;
    color: #e5e7eb;
    font-size: 0.9rem;
  }
  .map-filter-section {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    border: 1px solid #262626;
    border-radius: 10px;
    padding: 0.85rem 0.9rem;
    background: #121212;
  }
  .map-filter-title {
    font-size: 0.78rem;
    letter-spacing: 0.12em;
    font-weight: 700;
    color: #e5e7eb;
    text-transform: uppercase;
  }
  .map-filter-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 0.5rem 1rem;
  }
  .map-filter-separator {
    width: 100%;
    height: 1px;
    background: #1f1f1f;
    margin-top: 0.25rem;
  }
  .map-filter-item {
    display: flex;
    align-items: center;
    gap: 0.45rem;
  }
  .map-filter-item input {
    width: 18px;
    height: 18px;
    accent-color: #22c55e;
  }
  
  
</style>

<div class="row">
  <div class="col-md-12">
    <div class="">
      <div class="panel-heading">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <h4 class="m-b-none">Tickets Activos</h4>
          <span class="badge" id="ticketsCount">3 tickets</span>
        </div>
      </div>
      <div class="panel-body" style="overflow-x: auto; white-space: nowrap;">
        <div id="incidentTabs">
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row cad-container">
    <!-- Primera Columna - Formulario -->
    <div class="col-md-4">
        <div class="cad-scrollable" id="ticketFormContainer">
          <!-- Panel: Header Principal -->
          <div class="panel panel-filled mb-2">
            <div class="panel-heading">
              <h4 class="m-b-none">Registro de Incidencias ‚Äì Seguridad Ciudadana</h4>
            </div>
            <div class="panel-body">
              <small id="formTicketHeader">Ticket #3242 ‚Ä¢ 27/11/2025, 7:24:24 a.m.</small>
            </div>
          </div>
          
          <!-- Panel: Informaci√≥n General del Reporte -->
          <div class="panel panel-filled panel-inner-radius mb-2">
            <div class="panel-heading">
              <h5 class="m-b-none">Informaci√≥n General del Reporte</h5>
            </div>
            <div class="panel-body">
              <div class="row">
                <div class="col-lg-6">
                  <div class="form-group">
                    <label>ID de la Incidencia</label>
                    <input type="text" id="formIncidentId" class="form-control rounded-input bg-dark" readonly value="#3242">
                  </div>
                </div>
                <div class="col-lg-6">
                  <div class="form-group">
                    <label>Nivel de Alerta</label>
                    <select id="formAlertLevel" class="form-control rounded-input">
                      <option value="critica"> <span class="dot away"></span> Cr√≠tica</option>
                      <option value="alta">Alta</option>
                      <option value="media">Media</option>
                      <option value="baja">Baja</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Panel: Datos del Reportante -->
          <div class="panel panel-filled   panel-inner-radius mb-2">
            <div class="panel-heading">
              <h5 class="m-b-none">Datos del Reportante</h5>
            </div>
            <div class="panel-body">
              <div class="row">
                <div class="col-lg-6">
                  <div class="form-group">
                    <label>Nombre completo *</label>
                    <input type="text" id="formReporterName" class="form-control rounded-input" placeholder="Nombre completo" value="Juan P√©rez Garc√≠a">
                  </div>
                </div>
                <div class="col-lg-6">
                  <div class="form-group">
                    <label>DNI / Identificaci√≥n *</label>
                    <input type="text" id="formReporterDNI" class="form-control rounded-input" placeholder="DNI" value="12345678">
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-lg-6">
                  <div class="form-group">
                    <label>Tel√©fono de contacto *</label>
                    <input type="text" id="formReporterPhone" class="form-control rounded-input" placeholder="Tel√©fono" value="55 9876 5432">
                  </div>
                </div>
                <div class="col-lg-6">
                  <div class="form-group">
                    <label>Correo electr√≥nico</label>
                    <input type="email" id="formReporterEmail" class="form-control rounded-input" placeholder="correo@ejemplo.com" value="juan@example.com">
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-lg-12">
                  <div class="form-group">
                    <label>Relaci√≥n con el hecho</label>
                    <select id="formReporterRelation" class="form-control rounded-input">
                      <option value="">Seleccionar</option>
                      <option value="victima" selected>V√≠ctima</option>
                      <option value="testigo">Testigo</option>
                      <option value="tercero">Tercero</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>
        
          <!-- Panel: Tipo de Incidencia -->
          <div class="panel panel-filled  panel-inner-radius mb-2">
            <div class="panel-heading">
              <h5 class="m-b-none">Tipo de Incidencia</h5>
            </div>
            <div class="panel-body">
              <div class="form-group">
                <label>Tipo de Incidencia *</label>
                <select id="formIncidentType" class="form-control rounded-input">
                  <option value="">Seleccionar</option>
                  <option value="robo-vehiculo">üöó Robo de Veh√≠culo</option>
                  <option value="persona-sospechosa">üë§ Persona Sospechosa</option>
                  <option value="persona-desaparecida">üîç Persona Desaparecida</option>
                  <option value="vehiculo-sospechoso">üöô Veh√≠culo Sospechoso</option>
                  <option value="otra">üìã Otra incidencia</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Card: Persona Desaparecida (Din√°mico seg√∫n tipo) -->
          <div class="panel panel-filled panel-inner-radius mb-2" id="formMissingPersonSection" style="display: none;">
            <div class="panel-heading">
              <h5 class="m-b-none">Datos de la Persona Desaparecida</h5>
            </div>
            <div class="panel-body">
              <div class="row">
                <div class="col-lg-6">
                  <div class="form-group">
                    <label>Nombre completo</label>
                    <input type="text" id="formMissingName" class="form-control rounded-input" placeholder="Nombre completo">
                  </div>
                </div>
                <div class="col-lg-6">
                  <div class="form-group">
                    <label>Edad</label>
                    <input type="text" id="formMissingAge" class="form-control rounded-input" placeholder="Edad">
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-lg-6">
                  <div class="form-group">
                    <label>G√©nero</label>
                    <select id="formMissingGender" class="form-control rounded-input">
                      <option value="">Seleccionar</option>
                      <option value="masculino">Masculino</option>
                      <option value="femenino">Femenino</option>
                      <option value="otro">Otro</option>
                    </select>
                  </div>
                </div>
                <div class="col-lg-6">
                  <div class="form-group">
                    <label>DNI</label>
                    <input type="text" id="formMissingDNI" class="form-control rounded-input" placeholder="DNI">
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-lg-12">
                  <div class="form-group">
                    <label>Fecha y hora vista por √∫ltima vez</label>
                    <input type="datetime-local" id="formMissingLastSeen" class="form-control rounded-input">
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-lg-12">
                  <div class="form-group">
                    <label>Lugar donde fue vista por √∫ltima vez</label>
                    <input type="text" id="formMissingLastLocation" class="form-control rounded-input" placeholder="Ubicaci√≥n">
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-lg-12">
                  <div class="form-group">
                    <label>Descripci√≥n de la persona</label>
                    <textarea id="formMissingDescription" class="form-control rounded-input" placeholder="Incluya vestimenta, se√±ales particulares, tatuajes, cicatrices, etc." rows="4"></textarea>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-lg-12">
                  <div class="form-group">
                    <label>¬øTiene problemas m√©dicos o cognitivos?</label>
                    <select id="formMissingMedical" class="form-control rounded-input">
                      <option value="">Seleccionar</option>
                      <option value="si">S√≠</option>
                      <option value="no">No</option>
                      <option value="desconoce">Desconoce</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>
        
          <!-- Card: Persona Sospechosa (Din√°mico seg√∫n tipo) -->
          <div class="panel panel-filled panel-inner-radius mb-2" id="formSuspiciousPersonSection" style="display: none;">
            <div class="panel-heading">
              <h5 class="m-b-none">Datos de la Persona Sospechosa</h5>
            </div>
            <div class="panel-body">
              <div class="row">
                <div class="col-lg-6">
                  <div class="form-group">
                    <label>Nombre (opcional)</label>
                    <input type="text" id="formSuspiciousName" class="form-control rounded-input" placeholder="Si se conoce">
                  </div>
                </div>
                <div class="col-lg-6">
                  <div class="form-group">
                    <label>Alias (opcional)</label>
                    <input type="text" id="formSuspiciousAlias" class="form-control rounded-input" placeholder="Apodo o alias">
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-lg-12">
                  <div class="form-group">
                    <label>Descripci√≥n f√≠sica</label>
                    <textarea id="formSuspiciousDescription" class="form-control rounded-input" placeholder="Estatura, complexi√≥n, rasgos distintivos..." rows="3"></textarea>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-lg-12">
                  <div class="form-group">
                    <label>Motivo de sospecha</label>
                    <textarea id="formSuspiciousReason" class="form-control rounded-input" placeholder="¬øPor qu√© es sospechosa?" rows="3"></textarea>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-lg-12">
                  <div class="form-group">
                    <label>√öltimo lugar visto</label>
                    <input type="text" id="formSuspiciousLocation" class="form-control rounded-input" placeholder="Ubicaci√≥n">
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-lg-12">
                  <div class="form-group">
                    <label>¬øVinculado con hechos anteriores?</label>
                    <select id="formSuspiciousLinked" class="form-control rounded-input">
                      <option value="">Seleccionar</option>
                      <option value="si">S√≠</option>
                      <option value="no">No</option>
                      <option value="desconoce">Desconoce</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>
    
          <!-- Card: Veh√≠culo Sospechoso (Din√°mico seg√∫n tipo) -->
          <div class="panel panel-filled panel-inner-radius mb-2" id="formSuspiciousVehicleSection" style="display: none;">
            <div class="panel-heading">
              <h5 class="m-b-none">Datos del Veh√≠culo Sospechoso</h5>
            </div>
            <div class="panel-body">
              <div class="row">
                <div class="col-lg-12">
                  <div class="form-group">
                    <label>Placa (opcional)</label>
                    <input type="text" id="formSuspVehiclePlate" class="form-control rounded-input" placeholder="Si es visible">
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-lg-6">
                  <div class="form-group">
                    <label>Tipo de veh√≠culo</label>
                    <input type="text" id="formSuspVehicleType" class="form-control rounded-input" placeholder="Auto, camioneta, etc.">
                  </div>
                </div>
                <div class="col-lg-6">
                  <div class="form-group">
                    <label>Color</label>
                    <input type="text" id="formSuspVehicleColor" class="form-control rounded-input" placeholder="Color">
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-lg-12">
                  <div class="form-group">
                    <label>Detalles distintivos</label>
                    <textarea id="formSuspVehicleDetails" class="form-control rounded-input" placeholder="Calcoman√≠as, da√±os, caracter√≠sticas especiales..." rows="3"></textarea>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-lg-12">
                  <div class="form-group">
                    <label>Lugar donde fue visto</label>
                    <input type="text" id="formSuspVehicleLocation" class="form-control rounded-input" placeholder="Ubicaci√≥n">
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-lg-12">
                  <div class="form-group">
                    <label>Hora de registro</label>
                    <input type="time" id="formSuspVehicleTime" class="form-control rounded-input">
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-lg-12">
                  <div class="form-group">
                    <label>Comportamiento sospechoso</label>
                    <textarea id="formSuspVehicleBehavior" class="form-control rounded-input" placeholder="¬øQu√© hace que sea sospechoso?" rows="3"></textarea>
                  </div>
                </div>
              </div>
            </div>
          </div>
    
          <!-- Card: Datos del Robo de Veh√≠culo (Din√°mico seg√∫n tipo) -->
          <div class="panel panel-filled panel-inner-radius mb-2" id="formVehicleSection" style="display: none;">
            <div class="panel-heading">
              <h5 class="m-b-none">Datos del Robo de Veh√≠culo</h5>
            </div>
            <div class="panel-body">
              <div class="row">
                <div class="col-lg-6">
                  <div class="form-group">
                    <label>Tipo de veh√≠culo</label>
                    <select id="formVehicleType" class="form-control rounded-input">
                      <option value="">Seleccionar</option>
                      <option value="auto">Autom√≥vil</option>
                      <option value="moto">Motocicleta</option>
                      <option value="camioneta">Camioneta</option>
                      <option value="otro">Otro</option>
                    </select>
                  </div>
                </div>
                <div class="col-lg-6">
                  <div class="form-group">
                    <label>Marca / Modelo</label>
                    <input type="text" id="formVehicleBrand" class="form-control rounded-input" placeholder="Ej: Toyota Corolla">
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-lg-4">
                  <div class="form-group">
                    <label>Placa</label>
                    <input type="text" id="formVehiclePlate" class="form-control rounded-input" placeholder="ABC-123">
                  </div>
                </div>
                <div class="col-lg-4">
                  <div class="form-group">
                    <label>Color</label>
                    <input type="text" id="formVehicleColor" class="form-control rounded-input" placeholder="Color">
                  </div>
                </div>
                <div class="col-lg-4">
                  <div class="form-group">
                    <label>A√±o</label>
                    <input type="text" id="formVehicleYear" class="form-control rounded-input" placeholder="2020">
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-lg-12">
                  <div class="form-group">
                    <label>Lugar del robo</label>
                    <input type="text" id="formVehicleLocation" class="form-control rounded-input" placeholder="Ubicaci√≥n exacta">
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-lg-12">
                  <div class="form-group">
                    <label>Fecha y hora del robo</label>
                    <input type="datetime-local" id="formVehicleDateTime" class="form-control rounded-input">
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-lg-12">
                  <div class="form-group">
                    <label>¬øTiene GPS?</label>
                    <select id="formVehicleGPS" class="form-control rounded-input">
                      <option value="">Seleccionar</option>
                      <option value="si">S√≠</option>
                      <option value="no">No</option>
                      <option value="desconoce">Desconoce</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>
    
          <!-- Panel: Evidencia Adjunta -->
          <div class="panel panel-filled panel-inner-radius mb-2">
            <div class="panel-heading">
              <h5 class="m-b-none">Evidencia Adjunta (Opcional)</h5>
            </div>
            <div class="panel-body">
              <p style="font-size: 13px; color: #9ca3af; margin-bottom: 15px;">Sube fotos, videos, documentos o audio relacionados con el incidente</p>
              <input type="file" id="evidenceFileInput" multiple accept="image/*,video/*,audio/*,.pdf,.doc,.docx" style="display: none;">
              <button type="button" id="uploadEvidenceBtn" class="btn btn-accent" style="width: 100%;">
                <i class="pe-7s-upload" aria-hidden="true"></i> Subir archivos (m√°x. 10 archivos)
              </button>
              <div id="formEvidenceList" style="margin-top: 15px;"></div>
            </div>
          </div>

          <!-- Panel: Ubicaci√≥n del Incidente -->
          <div class="panel panel-filled panel-inner-radius mb-2">
            <div class="panel-heading">
              <h5 class="m-b-none">
                <i class="pe-7s-map-marker" aria-hidden="true"></i> Ubicaci√≥n del Incidente
              </h5>
            </div>
            <div class="panel-body">
              <div class="row">
                <div class="col-lg-12">
                  <div class="form-group">
                    <label>Direcci√≥n exacta *</label>
                    <input type="text" id="formLocationAddress" class="form-control rounded-input" placeholder="Calle, n√∫mero, colonia">
                    <p style="font-size: 11px; color: #9ca3af; margin-top: 5px;">üí° Usa el mapa de la derecha para buscar y autocompletar</p>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-lg-6">
                  <div class="form-group">
                    <label>Distrito *</label>
                    <input type="text" id="formLocationDistrict" class="form-control rounded-input" placeholder="Distrito">
                  </div>
                </div>
                <div class="col-lg-6">
                  <div class="form-group">
                    <label>Provincia *</label>
                    <input type="text" id="formLocationProvince" class="form-control rounded-input" placeholder="Provincia">
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-lg-12">
                  <div class="form-group">
                    <label>Referencia</label>
                    <input type="text" id="formLocationReference" class="form-control rounded-input" placeholder="Frente a..., cerca de...">
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-lg-12">
                  <div class="form-group">
                    <label>Coordenadas GPS</label>
                    <input type="text" id="formLocationCoordinates" class="form-control rounded-input" placeholder="Auto-detectado o manual" readonly style="background: #2a2a2a;">
                  </div>
                </div>
              </div>

              <!-- Agentes Cercanos Disponibles -->
              <div id="nearbyAgentsSection" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid #374151;">
                <div style="margin-bottom: 12px;">
                  <strong style="color: #e5e7eb; font-size: 14px;">
                    <i class="pe-7s-users" aria-hidden="true"></i> Agentes Disponibles Cercanos
                  </strong>
                  <p style="font-size: 11px; color: #9ca3af; margin-top: 5px;">Ordenados por proximidad al incidente</p>
                </div>
                <div id="nearbyAgentsList" style="max-height: 250px; overflow-y: auto;">
                  <!-- Los agentes cercanos se renderizar√°n aqu√≠ -->
                </div>
              </div>
            </div>
          </div>

          <!-- Bot√≥n Guardar -->
          <div class="panel panel-filled panel-inner-radius mb-2">
            <div class="panel-body" style="text-align: center;">
              <button type="button" id="saveTicketBtn" class="btn btn-accent" style="width: 100%; padding: 12px; font-size: 15px; font-weight: 600;">
                <i class="pe-7s-diskette" aria-hidden="true"></i> Guardar Cambios del Ticket
              </button>
            </div>
          </div>

          <!-- Panel: Agentes Asignados a este Ticket -->
          <div class="panel panel-filled panel-inner-radius mb-2">
            <div class="panel-heading">
              <h5 class="m-b-none">Agentes Asignados a este Ticket</h5>
            </div>
            <div class="panel-body" style="padding: 0;">
              <div id="ticketAssignedAgentsList" style="max-height: 300px; overflow-y: auto;">
                <!-- Los agentes asignados a ESTE ticket se renderizar√°n aqu√≠ -->
              </div>
            </div>
          </div>

        </div>
    </div>

    <!-- COLUMNA 2: Chat del Ticket -->
    <div class="col-md-4">
    <div class="panel panel-filled  " style="display: flex; flex-direction: column; height: calc(100vh - 200px);">

      <!-- Header del Chat -->
      <div class="panel-heading">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
          <div>
            <h5 class="m-b-none">Chat del ticket</h5>
            <div style="font-size: 12px; margin-top: 8px;">
              <div>Ticket: <strong id="chatTicketId">#3242</strong></div>
              <div>Agente: <strong id="chatAgentName">Agente Rodr√≠guez</strong></div>
              <div>Estado: <span style="color: #f67200;" id="chatTicketStatus">En atenci√≥n</span></div>
            </div>
          </div>
        </div>
      </div>

      <!-- √Årea de mensajes -->
      <div class="panel-body cad-scrollable" style="flex: 1; background: #111111; padding: 16px 12px;">
        <div id="chatTimeline" style="display: flex; flex-direction: column;">
          <!-- Los mensajes se renderizan aqu√≠ con JS -->
        </div>
      </div>

      <!-- Input de mensaje -->
      <div class="panel-footer" style="background: #252525; border-top: 1px solid #374151; padding: 12px;">
        <div style="display: flex; gap: 8px; align-items: center;">
          <input
            type="text"
            id="chatComposerInput"
            class="form-control"
            placeholder="Escribe un mensaje..."
            style="flex: 1; background: #1a1a1a; border: 1px solid #374151; color: #fff; border-radius: 20px; padding: 10px 16px;"
          >
          <button
            type="button"
            id="chatSendButton"
            class="btn btn-accent"
            style="border-radius: 50%; width: 42px; height: 42px; padding: 0; display: flex; align-items: center; justify-content: center;"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z"></path>
              <path d="m21.854 2.147-10.94 10.939"></path>
            </svg>
          </button>
        </div>
      </div>

    </div>
  </div>

    <!-- COLUMNA 3: Mapa Interactivo -->
    <div class="col-md-4">
        <div class="panel panel-filled  " style="display: flex; flex-direction: column; height: calc(100vh - 200px);">
            <!-- Header del Mapa -->
            <div class="panel-heading">
                <h5 class="m-b-none" id="mapTitle">Mapa Interactivo</h5>
                <div style="display: flex; gap: 8px; margin-top: 10px;">
                <input
                    type="text"
                    id="mapSearchInput"
                    class="form-control rounded-input"
                    placeholder="Buscar direcci√≥n..."
                    style="flex: 1;"
                  >
                  <button
                    type="button"
                    id="mapSearchBtn"
                    class="btn btn-accent btn-rounded"
                    style="width: 40px; padding: 8px;"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <circle cx="11" cy="11" r="8"></circle>
                      <path d="m21 21-4.3-4.3"></path>
                    </svg>
                </button>
                </div>
                <!-- Mensaje informativo para b√∫squeda de placas -->
                <div id="plateSearchInfo" style="display: none; margin-top: 10px; padding: 10px; background: #1e3a1e; border-radius: 6px; font-size: 12px; color: #22c55e;">
                  <strong>ü§ñ IA de Detecci√≥n:</strong> Las c√°maras que detectaron esta placa se marcar√°n en el mapa
                </div>
            </div>
        
            <!-- Tabs: Agentes / C√°maras -->
            <div style="padding: 10px; border-bottom: 1px solid #3d404c;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; background: #1a1a1a; padding: 4px; border-radius: 8px;" id="mapTabs">
                  <button
                    type="button"
                    data-tab="agents"
                    class="map-tab active"
                    style="display: flex; align-items: center; justify-content: center; gap: 6px; padding: 8px; font-size: 13px; border-radius: 6px; background: #252525; border: none; cursor: pointer;"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                      <circle cx="9" cy="7" r="4"></circle>
                      <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
                      <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    <span>Agentes</span>
                  </button>
                  <button
                    type="button"
                    data-tab="cameras"
                    class="map-tab"
                    style="display: flex; align-items: center; justify-content: center; gap: 6px; padding: 8px; font-size: 13px; border-radius: 6px; background: transparent; border: none; cursor: pointer; opacity: 0.6;"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"></path>
                      <circle cx="12" cy="13" r="3"></circle>
                    </svg>
                    <span>C√°maras</span>
                  </button>
                </div>
            </div>
        
            <!-- √Årea del Mapa -->
            <div class="panel-body map-panel-body">
                    <div id="mapCAD"></div>
            </div>
            
        </div>
    </div>
</div>

<div class="row">
  <div class="col-md-4">

  </div>
  <div class="col-md-4">
    <button
                type="button"
                id="closeTicketBtn"
                class="btn btn-w-md btn-default btn-block"
                style="margin-top: 5px;"
                title="Cerrar ticket"
              >
                <i class="pe-7s-close-circle" aria-hidden="true"></i> Cerrar Ticket
              </button>
  </div>
  <div class="col-md-4">

  </div>
</div>

<!-- Modal para asignar agente -->
<div class="modal fade" id="assignAgentModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header text-left">
                <h4 class="modal-title mb-0">Asignar Agente al Incidente</h4>
                <h7 class="mb-0" id="assignModalTicketInfo">Seleccione un agente disponible</h7>
            </div>

            <div class="modal-body">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="panel panel-filled panel-c-accent" style="border-radius: 15px">
                            <div class="panel-heading">
                                <h5>B√öSQUEDA DE AGENTES</h5>
                            </div>
                            <div class="panel-body">
                                <div class="form-group">
                                    <input
                                      type="text"
                                      id="agentSearchInput"
                                      class="form-control"
                                      placeholder="Buscar agente por nombre o transporte..."
                                      oninput="filterAgents()"
                                    />
                                </div>
                            </div>
                        </div>

                        <div class="panel panel-filled panel-c-accent" style="border-radius: 15px; margin-top: 15px;">
                            <div class="panel-heading">
                                <h5>AGENTES DISPONIBLES</h5>
                            </div>
                            <div class="panel-body" style="max-height: 400px; overflow-y: auto;">
                                <div id="agentListContainer"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-default btn-rounded" data-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmaci√≥n para crear ticket -->
<div class="modal fade" id="newTicketModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header text-left">
                <h4 class="modal-title mb-0">Crear Nuevo Ticket</h4>
                <h7 class="mb-0">¬øEst√° seguro que desea crear un nuevo ticket?</h7>
            </div>

            <div class="modal-body">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="panel panel-filled panel-c-accent" style="border-radius: 15px">
                            <div class="panel-body text-center" style="padding: 40px;">
                                <i class="pe-7s-note2" style="font-size: 64px; color: #f67200;"></i>
                                <h4 style="margin-top: 20px; margin-bottom: 15px;">Crear Nuevo Ticket de Incidente</h4>
                                <p style="color: #9ca3af; font-size: 14px;">
                                    Se crear√° un nuevo ticket que podr√° ser editado y asignado a un agente.<br>
                                    El ticket quedar√° registrado en el sistema.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-default btn-rounded" data-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-accent btn-rounded" onclick="confirmCreateTicket()">Crear Ticket</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmaci√≥n para cerrar ticket -->
<div class="modal fade" id="closeTicketModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header text-left">
                <h4 class="modal-title mb-0">Cerrar Ticket</h4>
                <h7 class="mb-0" id="closeTicketModalInfo">Ticket #000</h7>
            </div>

            <div class="modal-body">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="panel panel-filled panel-c-accent" style="border-radius: 15px">
                            <div class="panel-heading">
                                <h5>MOTIVO DE CIERRE</h5>
                            </div>
                            <div class="panel-body">
                                <div class="form-group">
                                    <label>Motivo *</label>
                                    <select id="closeTicketReason" class="form-control">
                                        <option value="">Seleccione motivo</option>
                                        <option value="resuelto">Incidente Resuelto</option>
                                        <option value="falsa-alarma">Falsa Alarma</option>
                                        <option value="duplicado">Ticket Duplicado</option>
                                        <option value="sin-respuesta">Sin Respuesta del Reportante</option>
                                        <option value="derivado">Derivado a Otra Autoridad</option>
                                        <option value="otro">Otro</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Observaciones *</label>
                                    <textarea id="closeTicketObservations" class="form-control" rows="5" placeholder="Describa el motivo del cierre y las acciones tomadas..." style="resize: none;"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-default btn-rounded" data-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger btn-rounded" onclick="confirmCloseTicket()">Cerrar Ticket</button>
            </div>
        </div>
    </div>
</div>

<script>
  // ============================================
  // MAPA INTERACTIVO CON AGENTES
  // ============================================

  var cadMap = null;
  var agentMarkers = [];
  var currentLocationMarker = null;

  // Pool de nombres de agentes para generar aleatoriamente
  var agentNamesPool = [
    { name: 'Agente Ram√≠rez', shortName: 'A. Ram√≠rez' },
    { name: 'Agente Vega', shortName: 'C. Vega' },
    { name: 'Agente Su√°rez', shortName: 'D. Su√°rez' },
    { name: 'Agente Torres', shortName: 'E. Torres' },
    { name: 'Agente L√≥pez', shortName: 'F. L√≥pez' },
    { name: 'Agente Garc√≠a', shortName: 'G. Garc√≠a' },
    { name: 'Agente Mart√≠nez', shortName: 'H. Mart√≠nez' },
    { name: 'Agente Fern√°ndez', shortName: 'I. Fern√°ndez' },
    { name: 'Agente Castro', shortName: 'J. Castro' },
    { name: 'Agente Rojas', shortName: 'K. Rojas' },
    { name: 'Agente Mendoza', shortName: 'L. Mendoza' },
    { name: 'Agente Silva', shortName: 'M. Silva' },
    { name: 'Agente Vargas', shortName: 'N. Vargas' },
    { name: 'Agente Morales', shortName: 'O. Morales' },
    { name: 'Agente Reyes', shortName: 'P. Reyes' }
  ];

  var transportTypes = ['Camioneta', 'Motocicleta', 'Bicicleta', 'A pie'];

  // Lista din√°mica de agentes (se regenera seg√∫n la ubicaci√≥n del incidente)
  var agentsData = [];

  // Pool de ubicaciones de c√°maras de seguridad
  var cameraLocations = [
    { name: 'C√°mara Av. Arequipa 1234', coords: [-12.0850, -77.0350] },
    { name: 'C√°mara Jr. Lampa 567', coords: [-12.0470, -77.0300] },
    { name: 'C√°mara Av. Brasil 890', coords: [-12.0650, -77.0500] },
    { name: 'C√°mara Jr. Ucayali 234', coords: [-12.0560, -77.0280] },
    { name: 'C√°mara Av. Tacna 789', coords: [-12.0750, -77.0420] },
    { name: 'C√°mara Av. Abancay 456', coords: [-12.0580, -77.0310] },
    { name: 'C√°mara Jr. Carabaya 123', coords: [-12.0450, -77.0290] },
    { name: 'C√°mara Av. Grau 890', coords: [-12.0520, -77.0410] },
    { name: 'C√°mara Jr. Ancash 345', coords: [-12.0490, -77.0320] },
    { name: 'C√°mara Av. Colonial 678', coords: [-12.0620, -77.0460] },
    { name: 'C√°mara Jr. Huallaga 901', coords: [-12.0540, -77.0295] },
    { name: 'C√°mara Av. Venezuela 234', coords: [-12.0680, -77.0380] }
  ];

  var cameraMarkers = [];
  var detectedPlateData = {}; // Almacena qu√© placas fueron detectadas por qu√© c√°maras

  // Initialize Leaflet map for the operator chat view
  document.addEventListener('DOMContentLoaded', function () {
    var el = document.getElementById('mapCAD');
    if (!el || typeof L === 'undefined') return;

    cadMap = L.map('mapCAD', { zoomControl: true, attributionControl: true });
    // Center near Av. Primavera; adjust as needed
    var primavera = [-12.1175, -76.9990];
    cadMap.setView(primavera, 14);

    // Dark theme basemap
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      maxZoom: 20,
      attribution: '&copy; OpenStreetMap contributors &copy; CARTO'
    }).addTo(cadMap);

    // Icono personalizado para agentes
    var agentIcon = L.divIcon({
      className: 'agent-marker-icon',
      html: '<div style="background: #22c55e; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);">üëÆ</div>',
      iconSize: [32, 32],
      iconAnchor: [16, 16]
    });

    // Icono para ubicaci√≥n del incidente
    var incidentIcon = L.divIcon({
      className: 'incident-marker-icon',
      html: '<div style="background: #ef4444; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 16px; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.4);">üìç</div>',
      iconSize: [36, 36],
      iconAnchor: [18, 18]
    });

    // Marcar ubicaci√≥n de ejemplo del incidente
    currentLocationMarker = L.marker(primavera, { icon: incidentIcon })
      .addTo(cadMap)
      .bindPopup('<b>Ubicaci√≥n del incidente</b><br>Av. Primavera 123');

    // üî• Generar agentes aleatorios iniciales alrededor de Av. Primavera
    regenerateAgentsAroundIncident(primavera[0], primavera[1]);

    // Renderizar agentes en el mapa
    renderAgentsOnMap();

    // Ensure correct sizing in case of late layout/visibility changes
    setTimeout(function () { cadMap.invalidateSize(); }, 300);

    // Event listeners para los tabs del mapa
    initializeMapTabs();

    // Inicializar b√∫squeda en el mapa
    initMapSearchForCAD();

    // Inicializar lista de agentes asignados
    renderAssignedAgentsList();
  });

  // Funci√≥n para inicializar b√∫squeda en el mapa CAD
  function initMapSearchForCAD() {
    var input = document.getElementById('mapSearchInput');
    var btn = document.getElementById('mapSearchBtn');

    if (btn) {
      btn.addEventListener('click', function() {
        var query = input ? input.value.trim() : '';
        if (query) {
          // Detectar en qu√© pesta√±a estamos
          if (activeMapTab === 'cameras') {
            searchPlateWithAI(query);
          } else {
            searchAddress(query);
          }
        }
      });
    }

    if (input) {
      input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          var query = input.value.trim();
          if (query) {
            // Detectar en qu√© pesta√±a estamos
            if (activeMapTab === 'cameras') {
              searchPlateWithAI(query);
            } else {
              searchAddress(query);
            }
          }
        }
      });
    }
  }

  // Funci√≥n para renderizar agentes en el mapa
  function renderAgentsOnMap() {
    if (!cadMap) return;

    // Limpiar marcadores anteriores
    agentMarkers.forEach(function(marker) {
      cadMap.removeLayer(marker);
    });
    agentMarkers = [];

    // Crear icono para agentes disponibles
    var agentIcon = L.divIcon({
      className: 'agent-marker-icon',
      html: '<div style="background: #22c55e; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);">üëÆ</div>',
      iconSize: [32, 32],
      iconAnchor: [16, 16]
    });

    // Agregar marcadores para agentes disponibles (sin ticket asignado)
    agentsData.forEach(function(agent) {
      if (agent.status === 'Disponible' && !agent.assignedTicket) {
        var marker = L.marker(agent.coords, { icon: agentIcon })
          .addTo(cadMap)
          .bindPopup(
            '<div style="min-width: 180px;">' +
              '<strong>' + agent.name + '</strong><br>' +
              '<span style="color: #6b7280;">üöó ' + agent.transporte + '</span><br>' +
              '<span style="color: #22c55e;">‚óè Disponible</span><br>' +
              '<span style="color: #6b7280;">üìç ' + agent.distancia + '</span><br>' +
              '<button onclick="assignAgentFromMap(\'' + agent.id + '\')" class="btn btn-accent btn-sm" style="margin-top: 8px; width: 100%;">Asignar Ticket</button>' +
            '</div>'
          );

        agentMarkers.push(marker);
      }
    });
  }

  // Funci√≥n para asignar un ticket desde el mapa
  function assignAgentFromMap(agentId) {
    if (!ticketsState.activeTicketId) {
      showNotification('Debe seleccionar un ticket primero', 'warning');
      return;
    }

    var agent = agentsData.find(function(a) { return a.id === agentId; });
    if (!agent) return;

    var ticket = ticketsState.tickets.find(function(t) { return t.id === ticketsState.activeTicketId; });
    if (!ticket) return;

    // Asignar ticket al agente
    agent.assignedTicket = ticket.id;
    agent.status = 'Ocupado';

    // Agregar evento al chat del ticket
    var now = new Date();
    var timeString = now.getHours() + ':' + String(now.getMinutes()).padStart(2, '0');

    var assignEvent = {
      type: 'event',
      icon: 'üëÆ',
      title: 'Agente asignado',
      detail: agent.name + ' ‚Ä¢ ' + agent.transporte,
      timestamp: timeString
    };

    if (!ticket.chatMessages) {
      ticket.chatMessages = [];
    }
    ticket.chatMessages.push(assignEvent);

    // Actualizar estado del ticket
    ticket.status = 'asignado';

    // Recargar chat y mapa
    loadTicketChat(ticket);
    renderAgentsOnMap();
    renderAssignedAgentsList();
    renderTicketAssignedAgents();

    showNotification('Agente ' + agent.name + ' asignado al ticket ' + ticket.id, 'success');
  }

  // Hacer funci√≥n global
  window.assignAgentFromMap = assignAgentFromMap;

  // Funci√≥n para inicializar tabs del mapa
  // Variable global para controlar el tab activo
  var activeMapTab = 'agents';

  function initializeMapTabs() {
    var mapTabs = document.querySelectorAll('.map-tab');

    mapTabs.forEach(function(tab) {
      tab.addEventListener('click', function() {
        var tabType = this.getAttribute('data-tab');

        // Actualizar estilos de tabs
        mapTabs.forEach(function(t) {
          t.classList.remove('active');
          t.style.background = 'transparent';
          t.style.opacity = '0.6';
        });

        this.classList.add('active');
        this.style.background = '#252525';
        this.style.opacity = '1';

        // Actualizar variable global
        activeMapTab = tabType;

        // Cambiar placeholder y funcionalidad del buscador
        var mapSearchInput = document.getElementById('mapSearchInput');
        var mapTitle = document.getElementById('mapTitle');
        var plateSearchInfo = document.getElementById('plateSearchInfo');

        if (tabType === 'agents') {
          mapSearchInput.placeholder = 'Buscar direcci√≥n...';
          mapTitle.textContent = 'Mapa Interactivo - Agentes';
          plateSearchInfo.style.display = 'none';
          renderAgentsOnMap();
        } else if (tabType === 'cameras') {
          mapSearchInput.placeholder = 'Buscar placa del veh√≠culo...';
          mapSearchInput.value = '';
          mapTitle.textContent = 'Mapa Interactivo - C√°maras IA';
          plateSearchInfo.style.display = 'block';
          renderCamerasOnMap();
        }
      });
    });
  }

  // Funci√≥n para renderizar lista de agentes asignados
  function renderAssignedAgentsList() {
    var container = document.getElementById('assignedAgentsList');
    if (!container) return;

    // Filtrar agentes que tienen tickets asignados
    var assignedAgents = agentsData.filter(function(agent) {
      return agent.assignedTicket !== null;
    });

    // Limpiar contenedor
    container.innerHTML = '';

    if (assignedAgents.length === 0) {
      container.innerHTML = '<div style="padding: 20px; text-align: center; color: #9ca3af; font-size: 13px;">No hay agentes asignados</div>';
      return;
    }

    // Renderizar cada agente asignado
    assignedAgents.forEach(function(agent) {
      var ticket = ticketsState.tickets.find(function(t) { return t.id === agent.assignedTicket; });
      var ticketInfo = ticket ? ticket.id : agent.assignedTicket;
      var ticketStatus = ticket ? ticket.status : 'desconocido';

      var agentCard = document.createElement('div');
      agentCard.style.cssText = 'padding: 12px 15px; border-bottom: 1px solid #1e293b; cursor: pointer; transition: background 0.2s;';
      agentCard.onmouseenter = function() { this.style.background = '#0f172a'; };
      agentCard.onmouseleave = function() { this.style.background = 'transparent'; };

      agentCard.innerHTML =
        '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">' +
          '<strong style="font-size: 14px; color: #e5e7eb;">' + agent.name + '</strong>' +
          '<span style="font-size: 11px; padding: 2px 6px; background: #1e3a1e; border-radius: 4px; color: #22c55e;">Ocupado</span>' +
        '</div>' +
        '<div style="font-size: 12px; color: #9ca3af; margin-bottom: 4px;">üöó ' + agent.transporte + '</div>' +
        '<div style="font-size: 12px; color: #9ca3af; margin-bottom: 4px;">üìã Ticket: <span style="color: #f67200; font-weight: 600;">' + ticketInfo + '</span></div>' +
        '<div style="font-size: 11px; color: #6b7280;">Estado: ' + ticketStatus + '</div>' +
        '<button onclick="releaseAgentFromTicket(\'' + agent.id + '\')" class="btn btn-sm" style="margin-top: 8px; width: 100%; padding: 6px; font-size: 11px; background: #dc2626; color: white; border: none;">Liberar Agente</button>';

      agentCard.addEventListener('click', function(e) {
        // No hacer nada al hacer click en el bot√≥n
        if (e.target.tagName === 'BUTTON') return;

        // Ir al ticket del agente
        if (ticket) {
          selectTicket(ticket.id);
        }
      });

      container.appendChild(agentCard);
    });
  }

  // Funci√≥n para liberar un agente de su ticket
  function releaseAgentFromTicket(agentId) {
    var agent = agentsData.find(function(a) { return a.id === agentId; });
    if (!agent) return;

    var ticketId = agent.assignedTicket;

    if (typeof Swal !== 'undefined') {
      Swal.fire({
        title: '¬øLiberar agente?',
        text: '¬øEst√° seguro que desea liberar a ' + agent.name + ' del ticket ' + ticketId + '?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#dc2626',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'S√≠, liberar',
        cancelButtonText: 'Cancelar'
      }).then(function(result) {
        if (result.isConfirmed) {
          // Liberar agente
          agent.assignedTicket = null;
          agent.status = 'Disponible';

          // Actualizar ticket si existe
          var ticket = ticketsState.tickets.find(function(t) { return t.id === ticketId; });
          if (ticket) {
            ticket.status = 'abierto';

            // Agregar evento al chat
            var now = new Date();
            var timeString = now.getHours() + ':' + String(now.getMinutes()).padStart(2, '0');

            var releaseEvent = {
              type: 'event',
              icon: 'üîì',
              title: 'Agente liberado',
              detail: agent.name + ' fue liberado del ticket',
              timestamp: timeString
            };

            if (!ticket.chatMessages) {
              ticket.chatMessages = [];
            }
            ticket.chatMessages.push(releaseEvent);

            // Recargar chat si es el ticket activo
            if (ticketsState.activeTicketId === ticketId) {
              loadTicketChat(ticket);
            }
          }

          // Actualizar mapa y lista
          renderAgentsOnMap();
          renderAssignedAgentsList();
          renderTicketAssignedAgents();

          showNotification('Agente ' + agent.name + ' liberado exitosamente', 'success');
        }
      });
    } else {
      if (confirm('¬øEst√° seguro que desea liberar a ' + agent.name + ' del ticket ' + ticketId + '?')) {
        // Liberar agente
        agent.assignedTicket = null;
        agent.status = 'Disponible';

        // Actualizar mapa y lista
        renderAgentsOnMap();
        renderAssignedAgentsList();
        renderTicketAssignedAgents();

        showNotification('Agente ' + agent.name + ' liberado exitosamente', 'success');
      }
    }
  }

  // Hacer funci√≥n global
  window.releaseAgentFromTicket = releaseAgentFromTicket;
</script>
<script>
  // General tab renderer (read-only context)
  (function(){
    function byId(id){ return document.getElementById(id); }
    var data = {
      id: 'INC-2025-001',
      titulo: 'Accidente de tr√°nsito en Av. Primavera',
      estado: 'Clasificado',
      origen: 'Llamada 105',
      severidad: 'Media',
      prioridad: 'Alta',
      fechaCreacion: '12/01/2025 10:30',
      tiempoTranscurrido: '18.50 h',
      slaPorcentaje: 82,
      direccion: 'Av. Primavera 123, Santiago de Surco',
      coords: '-12.117500, -76.999000',
      clasificacion: 'Tr√°nsito',
      tipo: 'Accidente de tr√°nsito',
      subtipo: 'Choque',
      descripcion: 'Colisi√≥n entre dos veh√≠culos. Sin heridos de gravedad reportados. Congesti√≥n en carril derecho.',
      denunciante: {
        nombre: 'Mario Salazar',
        telefono: '+51 999 123 456',
        documento: 'DNI 12345678'
      },
      agentes: [ { nombre:'A. Ram√≠rez' }, { nombre:'B. Torres' } ],
      personas: [ { nombre:'Juan P√©rez', rol:'Afectado' }, { nombre:'Mar√≠a L√≥pez', rol:'Testigo' } ],
      camaras: [
        { id:'CAM-014', estado:'online', ubicacion:'Primavera x Central', distancia:'120m' },
        { id:'CAM-021', estado:'offline', ubicacion:'Primavera x Velasco', distancia:'350m' }
      ]
    };
    const incidentTabsData = [
      { id: 'INC-2025-001', title: 'Accidente en Av. Primavera', summary: 'Colisi√≥n de veh√≠culos; tr√°nsito lento', unread: 3 },
      { id: 'INC-2025-014', title: 'Robo en Plaza Central', summary: 'Sospechoso huy√≥ hacia Av. Grau', unread: 1 },
      { id: 'INC-2025-022', title: 'Manifestaci√≥n no autorizada', summary: 'Grupo de 50 personas frente a municipalidad', unread: 0 },
      { id: 'INC-2025-027', title: 'Corte de electricidad', summary: 'Sector Los √Ålamos sin servicio', unread: 8 },
    ];
    let activeIncidentTab = incidentTabsData[0].id;

    const assignedAgents = [
      { shortName: 'A. Ram√≠rez', transporte: 'Camioneta', status: 'Disponible' },
      { shortName: 'B. Torres', transporte: 'Motocicleta', status: 'En ruta' },
    ];
    const availableAgents = [
      { id: 'ramirez', name: 'Agente Ram√≠rez', shortName: 'A. Ram√≠rez', transporte: 'Camioneta', status: 'Disponible', distancia: '0.8 km', incidenteActual: null },
      { id: 'vega', name: 'Agente Vega', shortName: 'C. Vega', transporte: 'Bicicleta', status: 'Disponible', distancia: '1.2 km', incidenteActual: null },
      { id: 'suarez', name: 'Agente Su√°rez', shortName: 'D. Su√°rez', transporte: 'Camioneta', status: 'Ocupado', distancia: '5.3 km', incidenteActual: '#2051' },
      { id: 'torres', name: 'Agente Torres', shortName: 'E. Torres', transporte: 'Camioneta', status: 'Ocupado', distancia: '3.7 km', incidenteActual: '#2053' },
      { id: 'lopez', name: 'Agente L√≥pez', shortName: 'F. L√≥pez', transporte: 'A pie', status: 'Disponible', distancia: '2.1 km', incidenteActual: null },
      { id: 'garcia', name: 'Agente Garc√≠a', shortName: 'G. Garc√≠a', transporte: 'Camioneta', status: 'Disponible', distancia: '0.5 km', incidenteActual: null },
      { id: 'martinez', name: 'Agente Mart√≠nez', shortName: 'H. Mart√≠nez', transporte: 'Bicicleta', status: 'Disponible', distancia: '1.8 km', incidenteActual: null },
      { id: 'fernandez', name: 'Agente Fern√°ndez', shortName: 'I. Fern√°ndez', transporte: 'Camioneta', status: 'Disponible', distancia: '4.2 km', incidenteActual: null },
      { id: 'diaz', name: 'Agente D√≠az', shortName: 'J. D√≠az', transporte: 'A pie', status: 'Ocupado', distancia: '8.1 km', incidenteActual: '#2048' }
    ];


    function openAssignAgentModal(){
      var modal = byId('assignAgentModal');
      if (!modal) return;
      currentAgentSearchTerm = '';
      var input = byId('agentSearchInput');
      if (input) input.value = '';
      renderAgentList(false, '');
      modal.classList.add('active');
      setTimeout(function(){ if (input) input.focus(); }, 100);
    }

    function closeAssignAgentModal(){
      var modal = byId('assignAgentModal');
      if (modal) modal.classList.remove('active');
    }

    function filterAgents(){
      var input = byId('agentSearchInput');
      currentAgentSearchTerm = input ? input.value.trim() : '';
      var includeOccupied = currentAgentSearchTerm.length > 0;
      renderAgentList(includeOccupied, currentAgentSearchTerm);
    }

    function renderAgentList(includeOccupied, searchTerm){
      if (includeOccupied === undefined) includeOccupied = false;
      if (searchTerm === undefined) searchTerm = '';
      var container = byId('agentListContainer');
      if (!container) return;
      var agentsToShow = availableAgents.filter(function(agent){
        return !assignedAgents.some(function(a){ return a.shortName === agent.shortName; });
      });
      if (!includeOccupied && !searchTerm) {
        agentsToShow = agentsToShow.filter(function(agent){ return agent.status === 'Disponible'; });
      }
      if (searchTerm) {
        agentsToShow = agentsToShow.filter(function(agent){
          return agent.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                 agent.transporte.toLowerCase().includes(searchTerm.toLowerCase());
        });
      }
      agentsToShow.sort(function(a,b){
        return parseFloat(a.distancia) - parseFloat(b.distancia);
      });
      container.innerHTML = '';
      if (!agentsToShow.length) {
        container.innerHTML = '<div class="no-results">No se encontraron agentes disponibles</div>';
        return;
      }
      agentsToShow.forEach(function(agent){
        var item = document.createElement('div');
        item.className = 'agent-list-item' + (agent.status === 'Ocupado' ? ' ocupado' : '');
        if (agent.status !== 'Ocupado') {
          item.addEventListener('click', function(){ assignAgent(agent); });
        }
        var info = document.createElement('div');
        info.className = 'agent-info';
        var name = document.createElement('div');
        name.className = 'agent-list-name';
        name.textContent = agent.name;
        var role = document.createElement('div');
        role.className = 'agent-list-role';
        role.textContent = formatTransportLabel(agent.transporte || '');
        info.appendChild(name);
        info.appendChild(role);
        if (agent.status === 'Ocupado' && agent.incidenteActual) {
          var tag = document.createElement('div');
          tag.className = 'agent-incident-tag';
          tag.textContent = 'Atendiendo incidente ' + agent.incidenteActual;
          info.appendChild(tag);
        }
        var meta = document.createElement('div');
        meta.style.textAlign = 'right';
        var statusMark = document.createElement('div');
        statusMark.style.fontSize = '1.2rem';
        statusMark.textContent = agent.status === 'Ocupado' ? '‚è∏' : '‚úì';
        if (agent.status === 'Ocupado') statusMark.style.color = '#999';
        var distance = document.createElement('div');
        distance.className = 'agent-distance';
        distance.textContent = 'üìç ' + agent.distancia;
        meta.appendChild(statusMark);
        meta.appendChild(distance);
        item.appendChild(info);
        item.appendChild(meta);
        container.appendChild(item);
      });
    }

    function assignAgent(agent){
      if (assignedAgents.some(function(a){ return a.shortName === agent.shortName; })) return;
      assignedAgents.push({
        shortName: agent.shortName,
        transporte: agent.transporte,
        status: agent.status
      });
      renderAssignedAgents();
      renderAgentList(currentAgentSearchTerm.length > 0, currentAgentSearchTerm);
      addChatEvent(activeIncidentTab, {
        icon: 'üëÆ',
        title: 'Agente asignado',
        detail: agent.shortName + ' (' + formatTransportLabel(agent.transporte || '') + ') incorporado.'
      });
      closeAssignAgentModal();
    }
    function releaseAllAgents(){
      if (!assignedAgents.length) return;
      var released = assignedAgents.length;
      assignedAgents.length = 0;
      renderAssignedAgents();
      renderAgentList(currentAgentSearchTerm.length > 0, currentAgentSearchTerm);
      addChatEvent(activeIncidentTab, {
        icon: '‚Ü©Ô∏è',
        title: 'Agentes liberados',
        detail: released + ' ' + (released === 1 ? 'agente liberado del incidente.' : 'agentes liberados del incidente.')
      });
    }

    document.addEventListener('click', function(e){
      if (e.target.classList && e.target.classList.contains('modal-overlay')) {
        closeAssignAgentModal();
      }
    });
    document.addEventListener('keydown', function(e){
      if (e.key === 'Escape') closeAssignAgentModal();
    });
    window.openAssignAgentModal = openAssignAgentModal;
    window.closeAssignAgentModal = closeAssignAgentModal;
    window.filterAgents = filterAgents;
    window.releaseAllAgents = releaseAllAgents;
  })();
</script>
<script>
  (function attachNuevoIncidenteModal(){
    function ensureLeaflet(cb){
      if (typeof L !== 'undefined') {
        if (cb) cb();
        return;
      }
      var existing = document.querySelector('script[data-leaflet]');
      if (existing) {
        if (cb) existing.addEventListener('load', cb, { once: true });
        return;
      }
      var script = document.createElement('script');
      script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
      script.defer = true;
      script.setAttribute('data-leaflet', '1');
      if (cb) script.addEventListener('load', cb, { once: true });
      document.head.appendChild(script);
    }

    function initNuevoIncidenteMap(){
      var modal = document.getElementById('modalIncidenteNuevo');
      if (!modal) return;
      var mapEl = modal.querySelector('#incn-inline-map');
      if (!mapEl || mapEl.dataset.leaflet === '1') return;
      var hint = modal.querySelector('#incn-map-hint');
      ensureLeaflet(function(){
        try {
          var latInput = modal.querySelector('#incn-lat');
          var lngInput = modal.querySelector('#incn-lng');
          var map = L.map(mapEl, { zoomControl: true, attributionControl: true });
          var center = [-12.1175, -76.9990];
          map.setView(center, 14);
          L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            maxZoom: 20,
            attribution: '&copy; OpenStreetMap contributors &copy; CARTO'
          }).addTo(map);
          var marker;
          function placeMarker(latlng){
            if (marker) marker.setLatLng(latlng);
            else marker = L.marker(latlng).addTo(map);
            if (latInput) latInput.value = latlng.lat.toFixed(6);
            if (lngInput) lngInput.value = latlng.lng.toFixed(6);
            if (hint) hint.style.display = 'none';
          }
          mapEl.addEventListener('mouseenter', function(){ if (hint) hint.style.display = 'none'; }, { once: true });
          map.on('click', function(evt){ placeMarker(evt.latlng); });
          var defaultLatLng = L.latLng(center[0], center[1]);
          marker = L.marker(defaultLatLng).addTo(map).bindPopup('<b>Incidente</b><br>Av. Primavera 123').openPopup();
          if (latInput) latInput.value = defaultLatLng.lat.toFixed(6);
          if (lngInput) lngInput.value = defaultLatLng.lng.toFixed(6);
          setTimeout(function(){ map.invalidateSize(); }, 60);
          mapEl.dataset.leaflet = '1';
          mapEl._leafletMap = map;
        } catch(error){
          console.error('Leaflet init error', error);
        }
      });
    }

    function showNuevoIncidenteModal(){
      var modal = document.getElementById('modalIncidenteNuevo');
      if (!modal) return;
      if (window.$ && typeof window.$('#modalIncidenteNuevo').modal === 'function') {
        window.$('#modalIncidenteNuevo')
          .one('shown.bs.modal', function(){ initNuevoIncidenteMap(); })
          .modal('show');
      } else {
        modal.style.display = 'block';
        modal.classList.add('in');
        modal.setAttribute('aria-hidden', 'false');
        setTimeout(initNuevoIncidenteMap, 50);
      }
    }

    function bindNuevoIncidenteButton(){
      var trigger = document.getElementById('addticket');
      if (!trigger || trigger.dataset.niBound === '1') return;
      trigger.dataset.niBound = '1';
      trigger.addEventListener('click', showNuevoIncidenteModal);
    }

    document.addEventListener('DOMContentLoaded', bindNuevoIncidenteButton);
  })();
</script>
<script>
  // Funci√≥n helper (necesaria porque byId est√° en scope privado en otro script)
  function byId(id) { return document.getElementById(id); }

  // Datos de agentes en el mapa
  var mapAgentsData = [
    { id: 'agent-1', name: 'Agente Rodr√≠guez', position: { left: '25%', top: '35%' }, status: 'active' },
    { id: 'agent-2', name: 'Agente Mart√≠nez', position: { left: '55%', top: '65%' }, status: 'active' },
    { id: 'agent-3', name: 'Agente L√≥pez', position: { left: '75%', top: '45%' }, status: 'active' },
  ];

  var mapCamerasData = [
    { id: 'cam-1', name: 'CAM-014', position: { left: '30%', top: '40%' }, status: 'online' },
    { id: 'cam-2', name: 'CAM-021', position: { left: '60%', top: '55%' }, status: 'offline' },
    { id: 'cam-3', name: 'CAM-033', position: { left: '45%', top: '70%' }, status: 'online' },
  ];

  var activeMapTab = 'agents';

  // Inicializar mapa
  function initMap() {
    renderMapGrid();
    renderMapMarkers();
    initMapTabs();
  }

  // Renderizar grid de fondo
  function renderMapGrid() {
    var grid = byId('mapGrid');
    if (!grid) return;
    grid.innerHTML = '';
    
    for (var i = 0; i < 144; i++) {
      var cell = document.createElement('div');
      cell.className = 'border border-gray-200/10';
      grid.appendChild(cell);
    }
  }

  // Renderizar marcadores seg√∫n tab activo
  function renderMapMarkers() {
    var container = byId('mapMarkers');
    if (!container) return;
    container.innerHTML = '';
    
    var data = activeMapTab === 'agents' ? mapAgentsData : mapCamerasData;
    var icon = activeMapTab === 'agents' ? getAgentIcon() : getCameraIcon();
    
    data.forEach(function(item) {
      var marker = document.createElement('div');
      marker.className = 'absolute transform -translate-x-1/2 -translate-y-1/2 cursor-pointer group';
      marker.style.left = item.position.left;
      marker.style.top = item.position.top;
      
      var statusColor = item.status === 'online' || item.status === 'active' 
        ? 'text-orange-500' 
        : 'text-gray-400';
      
      marker.innerHTML = 
        '<div class="relative">' +
          '<div class="' + statusColor + ' drop-shadow-lg group-hover:scale-110 transition-transform">' +
            icon +
          '</div>' +
          '<div class="absolute left-1/2 -translate-x-1/2 top-full mt-1 bg-gray-900 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-10">' +
            item.name +
          '</div>' +
        '</div>';
      
      marker.addEventListener('click', function() {
        onMarkerClick(item);
      });
      
      container.appendChild(marker);
    });
  }

  // Iconos SVG
  function getAgentIcon() {
    return '<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="currentColor" stroke="white" stroke-width="1">' +
      '<path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>' +
      '<circle cx="9" cy="7" r="4"></circle>' +
      '<path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>' +
      '<path d="M16 3.13a4 4 0 0 1 0 7.75"></path>' +
    '</svg>';
  }

  function getCameraIcon() {
    return '<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="currentColor" stroke="white" stroke-width="1">' +
      '<path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"></path>' +
      '<circle cx="12" cy="13" r="3"></circle>' +
    '</svg>';
  }

  // Inicializar tabs
  function initMapTabs() {
    var tabs = document.querySelectorAll('.map-tab');
    
    tabs.forEach(function(tab) {
      tab.addEventListener('click', function() {
        var tabName = this.getAttribute('data-tab');
        setActiveMapTab(tabName);
      });
    });
  }

  // Cambiar tab activo
  function setActiveMapTab(tabName) {
    activeMapTab = tabName;
    
    var tabs = document.querySelectorAll('.map-tab');
    tabs.forEach(function(tab) {
      var isActive = tab.getAttribute('data-tab') === tabName;
      
      if (isActive) {
        tab.classList.add('bg-white', 'text-gray-900', 'shadow-sm');
        tab.classList.remove('text-gray-500');
      } else {
        tab.classList.remove('bg-white', 'text-gray-900', 'shadow-sm');
        tab.classList.add('text-gray-500');
      }
    });
    
    renderMapMarkers();
    updateMapLegend();
  }

  // Actualizar leyenda
  function updateMapLegend() {
    var legendTitle = activeMapTab === 'agents' ? 'Vista de Agentes Activos' : 'Vista de C√°maras';
    var legendEl = document.querySelector('.map-legend-text');
    if (legendEl) {
      legendEl.textContent = legendTitle;
    }
  }

  // Click en marcador
  function onMarkerClick(item) {
    // Aqu√≠ puedes abrir un popup, mostrar info, etc.
  }

  // B√∫squeda en mapa
  function initMapSearch() {
    var input = byId('mapSearchInput');
    var btn = byId('mapSearchBtn');
    
    if (btn) {
      btn.addEventListener('click', function() {
        var query = input ? input.value.trim() : '';
        if (query) {
          searchAddress(query);
        }
      });
    }
    
    if (input) {
      input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          var query = input.value.trim();
          if (query) {
            searchAddress(query);
          }
        }
      });
    }
  }

  function searchAddress(query) {
    if (!cadMap) {
      showNotification('El mapa no est√° disponible', 'error');
      return;
    }

    // Usar Nominatim de OpenStreetMap para geocodificaci√≥n
    var nominatimUrl = 'https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(query) + '&countrycodes=pe&limit=5';

    fetch(nominatimUrl)
      .then(function(response) {
        return response.json();
      })
      .then(function(results) {
        if (results && results.length > 0) {
          var firstResult = results[0];
          var lat = parseFloat(firstResult.lat);
          var lon = parseFloat(firstResult.lon);

          // Centrar mapa en la ubicaci√≥n encontrada
          cadMap.setView([lat, lon], 16);

          // Actualizar o crear marcador de ubicaci√≥n
          if (currentLocationMarker) {
            cadMap.removeLayer(currentLocationMarker);
          }

          var incidentIcon = L.divIcon({
            className: 'incident-marker-icon',
            html: '<div style="background: #ef4444; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 16px; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.4);">üìç</div>',
            iconSize: [36, 36],
            iconAnchor: [18, 18]
          });

          currentLocationMarker = L.marker([lat, lon], { icon: incidentIcon })
            .addTo(cadMap)
            .bindPopup('<b>Ubicaci√≥n seleccionada</b><br>' + firstResult.display_name)
            .openPopup();

          // Autocompletar campo de ubicaci√≥n en el formulario
          updateIncidentLocation(firstResult.display_name, lat, lon);

          showNotification('Ubicaci√≥n encontrada: ' + firstResult.display_name, 'success');
        } else {
          showNotification('No se encontraron resultados para: ' + query, 'warning');
        }
      })
      .catch(function(error) {
        console.error('Error en b√∫squeda de direcci√≥n:', error);
        showNotification('Error al buscar la direcci√≥n', 'error');
      });
  }

  // Funci√≥n para actualizar la ubicaci√≥n del incidente en el formulario
  function updateIncidentLocation(address, lat, lon) {
    // Obtener detalles completos de la direcci√≥n mediante reverse geocoding
    var reverseUrl = 'https://nominatim.openstreetmap.org/reverse?format=json&lat=' + lat + '&lon=' + lon + '&addressdetails=1';

    fetch(reverseUrl)
      .then(function(response) {
        return response.json();
      })
      .then(function(data) {
        if (data && data.address) {
          var addr = data.address;

          // Extraer componentes de la direcci√≥n
          var street = addr.road || addr.street || '';
          var houseNumber = addr.house_number || '';
          var suburb = addr.suburb || addr.neighbourhood || addr.quarter || '';
          var district = addr.county || addr.state_district || addr.city_district || suburb || '';
          var province = addr.state || addr.province || addr.region || '';
          var city = addr.city || addr.town || addr.village || '';

          // Construir direcci√≥n completa
          var fullAddress = '';
          if (street) {
            fullAddress = street;
            if (houseNumber) fullAddress += ' ' + houseNumber;
            if (suburb) fullAddress += ', ' + suburb;
          } else {
            fullAddress = address;
          }

          // Actualizar campos del formulario
          var formLocationAddress = document.getElementById('formLocationAddress');
          var formLocationDistrict = document.getElementById('formLocationDistrict');
          var formLocationProvince = document.getElementById('formLocationProvince');
          var formLocationCoordinates = document.getElementById('formLocationCoordinates');

          if (formLocationAddress) formLocationAddress.value = fullAddress;
          if (formLocationDistrict) formLocationDistrict.value = district || city || '';
          if (formLocationProvince) formLocationProvince.value = province || '';
          if (formLocationCoordinates) formLocationCoordinates.value = lat.toFixed(6) + ', ' + lon.toFixed(6);

          // Guardar en el ticket activo
          if (ticketsState.activeTicketId) {
            var ticket = ticketsState.tickets.find(function(t) { return t.id === ticketsState.activeTicketId; });
            if (ticket) {
              ticket.location = {
                address: fullAddress,
                district: district || city || '',
                province: province || '',
                coordinates: lat.toFixed(6) + ', ' + lon.toFixed(6),
                lat: lat,
                lon: lon
              };
            }
          }

          // üî• REGENERAR agentes aleatoriamente alrededor del nuevo punto
          regenerateAgentsAroundIncident(lat, lon);

          // Mostrar agentes cercanos disponibles
          showNearbyAgents(lat, lon);
        }
      })
      .catch(function(error) {
        console.error('Error en reverse geocoding:', error);
        // Si falla el reverse geocoding, al menos guardar lo b√°sico
        var formLocationAddress = document.getElementById('formLocationAddress');
        var formLocationCoordinates = document.getElementById('formLocationCoordinates');

        if (formLocationAddress) formLocationAddress.value = address;
        if (formLocationCoordinates) formLocationCoordinates.value = lat.toFixed(6) + ', ' + lon.toFixed(6);

        if (ticketsState.activeTicketId) {
          var ticket = ticketsState.tickets.find(function(t) { return t.id === ticketsState.activeTicketId; });
          if (ticket) {
            ticket.location = {
              address: address,
              coordinates: lat.toFixed(6) + ', ' + lon.toFixed(6),
              lat: lat,
              lon: lon
            };
          }
        }

        // üî• REGENERAR agentes aleatoriamente alrededor del nuevo punto (aunque falle reverse geocoding)
        regenerateAgentsAroundIncident(lat, lon);

        // Mostrar agentes cercanos disponibles aunque falle el reverse geocoding
        showNearbyAgents(lat, lon);
      });
  }

  // Funci√≥n para calcular distancia entre dos puntos GPS (Haversine formula)
  function calculateDistance(lat1, lon1, lat2, lon2) {
    var R = 6371; // Radio de la Tierra en km
    var dLat = (lat2 - lat1) * Math.PI / 180;
    var dLon = (lon2 - lon1) * Math.PI / 180;
    var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLon/2) * Math.sin(dLon/2);
    var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    var distance = R * c; // Distancia en km
    return distance;
  }

  // Funci√≥n para generar agentes aleatorios alrededor de un punto
  function generateRandomAgentsAroundPoint(centerLat, centerLon, count) {
    var newAgents = [];
    var usedNames = [];

    // Barajar pool de nombres
    var shuffledNames = agentNamesPool.slice().sort(function() { return Math.random() - 0.5; });

    for (var i = 0; i < count; i++) {
      if (i >= shuffledNames.length) break;

      // Generar distancia aleatoria entre 0.3 km y 3.5 km
      var randomDistance = 0.3 + Math.random() * 3.2; // en km

      // Generar √°ngulo aleatorio (0-360 grados)
      var randomAngle = Math.random() * 360;

      // Convertir distancia y √°ngulo a coordenadas lat/lon
      // 1 grado de latitud ‚âà 111 km
      // 1 grado de longitud ‚âà 111 * cos(latitud) km
      var deltaLat = (randomDistance * Math.cos(randomAngle * Math.PI / 180)) / 111;
      var deltaLon = (randomDistance * Math.sin(randomAngle * Math.PI / 180)) / (111 * Math.cos(centerLat * Math.PI / 180));

      var agentLat = centerLat + deltaLat;
      var agentLon = centerLon + deltaLon;

      // Seleccionar transporte aleatorio
      var randomTransport = transportTypes[Math.floor(Math.random() * transportTypes.length)];

      // Calcular distancia real para mostrar
      var realDistance = calculateDistance(centerLat, centerLon, agentLat, agentLon);
      var distanceText = realDistance < 1
        ? Math.round(realDistance * 1000) + ' m'
        : realDistance.toFixed(1) + ' km';

      var agentData = shuffledNames[i];
      var agentId = 'agent_' + Date.now() + '_' + i;

      newAgents.push({
        id: agentId,
        name: agentData.name,
        shortName: agentData.shortName,
        transporte: randomTransport,
        status: 'Disponible',
        distancia: distanceText,
        coords: [agentLat, agentLon],
        assignedTicket: null
      });
    }

    return newAgents;
  }

  // Funci√≥n para regenerar agentes alrededor de una nueva ubicaci√≥n
  function regenerateAgentsAroundIncident(incidentLat, incidentLon) {
    // Preservar agentes que ya tienen tickets asignados
    var assignedAgents = agentsData.filter(function(agent) {
      return agent.assignedTicket !== null && agent.assignedTicket !== undefined;
    });

    // Generar entre 6 y 10 agentes nuevos disponibles
    var numberOfNewAgents = 6 + Math.floor(Math.random() * 5);
    var newAvailableAgents = generateRandomAgentsAroundPoint(incidentLat, incidentLon, numberOfNewAgents);

    // Combinar agentes asignados (mantener) + nuevos disponibles
    agentsData = assignedAgents.concat(newAvailableAgents);

    // Actualizar marcadores en el mapa
    renderAgentsOnMap();

    console.log('Agentes regenerados: ' + newAvailableAgents.length + ' nuevos disponibles alrededor del punto (' + incidentLat + ', ' + incidentLon + ')');
  }

  // ============================================
  // SISTEMA DE C√ÅMARAS CON IA DE DETECCI√ìN DE PLACAS
  // ============================================

  // Funci√≥n para renderizar c√°maras en el mapa
  function renderCamerasOnMap() {
    if (!cadMap) return;

    // Limpiar marcadores de agentes
    agentMarkers.forEach(function(marker) {
      cadMap.removeLayer(marker);
    });
    agentMarkers = [];

    // Limpiar marcadores de c√°maras anteriores
    cameraMarkers.forEach(function(marker) {
      cadMap.removeLayer(marker);
    });
    cameraMarkers = [];

    // Crear icono para c√°maras
    var cameraIcon = L.divIcon({
      className: 'camera-marker-icon',
      html: '<div style="background: #3b82f6; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px; border: 2px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);">üìπ</div>',
      iconSize: [28, 28],
      iconAnchor: [14, 14]
    });

    // Agregar marcadores para todas las c√°maras
    cameraLocations.forEach(function(camera) {
      var marker = L.marker(camera.coords, { icon: cameraIcon })
        .addTo(cadMap)
        .bindPopup(
          '<div style="min-width: 180px;">' +
            '<strong>' + camera.name + '</strong><br>' +
            '<span style="color: #22c55e;">‚óè Online</span><br>' +
            '<span style="font-size: 11px; color: #6b7280;">Sistema de IA activo</span>' +
          '</div>'
        );

      cameraMarkers.push(marker);
    });

    showNotification('Vista de c√°maras cargada', 'success');
  }

  // Funci√≥n para simular detecci√≥n de placa por IA
  function searchPlateWithAI(plate) {
    if (!plate || plate.trim() === '') {
      showNotification('Ingrese una placa v√°lida', 'warning');
      return;
    }

    plate = plate.trim().toUpperCase();

    showNotification('ü§ñ IA procesando b√∫squeda de placa: ' + plate, 'info');

    // Simular delay de procesamiento de IA
    setTimeout(function() {
      // Seleccionar aleatoriamente 2-5 c√°maras que "detectaron" la placa
      var numberOfDetections = 2 + Math.floor(Math.random() * 4);
      var shuffledCameras = cameraLocations.slice().sort(function() { return Math.random() - 0.5; });
      var detectedCameras = shuffledCameras.slice(0, numberOfDetections);

      // Guardar detecci√≥n
      detectedPlateData[plate] = detectedCameras;

      // Limpiar marcadores anteriores
      cameraMarkers.forEach(function(marker) {
        cadMap.removeLayer(marker);
      });
      cameraMarkers = [];

      // Icono para c√°maras que NO detectaron
      var cameraIcon = L.divIcon({
        className: 'camera-marker-icon',
        html: '<div style="background: #6b7280; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px; border: 2px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3); opacity: 0.5;">üìπ</div>',
        iconSize: [28, 28],
        iconAnchor: [14, 14]
      });

      // Icono para c√°maras que S√ç detectaron la placa
      var detectedIcon = L.divIcon({
        className: 'camera-detected-icon',
        html: '<div style="background: #ef4444; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 16px; border: 3px solid white; box-shadow: 0 0 20px rgba(239, 68, 68, 0.6); animation: pulse 2s infinite;">üìπ</div>',
        iconSize: [36, 36],
        iconAnchor: [18, 18]
      });

      var detectedIds = detectedCameras.map(function(c) { return c.name; });

      // Renderizar todas las c√°maras
      cameraLocations.forEach(function(camera) {
        var isDetected = detectedIds.includes(camera.name);
        var icon = isDetected ? detectedIcon : cameraIcon;

        var popupContent = '<div style="min-width: 200px;">' +
          '<strong>' + camera.name + '</strong><br>';

        if (isDetected) {
          var timestamp = new Date();
          var timeStr = timestamp.getHours() + ':' + String(timestamp.getMinutes()).padStart(2, '0');

          popupContent +=
            '<div style="background: #1e3a1e; padding: 8px; border-radius: 4px; margin-top: 8px;">' +
              '<div style="color: #22c55e; font-weight: 600; margin-bottom: 4px;">‚úÖ PLACA DETECTADA</div>' +
              '<div style="font-size: 12px; color: #9ca3af;">Placa: <strong style="color: #ef4444;">' + plate + '</strong></div>' +
              '<div style="font-size: 11px; color: #6b7280;">Detectada: ' + timeStr + '</div>' +
              '<div style="font-size: 10px; color: #6b7280; margin-top: 4px;">üìä Confianza IA: ' + (85 + Math.floor(Math.random() * 15)) + '%</div>' +
            '</div>';
        } else {
          popupContent += '<span style="color: #6b7280; font-size: 12px;">No detect√≥ esta placa</span>';
        }

        popupContent += '</div>';

        var marker = L.marker(camera.coords, { icon: icon })
          .addTo(cadMap)
          .bindPopup(popupContent);

        cameraMarkers.push(marker);

        // Abrir popup autom√°ticamente para c√°maras que detectaron
        if (isDetected) {
          marker.openPopup();
        }
      });

      // Centrar mapa en la primera c√°mara que detect√≥
      if (detectedCameras.length > 0) {
        cadMap.setView(detectedCameras[0].coords, 14);
      }

      showNotification('‚úÖ ' + detectedCameras.length + ' c√°mara(s) detectaron la placa ' + plate, 'success');
    }, 1500); // Simular delay de procesamiento de IA
  }

  // Funci√≥n para mostrar agentes cercanos a la ubicaci√≥n del incidente
  function showNearbyAgents(incidentLat, incidentLon) {
    var section = document.getElementById('nearbyAgentsSection');
    var container = document.getElementById('nearbyAgentsList');

    if (!section || !container) return;

    // Obtener ticket activo
    var activeTicket = ticketsState.activeTicketId
      ? ticketsState.tickets.find(function(t) { return t.id === ticketsState.activeTicketId; })
      : null;

    if (!activeTicket) {
      section.style.display = 'none';
      return;
    }

    // Calcular distancia de cada agente al incidente
    var agentsWithDistance = agentsData.map(function(agent) {
      var distance = calculateDistance(incidentLat, incidentLon, agent.coords[0], agent.coords[1]);

      // Crear copia del agente con propiedades adicionales (sin usar spread operator)
      var agentCopy = {
        id: agent.id,
        name: agent.name,
        shortName: agent.shortName,
        transporte: agent.transporte,
        status: agent.status,
        distancia: agent.distancia,
        coords: agent.coords,
        assignedTicket: agent.assignedTicket,
        calculatedDistance: distance,
        distanceText: distance < 1
          ? Math.round(distance * 1000) + ' m'
          : distance.toFixed(1) + ' km'
      };

      return agentCopy;
    });

    // Filtrar solo disponibles (sin ticket asignado)
    var availableAgents = agentsWithDistance.filter(function(agent) {
      return !agent.assignedTicket || agent.assignedTicket === null;
    });

    // Ordenar por distancia (m√°s cercano primero)
    availableAgents.sort(function(a, b) {
      return a.calculatedDistance - b.calculatedDistance;
    });

    // Mostrar solo los 5 m√°s cercanos
    var nearestAgents = availableAgents.slice(0, 5);

    if (nearestAgents.length === 0) {
      container.innerHTML = '<div style="padding: 15px; text-align: center; color: #9ca3af; font-size: 12px;">No hay agentes disponibles en este momento</div>';
      section.style.display = 'block';
      return;
    }

    // Renderizar lista de agentes
    container.innerHTML = '';
    nearestAgents.forEach(function(agent) {
      var agentCard = document.createElement('div');
      agentCard.style.cssText = 'padding: 10px 12px; border-bottom: 1px solid #374151; background: #1e293b; margin-bottom: 8px; border-radius: 6px;';

      var transportIcon = {
        'Camioneta': 'üöó',
        'Motocicleta': 'üèçÔ∏è',
        'Bicicleta': 'üö¥',
        'A pie': 'üö∂'
      }[agent.transporte] || 'üöó';

      agentCard.innerHTML =
        '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">' +
          '<div>' +
            '<strong style="font-size: 13px; color: #e5e7eb;">' + agent.name + '</strong>' +
            '<div style="font-size: 11px; color: #9ca3af; margin-top: 2px;">' + transportIcon + ' ' + agent.transporte + '</div>' +
          '</div>' +
          '<div style="text-align: right;">' +
            '<div style="font-size: 13px; color: #22c55e; font-weight: 600;">üìç ' + agent.distanceText + '</div>' +
            '<div style="font-size: 10px; color: #9ca3af;">de distancia</div>' +
          '</div>' +
        '</div>' +
        '<button onclick="assignAgentToTicketFromNearby(\'' + agent.id + '\')" class="btn btn-sm btn-accent" style="width: 100%; padding: 6px; font-size: 12px;">' +
          '<i class="pe-7s-check" aria-hidden="true"></i> Asignar a este incidente' +
        '</button>';

      container.appendChild(agentCard);
    });

    // Mostrar la secci√≥n
    section.style.display = 'block';
  }

  // Funci√≥n para asignar agente desde la lista de cercanos
  function assignAgentToTicketFromNearby(agentId) {
    if (!ticketsState.activeTicketId) {
      showNotification('No hay ticket activo', 'warning');
      return;
    }

    var agent = agentsData.find(function(a) { return a.id === agentId; });
    if (!agent) {
      showNotification('Agente no encontrado', 'error');
      return;
    }

    if (agent.assignedTicket) {
      showNotification('Este agente ya tiene un ticket asignado', 'warning');
      return;
    }

    var ticket = ticketsState.tickets.find(function(t) { return t.id === ticketsState.activeTicketId; });
    if (!ticket) return;

    // Asignar agente al ticket
    agent.assignedTicket = ticket.id;
    agent.status = 'En servicio';

    // Actualizar estado del ticket
    ticket.status = 'Asignado';
    ticket.assignedAgent = agent.name;

    // Agregar mensaje al chat
    if (!ticket.chatMessages) ticket.chatMessages = [];

    var now = new Date();
    var timeString = now.getHours() + ':' + String(now.getMinutes()).padStart(2, '0');

    ticket.chatMessages.push({
      type: 'event',
      icon: 'üëÆ',
      title: 'Agente asignado',
      detail: agent.name + ' - ' + agent.transporte,
      timestamp: timeString
    });

    // Actualizar vistas
    renderTicketTabs();
    renderAgentMarkers();
    loadTicketChat(ticket);
    renderTicketAssignedAgents();

    // Refrescar lista de agentes cercanos
    if (ticket.location && ticket.location.lat && ticket.location.lon) {
      showNearbyAgents(ticket.location.lat, ticket.location.lon);
    }

    showNotification('Agente ' + agent.name + ' asignado exitosamente', 'success');
  }

  // Esperar a que el elemento exista y luego inicializar
  function waitForElement(id, callback) {
    var el = document.getElementById(id);
    if (el) {
      callback();
    } else {
      setTimeout(function() { waitForElement(id, callback); }, 50);
    }
  }

  waitForElement('mapGrid', function() {
    initMap();
    initMapSearch();
  });

  // ============================================
  // SISTEMA DE TICKETS INTERACTIVO
  // ============================================

  // Estado global de tickets
  var ticketsState = {
    nextTicketId: 1,
    activeTicketId: null,
    tickets: []
  };

  // Funci√≥n para cargar incidencias desde la API
  function loadIncidencesFromAPI() {
    console.log('üîÑ Cargando incidencias desde API...');

    callAPI({
      method: 'getincidences',
      params: {
        
      },
      ok: function(data) {
        console.log('‚úÖ Incidencias recibidas:', data);
        console.log('üìä Total de incidencias:', data.length);

        // Validar que data sea un array
        if (!Array.isArray(data)) {
          console.error('‚ùå Error: La respuesta no es un array:', data);
          loadMockTickets();
          return;
        }

        // Convertir incidencias a formato de tickets
        ticketsState.tickets = data.map(function(incidence) {
          return convertIncidenceToTicket(incidence);
        });

        console.log('üé´ Tickets convertidos:', ticketsState.tickets);

        // Renderizar tickets en la UI
        renderTicketTabs();

        // Seleccionar el primer ticket si existe
        if (ticketsState.tickets.length > 0) {
          selectTicket(ticketsState.tickets[0].id);
        }

        showNotification('‚úÖ ' + ticketsState.tickets.length + ' tickets cargados desde la base de datos', 'success');
      },
      error: function(error) {
        console.error('‚ùå Error cargando incidencias:', error);
        showNotification('‚ö†Ô∏è Error al cargar tickets. Usando datos de ejemplo.', 'warning');

        // Cargar tickets de ejemplo si falla la API
        loadMockTickets();
      }
    });
  }

  // Funci√≥n para convertir incidencia de BD a formato de ticket del frontend
  function convertIncidenceToTicket(incidence) {
    // Calcular nivel de alerta basado en el tipo o clasificaci√≥n
    var alertLevel = 'media';
    if (incidence.classification_name) {
      var classification = incidence.classification_name.toLowerCase();
      if (classification.includes('critic') || classification.includes('urgent')) {
        alertLevel = 'critica';
      } else if (classification.includes('alta') || classification.includes('high')) {
        alertLevel = 'alta';
      } else if (classification.includes('baja') || classification.includes('low')) {
        alertLevel = 'baja';
      }
    }

    // Mapear tipo de incidencia
    var incidentType = 'otra';
    if (incidence.type_name) {
      var typeName = incidence.type_name.toLowerCase();
      if (typeName.includes('robo') && typeName.includes('vehic')) {
        incidentType = 'robo-vehiculo';
      } else if (typeName.includes('persona') && typeName.includes('sospech')) {
        incidentType = 'persona-sospechosa';
      } else if (typeName.includes('persona') && typeName.includes('desaparec')) {
        incidentType = 'persona-desaparecida';
      } else if (typeName.includes('vehic') && typeName.includes('sospech')) {
        incidentType = 'vehiculo-sospechoso';
      }
    }

    return {
      id: '#' + incidence.incidence_id,
      alertLevel: alertLevel,
      status: incidence.state_name || 'abierto',
      created: incidence.created_at || incidence.incidence_date,
      lastModified: incidence.updated_at || incidence.created_at,

      // Datos del reportante
      reporterName: incidence.complainant || 'Sin nombre',
      reporterDNI: incidence.document_number || '',
      reporterPhone: incidence.contact_number || '',
      reporterEmail: '',
      reporterRelation: 'victima',

      // Tipo de incidencia
      incidentType: incidentType,
      classification: incidence.classification_name || '',
      subtype: incidence.subtype_name || '',

      // Ubicaci√≥n
      location: {
        address: incidence.location || '',
        district: '',
        province: '',
        reference: incidence.location_reference || '',
        coordinates: incidence.latitude && incidence.longitude
          ? incidence.latitude + ', ' + incidence.longitude
          : '',
        lat: incidence.latitude || null,
        lon: incidence.longitude || null
      },

      // Descripci√≥n
      description: incidence.description_incidence || '',

      // Datos adicionales
      operator: incidence.operator || '',
      origin: incidence.origin_name || '',
      unit: incidence.unit_name || '',

      // Chat y agentes
      chatMessages: [],
      unreadCount: 0
    };
  }

  // Funci√≥n para cargar tickets de ejemplo (fallback)
  function loadMockTickets() {
    console.log('üì¶ Cargando tickets de ejemplo...');

    ticketsState.tickets = [
      {
        id: '#3242',
        alertLevel: 'alta',
        status: 'abierto',
        created: '2025-11-27 07:24:24',
        lastModified: '2025-11-27 07:24:24',
        reporterName: 'Juan P√©rez Garc√≠a',
        reporterDNI: '12345678',
        reporterPhone: '55 9876 5432',
        reporterEmail: 'juan@example.com',
        reporterRelation: 'victima',
        incidentType: 'robo-vehiculo',
        classification: 'Seguridad Ciudadana',
        subtype: 'Robo con violencia',
        location: {
          address: 'Av. Primavera 123, Santiago de Surco',
          district: 'Santiago de Surco',
          province: 'Lima',
          reference: 'Frente al parque',
          coordinates: '-12.1175, -76.9990',
          lat: -12.1175,
          lon: -76.9990
        },
        description: 'Robo de veh√≠culo marca Toyota color rojo',
        operator: 'Operadora Carla Q.',
        origin: 'Llamada 105',
        unit: 'Unidad Norte',
        chatMessages: [],
        unreadCount: 0
      },
      {
        id: '#3243',
        alertLevel: 'media',
        status: 'en_atencion',
        created: '2025-11-27 08:15:00',
        lastModified: '2025-11-27 08:30:00',
        reporterName: 'Mar√≠a L√≥pez',
        reporterDNI: '87654321',
        reporterPhone: '55 1234 5678',
        reporterEmail: '',
        reporterRelation: 'testigo',
        incidentType: 'persona-sospechosa',
        classification: 'Seguridad Ciudadana',
        subtype: 'Comportamiento extra√±o',
        location: {
          address: 'Jr. Los Olivos 456',
          district: 'Lima',
          province: 'Lima',
          reference: 'Cerca del colegio',
          coordinates: '-12.1185, -77.0000',
          lat: -12.1185,
          lon: -77.0000
        },
        description: 'Persona merodeando en zona residencial',
        operator: 'Operador Luis',
        origin: 'Aplicaci√≥n m√≥vil',
        unit: 'Unidad Sur',
        chatMessages: [],
        unreadCount: 2
      },
      {
        id: '#3244',
        alertLevel: 'critica',
        status: 'critico',
        created: '2025-11-27 09:00:00',
        lastModified: '2025-11-27 09:05:00',
        reporterName: 'Carlos G√≥mez',
        reporterDNI: '11223344',
        reporterPhone: '55 9999 8888',
        reporterEmail: '',
        reporterRelation: 'victima',
        incidentType: 'persona-desaparecida',
        classification: 'Emergencia',
        subtype: 'Menor de edad',
        location: {
          address: 'Av. Arequipa 789',
          district: 'Lima',
          province: 'Lima',
          reference: 'Centro comercial',
          coordinates: '-12.1150, -76.9980',
          lat: -12.1150,
          lon: -76.9980
        },
        description: 'Ni√±a de 8 a√±os desaparecida desde esta ma√±ana',
        operator: 'Operadora Elena',
        origin: 'Llamada 105',
        unit: 'Unidad Central',
        chatMessages: [],
        unreadCount: 5
      }
    ];

    renderTicketTabs();
    if (ticketsState.tickets.length > 0) {
      selectTicket(ticketsState.tickets[0].id);
    }
  }

  // Funci√≥n para generar un nuevo ID de ticket
  function generateTicketId() {
    var year = new Date().getFullYear();
    var ticketNumber = String(ticketsState.nextTicketId++).padStart(3, '0');
    return 'INC-' + year + '-' + ticketNumber;
  }

  // Funci√≥n para mostrar modal de confirmaci√≥n para crear ticket
  function showNewTicketModal() {
    $('#newTicketModal').modal('show');
  }

  // Funci√≥n para cerrar modal de crear ticket
  function closeNewTicketModal() {
    $('#newTicketModal').modal('hide');
    $('.modal-backdrop').remove();
  }

  // Funci√≥n para confirmar creaci√≥n de ticket desde el modal
  function confirmCreateTicket() {
    createNewTicket();
    $('#newTicketModal').modal('hide');
    $('.modal-backdrop').remove();
  }

  // Funci√≥n para crear un nuevo ticket
  function createNewTicket() {
    var newTicket = {
      id: generateTicketId(),
      timestamp: new Date().toLocaleString('es-ES'),
      alertLevel: 'media',
      incidentType: '',
      reporterName: '',
      reporterDNI: '',
      reporterPhone: '',
      reporterEmail: '',
      reporterRelation: '',
      location: '',
      status: 'abierto',
      unread: 0,
      chatMessages: []
    };

    // Agregar ticket al estado
    ticketsState.tickets.push(newTicket);

    // Actualizar la UI
    renderTicketTabs();

    // Activar el nuevo ticket
    selectTicket(newTicket.id);

    // Mostrar mensaje de confirmaci√≥n
    showNotification('Nuevo ticket ' + newTicket.id + ' creado exitosamente', 'success');

    return newTicket;
  }

  // Funci√≥n para renderizar los tabs de tickets
  function renderTicketTabs() {
    var container = document.getElementById('incidentTabs');
    var countEl = document.getElementById('ticketsCount');

    if (!container) return;

    // Limpiar contenedor
    container.innerHTML = '';

    // Crear bot√≥n de crear ticket con createElement para mantener event listeners
    var addTicketBtn = document.createElement('button');
    addTicketBtn.id = 'addticket';
    addTicketBtn.type = 'button';
    addTicketBtn.className = 'btn btn-warning';
    addTicketBtn.style.cssText = 'align-items: center; gap: 8px; padding: 12px 18px; border-radius: 8px; font-size: 0.9rem; font-weight: 600; transition: all 0.3s ease;';

    var icon = document.createElement('i');
    icon.className = 'pe-7s-plus';
    icon.setAttribute('aria-hidden', 'true');
    icon.style.fontSize = '2.5rem';

    var span = document.createElement('span');
    span.textContent = '';

    addTicketBtn.appendChild(icon);
    addTicketBtn.appendChild(span);

    // Efectos hover
    addTicketBtn.addEventListener('mouseenter', function() {
      this.style.transform = 'translateY(-2px)';
      this.style.boxShadow = '0 4px 12px rgba(59, 130, 246, 0.4)';
    });
    addTicketBtn.addEventListener('mouseleave', function() {
      this.style.transform = 'translateY(0)';
      this.style.boxShadow = 'none';
    });

    // Asignar evento click para crear nuevo ticket
    addTicketBtn.addEventListener('click', function() {
      if (typeof window.$ !== 'undefined' && window.$('#newTicketModal').length) {
        window.$('#newTicketModal').modal('show');
      }
    });

    container.appendChild(addTicketBtn);

    // Actualizar contador
    if (countEl) {
      countEl.textContent = ticketsState.tickets.length + ' ticket' + (ticketsState.tickets.length !== 1 ? 's' : '');
    }

    // Renderizar cada ticket
    ticketsState.tickets.forEach(function(ticket) {
      var button = document.createElement('button');
      button.type = 'button';

      var isActive = ticket.id === ticketsState.activeTicketId;
      button.className = isActive ? 'btn btn-accent ticket-tab' : 'btn btn-default ticket-tab';

      // Determinar color del c√≠rculo seg√∫n nivel de alerta
      var circleClass = 'alert-circle alert-circle-baja';
      if (ticket.alertLevel === 'critica') {
        circleClass = 'alert-circle alert-circle-critica';
      } else if (ticket.alertLevel === 'alta') {
        circleClass = 'alert-circle alert-circle-alta';
      } else if (ticket.alertLevel === 'media') {
        circleClass = 'alert-circle alert-circle-media';
      }

      // Obtener nombre del tipo de incidencia (sin emoji)
      var incidentTypeNames = {
        'robo-vehiculo': 'Robo de Veh√≠culo',
        'persona-sospechosa': 'Persona Sospechosa',
        'persona-desaparecida': 'Persona Desaparecida',
        'vehiculo-sospechoso': 'Veh√≠culo Sospechoso',
        'otra': 'Otra incidencia'
      };
      var incidentTypeName = incidentTypeNames[ticket.incidentType] || 'Sin tipo';

      // Agregar clase de ticket con mensajes sin leer
      if (ticket.unread > 0 && !isActive) {
        button.classList.add('ticket-has-unread');
      }

      // Badge de mensajes sin leer en esquina superior derecha
      var unreadBadge = '';
      if (ticket.unread > 0 && !isActive) {
        unreadBadge = '<span class="unread-badge">' + ticket.unread + '</span>';
      }

      button.innerHTML =
        unreadBadge +
        '<div style="display: flex; align-items: center; margin-bottom: 4px;">' +
          '<span class="' + circleClass + '"></span>' +
          '<h5 style="margin: 0; font-size: 14px; font-weight: 600;">' + ticket.id + '</h5>' +
        '</div>' +
        '<p style="margin: 0; font-size: 12px; color: #9ca3af; padding-left: 20px;">' + incidentTypeName + '</p>';

      button.addEventListener('click', function() {
        selectTicket(ticket.id);
      });

      container.appendChild(button);
    });
  }

  // Funci√≥n para seleccionar un ticket
  function selectTicket(ticketId) {
    ticketsState.activeTicketId = ticketId;
    var ticket = ticketsState.tickets.find(function(t) { return t.id === ticketId; });

    if (!ticket) return;

    // Marcar mensajes como le√≠dos
    ticket.unread = 0;

    // Actualizar tabs
    renderTicketTabs();

    // Cargar datos del ticket en el formulario
    loadTicketToForm(ticket);

    // Cargar chat del ticket
    loadTicketChat(ticket);

    // Cargar agentes asignados a este ticket
    renderTicketAssignedAgents();
  }

  // Funci√≥n para cargar datos del ticket en el formulario
  function loadTicketToForm(ticket) {
    var formTicketHeader = document.getElementById('formTicketHeader');
    var formIncidentId = document.getElementById('formIncidentId');
    var formAlertLevel = document.getElementById('formAlertLevel');
    var formIncidentType = document.getElementById('formIncidentType');
    var formReporterName = document.getElementById('formReporterName');
    var formReporterDNI = document.getElementById('formReporterDNI');
    var formReporterPhone = document.getElementById('formReporterPhone');
    var formReporterEmail = document.getElementById('formReporterEmail');
    var formReporterRelation = document.getElementById('formReporterRelation');

    if (formTicketHeader) formTicketHeader.textContent = 'Ticket ' + ticket.id + ' ‚Ä¢ ' + ticket.timestamp;
    if (formIncidentId) formIncidentId.value = ticket.id;
    if (formAlertLevel) formAlertLevel.value = ticket.alertLevel;
    if (formIncidentType) formIncidentType.value = ticket.incidentType;
    if (formReporterName) formReporterName.value = ticket.reporterName;
    if (formReporterDNI) formReporterDNI.value = ticket.reporterDNI;
    if (formReporterPhone) formReporterPhone.value = ticket.reporterPhone;
    if (formReporterEmail) formReporterEmail.value = ticket.reporterEmail;
    if (formReporterRelation) formReporterRelation.value = ticket.reporterRelation;

    // Cargar campos de ubicaci√≥n
    var formLocationAddress = document.getElementById('formLocationAddress');
    var formLocationDistrict = document.getElementById('formLocationDistrict');
    var formLocationProvince = document.getElementById('formLocationProvince');
    var formLocationReference = document.getElementById('formLocationReference');
    var formLocationCoordinates = document.getElementById('formLocationCoordinates');

    if (ticket.location) {
      if (formLocationAddress) formLocationAddress.value = ticket.location.address || '';
      if (formLocationDistrict) formLocationDistrict.value = ticket.location.district || '';
      if (formLocationProvince) formLocationProvince.value = ticket.location.province || '';
      if (formLocationReference) formLocationReference.value = ticket.location.reference || '';
      if (formLocationCoordinates) formLocationCoordinates.value = ticket.location.coordinates || '';

      // Si hay coordenadas, actualizar marcador en el mapa
      if (ticket.location.lat && ticket.location.lon && cadMap) {
        // Remover marcador previo
        if (currentLocationMarker) {
          cadMap.removeLayer(currentLocationMarker);
        }

        var incidentIcon = L.divIcon({
          className: 'incident-marker-icon',
          html: '<div style="background: #ef4444; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 16px; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.4);">üìç</div>',
          iconSize: [36, 36],
          iconAnchor: [18, 18]
        });

        currentLocationMarker = L.marker([ticket.location.lat, ticket.location.lon], { icon: incidentIcon })
          .addTo(cadMap)
          .bindPopup('<b>Ubicaci√≥n del incidente</b><br>' + (ticket.location.address || 'Sin direcci√≥n'));

        // Centrar mapa en la ubicaci√≥n
        cadMap.setView([ticket.location.lat, ticket.location.lon], 16);

        // üî• REGENERAR agentes alrededor de esta ubicaci√≥n
        regenerateAgentsAroundIncident(ticket.location.lat, ticket.location.lon);

        // Mostrar agentes cercanos disponibles
        showNearbyAgents(ticket.location.lat, ticket.location.lon);
      }
    } else {
      // Limpiar campos si no hay ubicaci√≥n
      if (formLocationAddress) formLocationAddress.value = '';
      if (formLocationDistrict) formLocationDistrict.value = '';
      if (formLocationProvince) formLocationProvince.value = '';
      if (formLocationReference) formLocationReference.value = '';
      if (formLocationCoordinates) formLocationCoordinates.value = '';

      // Ocultar secci√≥n de agentes cercanos
      var nearbySection = document.getElementById('nearbyAgentsSection');
      if (nearbySection) nearbySection.style.display = 'none';
    }

    // Mostrar/ocultar secciones seg√∫n tipo de incidencia
    handleIncidentTypeChange(ticket.incidentType);

    // Cargar evidencia del ticket
    renderEvidenceList(ticket);
  }

  // Funci√≥n para cargar chat del ticket
  function loadTicketChat(ticket) {
    var chatTimeline = document.getElementById('chatTimeline');
    var chatTicketId = document.getElementById('chatTicketId');
    var chatTicketStatus = document.getElementById('chatTicketStatus');
    var chatAgentName = document.getElementById('chatAgentName');

    if (chatTicketId) chatTicketId.textContent = ticket.id;
    if (chatTicketStatus) chatTicketStatus.textContent = ticket.status;

    // Actualizar nombre del agente
    if (chatAgentName) {
      if (ticket.assignedAgent) {
        chatAgentName.textContent = ticket.assignedAgent;
      } else {
        chatAgentName.textContent = 'No asignado';
      }
    }

    if (!chatTimeline) return;

    chatTimeline.innerHTML = '';

    // Si no tiene mensajes, mostrar solo el evento de creaci√≥n
    if (!ticket.chatMessages || ticket.chatMessages.length === 0) {
      var eventDiv = buildChatEvent({
        icon: '‚ö°Ô∏è',
        title: 'Incidente creado',
        detail: 'Registrado por operador',
        timestamp: ticket.timestamp.split(',')[1] || ticket.timestamp
      });
      chatTimeline.appendChild(eventDiv);
      return;
    }

    // Renderizar todos los mensajes del ticket
    ticket.chatMessages.forEach(function(msg) {
      var msgElement = msg.type === 'event'
        ? buildChatEvent(msg)
        : buildChatMessage(msg);
      chatTimeline.appendChild(msgElement);
    });

    // Auto scroll al final
    setTimeout(function() {
      var chatContainer = chatTimeline.parentElement;
      if (chatContainer) {
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }
    }, 100);
  }

  // Funci√≥n para construir un evento del chat
  function buildChatEvent(event) {
    var div = document.createElement('div');
    div.className = 'chat-event';
    div.innerHTML =
      '<span style="font-size: 14px;">' + (event.icon || '‚ö°Ô∏è') + '</span>' +
      '<span style="font-weight: 500; color: #d1d5db;">' + event.title + '</span>' +
      '<span style="color: #6b7280;">‚Ä¢</span>' +
      '<span style="color: #9ca3af; font-size: 11px;">' + event.timestamp + '</span>';
    return div;
  }

  // Funci√≥n para construir un mensaje del chat
  function buildChatMessage(message) {
    var div = document.createElement('div');
    var isOperator = message.from === 'operator';
    div.className = 'chat-message ' + (isOperator ? 'from-operator' : 'from-agent');

    var attachmentsHtml = '';
    if (message.attachments && message.attachments.length > 0) {
      attachmentsHtml = '<div class="chat-attachments">';
      message.attachments.forEach(function(att) {
        attachmentsHtml += '<span class="chat-attachment">üìé ' + att.name + '</span>';
      });
      attachmentsHtml += '</div>';
    }

    div.innerHTML =
      '<div class="chat-message-author">' +
        '<span>' + message.name + '</span>' +
        '<span class="chat-message-role"> ‚Ä¢ ' + message.role + '</span>' +
      '</div>' +
      '<div class="chat-message-text">' + message.text + '</div>' +
      attachmentsHtml +
      '<div class="chat-message-meta">' + message.timestamp + '</div>';

    return div;
  }

  // Funci√≥n para enviar un mensaje
  function sendChatMessage() {
    if (!ticketsState.activeTicketId) return;

    var ticket = ticketsState.tickets.find(function(t) { return t.id === ticketsState.activeTicketId; });
    if (!ticket) return;

    var chatInput = document.getElementById('chatComposerInput');
    if (!chatInput || !chatInput.value.trim()) return;

    var messageText = chatInput.value.trim();
    var now = new Date();
    var timeString = now.getHours() + ':' + String(now.getMinutes()).padStart(2, '0');

    // Crear el mensaje
    var newMessage = {
      type: 'message',
      from: 'operator',
      name: 'Operador',
      role: 'CAD',
      text: messageText,
      timestamp: timeString
    };

    // Inicializar array de mensajes si no existe
    if (!ticket.chatMessages) {
      ticket.chatMessages = [];
      // Agregar evento de creaci√≥n si es el primer mensaje
      ticket.chatMessages.push({
        type: 'event',
        icon: '‚ö°Ô∏è',
        title: 'Incidente creado',
        detail: 'Registrado por operador',
        timestamp: ticket.timestamp.split(',')[1] || ticket.timestamp
      });
    }

    // Agregar el mensaje al ticket
    ticket.chatMessages.push(newMessage);

    // Limpiar input
    chatInput.value = '';

    // Recargar el chat
    loadTicketChat(ticket);

    // Simular respuesta del agente despu√©s de 2-5 segundos
    simulateAgentResponse(ticket);
  }

  // Funci√≥n para simular respuesta de agente (solo para demo)
  function simulateAgentResponse(ticket) {
    var responses = [
      'Recibido, en camino al lugar.',
      'Entendido, llegando en 5 minutos.',
      'Confirmado, ubicaci√≥n identificada.',
      'Roger, procediendo seg√∫n protocolo.',
      'Afirmativo, contactando con el reportante.'
    ];

    var randomDelay = 2000 + Math.random() * 3000; // 2-5 segundos

    setTimeout(function() {
      var now = new Date();
      var timeString = now.getHours() + ':' + String(now.getMinutes()).padStart(2, '0');

      var agentMessage = {
        type: 'message',
        from: 'agent',
        name: 'Agente',
        role: 'En ruta',
        text: responses[Math.floor(Math.random() * responses.length)],
        timestamp: timeString
      };

      ticket.chatMessages.push(agentMessage);

      // Si este ticket no est√° activo, incrementar contador de no le√≠dos
      if (ticketsState.activeTicketId !== ticket.id) {
        ticket.unread++;
        renderTicketTabs();
      } else {
        // Si est√° activo, recargar el chat
        loadTicketChat(ticket);
      }
    }, randomDelay);
  }

  // Funci√≥n para cerrar un ticket con motivo
  // Funci√≥n para mostrar modal de cierre de ticket
  function closeTicketWithReason() {
    if (!ticketsState.activeTicketId) {
      showNotification('No hay ning√∫n ticket activo para cerrar', 'warning');
      return;
    }

    var ticket = ticketsState.tickets.find(function(t) { return t.id === ticketsState.activeTicketId; });
    if (!ticket) return;

    // Verificar que el ticket no est√© ya cerrado
    if (ticket.status === 'cerrado') {
      showNotification('Este ticket ya est√° cerrado', 'info');
      return;
    }

    // Actualizar informaci√≥n del ticket en el modal
    var modalInfo = document.getElementById('closeTicketModalInfo');
    if (modalInfo) {
      modalInfo.textContent = 'Ticket ' + ticket.id + ' - ' + ticket.incidentType;
    }

    // Limpiar campos
    $('#closeTicketReason').val('');
    $('#closeTicketObservations').val('');

    // Mostrar modal
    $('#closeTicketModal').modal('show');
  }

  // Funci√≥n para cancelar cierre de ticket
  function cancelCloseTicket() {
    $('#closeTicketModal').modal('hide');
    $('.modal-backdrop').remove();
  }

  // Funci√≥n para confirmar cierre de ticket desde el modal
  function confirmCloseTicket() {
    var reason = $('#closeTicketReason').val();
    var observations = $('#closeTicketObservations').val().trim();

    // Validar campos
    if (!reason) {
      showNotification('Debe seleccionar un motivo de cierre', 'warning');
      return;
    }

    if (!observations) {
      showNotification('Debe ingresar observaciones', 'warning');
      return;
    }

    var ticket = ticketsState.tickets.find(function(t) { return t.id === ticketsState.activeTicketId; });
    if (ticket) {
      var fullReason = reason + ': ' + observations;
      closeTicket(ticket, fullReason);
      $('#closeTicketModal').modal('hide');
      $('.modal-backdrop').remove();
    }
  }

  // Funci√≥n para cerrar el ticket
  function closeTicket(ticket, reason) {
    // Actualizar estado del ticket
    ticket.status = 'cerrado';
    ticket.closedAt = new Date().toLocaleString('es-ES');
    ticket.closeReason = reason;

    // Agregar evento de cierre al chat
    var now = new Date();
    var timeString = now.getHours() + ':' + String(now.getMinutes()).padStart(2, '0');

    var closeEvent = {
      type: 'event',
      icon: '‚úÖ',
      title: 'Ticket cerrado',
      detail: 'Motivo: ' + reason,
      timestamp: timeString
    };

    if (!ticket.chatMessages) {
      ticket.chatMessages = [];
    }
    ticket.chatMessages.push(closeEvent);

    // Remover el ticket de la lista (ya que est√° cerrado)
    var ticketIndex = ticketsState.tickets.findIndex(function(t) { return t.id === ticket.id; });
    if (ticketIndex !== -1) {
      ticketsState.tickets.splice(ticketIndex, 1);
    }

    // Actualizar tabs
    renderTicketTabs();

    // Si no hay m√°s tickets, limpiar formulario y chat
    if (ticketsState.tickets.length === 0) {
      ticketsState.activeTicketId = null;
      clearFormAndChat();
    } else {
      // Seleccionar el primer ticket disponible
      selectTicket(ticketsState.tickets[0].id);
    }

    showNotification('Ticket ' + ticket.id + ' cerrado exitosamente', 'success');
  }

  // Funci√≥n para limpiar formulario y chat cuando no hay tickets
  function clearFormAndChat() {
    // Limpiar formulario
    var formTicketHeader = document.getElementById('formTicketHeader');
    if (formTicketHeader) formTicketHeader.textContent = 'Sin ticket activo';

    var formIncidentId = document.getElementById('formIncidentId');
    if (formIncidentId) formIncidentId.value = '';

    // Limpiar chat
    var chatTimeline = document.getElementById('chatTimeline');
    if (chatTimeline) {
      chatTimeline.innerHTML = '<div style="text-align: center; padding: 40px; color: #9ca3af;">No hay mensajes</div>';
    }

    var chatTicketId = document.getElementById('chatTicketId');
    if (chatTicketId) chatTicketId.textContent = '-';

    var chatTicketStatus = document.getElementById('chatTicketStatus');
    if (chatTicketStatus) chatTicketStatus.textContent = '-';
  }

  // Vincular bot√≥n de enviar mensaje
  document.addEventListener('DOMContentLoaded', function() {
    var chatSendButton = document.getElementById('chatSendButton');
    var chatInput = document.getElementById('chatComposerInput');

    if (chatSendButton) {
      chatSendButton.addEventListener('click', sendChatMessage);
    }

    if (chatInput) {
      chatInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          sendChatMessage();
        }
      });
    }
  });

  // ============================================
  // SISTEMA DE ASIGNACI√ìN DE AGENTES
  // ============================================

  // NOTA: agentsData ya est√° definido en l√≠nea ~1093
  // No redefinir aqu√≠ para evitar conflictos

  // Alias para renderizar marcadores de agentes
  function renderAgentMarkers() {
    renderAgentsOnMap();
  }

  // Funci√≥n para abrir modal de asignaci√≥n de agentes
  function openAssignAgentModal() {
    if (!ticketsState.activeTicketId) {
      showNotification('Debe seleccionar un ticket primero', 'warning');
      return;
    }

    // Actualizar informaci√≥n del ticket en el modal
    var ticket = ticketsState.tickets.find(function(t) { return t.id === ticketsState.activeTicketId; });
    var ticketInfo = $('#assignModalTicketInfo');
    if (ticketInfo && ticket) {
      ticketInfo.text('Ticket ' + ticket.id + ' - ' + ticket.incidentType);
    }

    $('#agentSearchInput').val('');

    renderAgentListForAssignment();

    // Mostrar modal usando Bootstrap
    $('#assignAgentModal').modal('show');

    setTimeout(function() {
      $('#agentSearchInput').focus();
    }, 300);
  }

  // Funci√≥n para cerrar modal de asignaci√≥n
  function closeAssignAgentModal() {
    $('#assignAgentModal').modal('hide');
    $('.modal-backdrop').remove();
  }

  // Funci√≥n para filtrar agentes en el modal
  function filterAgents() {
    renderAgentListForAssignment();
  }

  // Funci√≥n para renderizar lista de agentes en el modal
  function renderAgentListForAssignment() {
    var container = document.getElementById('agentListContainer');
    var searchInput = document.getElementById('agentSearchInput');
    if (!container) return;

    var searchTerm = searchInput ? searchInput.value.trim().toLowerCase() : '';

    // Obtener ticket activo
    var activeTicket = ticketsState.tickets.find(function(t) { return t.id === ticketsState.activeTicketId; });
    if (!activeTicket) return;

    // Inicializar agentes asignados si no existe
    if (!activeTicket.assignedAgents) activeTicket.assignedAgents = [];

    // Filtrar agentes
    var availableAgents = agentsData.filter(function(agent) {
      // Excluir agentes ya asignados a este ticket
      var alreadyAssigned = activeTicket.assignedAgents.some(function(a) {
        return a.id === agent.id;
      });
      if (alreadyAssigned) return false;

      // Filtrar por b√∫squeda
      if (searchTerm) {
        return agent.name.toLowerCase().includes(searchTerm) ||
               agent.transporte.toLowerCase().includes(searchTerm);
      }

      // Solo mostrar disponibles si no hay b√∫squeda
      return agent.status === 'Disponible';
    });

    // Ordenar por distancia
    availableAgents.sort(function(a, b) {
      return parseFloat(a.distancia) - parseFloat(b.distancia);
    });

    container.innerHTML = '';

    if (availableAgents.length === 0) {
      container.innerHTML = '<div class="no-results">No se encontraron agentes disponibles</div>';
      return;
    }

    // Renderizar cada agente
    availableAgents.forEach(function(agent) {
      var item = document.createElement('div');
      item.className = 'agent-list-item' + (agent.status !== 'Disponible' ? ' ocupado' : '');

      var info = document.createElement('div');
      info.className = 'agent-info';

      var name = document.createElement('div');
      name.className = 'agent-list-name';
      name.textContent = agent.name;

      var role = document.createElement('div');
      role.className = 'agent-list-role';
      role.textContent = agent.transporte.toUpperCase();

      info.appendChild(name);
      info.appendChild(role);

      var meta = document.createElement('div');
      meta.style.textAlign = 'right';

      var statusMark = document.createElement('div');
      statusMark.style.fontSize = '1.2rem';
      statusMark.textContent = agent.status === 'Disponible' ? '‚úì' : '‚è∏';
      statusMark.style.color = agent.status === 'Disponible' ? '#22c55e' : '#999';

      var distance = document.createElement('div');
      distance.className = 'agent-distance';
      distance.textContent = 'üìç ' + agent.distancia;

      meta.appendChild(statusMark);
      meta.appendChild(distance);

      item.appendChild(info);
      item.appendChild(meta);

      // Solo permitir clic si est√° disponible
      if (agent.status === 'Disponible') {
        item.style.cursor = 'pointer';
        item.addEventListener('click', function() {
          assignAgentToTicket(agent);
        });
      }

      container.appendChild(item);
    });
  }

  // Funci√≥n para asignar agente al ticket
  function assignAgentToTicket(agent) {
    var activeTicket = ticketsState.tickets.find(function(t) { return t.id === ticketsState.activeTicketId; });
    if (!activeTicket) return;

    // Inicializar array si no existe
    if (!activeTicket.assignedAgents) activeTicket.assignedAgents = [];

    // Verificar si ya est√° asignado
    var alreadyAssigned = activeTicket.assignedAgents.some(function(a) {
      return a.id === agent.id;
    });
    if (alreadyAssigned) return;

    // Agregar agente al ticket
    activeTicket.assignedAgents.push({
      id: agent.id,
      name: agent.name,
      shortName: agent.shortName,
      transporte: agent.transporte,
      status: 'En ruta'
    });

    // Inicializar chatMessages si no existe
    if (!activeTicket.chatMessages) activeTicket.chatMessages = [];

    // Agregar evento al chat
    var now = new Date();
    var timeString = now.getHours() + ':' + String(now.getMinutes()).padStart(2, '0');

    activeTicket.chatMessages.push({
      type: 'event',
      icon: 'üëÆ',
      title: 'Agente asignado',
      detail: agent.shortName + ' ‚Ä¢ ' + agent.transporte,
      timestamp: timeString
    });

    // Actualizar UI
    loadTicketChat(activeTicket);
    renderAssignedAgentsList();
    closeAssignAgentModal();

    showNotification('Agente ' + agent.shortName + ' asignado correctamente', 'success');
  }

  // Funci√≥n para renderizar lista de agentes asignados
  function renderAssignedAgentsList() {
    var container = document.getElementById('assignedAgentsContainer');
    if (!container) return;

    var activeTicket = ticketsState.tickets.find(function(t) { return t.id === ticketsState.activeTicketId; });
    if (!activeTicket || !activeTicket.assignedAgents || activeTicket.assignedAgents.length === 0) {
      container.innerHTML = '<div style="padding: 1rem; text-align: center; color: #9ca3af; font-style: italic;">No hay agentes asignados</div>';
      return;
    }

    container.innerHTML = '';

    activeTicket.assignedAgents.forEach(function(agent) {
      var agentDiv = document.createElement('div');
      agentDiv.className = 'agent-tag';

      agentDiv.innerHTML =
        '<div class="agent-info-block">' +
          '<div class="agent-name">' + agent.shortName + '</div>' +
          '<div class="agent-meta-chip">' + agent.transporte + ' ‚Ä¢ ' + agent.status + '</div>' +
        '</div>' +
        '<button type="button" class="release-agent-btn" onclick="releaseAgentFromTicket(\'' + agent.id + '\')">Liberar</button>';

      container.appendChild(agentDiv);
    });
  }

  // Funci√≥n para liberar un agente del ticket
  function releaseAgentFromTicket(agentId) {
    var activeTicket = ticketsState.tickets.find(function(t) { return t.id === ticketsState.activeTicketId; });
    if (!activeTicket || !activeTicket.assignedAgents) return;

    var agentIndex = activeTicket.assignedAgents.findIndex(function(a) { return a.id === agentId; });
    if (agentIndex === -1) return;

    var agent = activeTicket.assignedAgents[agentIndex];
    activeTicket.assignedAgents.splice(agentIndex, 1);

    // Agregar evento al chat
    var now = new Date();
    var timeString = now.getHours() + ':' + String(now.getMinutes()).padStart(2, '0');

    if (!activeTicket.chatMessages) activeTicket.chatMessages = [];

    activeTicket.chatMessages.push({
      type: 'event',
      icon: '‚Ü©Ô∏è',
      title: 'Agente liberado',
      detail: agent.shortName + ' liberado del incidente',
      timestamp: timeString
    });

    // Actualizar UI
    loadTicketChat(activeTicket);
    renderAssignedAgentsList();

    showNotification('Agente ' + agent.shortName + ' liberado', 'info');
  }

  // Funci√≥n para liberar todos los agentes
  function releaseAllAgents() {
    var activeTicket = ticketsState.tickets.find(function(t) { return t.id === ticketsState.activeTicketId; });
    if (!activeTicket || !activeTicket.assignedAgents || activeTicket.assignedAgents.length === 0) {
      showNotification('No hay agentes asignados para liberar', 'warning');
      return;
    }

    var count = activeTicket.assignedAgents.length;
    activeTicket.assignedAgents = [];

    // Agregar evento al chat
    var now = new Date();
    var timeString = now.getHours() + ':' + String(now.getMinutes()).padStart(2, '0');

    if (!activeTicket.chatMessages) activeTicket.chatMessages = [];

    activeTicket.chatMessages.push({
      type: 'event',
      icon: '‚Ü©Ô∏è',
      title: 'Agentes liberados',
      detail: count + ' agente' + (count !== 1 ? 's' : '') + ' liberado' + (count !== 1 ? 's' : '') + ' del incidente',
      timestamp: timeString
    });

    // Actualizar UI
    loadTicketChat(activeTicket);
    renderAssignedAgentsList();

    showNotification(count + ' agente(s) liberado(s)', 'info');
  }

  // Exponer funciones globalmente para que los onclick funcionen
  window.openAssignAgentModal = openAssignAgentModal;
  window.closeAssignAgentModal = closeAssignAgentModal;
  window.filterAgents = filterAgents;
  window.releaseAgentFromTicket = releaseAgentFromTicket;
  window.releaseAllAgents = releaseAllAgents;

  // Cargar lista de agentes asignados cuando se selecciona un ticket
  document.addEventListener('DOMContentLoaded', function() {
    // Vincular eventos del modal
    var modal = document.getElementById('assignAgentModal');
    if (modal) {
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          closeAssignAgentModal();
        }
      });
    }

    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeAssignAgentModal();
      }
    });
  });

  // Funci√≥n para mostrar notificaciones
  function showNotification(message, type) {
    if (typeof Swal !== 'undefined') {
      Swal.fire({
        title: type === 'success' ? '¬°√âxito!' : 'Informaci√≥n',
        text: message,
        icon: type,
        timer: 2000,
        showConfirmButton: false
      });
    } else {
      alert(message);
    }
  }

  // Vincular el bot√≥n de crear ticket
  document.addEventListener('DOMContentLoaded', function() {
    var addTicketBtn = document.getElementById('addticket');
    if (addTicketBtn) {
      // Remover el listener anterior si existe
      var newBtn = addTicketBtn.cloneNode(true);
      addTicketBtn.parentNode.replaceChild(newBtn, addTicketBtn);

      // Agregar nuevo listener
      newBtn.addEventListener('click', function(e) {
        e.preventDefault();
        showNewTicketModal();
      });
    }

    // Vincular bot√≥n de enviar mensaje
    var sendBtn = document.getElementById('chatSendButton');
    var chatInput = document.getElementById('chatComposerInput');

    if (sendBtn) {
      sendBtn.addEventListener('click', sendChatMessage);
    }

    if (chatInput) {
      chatInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendChatMessage();
        }
      });
    }

    // Vincular bot√≥n de cerrar ticket
    var closeTicketBtn = document.getElementById('closeTicketBtn');
    if (closeTicketBtn) {
      closeTicketBtn.addEventListener('click', closeTicketWithReason);
    }

    // Vincular bot√≥n de guardar ticket
    var saveTicketBtn = document.getElementById('saveTicketBtn');
    if (saveTicketBtn) {
      saveTicketBtn.addEventListener('click', saveTicketChanges);
    }

    // Vincular bot√≥n de subir evidencia
    var uploadEvidenceBtn = document.getElementById('uploadEvidenceBtn');
    var evidenceFileInput = document.getElementById('evidenceFileInput');

    if (uploadEvidenceBtn && evidenceFileInput) {
      uploadEvidenceBtn.addEventListener('click', function() {
        evidenceFileInput.click();
      });

      evidenceFileInput.addEventListener('change', handleEvidenceUpload);
    }

    // Cargar tickets de ejemplo al inicio
    initializeSampleTickets();
  });

  // Funci√≥n para manejar la subida de evidencia
  function handleEvidenceUpload(event) {
    var files = event.target.files;
    if (!files || files.length === 0) return;

    if (!ticketsState.activeTicketId) {
      showNotification('Debe seleccionar un ticket primero', 'warning');
      event.target.value = '';
      return;
    }

    var ticket = ticketsState.tickets.find(function(t) { return t.id === ticketsState.activeTicketId; });
    if (!ticket) {
      event.target.value = '';
      return;
    }

    // Inicializar array de evidencias si no existe
    if (!ticket.evidence) {
      ticket.evidence = [];
    }

    // Verificar l√≠mite de 10 archivos
    if (ticket.evidence.length + files.length > 10) {
      showNotification('Solo puede subir un m√°ximo de 10 archivos', 'warning');
      event.target.value = '';
      return;
    }

    // Agregar archivos
    for (var i = 0; i < files.length; i++) {
      var file = files[i];
      var fileObj = {
        name: file.name,
        size: formatFileSize(file.size),
        type: getFileType(file.type),
        uploadDate: new Date().toLocaleString('es-ES')
      };
      ticket.evidence.push(fileObj);
    }

    // Actualizar lista visual
    renderEvidenceList(ticket);

    // Limpiar input
    event.target.value = '';

    showNotification(files.length + ' archivo(s) agregado(s) exitosamente', 'success');
  }

  // Funci√≥n para renderizar la lista de evidencias
  function renderEvidenceList(ticket) {
    var container = document.getElementById('formEvidenceList');
    if (!container) return;

    container.innerHTML = '';

    if (!ticket.evidence || ticket.evidence.length === 0) {
      return;
    }

    ticket.evidence.forEach(function(file, index) {
      var fileItem = document.createElement('div');
      fileItem.style.cssText = 'padding: 10px 12px; background: #1a1a1a; border: 1px solid #2d2d2d; border-radius: 6px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;';

      var fileIcon = getFileIcon(file.type);

      fileItem.innerHTML =
        '<div style="display: flex; align-items: center; gap: 10px; flex: 1;">' +
          '<span style="font-size: 20px;">' + fileIcon + '</span>' +
          '<div style="flex: 1;">' +
            '<div style="font-size: 13px; font-weight: 600; color: #e5e7eb;">' + file.name + '</div>' +
            '<div style="font-size: 11px; color: #9ca3af;">' + file.size + ' ‚Ä¢ ' + file.uploadDate + '</div>' +
          '</div>' +
        '</div>' +
        '<button onclick="removeEvidence(' + index + ')" class="btn btn-sm btn-danger" style="padding: 4px 8px; font-size: 11px;">' +
          '<i class="pe-7s-trash"></i>' +
        '</button>';

      container.appendChild(fileItem);
    });
  }

  // Funci√≥n para remover evidencia
  function removeEvidence(index) {
    if (!ticketsState.activeTicketId) return;

    var ticket = ticketsState.tickets.find(function(t) { return t.id === ticketsState.activeTicketId; });
    if (!ticket || !ticket.evidence) return;

    ticket.evidence.splice(index, 1);
    renderEvidenceList(ticket);

    showNotification('Archivo eliminado', 'info');
  }

  // Hacer funci√≥n global
  window.removeEvidence = removeEvidence;

  // Funci√≥n para formatear tama√±o de archivo
  function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    var k = 1024;
    var sizes = ['Bytes', 'KB', 'MB', 'GB'];
    var i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
  }

  // Funci√≥n para obtener tipo de archivo
  function getFileType(mimeType) {
    if (mimeType.startsWith('image/')) return 'image';
    if (mimeType.startsWith('video/')) return 'video';
    if (mimeType.startsWith('audio/')) return 'audio';
    if (mimeType.includes('pdf')) return 'pdf';
    if (mimeType.includes('document') || mimeType.includes('word')) return 'document';
    return 'file';
  }

  // Funci√≥n para obtener icono seg√∫n tipo de archivo
  function getFileIcon(type) {
    switch(type) {
      case 'image': return 'üñºÔ∏è';
      case 'video': return 'üé•';
      case 'audio': return 'üéµ';
      case 'pdf': return 'üìÑ';
      case 'document': return 'üìù';
      default: return 'üìé';
    }
  }

  // Inicializar tickets de ejemplo
  function initializeSampleTickets() {
    var year = new Date().getFullYear();

    // Crear 3 tickets de ejemplo
    var sampleTickets = [
      {
        id: 'INC-' + year + '-001',
        timestamp: '27/11/2025, 7:20:15 a.m.',
        alertLevel: 'critica',
        incidentType: 'robo-vehiculo',
        reporterName: 'Mar√≠a Garc√≠a',
        reporterDNI: '87654321',
        reporterPhone: '55 1234 5678',
        reporterEmail: 'maria@example.com',
        reporterRelation: 'victima',
        status: 'en atenci√≥n',
        unread: 2,
        chatMessages: [
          {
            type: 'event',
            icon: '‚ö°Ô∏è',
            title: 'Incidente creado',
            detail: 'Registrado por operador',
            timestamp: '7:20 a.m.'
          },
          {
            type: 'event',
            icon: 'üëÆ',
            title: 'Agente asignado',
            detail: 'Agente Ram√≠rez ‚Ä¢ Camioneta',
            timestamp: '7:21 a.m.'
          },
          {
            type: 'message',
            from: 'operator',
            name: 'Operador',
            role: 'CAD',
            text: 'A todos las agentes, favor dirigirse a Av. Principal 123. Robo de veh√≠culo reportado hace 10 minutos.',
            timestamp: '7:21'
          },
          {
            type: 'message',
            from: 'agent',
            name: 'Agente Ram√≠rez',
            role: 'En ruta',
            text: 'Recibido, en camino. ETA 5 minutos.',
            timestamp: '7:22'
          },
          {
            type: 'message',
            from: 'agent',
            name: 'Agente Ram√≠rez',
            role: 'En el lugar',
            text: 'Llegu√© al lugar. Estoy tomando declaraci√≥n de la v√≠ctima.',
            timestamp: '7:27',
            attachments: [{ type: 'foto', name: 'Evidencia_001.jpg' }]
          }
        ]
      },
      {
        id: 'INC-' + year + '-002',
        timestamp: '27/11/2025, 7:22:30 a.m.',
        alertLevel: 'alta',
        incidentType: 'persona-sospechosa',
        reporterName: 'Carlos Ruiz',
        reporterDNI: '45678912',
        reporterPhone: '55 9876 1234',
        reporterEmail: 'carlos@example.com',
        reporterRelation: 'testigo',
        status: 'abierto',
        unread: 0,
        chatMessages: [
          {
            type: 'event',
            icon: '‚ö°Ô∏è',
            title: 'Incidente creado',
            detail: 'Registrado por operador',
            timestamp: '7:22 a.m.'
          },
          {
            type: 'message',
            from: 'operator',
            name: 'Operador',
            role: 'CAD',
            text: 'Se reporta persona sospechosa cerca del parque central. Favor verificar.',
            timestamp: '7:23'
          }
        ]
      },
      {
        id: 'INC-' + year + '-003',
        timestamp: '27/11/2025, 7:24:10 a.m.',
        alertLevel: 'media',
        incidentType: 'vehiculo-sospechoso',
        reporterName: 'Ana L√≥pez',
        reporterDNI: '12398745',
        reporterPhone: '55 5555 9999',
        reporterEmail: 'ana@example.com',
        reporterRelation: 'testigo',
        status: 'abierto',
        unread: 1,
        chatMessages: [
          {
            type: 'event',
            icon: '‚ö°Ô∏è',
            title: 'Incidente creado',
            detail: 'Registrado por operador',
            timestamp: '7:24 a.m.'
          },
          {
            type: 'event',
            icon: 'üëÆ',
            title: 'Agente asignado',
            detail: 'Agente Torres ‚Ä¢ Motocicleta',
            timestamp: '7:25 a.m.'
          },
          {
            type: 'message',
            from: 'agent',
            name: 'Agente Torres',
            role: 'Patrulla',
            text: 'Veh√≠culo localizado. Procedo a verificar placas.',
            timestamp: '7:26'
          }
        ]
      }
    ];

    ticketsState.tickets = sampleTickets;
    ticketsState.nextTicketId = 4; // El siguiente ser√° INC-2025-004

    renderTicketTabs();

    // Seleccionar el primer ticket
    if (sampleTickets.length > 0) {
      selectTicket(sampleTickets[0].id);
    }
  }

  // Inicializar carga de tickets desde la API
  // Se ejecuta autom√°ticamente al cargar la p√°gina
  (function initializeTickets() {
    // Esperar a que el DOM est√© listo
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        loadIncidencesFromAPI();
      });
    } else {
      // El DOM ya est√° listo
      loadIncidencesFromAPI();
    }
  })();

  // ============================================
  // FORMULARIO DIN√ÅMICO SEG√öN TIPO DE INCIDENCIA
  // ============================================

  // Funci√≥n para mostrar/ocultar secciones seg√∫n tipo de incidencia
  function handleIncidentTypeChange(incidentType) {
    // Ocultar todas las secciones espec√≠ficas
    var missingPersonSection = document.getElementById('formMissingPersonSection');
    var suspiciousPersonSection = document.getElementById('formSuspiciousPersonSection');
    var suspiciousVehicleSection = document.getElementById('formSuspiciousVehicleSection');
    var vehicleSection = document.getElementById('formVehicleSection');

    if (missingPersonSection) missingPersonSection.style.display = 'none';
    if (suspiciousPersonSection) suspiciousPersonSection.style.display = 'none';
    if (suspiciousVehicleSection) suspiciousVehicleSection.style.display = 'none';
    if (vehicleSection) vehicleSection.style.display = 'none';

    // Mostrar la secci√≥n correspondiente
    switch(incidentType) {
      case 'persona-desaparecida':
        if (missingPersonSection) missingPersonSection.style.display = 'block';
        break;
      case 'persona-sospechosa':
        if (suspiciousPersonSection) suspiciousPersonSection.style.display = 'block';
        break;
      case 'vehiculo-sospechoso':
        if (suspiciousVehicleSection) suspiciousVehicleSection.style.display = 'block';
        break;
      case 'robo-vehiculo':
        if (vehicleSection) vehicleSection.style.display = 'block';
        break;
    }
  }

  // Funci√≥n para guardar cambios del ticket (bot√≥n Guardar)
  function saveTicketChanges() {
    if (!ticketsState.activeTicketId) {
      showNotification('No hay ning√∫n ticket activo para guardar', 'warning');
      return;
    }

    var ticket = ticketsState.tickets.find(function(t) { return t.id === ticketsState.activeTicketId; });
    if (!ticket) return;

    // Guardar todos los campos del formulario principal
    ticket.alertLevel = document.getElementById('formAlertLevel')?.value || ticket.alertLevel;
    ticket.incidentType = document.getElementById('formIncidentType')?.value || ticket.incidentType;
    ticket.reporterName = document.getElementById('formReporterName')?.value || ticket.reporterName;
    ticket.reporterDNI = document.getElementById('formReporterDNI')?.value || ticket.reporterDNI;
    ticket.reporterPhone = document.getElementById('formReporterPhone')?.value || ticket.reporterPhone;
    ticket.reporterEmail = document.getElementById('formReporterEmail')?.value || ticket.reporterEmail;
    ticket.reporterRelation = document.getElementById('formReporterRelation')?.value || ticket.reporterRelation;

    // Guardar campos de ubicaci√≥n
    if (!ticket.location) {
      ticket.location = {};
    }
    ticket.location.address = document.getElementById('formLocationAddress')?.value || ticket.location.address || '';
    ticket.location.district = document.getElementById('formLocationDistrict')?.value || ticket.location.district || '';
    ticket.location.province = document.getElementById('formLocationProvince')?.value || ticket.location.province || '';
    ticket.location.reference = document.getElementById('formLocationReference')?.value || ticket.location.reference || '';
    ticket.location.coordinates = document.getElementById('formLocationCoordinates')?.value || ticket.location.coordinates || '';

    // Guardar campos espec√≠ficos seg√∫n tipo de incidencia
    if (ticket.incidentType === 'persona-desaparecida') {
      ticket.missingPerson = {
        name: document.getElementById('formMissingName')?.value || '',
        age: document.getElementById('formMissingAge')?.value || '',
        gender: document.getElementById('formMissingGender')?.value || '',
        dni: document.getElementById('formMissingDNI')?.value || '',
        lastSeen: document.getElementById('formMissingLastSeen')?.value || '',
        lastLocation: document.getElementById('formMissingLastLocation')?.value || '',
        description: document.getElementById('formMissingDescription')?.value || '',
        medical: document.getElementById('formMissingMedical')?.value || ''
      };
    } else if (ticket.incidentType === 'persona-sospechosa') {
      ticket.suspiciousPerson = {
        name: document.getElementById('formSuspiciousName')?.value || '',
        alias: document.getElementById('formSuspiciousAlias')?.value || '',
        description: document.getElementById('formSuspiciousDescription')?.value || '',
        reason: document.getElementById('formSuspiciousReason')?.value || '',
        location: document.getElementById('formSuspiciousLocation')?.value || '',
        linked: document.getElementById('formSuspiciousLinked')?.value || ''
      };
    } else if (ticket.incidentType === 'vehiculo-sospechoso') {
      ticket.suspiciousVehicle = {
        plate: document.getElementById('formSuspVehiclePlate')?.value || '',
        type: document.getElementById('formSuspVehicleType')?.value || '',
        color: document.getElementById('formSuspVehicleColor')?.value || '',
        details: document.getElementById('formSuspVehicleDetails')?.value || '',
        location: document.getElementById('formSuspVehicleLocation')?.value || '',
        time: document.getElementById('formSuspVehicleTime')?.value || '',
        behavior: document.getElementById('formSuspVehicleBehavior')?.value || ''
      };
    } else if (ticket.incidentType === 'robo-vehiculo') {
      ticket.stolenVehicle = {
        type: document.getElementById('formVehicleType')?.value || '',
        brand: document.getElementById('formVehicleBrand')?.value || '',
        plate: document.getElementById('formVehiclePlate')?.value || '',
        color: document.getElementById('formVehicleColor')?.value || '',
        year: document.getElementById('formVehicleYear')?.value || '',
        location: document.getElementById('formVehicleLocation')?.value || '',
        dateTime: document.getElementById('formVehicleDateTime')?.value || '',
        gps: document.getElementById('formVehicleGPS')?.value || ''
      };
    }

    // Marcar como modificado
    ticket.lastModified = new Date().toLocaleString('es-ES');

    // Actualizar tabs para reflejar cambios
    renderTicketTabs();

    showNotification('Cambios guardados exitosamente en el ticket ' + ticket.id, 'success');
  }

  // Funci√≥n para guardar cambios del formulario autom√°ticamente
  function saveFormChanges() {
    if (!ticketsState.activeTicketId) return;

    var ticket = ticketsState.tickets.find(function(t) { return t.id === ticketsState.activeTicketId; });
    if (!ticket) return;

    // Guardar solo campos b√°sicos (sin notificaci√≥n)
    ticket.alertLevel = document.getElementById('formAlertLevel')?.value || ticket.alertLevel;
    ticket.incidentType = document.getElementById('formIncidentType')?.value || ticket.incidentType;
    ticket.reporterName = document.getElementById('formReporterName')?.value || ticket.reporterName;
    ticket.reporterDNI = document.getElementById('formReporterDNI')?.value || ticket.reporterDNI;
    ticket.reporterPhone = document.getElementById('formReporterPhone')?.value || ticket.reporterPhone;
    ticket.reporterEmail = document.getElementById('formReporterEmail')?.value || ticket.reporterEmail;
    ticket.reporterRelation = document.getElementById('formReporterRelation')?.value || ticket.reporterRelation;

    // Actualizar tabs para reflejar cambios
    renderTicketTabs();
  }

  // Funci√≥n para renderizar agentes asignados a ESTE ticket espec√≠fico
  function renderTicketAssignedAgents() {
    var container = document.getElementById('ticketAssignedAgentsList');
    if (!container) return;

    // Si no hay ticket activo, limpiar
    if (!ticketsState.activeTicketId) {
      container.innerHTML = '<div style="padding: 20px; text-align: center; color: #9ca3af; font-size: 13px;">Seleccione un ticket</div>';
      return;
    }

    var ticket = ticketsState.tickets.find(function(t) { return t.id === ticketsState.activeTicketId; });
    if (!ticket) {
      container.innerHTML = '<div style="padding: 20px; text-align: center; color: #9ca3af; font-size: 13px;">Ticket no encontrado</div>';
      return;
    }

    // Filtrar agentes que tienen asignado ESTE ticket espec√≠fico
    var ticketAgents = agentsData.filter(function(agent) {
      return agent.assignedTicket === ticket.id;
    });

    // Limpiar contenedor
    container.innerHTML = '';

    if (ticketAgents.length === 0) {
      container.innerHTML = '<div style="padding: 20px; text-align: center; color: #9ca3af; font-size: 13px;">No hay agentes asignados a este ticket</div>';
      return;
    }

    // Renderizar cada agente asignado
    ticketAgents.forEach(function(agent) {
      var agentCard = document.createElement('div');
      agentCard.style.cssText = 'padding: 12px 15px; border-bottom: 1px solid #1e293b;';

      agentCard.innerHTML =
        '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">' +
          '<strong style="font-size: 14px; color: #e5e7eb;">' + agent.name + '</strong>' +
          '<span style="font-size: 11px; padding: 2px 6px; background: #1e3a1e; border-radius: 4px; color: #22c55e;">En este ticket</span>' +
        '</div>' +
        '<div style="font-size: 12px; color: #9ca3af; margin-bottom: 4px;">üöó ' + agent.transporte + '</div>' +
        '<div style="font-size: 12px; color: #9ca3af; margin-bottom: 8px;">üìç ' + agent.distancia + '</div>' +
        '<button onclick="releaseAgentFromTicket(\'' + agent.id + '\')" class="btn btn-sm" style="width: 100%; padding: 6px; font-size: 11px; background: #dc2626; color: white; border: none;">Liberar Agente</button>';

      container.appendChild(agentCard);
    });
  }

  // Vincular eventos del formulario
  document.addEventListener('DOMContentLoaded', function() {
    // Listener para cambio de tipo de incidencia
    var formIncidentType = document.getElementById('formIncidentType');
    if (formIncidentType) {
      formIncidentType.addEventListener('change', function() {
        handleIncidentTypeChange(this.value);
        saveFormChanges();
      });
    }

    // Listeners para guardar cambios autom√°ticamente
    var formFields = [
      'formAlertLevel',
      'formReporterName',
      'formReporterDNI',
      'formReporterPhone',
      'formReporterEmail',
      'formReporterRelation'
    ];

    formFields.forEach(function(fieldId) {
      var field = document.getElementById(fieldId);
      if (field) {
        field.addEventListener('change', saveFormChanges);
        field.addEventListener('blur', saveFormChanges);
      }
    });
  });
</script>