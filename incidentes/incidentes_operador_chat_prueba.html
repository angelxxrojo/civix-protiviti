<!-- SweetAlert2 (requerido por la consola CAD) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.tailwindcss.com"></script>
<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Tu app CAD -->


<!-- <div class="row">
  <div class="col-md-12">
    <div class="new-incident-wrapper">
      <button class="btn btn-accent btn-rounded" id="addticket" type="button">
        <i class="pe-7s-plus" aria-hidden="true"></i> Registrar nuevo incidente
      </button>
    </div>
  </div>
</div> -->

<div class="w-full">
  <div class="w-full">
    <div class="bg-white border-b border-gray-200 px-6 py-4">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-bold text-gray-900">Tickets Activos</h3>
        <span class="text-sm text-gray-500" id="ticketsCount">3 tickets</span>
      </div>
      <div class="overflow-x-auto scrollbar-hide">
        <div class="flex gap-3 pb-2" id="incidentTabs"></div>
      </div>
    </div>
  </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 p-4">
  
  <!-- COLUMNA 1: Formulario del Ticket -->
  <div class="h-[calc(100vh-200px)] overflow-y-auto scrollbar-hide">
    <div class="space-y-6 pr-4" id="ticketFormContainer">

      <!-- Card: Header Principal -->
      <div class="rounded-lg border border-gray-200 bg-white shadow-sm">
        <div class="p-6">
          <h3 class="text-2xl font-bold text-orange-500">Registro de Incidencias ‚Äì Seguridad Ciudadana</h3>
          <p class="text-sm text-gray-500 mt-1" id="formTicketHeader">Ticket #3242 ‚Ä¢ 27/11/2025, 7:24:24 a.m.</p>
        </div>
      </div>

      <!-- Card: Informaci√≥n General del Reporte -->
      <div class="rounded-lg border border-gray-200 bg-white shadow-sm">
        <div class="p-6">
          <h3 class="text-xl font-semibold flex items-center gap-2 mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-600">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" x2="12" y1="16" y2="12"></line>
              <line x1="12" x2="12.01" y1="8" y2="8"></line>
            </svg>
            Informaci√≥n General del Reporte
          </h3>
          <div class="grid grid-cols-2 gap-4">
            <div class="space-y-2">
              <label class="text-sm font-medium text-gray-700">ID de la Incidencia</label>
              <input type="text" id="formIncidentId" class="w-full h-10 px-3 py-2 text-sm border border-gray-300 rounded-md bg-gray-100" readonly value="#3242">
            </div>
            <div class="space-y-2">
              <label class="text-sm font-medium text-gray-700">Nivel de Alerta</label>
              <select id="formAlertLevel" class="w-full h-10 px-3 py-2 text-sm border border-gray-300 rounded-md bg-white">
                <option value="critica">üî¥ Cr√≠tica</option>
                <option value="alta">üü† Alta</option>
                <option value="media">üü° Media</option>
                <option value="baja">üü¢ Baja</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- Card: Tipo de Incidencia -->
      <div class="rounded-lg border border-gray-200 bg-white shadow-sm">
        <div class="p-6">
          <div class="space-y-2">
            <label class="text-sm font-medium text-gray-700">Tipo de Incidencia *</label>
            <select id="formIncidentType" class="w-full h-10 px-3 py-2 text-sm border border-gray-300 rounded-md bg-white">
              <option value="">Seleccionar</option>
              <option value="robo-vehiculo">üöó Robo de Veh√≠culo</option>
              <option value="persona-sospechosa">üë§ Persona Sospechosa</option>
              <option value="persona-desaparecida">üîç Persona Desaparecida</option>
              <option value="vehiculo-sospechoso">üöô Veh√≠culo Sospechoso</option>
              <option value="otra">üìã Otra incidencia</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Card: Datos del Reportante -->
      <div class="rounded-lg border border-gray-200 bg-white shadow-sm">
        <div class="p-6">
          <h3 class="text-xl font-semibold flex items-center gap-2 mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-600">
              <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
            Datos del Reportante
          </h3>
          <div class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
              <div class="space-y-2">
                <label class="text-sm font-medium text-gray-700">Nombre completo *</label>
                <input type="text" id="formReporterName" class="w-full h-10 px-3 py-2 text-sm border border-gray-300 rounded-md bg-white" placeholder="Nombre completo" value="Juan P√©rez Garc√≠a">
              </div>
              <div class="space-y-2">
                <label class="text-sm font-medium text-gray-700">DNI / Identificaci√≥n *</label>
                <input type="text" id="formReporterDNI" class="w-full h-10 px-3 py-2 text-sm border border-gray-300 rounded-md bg-white" placeholder="DNI" value="12345678">
              </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div class="space-y-2">
                <label class="text-sm font-medium text-gray-700">Tel√©fono de contacto *</label>
                <input type="text" id="formReporterPhone" class="w-full h-10 px-3 py-2 text-sm border border-gray-300 rounded-md bg-white" placeholder="Tel√©fono" value="55 9876 5432">
              </div>
              <div class="space-y-2">
                <label class="text-sm font-medium text-gray-700">Correo electr√≥nico</label>
                <input type="email" id="formReporterEmail" class="w-full h-10 px-3 py-2 text-sm border border-gray-300 rounded-md bg-white" placeholder="correo@ejemplo.com" value="juan@example.com">
              </div>
            </div>
            <div class="space-y-2">
              <label class="text-sm font-medium text-gray-700">Relaci√≥n con el hecho</label>
              <select id="formReporterRelation" class="w-full h-10 px-3 py-2 text-sm border border-gray-300 rounded-md bg-white">
                <option value="">Seleccionar</option>
                <option value="victima" selected>V√≠ctima</option>
                <option value="testigo">Testigo</option>
                <option value="tercero">Tercero</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- Card: Persona Desaparecida (Din√°mico seg√∫n tipo) -->
      <div class="rounded-lg border border-gray-200 bg-white shadow-sm border-l-4 border-l-orange-500" id="formMissingPersonSection" style="display: none;">
        <div class="p-6">
          <h3 class="text-xl font-semibold flex items-center gap-2 mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-600">
              <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
              <line x1="17" x2="22" y1="8" y2="13"></line>
              <line x1="22" x2="17" y1="8" y2="13"></line>
            </svg>
            Datos de la Persona Desaparecida
          </h3>
          <div class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
              <div class="space-y-2">
                <label class="text-sm font-medium text-gray-700">Nombre completo</label>
                <input type="text" id="formMissingName" class="w-full h-10 px-3 py-2 text-sm border border-gray-300 rounded-md bg-white" placeholder="Nombre completo">
              </div>
              <div class="space-y-2">
                <label class="text-sm font-medium text-gray-700">Edad</label>
                <input type="text" id="formMissingAge" class="w-full h-10 px-3 py-2 text-sm border border-gray-300 rounded-md bg-white" placeholder="Edad">
              </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div class="space-y-2">
                <label class="text-sm font-medium text-gray-700">G√©nero</label>
                <select id="formMissingGender" class="w-full h-10 px-3 py-2 text-sm border border-gray-300 rounded-md bg-white">
                  <option value="">Seleccionar</option>
                  <option value="masculino">Masculino</option>
                  <option value="femenino">Femenino</option>
                  <option value="otro">Otro</option>
                </select>
              </div>
              <div class="space-y-2">
                <label class="text-sm font-medium text-gray-700">DNI</label>
                <input type="text" id="formMissingDNI" class="w-full h-10 px-3 py-2 text-sm border border-gray-300 rounded-md bg-white" placeholder="DNI">
              </div>
            </div>
            <div class="space-y-2">
              <label class="text-sm font-medium text-gray-700">Fecha y hora vista por √∫ltima vez</label>
              <input type="datetime-local" id="formMissingLastSeen" class="w-full h-10 px-3 py-2 text-sm border border-gray-300 rounded-md bg-white">
            </div>
            <div class="space-y-2">
              <label class="text-sm font-medium text-gray-700">Lugar donde fue vista por √∫ltima vez</label>
              <input type="text" id="formMissingLastLocation" class="w-full h-10 px-3 py-2 text-sm border border-gray-300 rounded-md bg-white" placeholder="Ubicaci√≥n">
            </div>
            <div class="space-y-2">
              <label class="text-sm font-medium text-gray-700">Descripci√≥n de la persona</label>
              <textarea id="formMissingDescription" class="w-full min-h-[80px] px-3 py-2 text-sm border border-gray-300 rounded-md bg-white resize-vertical" placeholder="Incluya vestimenta, se√±ales particulares, tatuajes, cicatrices, etc." rows="4"></textarea>
            </div>
            <div class="space-y-2">
              <label class="text-sm font-medium text-gray-700">¬øTiene problemas m√©dicos o cognitivos?</label>
              <select id="formMissingMedical" class="w-full h-10 px-3 py-2 text-sm border border-gray-300 rounded-md bg-white">
                <option value="">Seleccionar</option>
                <option value="si">S√≠</option>
                <option value="no">No</option>
                <option value="desconoce">Desconoce</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- Card: Persona Sospechosa (Din√°mico seg√∫n tipo) -->
      <div class="rounded-lg border border-gray-200 bg-white shadow-sm border-l-4 border-l-yellow-500" id="formSuspiciousPersonSection" style="display: none;">
        <div class="p-6">
          <h3 class="text-xl font-semibold flex items-center gap-2 mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-600">
              <circle cx="10" cy="7" r="4"></circle>
              <path d="M10.3 15H7a4 4 0 0 0-4 4v2"></path>
              <circle cx="17" cy="17" r="3"></circle>
              <path d="m21 21-1.9-1.9"></path>
            </svg>
            Datos de la Persona Sospechosa
          </h3>
          <div class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
              <div class="space-y-2">
                <label class="text-sm font-medium text-gray-700">Nombre (opcional)</label>
                <input type="text" id="formSuspiciousName" class="w-full h-10 px-3 py-2 text-sm border border-gray-300 rounded-md bg-white" placeholder="Si se conoce">
              </div>
              <div class="space-y-2">
                <label class="text-sm font-medium text-gray-700">Alias (opcional)</label>
                <input type="text" id="formSuspiciousAlias" class="w-full h-10 px-3 py-2 text-sm border border-gray-300 rounded-md bg-white" placeholder="Apodo o alias">
              </div>
            </div>
            <div class="space-y-2">
              <label class="text-sm font-medium text-gray-700">Descripci√≥n f√≠sica</label>
              <textarea id="formSuspiciousDescription" class="w-full min-h-[80px] px-3 py-2 text-sm border border-gray-300 rounded-md bg-white resize-vertical" placeholder="Estatura, complexi√≥n, rasgos distintivos..."></textarea>
            </div>
            <div class="space-y-2">
              <label class="text-sm font-medium text-gray-700">Motivo de sospecha</label>
              <textarea id="formSuspiciousReason" class="w-full min-h-[80px] px-3 py-2 text-sm border border-gray-300 rounded-md bg-white resize-vertical" placeholder="¬øPor qu√© es sospechosa?"></textarea>
            </div>
            <div class="space-y-2">
              <label class="text-sm font-medium text-gray-700">√öltimo lugar visto</label>
              <input type="text" id="formSuspiciousLocation" class="w-full h-10 px-3 py-2 text-sm border border-gray-300 rounded-md bg-white" placeholder="Ubicaci√≥n">
            </div>
            <div class="space-y-2">
              <label class="text-sm font-medium text-gray-700">¬øVinculado con hechos anteriores?</label>
              <select id="formSuspiciousLinked" class="w-full h-10 px-3 py-2 text-sm border border-gray-300 rounded-md bg-white">
                <option value="">Seleccionar</option>
                <option value="si">S√≠</option>
                <option value="no">No</option>
                <option value="desconoce">Desconoce</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- Card: Veh√≠culo Sospechoso (Din√°mico seg√∫n tipo) -->
      <div class="rounded-lg border border-gray-200 bg-white shadow-sm border-l-4 border-l-blue-500" id="formSuspiciousVehicleSection" style="display: none;">
        <div class="p-6">
          <h3 class="text-xl font-semibold flex items-center gap-2 mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-600">
              <path d="M14 18V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v11a1 1 0 0 0 1 1h2"></path>
              <path d="M15 18H9"></path>
              <path d="M19 18h2a1 1 0 0 0 1-1v-3.65a1 1 0 0 0-.22-.624l-3.48-4.35A1 1 0 0 0 17.52 8H14"></path>
              <circle cx="17" cy="18" r="2"></circle>
              <circle cx="7" cy="18" r="2"></circle>
            </svg>
            Datos del Veh√≠culo Sospechoso
          </h3>
          <div class="space-y-4">
            <div class="space-y-2">
              <label class="text-sm font-medium text-gray-700">Placa (opcional)</label>
              <input type="text" id="formSuspVehiclePlate" class="w-full h-10 px-3 py-2 text-sm border border-gray-300 rounded-md bg-white" placeholder="Si es visible">
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div class="space-y-2">
                <label class="text-sm font-medium text-gray-700">Tipo de veh√≠culo</label>
                <input type="text" id="formSuspVehicleType" class="w-full h-10 px-3 py-2 text-sm border border-gray-300 rounded-md bg-white" placeholder="Auto, camioneta, etc.">
              </div>
              <div class="space-y-2">
                <label class="text-sm font-medium text-gray-700">Color</label>
                <input type="text" id="formSuspVehicleColor" class="w-full h-10 px-3 py-2 text-sm border border-gray-300 rounded-md bg-white" placeholder="Color">
              </div>
            </div>
            <div class="space-y-2">
              <label class="text-sm font-medium text-gray-700">Detalles distintivos</label>
              <textarea id="formSuspVehicleDetails" class="w-full min-h-[80px] px-3 py-2 text-sm border border-gray-300 rounded-md bg-white resize-vertical" placeholder="Calcoman√≠as, da√±os, caracter√≠sticas especiales..."></textarea>
            </div>
            <div class="space-y-2">
              <label class="text-sm font-medium text-gray-700">Lugar donde fue visto</label>
              <input type="text" id="formSuspVehicleLocation" class="w-full h-10 px-3 py-2 text-sm border border-gray-300 rounded-md bg-white" placeholder="Ubicaci√≥n">
            </div>
            <div class="space-y-2">
              <label class="text-sm font-medium text-gray-700">Hora de registro</label>
              <input type="time" id="formSuspVehicleTime" class="w-full h-10 px-3 py-2 text-sm border border-gray-300 rounded-md bg-white">
            </div>
            <div class="space-y-2">
              <label class="text-sm font-medium text-gray-700">Comportamiento sospechoso</label>
              <textarea id="formSuspVehicleBehavior" class="w-full min-h-[80px] px-3 py-2 text-sm border border-gray-300 rounded-md bg-white resize-vertical" placeholder="¬øQu√© hace que sea sospechoso?"></textarea>
            </div>
          </div>
        </div>
      </div>

      <!-- Card: Datos del Robo de Veh√≠culo (Din√°mico seg√∫n tipo) -->
      <div class="rounded-lg border border-gray-200 bg-white shadow-sm border-l-4 border-l-purple-500" id="formVehicleSection" style="display: none;">
        <div class="p-6">
          <h3 class="text-xl font-semibold flex items-center gap-2 mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-600">
              <path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"></path>
              <circle cx="7" cy="17" r="2"></circle>
              <path d="M9 17h6"></path>
              <circle cx="17" cy="17" r="2"></circle>
            </svg>
            Datos del Robo de Veh√≠culo
          </h3>
          <div class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
              <div class="space-y-2">
                <label class="text-sm font-medium text-gray-700">Tipo de veh√≠culo</label>
                <select id="formVehicleType" class="w-full h-10 px-3 py-2 text-sm border border-gray-300 rounded-md bg-white">
                  <option value="">Seleccionar</option>
                  <option value="auto">Autom√≥vil</option>
                  <option value="moto">Motocicleta</option>
                  <option value="camioneta">Camioneta</option>
                  <option value="otro">Otro</option>
                </select>
              </div>
              <div class="space-y-2">
                <label class="text-sm font-medium text-gray-700">Marca / Modelo</label>
                <input type="text" id="formVehicleBrand" class="w-full h-10 px-3 py-2 text-sm border border-gray-300 rounded-md bg-white" placeholder="Ej: Toyota Corolla">
              </div>
            </div>
            <div class="grid grid-cols-3 gap-4">
              <div class="space-y-2">
                <label class="text-sm font-medium text-gray-700">Placa</label>
                <input type="text" id="formVehiclePlate" class="w-full h-10 px-3 py-2 text-sm border border-gray-300 rounded-md bg-white" placeholder="ABC-123">
              </div>
              <div class="space-y-2">
                <label class="text-sm font-medium text-gray-700">Color</label>
                <input type="text" id="formVehicleColor" class="w-full h-10 px-3 py-2 text-sm border border-gray-300 rounded-md bg-white" placeholder="Color">
              </div>
              <div class="space-y-2">
                <label class="text-sm font-medium text-gray-700">A√±o</label>
                <input type="text" id="formVehicleYear" class="w-full h-10 px-3 py-2 text-sm border border-gray-300 rounded-md bg-white" placeholder="2020">
              </div>
            </div>
            <div class="space-y-2">
              <label class="text-sm font-medium text-gray-700">Lugar del robo</label>
              <input type="text" id="formVehicleLocation" class="w-full h-10 px-3 py-2 text-sm border border-gray-300 rounded-md bg-white" placeholder="Ubicaci√≥n exacta">
            </div>
            <div class="space-y-2">
              <label class="text-sm font-medium text-gray-700">Fecha y hora del robo</label>
              <input type="datetime-local" id="formVehicleDateTime" class="w-full h-10 px-3 py-2 text-sm border border-gray-300 rounded-md bg-white">
            </div>
            <div class="space-y-2">
              <label class="text-sm font-medium text-gray-700">¬øTiene GPS?</label>
              <select id="formVehicleGPS" class="w-full h-10 px-3 py-2 text-sm border border-gray-300 rounded-md bg-white">
                <option value="">Seleccionar</option>
                <option value="si">S√≠</option>
                <option value="no">No</option>
                <option value="desconoce">Desconoce</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- Card: Evidencia Adjunta -->
      <div class="rounded-lg border border-gray-200 bg-white shadow-sm">
        <div class="p-6">
          <h3 class="text-xl font-semibold flex items-center gap-2 mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-600">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="17 8 12 3 7 8"></polyline>
              <line x1="12" x2="12" y1="3" y2="15"></line>
            </svg>
            Evidencia Adjunta (Opcional)
          </h3>
          <div class="space-y-3">
            <p class="text-sm text-gray-500">Sube fotos, videos, documentos o audio relacionados con el incidente</p>
            <button type="button" class="w-full h-11 px-8 text-sm font-medium text-gray-700 bg-white border border-gray-300 hover:bg-gray-50 rounded-md transition-colors inline-flex items-center justify-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" x2="12" y1="3" y2="15"></line>
              </svg>
              Subir archivos (m√°x. 10 archivos)
            </button>
            <div id="formEvidenceList" class="space-y-2 mt-3"></div>
          </div>
        </div>
      </div>

      <!-- Card: Ubicaci√≥n del Incidente -->
      <div class="rounded-lg border border-gray-200 bg-white shadow-sm">
        <div class="p-6">
          <h3 class="text-xl font-semibold flex items-center gap-2 mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-600">
              <path d="M20 10c0 4.993-5.539 10.193-7.399 11.799a1 1 0 0 1-1.202 0C9.539 20.193 4 14.993 4 10a8 8 0 0 1 16 0"></path>
              <circle cx="12" cy="10" r="3"></circle>
            </svg>
            Ubicaci√≥n del Incidente
          </h3>
          <div class="space-y-4">
            <div class="space-y-2">
              <label class="text-sm font-medium text-gray-700">Direcci√≥n exacta *</label>
              <input type="text" id="formLocationAddress" class="w-full h-10 px-3 py-2 text-sm border border-gray-300 rounded-md bg-white" placeholder="Calle, n√∫mero, colonia" value="Av. Reforma 456, Col. Ju√°rez">
              <p class="text-xs text-gray-500">üí° Usa el mapa de la derecha para buscar y autocompletar</p>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div class="space-y-2">
                <label class="text-sm font-medium text-gray-700">Distrito *</label>
                <input type="text" id="formLocationDistrict" class="w-full h-10 px-3 py-2 text-sm border border-gray-300 rounded-md bg-white" placeholder="Distrito" value="Cuauht√©moc">
              </div>
              <div class="space-y-2">
                <label class="text-sm font-medium text-gray-700">Provincia *</label>
                <input type="text" id="formLocationProvince" class="w-full h-10 px-3 py-2 text-sm border border-gray-300 rounded-md bg-white" placeholder="Provincia" value="Ciudad de M√©xico">
              </div>
            </div>
            <div class="space-y-2">
              <label class="text-sm font-medium text-gray-700">Referencia</label>
              <input type="text" id="formLocationReference" class="w-full h-10 px-3 py-2 text-sm border border-gray-300 rounded-md bg-white" placeholder="Frente a..., cerca de..." value="Frente al banco">
            </div>
            <div class="space-y-2">
              <label class="text-sm font-medium text-gray-700">Coordenadas GPS</label>
              <input type="text" id="formLocationCoords" class="w-full h-10 px-3 py-2 text-sm border border-gray-300 rounded-md bg-gray-100" readonly placeholder="Auto-detectado o manual" value="19.4326, -99.1332">
            </div>
          </div>
        </div>
      </div>

      <!-- Card: Otra Incidencia (Din√°mico seg√∫n tipo) -->
      <div class="rounded-lg border border-gray-200 bg-white shadow-sm border-l-4 border-l-gray-500" id="formOtherSection" style="display: none;">
        <div class="p-6">
          <h3 class="text-xl font-semibold flex items-center gap-2 mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-600">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" x2="12" y1="8" y2="12"></line>
              <line x1="12" x2="12.01" y1="16" y2="16"></line>
            </svg>
            Descripci√≥n de la Incidencia
          </h3>
          <div class="space-y-2">
            <label class="text-sm font-medium text-gray-700">Descripci√≥n detallada</label>
            <textarea id="formOtherDescription" class="w-full min-h-[120px] px-3 py-2 text-sm border border-gray-300 rounded-md bg-white resize-vertical" rows="6" placeholder="Describe detalladamente la incidencia..."></textarea>
          </div>
        </div>
      </div>

      <!-- Botones de acci√≥n -->
      <div class="flex gap-3 sticky bottom-0 bg-white/95 backdrop-blur-sm p-4 border-t border-gray-200">
        <button type="button" id="formSaveBtn" class="flex-1 h-11 px-8 text-sm font-medium text-white bg-orange-500 hover:bg-orange-600 rounded-md transition-colors">Guardar reporte</button>
        <button type="button" id="formClearBtn" class="h-11 px-8 text-sm font-medium text-gray-700 bg-white border border-gray-300 hover:bg-gray-50 rounded-md transition-colors">Limpiar formulario</button>
        <button type="button" id="formCancelBtn" class="h-11 px-8 text-sm font-medium text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-md transition-colors">Cancelar</button>
      </div>

    </div>
  </div>
  
  <!-- COLUMNA 2: Chat del Ticket -->
  <div class="h-[calc(100vh-200px)]">
    <div class="bg-white rounded-lg border border-gray-200 flex flex-col h-full">
      
      <!-- Header del Chat -->
      <div class="p-6 border-b border-gray-200">
        <h2 class="text-xl font-bold text-gray-900 mb-2">Chat del ticket</h2>
        <div class="space-y-1 text-sm text-gray-500">
          <div>Ticket: <span class="font-semibold text-gray-900" id="chatTicketId">#3242</span></div>
          <div>Agente: <span class="font-semibold text-gray-900" id="chatAgentName">Agente Rodr√≠guez</span></div>
          <div>Estado: <span class="font-semibold text-orange-500" id="chatTicketStatus">En atenci√≥n</span></div>
        </div>
      </div>
      
      <!-- √Årea de mensajes -->
      <div class="flex-1 overflow-y-auto p-6 scrollbar-hide">
        <div class="space-y-4" id="chatTimeline">
          <!-- Los mensajes se renderizan aqu√≠ con JS -->
        </div>
      </div>
      
      <!-- Input de mensaje -->
      <div class="p-6 border-t border-gray-200">
        <div class="flex gap-2">
          <input 
            type="text" 
            id="chatComposerInput"
            class="flex-1 h-10 px-3 py-2 text-sm border border-gray-300 rounded-md bg-white placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent" 
            placeholder="Escribe un mensaje..."
          >
          <button 
            type="button" 
            id="chatSendButton"
            class="inline-flex items-center justify-center h-10 px-4 py-2 text-sm font-medium text-white bg-orange-500 hover:bg-orange-600 rounded-md transition-colors"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z"></path>
              <path d="m21.854 2.147-10.94 10.939"></path>
            </svg>
          </button>
        </div>
      </div>
      
    </div>
</div>
  
  <!-- COLUMNA 3: Mapa Interactivo -->
  <div class="h-[calc(100vh-200px)]">
    <div class="bg-white rounded-lg border border-gray-200 flex flex-col h-full">
      
      <!-- Header del Mapa -->
      <div class="p-4 border-b border-gray-200">
        <h2 class="text-xl font-bold text-gray-900">Mapa Interactivo</h2>
        <div class="flex gap-2 mt-3">
          <input 
            type="text" 
            id="mapSearchInput"
            class="flex-1 h-10 px-3 py-2 text-sm border border-gray-300 rounded-md bg-white placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent" 
            placeholder="Buscar direcci√≥n..."
          >
          <button 
            type="button" 
            id="mapSearchBtn"
            class="inline-flex items-center justify-center h-10 w-10 text-white bg-orange-500 hover:bg-orange-600 rounded-md transition-colors"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.3-4.3"></path>
            </svg>
          </button>
        </div>
      </div>
      
      <!-- Tabs: Agentes / C√°maras -->
      <div class="p-4 border-b border-gray-200">
        <div class="h-10 w-full grid grid-cols-2 items-center justify-center rounded-md bg-gray-100 p-1" id="mapTabs">
          <button 
            type="button" 
            data-tab="agents"
            class="map-tab flex items-center justify-center gap-2 px-3 py-1.5 text-sm font-medium rounded-sm transition-all active bg-white text-gray-900 shadow-sm"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
              <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
            <span>Agentes</span>
          </button>
          <button 
            type="button" 
            data-tab="cameras"
            class="map-tab flex items-center justify-center gap-2 px-3 py-1.5 text-sm font-medium rounded-sm transition-all text-gray-500"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"></path>
              <circle cx="12" cy="13" r="3"></circle>
            </svg>
            <span>C√°maras</span>
          </button>
        </div>
      </div>
      
      <!-- √Årea del Mapa -->
      <div class="flex-1 bg-gray-50 relative overflow-hidden">
        
        <!-- Grid de fondo -->
        <div class="absolute inset-0 grid grid-cols-12 grid-rows-12" id="mapGrid">
          <!-- Las celdas se generan con JS o se pueden poner est√°ticas -->
        </div>
        
        <!-- L√≠neas de calles (SVG) -->
        <svg class="absolute inset-0 w-full h-full pointer-events-none opacity-30">
          <line x1="20%" y1="0" x2="20%" y2="100%" stroke="#9ca3af" stroke-width="2"></line>
          <line x1="50%" y1="0" x2="50%" y2="100%" stroke="#9ca3af" stroke-width="3"></line>
          <line x1="80%" y1="0" x2="80%" y2="100%" stroke="#9ca3af" stroke-width="2"></line>
          <line x1="0" y1="30%" x2="100%" y2="30%" stroke="#9ca3af" stroke-width="2"></line>
          <line x1="0" y1="60%" x2="100%" y2="60%" stroke="#9ca3af" stroke-width="3"></line>
          <line x1="0" y1="80%" x2="100%" y2="80%" stroke="#9ca3af" stroke-width="2"></line>
        </svg>
        
        <!-- Marcadores de agentes -->
        <div id="mapMarkers">
          <!-- Los marcadores se renderizan con JS -->
        </div>
        
        <!-- Leyenda del mapa -->
        <div class="absolute bottom-4 left-4 bg-white/95 border border-gray-200 rounded-lg p-3 text-xs">
          <div class="font-semibold text-gray-900 mb-1">Mapa Simulado</div>
          <div class="text-gray-500 map-legend-text">Vista de Agentes Activos</div>
        </div>
        
        <!-- Mapa real (Leaflet) - oculto por defecto, mostrar cuando est√© disponible -->
        <div id="mapCAD" class="absolute inset-0 z-10 hidden"></div>
        
      </div>
      
    </div>
  </div>
  
</div>

<!-- Modal para asignar agente -->
<!-- <div class="modal-overlay" id="assignAgentModal">
  <div class="agent-modal">
    <div class="agent-modal-header">
      <h3 class="agent-modal-title">Asignar agente al incidente</h3>
      <button class="agent-modal-close" onclick="closeAssignAgentModal()" aria-label="Cerrar modal">&times;</button>
    </div>
    <div class="agent-modal-body">
      <div class="modal-search">
        <input type="text" id="agentSearchInput" placeholder="Buscar agente por nombre..." oninput="filterAgents()"
          aria-label="Buscar agente" />
      </div>
      <div id="agentListContainer"></div>
    </div>
  </div>
</div>

{{modal_nuevo_incidente}} -->

<script>
  // Initialize Leaflet map for the operator chat view
  document.addEventListener('DOMContentLoaded', function () {
    var el = document.getElementById('mapCAD');
    if (!el || typeof L === 'undefined') return;

    var map = L.map('mapCAD', { zoomControl: true, attributionControl: true });
    // Center near Av. Primavera; adjust as needed
    var primavera = [-12.1175, -76.9990];
    map.setView(primavera, 14);

    // Mid-gray basemap for better contrast with overlays
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      maxZoom: 20,
      attribution: '&copy; OpenStreetMap contributors &copy; CARTO'
    }).addTo(map);

    // Incident marker and popup
    L.marker(primavera)
      .addTo(map)
      .bindPopup('<b>Incidente</b><br>Av. Primavera 123')
      .openPopup();

    // Ensure correct sizing in case of late layout/visibility changes
    setTimeout(function () { map.invalidateSize(); }, 300);
  });
</script>
<script>
  // General tab renderer (read-only context)
  (function () {
    function byId(id) { return document.getElementById(id); }
    var data = {
      id: 'INC-2025-001',
      titulo: 'Accidente de tr√°nsito en Av. Primavera',
      estado: 'Clasificado',
      origen: 'Llamada 105',
      severidad: 'Media',
      prioridad: 'Alta',
      fechaCreacion: '12/01/2025 10:30',
      tiempoTranscurrido: '18.50 h',
      slaPorcentaje: 82,
      direccion: 'Av. Primavera 123, Santiago de Surco',
      coords: '-12.117500, -76.999000',
      clasificacion: 'Tr√°nsito',
      tipo: 'Accidente de tr√°nsito',
      subtipo: 'Choque',
      descripcion: 'Colisi√≥n entre dos veh√≠culos. Sin heridos de gravedad reportados. Congesti√≥n en carril derecho.',
      denunciante: {
        nombre: 'Mario Salazar',
        telefono: '+51 999 123 456',
        documento: 'DNI 12345678'
      },
      agentes: [{ nombre: 'A. Ram√≠rez' }, { nombre: 'B. Torres' }],
      personas: [{ nombre: 'Juan P√©rez', rol: 'Afectado' }, { nombre: 'Mar√≠a L√≥pez', rol: 'Testigo' }],
      camaras: [
        { id: 'CAM-014', estado: 'online', ubicacion: 'Primavera x Central', distancia: '120m' },
        { id: 'CAM-021', estado: 'offline', ubicacion: 'Primavera x Velasco', distancia: '350m' }
      ]
    };
    const incidentTabsData = [
      { id: '#3242', title: 'Robo de Veh√≠culo', date: '26 nov, 12:51 p.m.', status: 'high', unread: 3 },
      { id: '#3247', title: 'Persona Sospechosa', date: '26 nov, 11:51 a.m.', status: 'medium', unread: 1 },
      { id: '#3245', title: 'Otra incidencia', date: '26 nov, 10:51 a.m.', status: 'low', unread: 0 },
    ];
    let activeIncidentTab = incidentTabsData[0].id;

    // Datos de formulario por cada ticket
    const ticketFormData = {
      '#3242': {
        ticketId: '#3242',
        date: '27/11/2025, 7:24:24 a.m.',
        alertLevel: 'alta',
        incidentType: 'robo-vehiculo',
        reporter: {
          name: 'Juan P√©rez Garc√≠a',
          dni: '12345678',
          phone: '55 9876 5432',
          email: 'juan@example.com',
          relation: 'victima'
        },
        vehicle: {
          type: 'auto',
          brand: 'Toyota Corolla 2020',
          plate: 'ABC-1234',
          color: 'Rojo',
          year: '2020',
          location: 'Av. Reforma 456, Col. Ju√°rez',
          dateTime: '2025-11-27T07:00',
          hasGPS: 'no'
        },
        location: {
          address: 'Av. Reforma 456, Col. Ju√°rez',
          district: 'Cuauht√©moc',
          province: 'Ciudad de M√©xico',
          reference: 'Frente al banco',
          coords: '19.4326, -99.1332'
        }
      },
      '#3247': {
        ticketId: '#3247',
        date: '26/11/2025, 11:51:00 a.m.',
        alertLevel: 'media',
        incidentType: 'persona-sospechosa',
        reporter: {
          name: 'Mar√≠a L√≥pez S√°nchez',
          dni: '87654321',
          phone: '55 1234 5678',
          email: 'maria@example.com',
          relation: 'testigo'
        },
        suspiciousPerson: {
          name: 'Desconocido',
          alias: 'El Flaco',
          description: 'Hombre de aproximadamente 1.75m, complexi√≥n delgada, vestimenta oscura',
          reason: 'Merodeando establecimientos comerciales de manera sospechosa',
          lastLocation: 'Plaza comercial Central',
          linked: 'desconoce'
        },
        location: {
          address: 'Calle Principal 123, Col. Centro',
          district: 'Benito Ju√°rez',
          province: 'Ciudad de M√©xico',
          reference: 'Cerca del parque',
          coords: '19.3910, -99.1560'
        }
      },
      '#3245': {
        ticketId: '#3245',
        date: '26/11/2025, 10:51:00 a.m.',
        alertLevel: 'baja',
        incidentType: 'otra',
        reporter: {
          name: 'Carlos Ram√≠rez',
          dni: '45678912',
          phone: '55 9999 8888',
          email: 'carlos@example.com',
          relation: 'tercero'
        },
        otherDescription: 'Ruido excesivo en zona residencial durante horario nocturno',
        location: {
          address: 'Av. Insurgentes 789',
          district: 'Miguel Hidalgo',
          province: 'Ciudad de M√©xico',
          reference: 'Esquina con Reforma',
          coords: '19.4200, -99.1700'
        }
      }
    };

    const assignedAgents = [
      { shortName: 'A. Ram√≠rez', transporte: 'Camioneta', status: 'Disponible' },
      { shortName: 'B. Torres', transporte: 'Motocicleta', status: 'En ruta' },
    ];
    const availableAgents = [
      { id: 'ramirez', name: 'Agente Ram√≠rez', shortName: 'A. Ram√≠rez', transporte: 'Camioneta', status: 'Disponible', distancia: '0.8 km', incidenteActual: null },
      { id: 'vega', name: 'Agente Vega', shortName: 'C. Vega', transporte: 'Bicicleta', status: 'Disponible', distancia: '1.2 km', incidenteActual: null },
      { id: 'suarez', name: 'Agente Su√°rez', shortName: 'D. Su√°rez', transporte: 'Camioneta', status: 'Ocupado', distancia: '5.3 km', incidenteActual: '#2051' },
      { id: 'torres', name: 'Agente Torres', shortName: 'E. Torres', transporte: 'Camioneta', status: 'Ocupado', distancia: '3.7 km', incidenteActual: '#2053' },
      { id: 'lopez', name: 'Agente L√≥pez', shortName: 'F. L√≥pez', transporte: 'A pie', status: 'Disponible', distancia: '2.1 km', incidenteActual: null },
      { id: 'garcia', name: 'Agente Garc√≠a', shortName: 'G. Garc√≠a', transporte: 'Camioneta', status: 'Disponible', distancia: '0.5 km', incidenteActual: null },
      { id: 'martinez', name: 'Agente Mart√≠nez', shortName: 'H. Mart√≠nez', transporte: 'Bicicleta', status: 'Disponible', distancia: '1.8 km', incidenteActual: null },
      { id: 'fernandez', name: 'Agente Fern√°ndez', shortName: 'I. Fern√°ndez', transporte: 'Camioneta', status: 'Disponible', distancia: '4.2 km', incidenteActual: null },
      { id: 'diaz', name: 'Agente D√≠az', shortName: 'J. D√≠az', transporte: 'A pie', status: 'Ocupado', distancia: '8.1 km', incidenteActual: '#2048' }
    ];
    const chatTimelineByIncident = {
      'INC-2025-001': [
        { id: 'evt-001', type: 'event', icon: '‚ö°Ô∏è', title: 'Incidente creado', detail: 'Registrado v√≠a llamada 105', timestamp: '10:30' },
        { id: 'evt-002', type: 'event', icon: 'üëÆ', title: 'Agente A. Ram√≠rez asignado', detail: 'Camioneta ‚Ä¢ 0.8 km', timestamp: '10:32' },
        { id: 'evt-003', type: 'event', icon: 'üëÆ', title: 'Agente B. Torres asignado', detail: 'Motocicleta ‚Ä¢ 1.1 km', timestamp: '10:32' },
        { id: 'msg-001', type: 'message', from: 'operator', name: 'Operadora Carla Q.', role: 'CAD', text: 'Equipo, confirmen arribo y bloqueo del carril derecho.', timestamp: '10:33' },
        { id: 'msg-002', type: 'message', from: 'agent', name: 'A. Ram√≠rez', role: 'En ruta', text: 'Ingresando por Primavera. Congesti√≥n moderada, pido apoyo de tr√°nsito.', timestamp: '10:35', attachments: [{ type: 'foto', name: 'Congestion_Primavera.jpg' }] },
        { id: 'msg-003', type: 'message', from: 'agent', name: 'B. Torres', role: 'Motocicleta', text: 'Llego en 2 min. Tomo desv√≠o lateral para liberar carril izquierdo.', timestamp: '10:37' },
        { id: 'evt-004', type: 'event', icon: 'üìé', title: 'Evidencia cargada', detail: 'Unidad Ram√≠rez comparti√≥ 1 archivo.', timestamp: '10:38' },
        { id: 'msg-004', type: 'message', from: 'operator', name: 'Operadora Carla Q.', role: 'CAD', text: 'Listo, ambulancia privada en camino. Mantengan despejado.', timestamp: '10:39' }
      ],
      'INC-2025-014': [
        { id: 'evt-101', type: 'event', icon: '‚ö°Ô∏è', title: 'Incidente creado', detail: 'Robo en Plaza Central', timestamp: '09:10' },
        { id: 'evt-102', type: 'event', icon: 'üëÆ', title: 'Agente C. Vega asignado', detail: 'Bicicleta ‚Ä¢ 1.2 km', timestamp: '09:12' },
        { id: 'msg-101', type: 'message', from: 'agent', name: 'C. Vega', role: 'En patrullaje', text: 'Persiguiendo a sospechoso hacia Av. Grau, solicito cierre en la cuadra 4.', timestamp: '09:13' },
        { id: 'msg-102', type: 'message', from: 'operator', name: 'Operador Luis', role: 'CAD', text: 'Se coordin√≥ cerco con Serenazgo sector 2.', timestamp: '09:14' },
        { id: 'evt-103', type: 'event', icon: 'üìç', title: 'Testigo contactado', detail: 'Operador Jim√©nez en llamada con comerciante.', timestamp: '09:16' }
      ],
      'INC-2025-022': [
        { id: 'evt-201', type: 'event', icon: '‚ö°Ô∏è', title: 'Incidente creado', detail: 'Manifestaci√≥n no autorizada', timestamp: '07:45' },
        { id: 'evt-202', type: 'event', icon: 'üëÆ', title: 'Agente D. Su√°rez asignado', detail: 'Camioneta ‚Ä¢ 5.3 km', timestamp: '07:47' },
        { id: 'msg-201', type: 'message', from: 'operator', name: 'Operadora Elena', role: 'CAD', text: 'Recordatorio: documentar aforo y bloqueos.', timestamp: '07:51' },
        { id: 'msg-202', type: 'message', from: 'agent', name: 'D. Su√°rez', role: 'Jefe de patrulla', text: 'Grupo de 50 personas, sin disturbios. Env√≠o video corto.', timestamp: '07:53', attachments: [{ type: 'video', name: 'Manifestacion_022.mp4' }] }
      ],
      'INC-2025-027': [
        { id: 'evt-301', type: 'event', icon: '‚ö°Ô∏è', title: 'Incidente creado', detail: 'Corte de electricidad sector Los √Ålamos', timestamp: '06:05' },
        { id: 'msg-301', type: 'message', from: 'operator', name: 'Operador Luis', role: 'CAD', text: 'Se coordina con empresa el√©ctrica para restablecer servicio.', timestamp: '06:07' }
      ]
    };
    let chatFilterTerm = '';
    let chatAutoScroll = true;
    const chatStreamEl = byId('chatStream');
    const chatTimelineEl = byId('chatTimeline');
    const chatIncidentLabelEl = byId('chatIncidentLabel');
    const chatSearchInput = byId('chatSearchInput');
    const chatComposerInput = byId('chatComposerInput');
    const chatSendButton = byId('chatSendButton');
    const chatScrollCta = byId('chatScrollCta');
    const chatGoBottomBtn = byId('chatGoBottom');
    const chatDayPillEl = byId('chatDayPill');
    const chatKpiRefs = {
      mensajes: byId('chatKpiMensajes'),
      eventos: byId('chatKpiEventos'),
      archivos: byId('chatKpiArchivos'),
      agentes: byId('chatKpiAgentes')
    };

    try {
      if (byId('cg-id')) byId('cg-id').textContent = data.id;
      if (byId('cg-title')) byId('cg-title').textContent = data.titulo;
      if (byId('cg-estado')) byId('cg-estado').textContent = data.estado;
      if (byId('cg-prioridad')) byId('cg-prioridad').textContent = data.prioridad || data.severidad || '‚Äî';
      if (byId('cg-creacion')) byId('cg-creacion').textContent = data.fechaCreacion;
      if (byId('cg-tiempo')) byId('cg-tiempo').textContent = data.tiempoTranscurrido;
      if (byId('cg-sla-text')) byId('cg-sla-text').textContent = (data.slaPorcentaje ?? 0) + '%';
      const estadoBtns = document.querySelectorAll('.estado-btn');
      estadoBtns.forEach(btn => {
        if (btn.dataset.state === data.estado) btn.classList.add('is-active');
        else btn.classList.remove('is-active');
      });
      dibujarSlaPie(data.slaPorcentaje);
      if (byId('cg-direccion')) byId('cg-direccion').textContent = data.direccion;
      if (byId('cg-clasificacion')) byId('cg-clasificacion').textContent = data.clasificacion;
      if (byId('cg-tipo')) byId('cg-tipo').textContent = data.tipo;
      if (byId('cg-subtipo')) byId('cg-subtipo').textContent = data.subtipo;
      if (byId('cg-desc')) byId('cg-desc').textContent = data.descripcion;

      // Sections for agentes/personas/c√°maras are managed in dedicated tabs; omitted here.
      renderPersonasTab(data);
      renderIncidentTabs();
      renderAssignedAgents();
      renderChatTimeline();
      updateTicketForm(activeIncidentTab);
    } catch (_) { }

    function dibujarSlaPie(porcentaje) {
      var canvas = document.getElementById('cg-sla-pie');
      if (!canvas || !canvas.getContext) return;
      var ctx = canvas.getContext('2d');
      var pct = Math.max(0, Math.min(100, Number(porcentaje) || 0)) / 100;
      var cx = canvas.width / 2;
      var cy = canvas.height / 2;
      var radius = Math.min(canvas.width, canvas.height) / 2 - 4;

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      ctx.beginPath();
      ctx.arc(cx, cy, radius, 0, Math.PI * 2);
      ctx.fillStyle = '#3a3a3a';
      ctx.fill();

      ctx.beginPath();
      ctx.moveTo(cx, cy);
      ctx.arc(cx, cy, radius, -Math.PI / 2, (Math.PI * 2 * pct) - Math.PI / 2);
      ctx.closePath();
      ctx.fillStyle = '#ef4444';
      ctx.fill();

      ctx.beginPath();
      ctx.arc(cx, cy, radius - 6, 0, Math.PI * 2);
      ctx.fillStyle = '#2b2b2b';
      ctx.fill();
    }

    function renderPersonasTab(info) {
      var denSection = byId('denunciante-section');
      if (!denSection) return;
      var denunciante = info && info.denunciante;
      if (denunciante) {
        var dn = byId('denunciante-nombre');
        var dt = byId('denunciante-telefono');
        var dd = byId('denunciante-documento');
        if (dn) dn.textContent = denunciante.nombre || '‚Äî';
        if (dt) dt.textContent = denunciante.telefono || '‚Äî';
        if (dd) dd.textContent = denunciante.documento || '‚Äî';
        denSection.style.display = '';
      } else {
        denSection.style.display = 'none';
      }
    }

    // Funci√≥n para mostrar/ocultar secciones seg√∫n tipo de incidencia
    function toggleIncidentTypeSections(incidentType) {
      var vehicleSection = byId('formVehicleSection');
      var missingPersonSection = byId('formMissingPersonSection');
      var suspiciousPersonSection = byId('formSuspiciousPersonSection');
      var suspiciousVehicleSection = byId('formSuspiciousVehicleSection');
      var otherSection = byId('formOtherSection');

      // Ocultar todas las secciones primero
      if (vehicleSection) vehicleSection.style.display = 'none';
      if (missingPersonSection) missingPersonSection.style.display = 'none';
      if (suspiciousPersonSection) suspiciousPersonSection.style.display = 'none';
      if (suspiciousVehicleSection) suspiciousVehicleSection.style.display = 'none';
      if (otherSection) otherSection.style.display = 'none';

      // Mostrar la secci√≥n correspondiente
      switch(incidentType) {
        case 'robo-vehiculo':
          if (vehicleSection) vehicleSection.style.display = '';
          break;
        case 'persona-desaparecida':
          if (missingPersonSection) missingPersonSection.style.display = '';
          break;
        case 'persona-sospechosa':
          if (suspiciousPersonSection) suspiciousPersonSection.style.display = '';
          break;
        case 'vehiculo-sospechoso':
          if (suspiciousVehicleSection) suspiciousVehicleSection.style.display = '';
          break;
        case 'otra':
          if (otherSection) otherSection.style.display = '';
          break;
      }
    }

    // Funci√≥n para actualizar el formulario seg√∫n el ticket seleccionado
    function updateTicketForm(ticketId) {
      var formData = ticketFormData[ticketId];
      if (!formData) return;

      // Actualizar header
      var headerEl = byId('formTicketHeader');
      if (headerEl) {
        headerEl.textContent = 'Ticket ' + formData.ticketId + ' ‚Ä¢ ' + formData.date;
      }

      // Actualizar informaci√≥n general
      var incidentIdEl = byId('formIncidentId');
      if (incidentIdEl) incidentIdEl.value = formData.ticketId;

      var alertLevelEl = byId('formAlertLevel');
      if (alertLevelEl) alertLevelEl.value = formData.alertLevel;

      var incidentTypeEl = byId('formIncidentType');
      if (incidentTypeEl) incidentTypeEl.value = formData.incidentType;

      // Actualizar datos del reportante
      var reporterNameEl = byId('formReporterName');
      if (reporterNameEl) reporterNameEl.value = formData.reporter.name || '';

      var reporterDNIEl = byId('formReporterDNI');
      if (reporterDNIEl) reporterDNIEl.value = formData.reporter.dni || '';

      var reporterPhoneEl = byId('formReporterPhone');
      if (reporterPhoneEl) reporterPhoneEl.value = formData.reporter.phone || '';

      var reporterEmailEl = byId('formReporterEmail');
      if (reporterEmailEl) reporterEmailEl.value = formData.reporter.email || '';

      var reporterRelationEl = byId('formReporterRelation');
      if (reporterRelationEl) reporterRelationEl.value = formData.reporter.relation || '';

      // Mostrar/ocultar secciones seg√∫n tipo de incidente
      toggleIncidentTypeSections(formData.incidentType);

      // Llenar datos de robo de veh√≠culo si existe
      if (formData.vehicle && formData.incidentType === 'robo-vehiculo') {
        var vehicleTypeEl = byId('formVehicleType');
        if (vehicleTypeEl) vehicleTypeEl.value = formData.vehicle.type || '';

        var vehicleBrandEl = byId('formVehicleBrand');
        if (vehicleBrandEl) vehicleBrandEl.value = formData.vehicle.brand || '';

        var vehiclePlateEl = byId('formVehiclePlate');
        if (vehiclePlateEl) vehiclePlateEl.value = formData.vehicle.plate || '';

        var vehicleColorEl = byId('formVehicleColor');
        if (vehicleColorEl) vehicleColorEl.value = formData.vehicle.color || '';

        var vehicleYearEl = byId('formVehicleYear');
        if (vehicleYearEl) vehicleYearEl.value = formData.vehicle.year || '';

        var vehicleLocationEl = byId('formVehicleLocation');
        if (vehicleLocationEl) vehicleLocationEl.value = formData.vehicle.location || '';

        var vehicleDateTimeEl = byId('formVehicleDateTime');
        if (vehicleDateTimeEl) vehicleDateTimeEl.value = formData.vehicle.dateTime || '';

        var vehicleGPSEl = byId('formVehicleGPS');
        if (vehicleGPSEl) vehicleGPSEl.value = formData.vehicle.hasGPS || '';
      }

      // Llenar datos de persona sospechosa si existe
      if (formData.suspiciousPerson && formData.incidentType === 'persona-sospechosa') {
        var suspNameEl = byId('formSuspiciousName');
        if (suspNameEl) suspNameEl.value = formData.suspiciousPerson.name || '';

        var suspAliasEl = byId('formSuspiciousAlias');
        if (suspAliasEl) suspAliasEl.value = formData.suspiciousPerson.alias || '';

        var suspDescEl = byId('formSuspiciousDescription');
        if (suspDescEl) suspDescEl.value = formData.suspiciousPerson.description || '';

        var suspReasonEl = byId('formSuspiciousReason');
        if (suspReasonEl) suspReasonEl.value = formData.suspiciousPerson.reason || '';

        var suspLocationEl = byId('formSuspiciousLocation');
        if (suspLocationEl) suspLocationEl.value = formData.suspiciousPerson.lastLocation || '';

        var suspLinkedEl = byId('formSuspiciousLinked');
        if (suspLinkedEl) suspLinkedEl.value = formData.suspiciousPerson.linked || '';
      }

      // Llenar datos de otra incidencia si existe
      if (formData.otherDescription && formData.incidentType === 'otra') {
        var otherDescEl = byId('formOtherDescription');
        if (otherDescEl) otherDescEl.value = formData.otherDescription || '';
      }

      // Actualizar ubicaci√≥n
      var locationAddressEl = byId('formLocationAddress');
      if (locationAddressEl) locationAddressEl.value = formData.location.address || '';

      var locationDistrictEl = byId('formLocationDistrict');
      if (locationDistrictEl) locationDistrictEl.value = formData.location.district || '';

      var locationProvinceEl = byId('formLocationProvince');
      if (locationProvinceEl) locationProvinceEl.value = formData.location.province || '';

      var locationReferenceEl = byId('formLocationReference');
      if (locationReferenceEl) locationReferenceEl.value = formData.location.reference || '';

      var locationCoordsEl = byId('formLocationCoords');
      if (locationCoordsEl) locationCoordsEl.value = formData.location.coords || '';
    }

    // Event listener para cambio de tipo de incidencia en tiempo real
    var incidentTypeSelect = byId('formIncidentType');
    if (incidentTypeSelect) {
      incidentTypeSelect.addEventListener('change', function() {
        toggleIncidentTypeSections(this.value);
      });
    }

    function formatTransportLabel(text) {
      if (!text) return '';
      var upper = text.toString().trim().toUpperCase();
      if (upper.startsWith('A ') || upper.startsWith('EN ')) return upper;
      return 'EN ' + upper;
    }

    function renderIncidentTabs() {
      var container = byId('incidentTabs');
      var countEl = byId('ticketsCount');
      if (!container) return;
      container.innerHTML = '';

      if (countEl) {
        countEl.textContent = incidentTabsData.length + ' ticket' + (incidentTabsData.length !== 1 ? 's' : '');
      }

      incidentTabsData.forEach(function(tab) {
        var button = document.createElement('button');
        button.type = 'button';
        
        // Clases base
        var baseClasses = 'flex-shrink-0 p-4 rounded-lg border-2 transition-all hover:shadow-md min-w-[200px] text-left';
        
        // Clases seg√∫n estado activo/inactivo
        var stateClasses = tab.id === activeIncidentTab 
          ? 'border-orange-500 bg-orange-50 shadow-md' 
          : 'border-gray-200 bg-white hover:border-gray-400';
        
        button.className = baseClasses + ' ' + stateClasses;
        
        // Determinar color del indicador seg√∫n status
        var statusColor = 'bg-green-500'; // default: low
        if (tab.status === 'high') {
          statusColor = 'bg-orange-500';
        } else if (tab.status === 'medium') {
          statusColor = 'bg-yellow-500';
        }
        
        button.innerHTML = 
          '<div class="space-y-2">' +
            '<div class="flex items-center justify-between gap-2">' +
              '<div class="font-bold text-lg text-gray-900">' + tab.id + '</div>' +
              '<div class="w-3 h-3 rounded-full ' + statusColor + '"></div>' +
            '</div>' +
            '<div class="text-sm font-medium text-gray-700 line-clamp-1">' + tab.title + '</div>' +
            '<div class="text-xs text-gray-500">' + tab.date + '</div>' +
          '</div>';
        
        button.addEventListener('click', function() {
          activeIncidentTab = tab.id;
          tab.unread = 0;
          chatAutoScroll = true;
          renderIncidentTabs();
          renderChatTimeline();
          updateTicketForm(tab.id);
        });
        
        container.appendChild(button);
      });
      
      updateChatIncidentContext();
    }
    function updateChatIncidentContext() {
      var ticketIdEl = byId('chatTicketId');
      var agentNameEl = byId('chatAgentName');
      var statusEl = byId('chatTicketStatus');
      
      var active = incidentTabsData.find(function(tab) { 
        return tab.id === activeIncidentTab; 
      });
      
      if (ticketIdEl) ticketIdEl.textContent = active ? active.id : '‚Äî';
      if (agentNameEl) agentNameEl.textContent = 'Agente Rodr√≠guez'; // Puedes hacerlo din√°mico
      if (statusEl) statusEl.textContent = 'En atenci√≥n'; // Puedes hacerlo din√°mico
    }
    function getChatTimelineForIncident(incidentId) {
      if (!chatTimelineByIncident[incidentId]) chatTimelineByIncident[incidentId] = [];
      return chatTimelineByIncident[incidentId];
    }
    function formatChatTime(date) {
      return date.toLocaleTimeString('es-PE', { hour: '2-digit', minute: '2-digit' });
    }
    function buildChatEvent(item) {
      var wrapper = document.createElement('div');
      wrapper.className = 'flex items-start gap-3 p-3 bg-gray-50 border border-dashed border-gray-200 rounded-lg';
      
      wrapper.innerHTML = 
        '<div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-base">' + 
          (item.icon || '‚öôÔ∏è') + 
        '</div>' +
        '<div class="flex-1">' +
          '<div class="font-semibold text-gray-900 text-sm">' + (item.title || 'Evento del sistema') + '</div>' +
          (item.detail ? '<div class="text-sm text-gray-600">' + item.detail + '</div>' : '') +
          '<div class="text-xs text-gray-400 uppercase tracking-wide mt-1">' + (item.timestamp || '') + '</div>' +
        '</div>';
      
      return wrapper;
    }

    function buildChatMessage(item) {
      var wrapper = document.createElement('div');
      var isOperator = item.from === 'operator';
      
      // Contenedor con alineaci√≥n
      wrapper.className = 'flex ' + (isOperator ? 'justify-end' : 'justify-start');
      
      // Clases del mensaje seg√∫n tipo
      var messageClasses = isOperator 
        ? 'bg-orange-500 text-white' 
        : 'bg-gray-100 text-gray-900';
      
      var timeClasses = isOperator 
        ? 'text-orange-200' 
        : 'text-gray-500';
      
      var messageDiv = document.createElement('div');
      messageDiv.className = 'max-w-[75%] rounded-lg p-3 ' + messageClasses;
      
      messageDiv.innerHTML = 
        '<div class="text-sm mb-1">' + (item.text || '') + '</div>' +
        '<div class="text-xs ' + timeClasses + '">' + (item.timestamp || '') + '</div>';
      
      // Attachments si existen
      if (item.attachments && item.attachments.length) {
        var attachmentsDiv = document.createElement('div');
        attachmentsDiv.className = 'flex flex-wrap gap-1 mt-2';
        
        item.attachments.forEach(function(att) {
          var tag = document.createElement('div');
          tag.className = 'text-xs px-2 py-1 rounded border ' + 
            (isOperator ? 'border-orange-300 text-orange-100' : 'border-gray-300 text-gray-600');
          tag.textContent = 'üìé ' + att.name;
          attachmentsDiv.appendChild(tag);
        });
        
        messageDiv.appendChild(attachmentsDiv);
      }
      
      wrapper.appendChild(messageDiv);
      return wrapper;
    }

    function renderChatTimeline() {
      var container = byId('chatTimeline');
      if (!container) return;
      container.innerHTML = '';

      var timeline = getChatTimelineForIncident(activeIncidentTab);
      
      if (!timeline || !timeline.length) {
        container.innerHTML = '<div class="text-center text-gray-500 italic py-4">No hay mensajes a√∫n</div>';
        return;
      }

      timeline.forEach(function(item) {
        if (item.type === 'event') {
          container.appendChild(buildChatEvent(item));
        } else if (item.type === 'message') {
          container.appendChild(buildChatMessage(item));
        }
      });

      // Auto scroll al final
      if (chatAutoScroll && chatStreamEl) {
        chatStreamEl.scrollTop = chatStreamEl.scrollHeight;
      }
    }

    function updateChatKpis() {
      var timeline = getChatTimelineForIncident(activeIncidentTab);
      var totalMensajes = timeline.filter(function (item) { return item.type === 'message'; }).length;
      var totalEventos = timeline.filter(function (item) { return item.type === 'event'; }).length;
      var totalArchivos = timeline.reduce(function (acc, item) {
        return acc + ((item.attachments && item.attachments.length) || 0);
      }, 0);
      if (chatKpiRefs.mensajes) chatKpiRefs.mensajes.textContent = totalMensajes;
      if (chatKpiRefs.eventos) chatKpiRefs.eventos.textContent = totalEventos;
      if (chatKpiRefs.archivos) chatKpiRefs.archivos.textContent = totalArchivos;
      if (chatKpiRefs.agentes) chatKpiRefs.agentes.textContent = assignedAgents.length;
    }
    function addChatEntry(incidentId, entry) {
      var timeline = getChatTimelineForIncident(incidentId);
      timeline.push(entry);
      if (incidentId === activeIncidentTab) {
        renderChatTimeline();
      }
    }
    function addChatMessage(incidentId, message) {
      var timeline = getChatTimelineForIncident(incidentId);
      timeline.push({
        id: 'msg-' + Date.now(),
        type: 'message',
        from: message.from,
        name: message.name,
        text: message.text,
        timestamp: message.timestamp,
        attachments: message.attachments || []
      });
    }
    function addChatEvent(incidentId, event) {
      var timeline = getChatTimelineForIncident(incidentId);
      timeline.push({
        id: 'evt-' + Date.now(),
        type: 'event',
        icon: event.icon,
        title: event.title,
        detail: event.detail,
        timestamp: formatChatTime(new Date())
      });
    }
    function handleChatSend() {
      var input = byId('chatComposerInput');
      if (!input || !input.value.trim()) return;
      
      var text = input.value.trim();
      input.value = '';
      
      addChatMessage(activeIncidentTab, {
        from: 'operator',
        name: 'Operador',
        text: text,
        timestamp: formatChatTime(new Date())
      });
      
      chatAutoScroll = true;
      renderChatTimeline();
    }
    function scheduleAgentResponse(targetIncident) {
      if (!assignedAgents.length) return;
      var replies = [
        'Recibido, seguimos en el punto.',
        'Coordinando con tr√°nsito local.',
        'Atenci√≥n completada, pendientes de nueva indicaci√≥n.'
      ];
      var responder = assignedAgents[Math.floor(Math.random() * assignedAgents.length)];
      setTimeout(function () {
        addChatMessage(targetIncident, {
          from: 'agent',
          name: responder.shortName,
          role: responder.status || 'En campo',
          text: replies[Math.floor(Math.random() * replies.length)]
        });
      }, 1500);
    }

    function renderAssignedAgents() {
      var container = byId('assignedAgentsContainer');
      if (!container) return;
      container.innerHTML = '';
      if (!assignedAgents.length) {
        var empty = document.createElement('div');
        empty.className = 'personas-empty';
        empty.textContent = 'Sin agentes asignados.';
        container.appendChild(empty);
        updateChatKpis();
        return;
      }
      assignedAgents.forEach(function (agent) {
        var tag = document.createElement('div');
        tag.className = 'agent-tag';
        var infoBlock = document.createElement('div');
        infoBlock.className = 'agent-info-block';
        var name = document.createElement('div');
        name.className = 'agent-name';
        name.textContent = agent.shortName;
        var meta = document.createElement('div');
        meta.className = 'agent-meta-chip';
        var transportText = formatTransportLabel(agent.transporte || '');
        var statusText = agent.status ? ' ‚Ä¢ ' + agent.status.toUpperCase() : '';
        meta.textContent = (transportText + statusText).trim();
        infoBlock.appendChild(name);
        if (meta.textContent) infoBlock.appendChild(meta);
        var btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'btn btn-default btn-rounded release-agent-btn';
        btn.textContent = 'Liberar';
        btn.addEventListener('click', function () { releaseAgent(agent.shortName); });
        tag.appendChild(infoBlock);
        tag.appendChild(btn);
        container.appendChild(tag);
      });
      updateChatKpis();
    }

    function releaseAgent(agentName) {
      var idx = assignedAgents.findIndex(function (agent) { return agent.shortName === agentName; });
      if (idx === -1) return;
      var removed = assignedAgents[idx];
      assignedAgents.splice(idx, 1);
      renderAssignedAgents();
      renderAgentList(currentAgentSearchTerm.length > 0, currentAgentSearchTerm);
      addChatEvent(activeIncidentTab, {
        icon: '‚Ü©Ô∏è',
        title: 'Agente liberado',
        detail: (removed ? removed.shortName : agentName) + ' sali√≥ del incidente.'
      });
    }

    let currentAgentSearchTerm = '';
    if (chatSearchInput) {
      chatSearchInput.addEventListener('input', function (evt) {
        chatFilterTerm = evt.target.value || '';
        chatAutoScroll = true;
        renderChatTimeline();
      });
    }
    if (chatSendButton) {
      chatSendButton.addEventListener('click', handleChatSend);
    }
    if (chatComposerInput) {
      chatComposerInput.addEventListener('keydown', function (evt) {
        if (evt.key === 'Enter' && !evt.shiftKey) {
          evt.preventDefault();
          handleChatSend();
        }
      });
    }
    if (chatStreamEl) {
      chatStreamEl.addEventListener('scroll', function () {
        var nearBottom = chatStreamEl.scrollHeight - chatStreamEl.scrollTop - chatStreamEl.clientHeight < 40;
        chatAutoScroll = nearBottom;
        if (chatScrollCta) chatScrollCta.style.display = nearBottom ? 'none' : 'flex';
      });
    }
    if (chatGoBottomBtn) {
      chatGoBottomBtn.addEventListener('click', function () {
        chatAutoScroll = true;
        if (chatStreamEl) chatStreamEl.scrollTo({ top: chatStreamEl.scrollHeight, behavior: 'smooth' });
        if (chatScrollCta) chatScrollCta.style.display = 'none';
      });
    }

    function openAssignAgentModal() {
      var modal = byId('assignAgentModal');
      if (!modal) return;
      currentAgentSearchTerm = '';
      var input = byId('agentSearchInput');
      if (input) input.value = '';
      renderAgentList(false, '');
      modal.classList.add('active');
      setTimeout(function () { if (input) input.focus(); }, 100);
    }

    function closeAssignAgentModal() {
      var modal = byId('assignAgentModal');
      if (modal) modal.classList.remove('active');
    }

    function filterAgents() {
      var input = byId('agentSearchInput');
      currentAgentSearchTerm = input ? input.value.trim() : '';
      var includeOccupied = currentAgentSearchTerm.length > 0;
      renderAgentList(includeOccupied, currentAgentSearchTerm);
    }

    function renderAgentList(includeOccupied, searchTerm) {
      if (includeOccupied === undefined) includeOccupied = false;
      if (searchTerm === undefined) searchTerm = '';
      var container = byId('agentListContainer');
      if (!container) return;
      var agentsToShow = availableAgents.filter(function (agent) {
        return !assignedAgents.some(function (a) { return a.shortName === agent.shortName; });
      });
      if (!includeOccupied && !searchTerm) {
        agentsToShow = agentsToShow.filter(function (agent) { return agent.status === 'Disponible'; });
      }
      if (searchTerm) {
        agentsToShow = agentsToShow.filter(function (agent) {
          return agent.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
            agent.transporte.toLowerCase().includes(searchTerm.toLowerCase());
        });
      }
      agentsToShow.sort(function (a, b) {
        return parseFloat(a.distancia) - parseFloat(b.distancia);
      });
      container.innerHTML = '';
      if (!agentsToShow.length) {
        container.innerHTML = '<div class="no-results">No se encontraron agentes disponibles</div>';
        return;
      }
      agentsToShow.forEach(function (agent) {
        var item = document.createElement('div');
        item.className = 'agent-list-item' + (agent.status === 'Ocupado' ? ' ocupado' : '');
        if (agent.status !== 'Ocupado') {
          item.addEventListener('click', function () { assignAgent(agent); });
        }
        var info = document.createElement('div');
        info.className = 'agent-info';
        var name = document.createElement('div');
        name.className = 'agent-list-name';
        name.textContent = agent.name;
        var role = document.createElement('div');
        role.className = 'agent-list-role';
        role.textContent = formatTransportLabel(agent.transporte || '');
        info.appendChild(name);
        info.appendChild(role);
        if (agent.status === 'Ocupado' && agent.incidenteActual) {
          var tag = document.createElement('div');
          tag.className = 'agent-incident-tag';
          tag.textContent = 'Atendiendo incidente ' + agent.incidenteActual;
          info.appendChild(tag);
        }
        var meta = document.createElement('div');
        meta.style.textAlign = 'right';
        var statusMark = document.createElement('div');
        statusMark.style.fontSize = '1.2rem';
        statusMark.textContent = agent.status === 'Ocupado' ? '‚è∏' : '‚úì';
        if (agent.status === 'Ocupado') statusMark.style.color = '#999';
        var distance = document.createElement('div');
        distance.className = 'agent-distance';
        distance.textContent = 'üìç ' + agent.distancia;
        meta.appendChild(statusMark);
        meta.appendChild(distance);
        item.appendChild(info);
        item.appendChild(meta);
        container.appendChild(item);
      });
    }

    function assignAgent(agent) {
      if (assignedAgents.some(function (a) { return a.shortName === agent.shortName; })) return;
      assignedAgents.push({
        shortName: agent.shortName,
        transporte: agent.transporte,
        status: agent.status
      });
      renderAssignedAgents();
      renderAgentList(currentAgentSearchTerm.length > 0, currentAgentSearchTerm);
      addChatEvent(activeIncidentTab, {
        icon: 'üëÆ',
        title: 'Agente asignado',
        detail: agent.shortName + ' (' + formatTransportLabel(agent.transporte || '') + ') incorporado.'
      });
      closeAssignAgentModal();
    }
    function releaseAllAgents() {
      if (!assignedAgents.length) return;
      var released = assignedAgents.length;
      assignedAgents.length = 0;
      renderAssignedAgents();
      renderAgentList(currentAgentSearchTerm.length > 0, currentAgentSearchTerm);
      addChatEvent(activeIncidentTab, {
        icon: '‚Ü©Ô∏è',
        title: 'Agentes liberados',
        detail: released + ' ' + (released === 1 ? 'agente liberado del incidente.' : 'agentes liberados del incidente.')
      });
    }

    document.addEventListener('click', function (e) {
      if (e.target.classList && e.target.classList.contains('modal-overlay')) {
        closeAssignAgentModal();
      }
    });
    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape') closeAssignAgentModal();
    });
    window.openAssignAgentModal = openAssignAgentModal;
    window.closeAssignAgentModal = closeAssignAgentModal;
    window.filterAgents = filterAgents;
    window.releaseAllAgents = releaseAllAgents;
  })();
</script>
<script>
  (function attachNuevoIncidenteModal() {
    function ensureLeaflet(cb) {
      if (typeof L !== 'undefined') {
        if (cb) cb();
        return;
      }
      var existing = document.querySelector('script[data-leaflet]');
      if (existing) {
        if (cb) existing.addEventListener('load', cb, { once: true });
        return;
      }
      var script = document.createElement('script');
      script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
      script.defer = true;
      script.setAttribute('data-leaflet', '1');
      if (cb) script.addEventListener('load', cb, { once: true });
      document.head.appendChild(script);
    }

    function initNuevoIncidenteMap() {
      var modal = document.getElementById('modalIncidenteNuevo');
      if (!modal) return;
      var mapEl = modal.querySelector('#incn-inline-map');
      if (!mapEl || mapEl.dataset.leaflet === '1') return;
      var hint = modal.querySelector('#incn-map-hint');
      ensureLeaflet(function () {
        try {
          var latInput = modal.querySelector('#incn-lat');
          var lngInput = modal.querySelector('#incn-lng');
          var map = L.map(mapEl, { zoomControl: true, attributionControl: true });
          var center = [-12.1175, -76.9990];
          map.setView(center, 14);
          L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            maxZoom: 20,
            attribution: '&copy; OpenStreetMap contributors &copy; CARTO'
          }).addTo(map);
          var marker;
          function placeMarker(latlng) {
            if (marker) marker.setLatLng(latlng);
            else marker = L.marker(latlng).addTo(map);
            if (latInput) latInput.value = latlng.lat.toFixed(6);
            if (lngInput) lngInput.value = latlng.lng.toFixed(6);
            if (hint) hint.style.display = 'none';
          }
          mapEl.addEventListener('mouseenter', function () { if (hint) hint.style.display = 'none'; }, { once: true });
          map.on('click', function (evt) { placeMarker(evt.latlng); });
          var defaultLatLng = L.latLng(center[0], center[1]);
          marker = L.marker(defaultLatLng).addTo(map).bindPopup('<b>Incidente</b><br>Av. Primavera 123').openPopup();
          if (latInput) latInput.value = defaultLatLng.lat.toFixed(6);
          if (lngInput) lngInput.value = defaultLatLng.lng.toFixed(6);
          setTimeout(function () { map.invalidateSize(); }, 60);
          mapEl.dataset.leaflet = '1';
          mapEl._leafletMap = map;
        } catch (error) {
          console.error('Leaflet init error', error);
        }
      });
    }

    function showNuevoIncidenteModal() {
      var modal = document.getElementById('modalIncidenteNuevo');
      if (!modal) return;
      if (window.$ && typeof window.$('#modalIncidenteNuevo').modal === 'function') {
        window.$('#modalIncidenteNuevo')
          .one('shown.bs.modal', function () { initNuevoIncidenteMap(); })
          .modal('show');
      } else {
        modal.style.display = 'block';
        modal.classList.add('in');
        modal.setAttribute('aria-hidden', 'false');
        setTimeout(initNuevoIncidenteMap, 50);
      }
    }

    function bindNuevoIncidenteButton() {
      var trigger = document.getElementById('addticket');
      if (!trigger || trigger.dataset.niBound === '1') return;
      trigger.dataset.niBound = '1';
      trigger.addEventListener('click', showNuevoIncidenteModal);
    }

    document.addEventListener('DOMContentLoaded', bindNuevoIncidenteButton);
  })();
</script>
<script>
  // Funci√≥n helper (necesaria porque byId est√° en scope privado en otro script)
  function byId(id) { return document.getElementById(id); }

  // Datos de agentes en el mapa
  var mapAgentsData = [
    { id: 'agent-1', name: 'Agente Rodr√≠guez', position: { left: '25%', top: '35%' }, status: 'active' },
    { id: 'agent-2', name: 'Agente Mart√≠nez', position: { left: '55%', top: '65%' }, status: 'active' },
    { id: 'agent-3', name: 'Agente L√≥pez', position: { left: '75%', top: '45%' }, status: 'active' },
  ];

  var mapCamerasData = [
    { id: 'cam-1', name: 'CAM-014', position: { left: '30%', top: '40%' }, status: 'online' },
    { id: 'cam-2', name: 'CAM-021', position: { left: '60%', top: '55%' }, status: 'offline' },
    { id: 'cam-3', name: 'CAM-033', position: { left: '45%', top: '70%' }, status: 'online' },
  ];

  var activeMapTab = 'agents';

  // Inicializar mapa
  function initMap() {
    renderMapGrid();
    renderMapMarkers();
    initMapTabs();
  }

  // Renderizar grid de fondo
  function renderMapGrid() {
    var grid = byId('mapGrid');
    if (!grid) return;
    grid.innerHTML = '';
    
    for (var i = 0; i < 144; i++) {
      var cell = document.createElement('div');
      cell.className = 'border border-gray-200/10';
      grid.appendChild(cell);
    }
  }

  // Renderizar marcadores seg√∫n tab activo
  function renderMapMarkers() {
    var container = byId('mapMarkers');
    if (!container) return;
    container.innerHTML = '';
    
    var data = activeMapTab === 'agents' ? mapAgentsData : mapCamerasData;
    var icon = activeMapTab === 'agents' ? getAgentIcon() : getCameraIcon();
    
    data.forEach(function(item) {
      var marker = document.createElement('div');
      marker.className = 'absolute transform -translate-x-1/2 -translate-y-1/2 cursor-pointer group';
      marker.style.left = item.position.left;
      marker.style.top = item.position.top;
      
      var statusColor = item.status === 'online' || item.status === 'active' 
        ? 'text-orange-500' 
        : 'text-gray-400';
      
      marker.innerHTML = 
        '<div class="relative">' +
          '<div class="' + statusColor + ' drop-shadow-lg group-hover:scale-110 transition-transform">' +
            icon +
          '</div>' +
          '<div class="absolute left-1/2 -translate-x-1/2 top-full mt-1 bg-gray-900 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-10">' +
            item.name +
          '</div>' +
        '</div>';
      
      marker.addEventListener('click', function() {
        onMarkerClick(item);
      });
      
      container.appendChild(marker);
    });
  }

  // Iconos SVG
  function getAgentIcon() {
    return '<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="currentColor" stroke="white" stroke-width="1">' +
      '<path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>' +
      '<circle cx="9" cy="7" r="4"></circle>' +
      '<path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>' +
      '<path d="M16 3.13a4 4 0 0 1 0 7.75"></path>' +
    '</svg>';
  }

  function getCameraIcon() {
    return '<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="currentColor" stroke="white" stroke-width="1">' +
      '<path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"></path>' +
      '<circle cx="12" cy="13" r="3"></circle>' +
    '</svg>';
  }

  // Inicializar tabs
  function initMapTabs() {
    var tabs = document.querySelectorAll('.map-tab');
    
    tabs.forEach(function(tab) {
      tab.addEventListener('click', function() {
        var tabName = this.getAttribute('data-tab');
        setActiveMapTab(tabName);
      });
    });
  }

  // Cambiar tab activo
  function setActiveMapTab(tabName) {
    activeMapTab = tabName;
    
    var tabs = document.querySelectorAll('.map-tab');
    tabs.forEach(function(tab) {
      var isActive = tab.getAttribute('data-tab') === tabName;
      
      if (isActive) {
        tab.classList.add('bg-white', 'text-gray-900', 'shadow-sm');
        tab.classList.remove('text-gray-500');
      } else {
        tab.classList.remove('bg-white', 'text-gray-900', 'shadow-sm');
        tab.classList.add('text-gray-500');
      }
    });
    
    renderMapMarkers();
    updateMapLegend();
  }

  // Actualizar leyenda
  function updateMapLegend() {
    var legendTitle = activeMapTab === 'agents' ? 'Vista de Agentes Activos' : 'Vista de C√°maras';
    var legendEl = document.querySelector('.map-legend-text');
    if (legendEl) {
      legendEl.textContent = legendTitle;
    }
  }

  // Click en marcador
  function onMarkerClick(item) {
    // Aqu√≠ puedes abrir un popup, mostrar info, etc.
  }

  // B√∫squeda en mapa
  function initMapSearch() {
    var input = byId('mapSearchInput');
    var btn = byId('mapSearchBtn');
    
    if (btn) {
      btn.addEventListener('click', function() {
        var query = input ? input.value.trim() : '';
        if (query) {
          searchAddress(query);
        }
      });
    }
    
    if (input) {
      input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          var query = input.value.trim();
          if (query) {
            searchAddress(query);
          }
        }
      });
    }
  }

  function searchAddress(query) {
    // Integrar con geocoding API si es necesario
  }

  // Esperar a que el elemento exista y luego inicializar
  function waitForElement(id, callback) {
    var el = document.getElementById(id);
    if (el) {
      callback();
    } else {
      setTimeout(function() { waitForElement(id, callback); }, 50);
    }
  }

  waitForElement('mapGrid', function() {
    initMap();
    initMapSearch();
  });
</script>