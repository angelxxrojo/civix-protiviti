<!-- SweetAlert2 (requerido por la consola CAD) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Tu app CAD -->

{{styles_operador_tickets}}


<div class="row">
  <div class="col-md-12">
    <div class="">
      <div class="panel-heading">
        <div id="incidentTabs">
        </div>
      </div>

    </div>
  </div>
</div>

<div class="row cad-container">
  <div class="col-md-12">
    <div class="panel" style="margin-bottom: 0;">
      <div class="panel-body">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <h4 class="m-b-none">Registro de Incidencias ‚Äì Seguridad Ciudadana</h4>
          <div>
                <button type="button" id="closeTicketBtn" class="btn btn-w-md btn-accent btn-block" style="margin-top: 5px;"
                  title="Cerrar ticket">
                  <i class="pe-7s-close-circle" aria-hidden="true"></i> Cerrar Ticket
                </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row cad-container">
  <!-- Primera Columna - Formulario -->
  <div class="col-md-4">
    <div class="cad-scrollable" id="ticketFormContainer">
      <!-- Panel: Header Principal -->
      <div class="panel panel-filled mb-2">
        <div class="panel-body">
          <small><h5 id="formTicketHeader">Ticket #3242 ‚Ä¢ 27/11/2025, 7:24:24 a.m.</h5></small>
        </div>
      </div>




      <!-- Panel: Origen de la Incidencia -->
      <div class="panel panel-filled panel-inner-radius mb-2">
        <div class="panel-heading">
          <h5 class="m-b-none">Origen de la Incidencia</h5>
        </div>
        <div class="panel-body">
          <div class="row">
            <div class="col-lg-12">
              <div class="form-group">
                <label>Origen *</label>
                <select id="formOrigin" class="form-control rounded-input">
                  <option value="">Seleccionar origen</option>
                </select>
              </div>
            </div>
          </div>
        </div>
      </div>



      <!-- Panel: Datos del Reportante -->
      <div class="panel panel-filled   panel-inner-radius mb-2">
        <div class="panel-heading">
          <h5 class="m-b-none">Datos del Reportante</h5>
        </div>
        <div class="panel-body">
          <div class="row">
            <div class="col-lg-6">
              <div class="form-group">
                <label>Nombre completo *</label>
                <input type="text" id="formReporterName" class="form-control rounded-input"
                  placeholder="Nombre completo" value="Juan P√©rez Garc√≠a">
              </div>
            </div>
            <div class="col-lg-6">
              <div class="form-group">
                <label>DNI / Identificaci√≥n *</label>
                <input type="text" id="formReporterDNI" class="form-control rounded-input" placeholder="DNI"
                  value="12345678">
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-lg-6">
              <div class="form-group">
                <label>Tel√©fono de contacto *</label>
                <input type="text" id="formReporterPhone" class="form-control rounded-input" placeholder="Tel√©fono"
                  value="55 9876 5432">
              </div>
            </div>
            <div class="col-lg-6">
              <div class="form-group">
                <label>Correo electr√≥nico</label>
                <input type="email" id="formReporterEmail" class="form-control rounded-input"
                  placeholder="correo@ejemplo.com" value="juan@example.com">
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-lg-12">
              <div class="form-group">
                <label>Relaci√≥n con el hecho</label>
                <select id="formReporterRelation" class="form-control rounded-input">
                  <option value="">Seleccionar</option>
                  <option value="victima" selected>V√≠ctima</option>
                  <option value="testigo">Testigo</option>
                  <option value="tercero">Tercero</option>
                </select>
              </div>
            </div>
          </div>
        </div>
      </div>

         <!-- Panel: Ubicaci√≥n del Incidente -->
      <div class="panel panel-filled panel-inner-radius mb-2">
        <div class="panel-heading">
          <h5 class="m-b-none">
            <i class="pe-7s-map-marker" aria-hidden="true"></i> Ubicaci√≥n del Incidente
          </h5>
        </div>
        <div class="panel-body">
          <div class="row">
            <div class="col-lg-12">
              <div class="form-group">
                <label>Direcci√≥n exacta *</label>
                <input type="text" id="formLocationAddress" class="form-control rounded-input"
                  placeholder="Calle, n√∫mero, colonia">
                <p style="font-size: 11px; color: #9ca3af; margin-top: 5px;">üí° Usa el mapa de la derecha para buscar y
                  autocompletar</p>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-lg-6">
              <div class="form-group">
                <label>Distrito *</label>
                <input type="text" id="formLocationDistrict" class="form-control rounded-input" placeholder="Distrito">
              </div>
            </div>
            <div class="col-lg-6">
              <div class="form-group">
                <label>Provincia *</label>
                <input type="text" id="formLocationProvince" class="form-control rounded-input" placeholder="Provincia">
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-lg-12">
              <div class="form-group">
                <label>Referencia</label>
                <input type="text" id="formLocationReference" class="form-control rounded-input"
                  placeholder="Frente a..., cerca de...">
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-lg-12">
              <div class="form-group">
                <label>Coordenadas GPS</label>
                <input type="text" id="formLocationCoordinates" class="form-control rounded-input"
                  placeholder="Auto-detectado o manual" readonly style="background: #2a2a2a;">
              </div>
            </div>
          </div>


        </div>
      </div>

    <!-- Descripci√≥n de la Incidencia -->
      <div class="panel panel-filled panel-inner-radius mb-2">
      <div class="panel-heading">
        <h5 class="m-b-none">
          <i class="pe-7s-map-marker" aria-hidden="true"></i>Descripci√≥n de la incidencia
        </h5>
      </div>
      <div class="panel-body">
        <textarea id="formDescription" class="form-control rounded-input" rows="3"
          placeholder="Describe brevemente la incidencia..."></textarea>
      </div>
                 </div>

      <!-- Panel: Tipo de Incidencia -->
      <div class="panel panel-filled  panel-inner-radius mb-2">
        <div class="panel-heading">
          <h5 class="m-b-none">Tipo de Incidencia</h5>
        </div>
        <div class="panel-body">

          <!-- Selector inteligente de incidencia -->
          <div class="form-group">
            <label>Tipo de Incidencia *</label>
            <div style="display: flex; gap: 8px;">
              <input type="text"
                     id="incidenceTypeDisplay"
                     class="form-control rounded-input"
                     readonly
                     placeholder="Haz clic en 'Seleccionar' para elegir"
                     style="background: #2a2a2a; flex: 1;">
              <button type="button"
                      class="btn btn-accent"
                      data-toggle="modal"
                      data-target="#incidenceTypeModal"
                      style="white-space: nowrap;">
                <i class="pe-7s-search" aria-hidden="true"></i> Seleccionar
              </button>
            </div>
          </div>

          <!-- Campos ocultos para mantener compatibilidad -->
          <div style="display: none;">
            <select id="formUnit"><option value=""></option></select>
            <select id="formClassification"><option value=""></option></select>
            <select id="formIncidentType"><option value=""></option></select>
            <select id="formIncidentSubtype"><option value=""></option></select>
          </div>


        </div>
      </div>

      
      <div class="panel panel-filled panel-inner-radius mb-2">
        <div class="panel-heading">
          <h5 class="m-b-none">Datos complementarios</h5>
        </div>
        <div class="panel-body">
          <div class="row">
            <div class="col-lg-6">
              <button type="button"
                      class="btn btn-accent btn-block"
                      data-toggle="modal"
                      data-target="#modal-persona-desaparecida"
                      style="padding: 12px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                <i class="pe-7s-user" style="font-size: 18px;"></i>
                <span>Registrar Persona Desaparecida</span>
              </button>
            </div>
            <div class="col-lg-6">
              <button type="button"
                      class="btn btn-accent btn-block"
                      data-toggle="modal"
                      data-target="#modal-vehiculo-robado"
                      style="padding: 12px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                <i class="pe-7s-car" style="font-size: 18px;"></i>
                <span>Registrar Veh√≠culo Robado</span>
              </button>
            </div>
          </div>
          <p style="font-size: 11px; color: #9ca3af; margin-top: 8px; text-align: center;">
            üí° Registre personas desaparecidas o veh√≠culos robados sin salir del ticket actual
          </p>
        </div>
      </div>

      <div class="panel panel-filled panel-inner-radius mb-2">
         <div class="panel-heading">
            Persona Involucrada
         </div>
         <div class="panel-body">
            Foto
         </div>
      </div>
        
          
          
          
      <!-- Card: Persona Desaparecida (Din√°mico seg√∫n tipo) -->
      <div class="panel panel-filled panel-inner-radius mb-2" id="formMissingPersonSection" style="display: none;">
        <div class="panel-heading">
          <h5 class="m-b-none">Datos de la Persona Desaparecida</h5>
        </div>
        <div class="panel-body">
          <div class="row">
            <div class="col-lg-6">
              <div class="form-group">
                <label>Nombre completo</label>
                <input type="text" id="formMissingName" class="form-control rounded-input"
                  placeholder="Nombre completo">
              </div>
            </div>
            <div class="col-lg-6">
              <div class="form-group">
                <label>Edad</label>
                <input type="text" id="formMissingAge" class="form-control rounded-input" placeholder="Edad">
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-lg-6">
              <div class="form-group">
                <label>G√©nero</label>
                <select id="formMissingGender" class="form-control rounded-input">
                  <option value="">Seleccionar</option>
                  <option value="masculino">Masculino</option>
                  <option value="femenino">Femenino</option>
                  <option value="otro">Otro</option>
                </select>
              </div>
            </div>
            <div class="col-lg-6">
              <div class="form-group">
                <label>DNI</label>
                <input type="text" id="formMissingDNI" class="form-control rounded-input" placeholder="DNI">
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-lg-12">
              <div class="form-group">
                <label>Fecha y hora vista por √∫ltima vez</label>
                <input type="datetime-local" id="formMissingLastSeen" class="form-control rounded-input">
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-lg-12">
              <div class="form-group">
                <label>Lugar donde fue vista por √∫ltima vez</label>
                <input type="text" id="formMissingLastLocation" class="form-control rounded-input"
                  placeholder="Ubicaci√≥n">
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-lg-12">
              <div class="form-group">
                <label>Descripci√≥n de la persona</label>
                <textarea id="formMissingDescription" class="form-control rounded-input"
                  placeholder="Incluya vestimenta, se√±ales particulares, tatuajes, cicatrices, etc."
                  rows="4"></textarea>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-lg-12">
              <div class="form-group">
                <label>¬øTiene problemas m√©dicos o cognitivos?</label>
                <select id="formMissingMedical" class="form-control rounded-input">
                  <option value="">Seleccionar</option>
                  <option value="si">S√≠</option>
                  <option value="no">No</option>
                  <option value="desconoce">Desconoce</option>
                </select>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Card: Persona Sospechosa (Din√°mico seg√∫n tipo) -->
      <div class="panel panel-filled panel-inner-radius mb-2" id="formSuspiciousPersonSection" style="display: none;">
        <div class="panel-heading">
          <h5 class="m-b-none">Datos de la Persona Sospechosa</h5>
        </div>
        <div class="panel-body">
          <div class="row">
            <div class="col-lg-6">
              <div class="form-group">
                <label>Nombre (opcional)</label>
                <input type="text" id="formSuspiciousName" class="form-control rounded-input"
                  placeholder="Si se conoce">
              </div>
            </div>
            <div class="col-lg-6">
              <div class="form-group">
                <label>Alias (opcional)</label>
                <input type="text" id="formSuspiciousAlias" class="form-control rounded-input"
                  placeholder="Apodo o alias">
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-lg-12">
              <div class="form-group">
                <label>Descripci√≥n f√≠sica</label>
                <textarea id="formSuspiciousDescription" class="form-control rounded-input"
                  placeholder="Estatura, complexi√≥n, rasgos distintivos..." rows="3"></textarea>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-lg-12">
              <div class="form-group">
                <label>Motivo de sospecha</label>
                <textarea id="formSuspiciousReason" class="form-control rounded-input"
                  placeholder="¬øPor qu√© es sospechosa?" rows="3"></textarea>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-lg-12">
              <div class="form-group">
                <label>√öltimo lugar visto</label>
                <input type="text" id="formSuspiciousLocation" class="form-control rounded-input"
                  placeholder="Ubicaci√≥n">
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-lg-12">
              <div class="form-group">
                <label>¬øVinculado con hechos anteriores?</label>
                <select id="formSuspiciousLinked" class="form-control rounded-input">
                  <option value="">Seleccionar</option>
                  <option value="si">S√≠</option>
                  <option value="no">No</option>
                  <option value="desconoce">Desconoce</option>
                </select>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Card: Veh√≠culo Sospechoso (Din√°mico seg√∫n tipo) -->
      <div class="panel panel-filled panel-inner-radius mb-2" id="formSuspiciousVehicleSection" style="display: none;">
        <div class="panel-heading">
          <h5 class="m-b-none">Datos del Veh√≠culo Sospechoso</h5>
        </div>
        <div class="panel-body">
          <div class="row">
            <div class="col-lg-12">
              <div class="form-group">
                <label>Placa (opcional)</label>
                <input type="text" id="formSuspVehiclePlate" class="form-control rounded-input"
                  placeholder="Si es visible">
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-lg-6">
              <div class="form-group">
                <label>Tipo de veh√≠culo</label>
                <input type="text" id="formSuspVehicleType" class="form-control rounded-input"
                  placeholder="Auto, camioneta, etc.">
              </div>
            </div>
            <div class="col-lg-6">
              <div class="form-group">
                <label>Color</label>
                <input type="text" id="formSuspVehicleColor" class="form-control rounded-input" placeholder="Color">
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-lg-12">
              <div class="form-group">
                <label>Detalles distintivos</label>
                <textarea id="formSuspVehicleDetails" class="form-control rounded-input"
                  placeholder="Calcoman√≠as, da√±os, caracter√≠sticas especiales..." rows="3"></textarea>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-lg-12">
              <div class="form-group">
                <label>Lugar donde fue visto</label>
                <input type="text" id="formSuspVehicleLocation" class="form-control rounded-input"
                  placeholder="Ubicaci√≥n">
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-lg-12">
              <div class="form-group">
                <label>Hora de registro</label>
                <input type="time" id="formSuspVehicleTime" class="form-control rounded-input">
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-lg-12">
              <div class="form-group">
                <label>Comportamiento sospechoso</label>
                <textarea id="formSuspVehicleBehavior" class="form-control rounded-input"
                  placeholder="¬øQu√© hace que sea sospechoso?" rows="3"></textarea>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Card: Datos del Robo de Veh√≠culo (Din√°mico seg√∫n tipo) -->
      <div class="panel panel-filled panel-inner-radius mb-2" id="formVehicleSection" style="display: none;">
        <div class="panel-heading">
          <h5 class="m-b-none">Datos del Robo de Veh√≠culo</h5>
        </div>
        <div class="panel-body">
          <div class="row">
            <div class="col-lg-6">
              <div class="form-group">
                <label>Tipo de veh√≠culo</label>
                <select id="formVehicleType" class="form-control rounded-input">
                  <option value="">Seleccionar</option>
                  <option value="auto">Autom√≥vil</option>
                  <option value="moto">Motocicleta</option>
                  <option value="camioneta">Camioneta</option>
                  <option value="otro">Otro</option>
                </select>
              </div>
            </div>
            <div class="col-lg-6">
              <div class="form-group">
                <label>Marca / Modelo</label>
                <input type="text" id="formVehicleBrand" class="form-control rounded-input"
                  placeholder="Ej: Toyota Corolla">
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-lg-4">
              <div class="form-group">
                <label>Placa</label>
                <input type="text" id="formVehiclePlate" class="form-control rounded-input" placeholder="ABC-123">
              </div>
            </div>
            <div class="col-lg-4">
              <div class="form-group">
                <label>Color</label>
                <input type="text" id="formVehicleColor" class="form-control rounded-input" placeholder="Color">
              </div>
            </div>
            <div class="col-lg-4">
              <div class="form-group">
                <label>A√±o</label>
                <input type="text" id="formVehicleYear" class="form-control rounded-input" placeholder="2020">
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-lg-12">
              <div class="form-group">
                <label>Lugar del robo</label>
                <input type="text" id="formVehicleLocation" class="form-control rounded-input"
                  placeholder="Ubicaci√≥n exacta">
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-lg-12">
              <div class="form-group">
                <label>Fecha y hora del robo</label>
                <input type="datetime-local" id="formVehicleDateTime" class="form-control rounded-input">
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-lg-12">
              <div class="form-group">
                <label>¬øTiene GPS?</label>
                <select id="formVehicleGPS" class="form-control rounded-input">
                  <option value="">Seleccionar</option>
                  <option value="si">S√≠</option>
                  <option value="no">No</option>
                  <option value="desconoce">Desconoce</option>
                </select>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Panel: Informaci√≥n General del Reporte -->
      <div class="panel panel-filled panel-inner-radius mb-2">
        <div class="panel-heading">
          <h5 class="m-b-none">Informaci√≥n General del Reporte</h5>
        </div>
        <div class="panel-body">
          <div class="row">
            <div class="col-lg-6">
              <div class="form-group">
                <label>ID de la Incidencia</label>
                <input type="text" id="formIncidentId" class="form-control rounded-input bg-dark" readonly
                  value="#3242">
              </div>
            </div>
            <div class="col-lg-6">
              <div class="form-group">
                <label>Nivel de Alerta</label>
                <select id="formAlertLevel" class="form-control rounded-input">
                  <option value="critica"> <span class="dot away"></span> Cr√≠tica</option>
                  <option value="alta">Alta</option>
                  <option value="media">Media</option>
                  <option value="baja">Baja</option>
                </select>
              </div>
            </div>
          </div>
        </div>
      </div>

   
      <!-- Bot√≥n Guardar - OCULTO (Autoguardado autom√°tico) -->
      <div class="panel panel-filled panel-inner-radius mb-2" style="display: none;">
        <div class="panel-body" style="text-align: center;">
          <button type="button" id="saveTicketBtn" class="btn btn-accent"
            style="width: 100%; padding: 12px; font-size: 15px; font-weight: 600;">
            <i class="pe-7s-diskette" aria-hidden="true"></i> Guardar Cambios del Ticket
          </button>
        </div>
      </div>

      <!-- Panel: Agentes Asignados a este Ticket -->
      <div class="panel panel-filled panel-inner-radius mb-2">
        <div class="panel-heading">
          <h5 class="m-b-none">Agentes Asignados a este Ticket</h5>
        </div>
        <div class="panel-body" style="padding: 0;">
          <div id="ticketAssignedAgentsList" style="max-height: 300px; overflow-y: auto;">
            <!-- Los agentes asignados a ESTE ticket se renderizar√°n aqu√≠ -->
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- COLUMNA 2: Chat del Ticket -->
  <div class="col-md-4">
    <div class="panel panel-filled  " style="display: flex; flex-direction: column; height: calc(100vh - 200px);">

      <!-- Header del Chat -->
      <div class="panel-heading">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
          <div>
            <h5 class="m-b-none">Chat del ticket</h5>
            <div style="font-size: 12px; margin-top: 8px;">
              <div>Ticket: <strong id="chatTicketId">#3242</strong></div>
              <div>Agente: <strong id="chatAgentName">Agente Rodr√≠guez</strong></div>
              <div>Estado: <span style="color: #f67200;" id="chatTicketStatus">En atenci√≥n</span></div>
            </div>
          </div>
        </div>
      </div>

      <!-- √Årea de mensajes -->
      <div class="panel-body cad-scrollable" style="flex: 1; background: #111111; padding: 16px 12px;">
        <div id="chatTimeline" style="display: flex; flex-direction: column;">
          <!-- Los mensajes se renderizan aqu√≠ con JS -->
        </div>
      </div>

      <!-- Input de mensaje -->
      <div class="panel-footer" style="background: #252525; border-top: 1px solid #374151; padding: 12px;">
        <div style="display: flex; gap: 8px; align-items: center;">
          <button type="button" id="generateTelegramBtn" onclick="fillTelegramMessage()" class="btn"
            title="Generar mensaje de emergencia para Telegram"
            style="border-radius: 50%; width: 42px; height: 42px; padding: 0; display: flex; align-items: center; justify-content: center; background: #0088cc; color: white; border: none; transition: all 0.2s;"
            onmouseover="this.style.background='#006699'; this.style.transform='scale(1.05)'"
            onmouseout="this.style.background='#0088cc'; this.style.transform='scale(1)'">
            <span style="font-size: 18px;">üì±</span>
          </button>
          <textarea id="chatComposerInput" class="form-control" placeholder="Escribe un mensaje o genera uno de emergencia con üì±"
            style="flex: 1; background: #1a1a1a; border: 1px solid #374151; color: #fff; border-radius: 12px; padding: 10px 16px; resize: none; min-height: 42px; max-height: 120px; font-family: inherit; line-height: 1.4;"
            rows="1"></textarea>
          <button type="button" id="chatSendButton" class="btn btn-accent"
            style="border-radius: 50%; width: 42px; height: 42px; padding: 0; display: flex; align-items: center; justify-content: center;">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path
                d="M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z">
              </path>
              <path d="m21.854 2.147-10.94 10.939"></path>
            </svg>
          </button>
        </div>
      </div>

    </div>
  </div>

  <!-- COLUMNA 3: Mapa Interactivo -->
  <div class="col-md-4">
    <div class="panel panel-filled  " style="display: flex; flex-direction: column; height: calc(100vh - 200px);">
      <!-- Header del Mapa -->
      <div class="panel-heading">
        <h5 class="m-b-none" id="mapTitle">Mapa Interactivo</h5>
        <div style="display: flex; gap: 8px; margin-top: 10px;">
          <input type="text" id="mapSearchInput" class="form-control rounded-input" placeholder="Buscar direcci√≥n..."
            style="flex: 1;">
          <button type="button" id="mapSearchBtn" class="btn btn-accent btn-rounded" style="width: 40px; padding: 8px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.3-4.3"></path>
            </svg>
          </button>
        </div>
      </div>

      <!-- Tabs: Agentes / C√°maras -->
      <div style="padding: 10px; border-bottom: 1px solid #3d404c;">
        <div
          style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; background: #1a1a1a; padding: 4px; border-radius: 8px;"
          id="mapTabs">
          <button type="button" data-tab="agents" class="map-tab active"
            style="display: flex; align-items: center; justify-content: center; gap: 6px; padding: 8px; font-size: 13px; border-radius: 6px; background: #252525; border: none; cursor: pointer;">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
              <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
            <span>Agentes</span>
          </button>
          <button type="button" data-tab="cameras" class="map-tab"
            style="display: flex; align-items: center; justify-content: center; gap: 6px; padding: 8px; font-size: 13px; border-radius: 6px; background: transparent; border: none; cursor: pointer; opacity: 0.6;">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z">
              </path>
              <circle cx="12" cy="13" r="3"></circle>
            </svg>
            <span>C√°maras</span>
          </button>
        </div>
      </div>

      <!-- √Årea del Mapa -->
      <div class="panel-body map-panel-body" style="position: relative;">
        <div id="mapCAD"></div>

        <!-- ‚úÖ Control de Filtro Flotante dentro del Mapa -->
        <div id="mapFilterControl" style="position: absolute; top: 10px; right: 10px; z-index: 1000;">
          <!-- Bot√≥n del Dropdown -->
          <button id="filterToggleBtn" style="
            background: rgba(26, 26, 26, 0.95);
            border: 2px solid #3d404c;
            border-radius: 8px;
            padding: 10px 16px;
            color: #e5e7eb;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            transition: all 0.2s;
          " onmouseover="this.style.background='rgba(45, 45, 45, 0.95)'" onmouseout="this.style.background='rgba(26, 26, 26, 0.95)'">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="4" y1="21" x2="4" y2="14"></line>
              <line x1="4" y1="10" x2="4" y2="3"></line>
              <line x1="12" y1="21" x2="12" y2="12"></line>
              <line x1="12" y1="8" x2="12" y2="3"></line>
              <line x1="20" y1="21" x2="20" y2="16"></line>
              <line x1="20" y1="12" x2="20" y2="3"></line>
              <line x1="1" y1="14" x2="7" y2="14"></line>
              <line x1="9" y1="8" x2="15" y2="8"></line>
              <line x1="17" y1="16" x2="23" y2="16"></line>
            </svg>
            <span>Filtros</span>
            <svg id="filterArrow" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="transition: transform 0.2s;">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </button>

          <!-- Men√∫ Dropdown -->
          <div id="filterDropdown" style="
            display: none;
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: rgba(26, 26, 26, 0.98);
            border: 2px solid #3d404c;
            border-radius: 8px;
            padding: 12px;
            min-width: 240px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
          ">
            <!-- Secci√≥n: Filtro de Agentes -->
            <div id="filterAgentsSection">
              <div style="color: #9ca3af; font-size: 11px; font-weight: 600; text-transform: uppercase; margin-bottom: 12px; letter-spacing: 0.5px;">
                Mostrar Agentes
              </div>

              <!-- Opci√≥n: Todos -->
              <label style="display: flex; align-items: center; gap: 10px; padding: 8px 6px; cursor: pointer; border-radius: 4px; transition: background 0.2s; margin: 0;" onmouseover="this.style.background='rgba(55, 55, 55, 0.5)'" onmouseout="this.style.background='transparent'">
                <input type="checkbox" id="filterAll" style="width: 18px; height: 18px; accent-color: #3b82f6; cursor: pointer;">
                <span style="color: #e5e7eb; font-size: 14px; user-select: none;">‚ú® Todos los agentes</span>
              </label>

              <!-- Opci√≥n: Disponibles -->
              <label style="display: flex; align-items: center; gap: 10px; padding: 8px 6px; cursor: pointer; border-radius: 4px; transition: background 0.2s; margin: 0;" onmouseover="this.style.background='rgba(55, 55, 55, 0.5)'" onmouseout="this.style.background='transparent'">
                <input type="checkbox" id="filterAvailable" checked style="width: 18px; height: 18px; accent-color: #22c55e; cursor: pointer;">
                <span style="color: #e5e7eb; font-size: 14px; user-select: none;">üü¢ Disponibles</span>
              </label>

              <!-- Opci√≥n: Ocupados -->
              <label style="display: flex; align-items: center; gap: 10px; padding: 8px 6px; cursor: pointer; border-radius: 4px; transition: background 0.2s; margin: 0;" onmouseover="this.style.background='rgba(55, 55, 55, 0.5)'" onmouseout="this.style.background='transparent'">
                <input type="checkbox" id="filterBusy" checked style="width: 18px; height: 18px; accent-color: #f59e0b; cursor: pointer;">
                <span style="color: #e5e7eb; font-size: 14px; user-select: none;">üü° Ocupados</span>
              </label>
            </div>

            <!-- Secci√≥n: Filtro de Radio de C√°maras -->
            <div id="filterCamerasSection" style="display: none; border-top: 1px solid #3d404c; margin-top: 12px; padding-top: 12px;">
              <div style="color: #9ca3af; font-size: 11px; font-weight: 600; text-transform: uppercase; margin-bottom: 12px; letter-spacing: 0.5px;">
                üìπ Radio de C√°maras
              </div>

              <div style="margin-bottom: 12px;">
                <select id="cameraDistanceSelect" onchange="setCameraDistanceFilter(this.value)" style="
                  width: 100%;
                  background: rgba(45, 45, 45, 0.8);
                  border: 1px solid #3d404c;
                  border-radius: 6px;
                  padding: 8px 12px;
                  color: #e5e7eb;
                  font-size: 14px;
                  cursor: pointer;
                  outline: none;
                ">
                  <option value="100">üìç 100 metros</option>
                  <option value="200">üìç 200 metros</option>
                  <option value="300" selected>üìç 300 metros</option>
                  <option value="500">üìç 500 metros</option>
                  <option value="1000">üìç 1 kil√≥metro</option>
                  <option value="2000">üìç 2 kil√≥metros</option>
                  <option value="0">üìç Todas las c√°maras</option>
                </select>
              </div>

              <!-- Contador de c√°maras -->
              <div style="
                background: rgba(59, 130, 246, 0.1);
                border: 1px solid rgba(59, 130, 246, 0.3);
                border-radius: 6px;
                padding: 8px 12px;
                text-align: center;
              ">
                <div style="color: #9ca3af; font-size: 11px; margin-bottom: 4px;">C√°maras visibles</div>
                <div id="cameraCounter" style="color: #3b82f6; font-size: 16px; font-weight: 700;">0 / 0</div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<div class="row">
  <div class="col-md-4">

  </div>
  <div class="col-md-4">

  </div>
  <div class="col-md-4">

  </div>
</div>

<!-- Modal para asignar agente -->
<div class="modal fade" id="assignAgentModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header text-left">
        <h4 class="modal-title mb-0">Asignar Agente al Incidente</h4>
        <h7 class="mb-0" id="assignModalTicketInfo">Seleccione un agente disponible</h7>
      </div>

      <div class="modal-body">
        <div class="row">
          <div class="col-lg-12">
            <div class="panel panel-filled panel-c-accent" style="border-radius: 15px">
              <div class="panel-heading">
                <h5>B√öSQUEDA DE AGENTES</h5>
              </div>
              <div class="panel-body">
                <div class="form-group">
                  <input type="text" id="agentSearchInput" class="form-control"
                    placeholder="Buscar agente por nombre o transporte..." oninput="filterAgents()" />
                </div>
              </div>
            </div>

            <div class="panel panel-filled panel-c-accent" style="border-radius: 15px; margin-top: 15px;">
              <div class="panel-heading">
                <h5>AGENTES DISPONIBLES</h5>
              </div>
              <div class="panel-body" style="max-height: 400px; overflow-y: auto;">
                <div id="agentListContainer"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-default btn-rounded" data-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de confirmaci√≥n para crear ticket -->
<div class="modal fade" id="newTicketModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header text-left">
        <h4 class="modal-title mb-0">Crear Nuevo Ticket</h4>
        <h7 class="mb-0">¬øEst√° seguro que desea crear un nuevo ticket?</h7>
      </div>

      <div class="modal-body">
        <div class="row">
          <div class="col-lg-12">
            <div class="panel panel-filled panel-c-accent" style="border-radius: 15px">
              <div class="panel-body text-center" style="padding: 40px;">
                <i class="pe-7s-note2" style="font-size: 64px; color: #f67200;"></i>
                <h4 style="margin-top: 20px; margin-bottom: 15px;">Crear Nuevo Ticket de Incidente</h4>
                <p style="color: #9ca3af; font-size: 14px;">
                  Se crear√° un nuevo ticket que podr√° ser editado y asignado a un agente.<br>
                  El ticket quedar√° registrado en el sistema.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-default btn-rounded" data-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-accent btn-rounded" onclick="confirmCreateTicket()">Crear Ticket</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de confirmaci√≥n para cerrar ticket -->
<div class="modal fade" id="closeTicketModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header text-left">
        <h4 class="modal-title mb-0">Cerrar Ticket</h4>
        <h7 class="mb-0" id="closeTicketModalInfo">Ticket #000</h7>
      </div>

      <div class="modal-body">
        <div class="row">
          <div class="col-lg-12">
            <div class="panel panel-filled panel-c-accent" style="border-radius: 15px">
              <div class="panel-heading">
                <h5>MOTIVO DE CIERRE</h5>
              </div>
              <div class="panel-body">
                <!-- Opci√≥n: ¬øCambiar tipo de incidencia? -->
                <div class="form-group">
                  <label style="font-weight: 600; margin-bottom: 10px;">¬øEl tipo de incidencia es correcto?</label>
                  <div style="margin-bottom: 15px;">
                    <label class="radio-inline" style="margin-right: 20px; cursor: pointer;">
                      <input type="radio" name="closeIncidenceAction" value="keep" checked
                             onchange="toggleIncidenceTypeChange()">
                      <span style="margin-left: 5px;">S√≠, cerrar con tipo actual</span>
                    </label>
                    <label class="radio-inline" style="cursor: pointer;">
                      <input type="radio" name="closeIncidenceAction" value="change"
                             onchange="toggleIncidenceTypeChange()">
                      <span style="margin-left: 5px;">No, cambiar tipo de incidencia</span>
                    </label>
                  </div>
                </div>

                <!-- Mostrar tipo actual -->
                <div style="background: #f5f5f5; padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                  <p style="margin-bottom: 8px; color: #666; font-size: 13px;">
                    <i class="pe-7s-note2"></i> Tipo de incidencia <span id="closeIncidenceStatusLabel">actual</span>:
                  </p>
                  <div id="closeTicketCurrentIncidenceType" style="font-weight: 500;">
                    <span id="closeTicketIncidencePath">Cargando...</span>
                  </div>
                </div>

                <!-- Bot√≥n para cambiar (solo visible cuando se selecciona "cambiar") -->
                <div id="changeIncidenceButtonContainer" style="display: none; margin-bottom: 20px;">
                  <button type="button"
                          class="btn btn-accent btn-rounded"
                          onclick="openIncidenceTypeSelectorForClose()"
                          style="width: 100%;">
                    <i class="pe-7s-refresh"></i> Seleccionar Nuevo Tipo de Incidencia
                  </button>
                </div>

                <!-- Hidden fields para almacenar el nuevo tipo -->
                <input type="hidden" id="closeTicketNewUnitId">
                <input type="hidden" id="closeTicketNewClassificationId">
                <input type="hidden" id="closeTicketNewTypeId">
                <input type="hidden" id="closeTicketNewSubtypeId">

                <!-- Separador visual -->
                <hr style="margin: 20px 0; border-top: 1px solid #e0e0e0;">

                <!-- Motivo de cierre -->
                <div class="form-group">
                  <label>Motivo *</label>
                  <select id="closeTicketReason" class="form-control">
                    <option value="">Seleccione motivo</option>
                    <option value="resuelto">Incidente Resuelto</option>
                    <option value="falsa-alarma">Falsa Alarma</option>
                    <option value="duplicado">Ticket Duplicado</option>
                    <option value="sin-respuesta">Sin Respuesta del Reportante</option>
                    <option value="derivado">Derivado a Otra Autoridad</option>
                    <option value="otro">Otro</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Observaciones *</label>
                  <textarea id="closeTicketObservations" class="form-control" rows="5"
                    placeholder="Describa el motivo del cierre y las acciones tomadas..."
                    style="resize: none;"></textarea>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-default btn-rounded" data-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-danger btn-rounded" onclick="confirmCloseTicket()">Cerrar Ticket</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Selector Inteligente de Incidencia -->
<!-- NOTA: El modal se carga desde fragments/scripts/selector_incidencia.html -->

<script>
  // ============================================
  // MAPA INTERACTIVO CON AGENTES
  // ============================================

  var cadMap = null;
  var agentMarkers = [];
  var currentLocationMarker = null;

  // Pool de nombres de agentes para generar aleatoriamente
  var agentNamesPool = [
    { name: 'Agente Ram√≠rez', shortName: 'A. Ram√≠rez' },
    { name: 'Agente Vega', shortName: 'C. Vega' },
    { name: 'Agente Su√°rez', shortName: 'D. Su√°rez' },
    { name: 'Agente Torres', shortName: 'E. Torres' },
    { name: 'Agente L√≥pez', shortName: 'F. L√≥pez' },
    { name: 'Agente Garc√≠a', shortName: 'G. Garc√≠a' },
    { name: 'Agente Mart√≠nez', shortName: 'H. Mart√≠nez' },
    { name: 'Agente Fern√°ndez', shortName: 'I. Fern√°ndez' },
    { name: 'Agente Castro', shortName: 'J. Castro' },
    { name: 'Agente Rojas', shortName: 'K. Rojas' },
    { name: 'Agente Mendoza', shortName: 'L. Mendoza' },
    { name: 'Agente Silva', shortName: 'M. Silva' },
    { name: 'Agente Vargas', shortName: 'N. Vargas' },
    { name: 'Agente Morales', shortName: 'O. Morales' },
    { name: 'Agente Reyes', shortName: 'P. Reyes' }
  ];

  var transportTypes = ['Camioneta', 'Motocicleta', 'Bicicleta', 'A pie'];

  // Lista din√°mica de agentes (se regenera seg√∫n la ubicaci√≥n del incidente)
  var agentsData = [];

  // Pool de ubicaciones de c√°maras de seguridad
  var cameraLocations = [
    { name: 'C√°mara Av. Arequipa 1234', coords: [-12.0850, -77.0350] },
    { name: 'C√°mara Jr. Lampa 567', coords: [-12.0470, -77.0300] },
    { name: 'C√°mara Av. Brasil 890', coords: [-12.0650, -77.0500] },
    { name: 'C√°mara Jr. Ucayali 234', coords: [-12.0560, -77.0280] },
    { name: 'C√°mara Av. Tacna 789', coords: [-12.0750, -77.0420] },
    { name: 'C√°mara Av. Abancay 456', coords: [-12.0580, -77.0310] },
    { name: 'C√°mara Jr. Carabaya 123', coords: [-12.0450, -77.0290] },
    { name: 'C√°mara Av. Grau 890', coords: [-12.0520, -77.0410] },
    { name: 'C√°mara Jr. Ancash 345', coords: [-12.0490, -77.0320] },
    { name: 'C√°mara Av. Colonial 678', coords: [-12.0620, -77.0460] },
    { name: 'C√°mara Jr. Huallaga 901', coords: [-12.0540, -77.0295] },
    { name: 'C√°mara Av. Venezuela 234', coords: [-12.0680, -77.0380] }
  ];

  var cameraMarkers = [];
  var detectedPlateData = {}; // Almacena qu√© placas fueron detectadas por qu√© c√°maras

  // Initialize Leaflet map for the operator chat view
  document.addEventListener('DOMContentLoaded', function () {
    var el = document.getElementById('mapCAD');

    // Validar que el elemento existe y es un nodo v√°lido
    if (!el) {
      console.warn('‚ö†Ô∏è Elemento mapCAD no encontrado');
      return;
    }

    if (!(el instanceof Node)) {
      console.error('‚ùå mapCAD no es un nodo v√°lido');
      return;
    }

    if (typeof L === 'undefined') {
      console.warn('‚ö†Ô∏è Librer√≠a Leaflet no est√° cargada');
      return;
    }

    try {
      cadMap = L.map('mapCAD', { zoomControl: true, attributionControl: true });
      // Center near Av. Primavera; adjust as needed
      var primavera = [-12.1175, -76.9990];
      cadMap.setView(primavera, 14);
    } catch (error) {
      console.error('‚ùå Error al inicializar mapa Leaflet:', error);
      return;
    }

    // Dark theme basemap
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      maxZoom: 20,
      attribution: '&copy; OpenStreetMap contributors &copy; CARTO'
    }).addTo(cadMap);

    // Icono personalizado para agentes
    var agentIcon = L.divIcon({
      className: 'agent-marker-icon',
      html: '<div style="background: #22c55e; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);">üëÆ</div>',
      iconSize: [32, 32],
      iconAnchor: [16, 16]
    });

    // Icono para ubicaci√≥n del incidente
    var incidentIcon = L.divIcon({
      className: 'incident-marker-icon',
      html: '<div style="background: #ef4444; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 16px; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.4);">üìç</div>',
      iconSize: [36, 36],
      iconAnchor: [18, 18]
    });

    // ‚úÖ Marcar ubicaci√≥n del incidente (DRAGGABLE - Se puede mover)
    currentLocationMarker = L.marker(primavera, {
      icon: incidentIcon,
      draggable: true  // ‚Üê Permitir arrastrar el pin
    })
      .addTo(cadMap)
      .bindPopup('<b>üìç Ubicaci√≥n del incidente</b><br><small>Arrastra el pin para cambiar la ubicaci√≥n</small>');

    // ‚úÖ Evento: Cuando el usuario mueve el pin
    currentLocationMarker.on('dragend', function(e) {
      var newLatLng = e.target.getLatLng();
      console.log('üìç Pin movido a:', newLatLng.lat, newLatLng.lng);

      // Actualizar coordenadas en el formulario
      updateLocationFromCoordinates(newLatLng.lat, newLatLng.lng);

      // Regenerar agentes alrededor de la nueva ubicaci√≥n
      regenerateAgentsAroundIncident(newLatLng.lat, newLatLng.lng);
      renderAgentsOnMap();
    });

    // üî• Generar agentes aleatorios iniciales alrededor de Av. Primavera
    regenerateAgentsAroundIncident(primavera[0], primavera[1]);

    // Renderizar agentes en el mapa
    renderAgentsOnMap();

    // Ensure correct sizing in case of late layout/visibility changes
    setTimeout(function () { cadMap.invalidateSize(); }, 300);

    // Event listeners para los tabs del mapa
    initializeMapTabs();

    // Inicializar b√∫squeda en el mapa
    initMapSearchForCAD();

    // Inicializar lista de agentes asignados
    renderAssignedAgentsList();

    // Inicializar filtros de agentes en el mapa
    initializeAgentFilters();
  });

  // Funci√≥n para inicializar b√∫squeda en el mapa CAD
  function initMapSearchForCAD() {
    var input = document.getElementById('mapSearchInput');
    var btn = document.getElementById('mapSearchBtn');

    if (btn) {
      btn.addEventListener('click', function () {
        var query = input ? input.value.trim() : '';
        if (query) {
          // Detectar en qu√© pesta√±a estamos
          if (activeMapTab === 'cameras') {
            searchPlateWithAI(query);
          } else {
            searchAddress(query);
          }
        }
      });
    }

    if (input) {
      input.addEventListener('keydown', function (e) {
        if (e.key === 'Enter') {
          var query = input.value.trim();
          if (query) {
            // Detectar en qu√© pesta√±a estamos
            if (activeMapTab === 'cameras') {
              searchPlateWithAI(query);
            } else {
              searchAddress(query);
            }
          }
        }
      });
    }
  }

  // Funci√≥n para inicializar filtros de agentes
  function initializeAgentFilters() {
    var filterAvailable = document.getElementById('filterAvailable');
    var filterBusy = document.getElementById('filterBusy');
    var filterAll = document.getElementById('filterAll');
    var filterToggleBtn = document.getElementById('filterToggleBtn');
    var filterDropdown = document.getElementById('filterDropdown');
    var filterArrow = document.getElementById('filterArrow');

    // ‚úÖ Toggle del dropdown
    if (filterToggleBtn && filterDropdown && filterArrow) {
      filterToggleBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        var isOpen = filterDropdown.style.display === 'block';

        if (isOpen) {
          filterDropdown.style.display = 'none';
          filterArrow.style.transform = 'rotate(0deg)';
        } else {
          filterDropdown.style.display = 'block';
          filterArrow.style.transform = 'rotate(180deg)';
        }
      });

      // Cerrar dropdown al hacer clic fuera
      document.addEventListener('click', function(e) {
        if (!filterToggleBtn.contains(e.target) && !filterDropdown.contains(e.target)) {
          filterDropdown.style.display = 'none';
          filterArrow.style.transform = 'rotate(0deg)';
        }
      });
    }

    // ‚úÖ Checkbox "Todos los agentes"
    if (filterAll && filterAvailable && filterBusy) {
      filterAll.addEventListener('change', function() {
        if (this.checked) {
          // Marcar todos los checkboxes
          filterAvailable.checked = true;
          filterBusy.checked = true;
        } else {
          // Desmarcar todos los checkboxes
          filterAvailable.checked = false;
          filterBusy.checked = false;
        }
        renderAgentsOnMap();
      });
    }

    // ‚úÖ Checkboxes individuales
    if (filterAvailable) {
      filterAvailable.addEventListener('change', function () {
        // Si se desmarca alguno, desmarcar "Todos"
        if (!this.checked && filterAll) {
          filterAll.checked = false;
        }
        // Si ambos est√°n marcados, marcar "Todos"
        if (this.checked && filterBusy && filterBusy.checked && filterAll) {
          filterAll.checked = true;
        }
        renderAgentsOnMap();
      });
    }

    if (filterBusy) {
      filterBusy.addEventListener('change', function () {
        // Si se desmarca alguno, desmarcar "Todos"
        if (!this.checked && filterAll) {
          filterAll.checked = false;
        }
        // Si ambos est√°n marcados, marcar "Todos"
        if (this.checked && filterAvailable && filterAvailable.checked && filterAll) {
          filterAll.checked = true;
        }
        renderAgentsOnMap();
      });
    }

    // ‚úÖ Inicializar estado de "Todos" basado en los checkboxes actuales
    if (filterAll && filterAvailable && filterBusy) {
      filterAll.checked = filterAvailable.checked && filterBusy.checked;
    }
  }

  // Funci√≥n para renderizar agentes en el mapa (con filtros)
  function renderAgentsOnMap() {
    if (!cadMap) return;

    // Limpiar marcadores anteriores de agentes
    agentMarkers.forEach(function (marker) {
      cadMap.removeLayer(marker);
    });
    agentMarkers = [];

    // üî• ASEGURAR QUE NO HAYA C√ÅMARAS VISIBLES
    if (typeof cameraMarkers !== 'undefined' && cameraMarkers.length > 0) {
      cameraMarkers.forEach(function(marker) {
        try {
          cadMap.removeLayer(marker);
        } catch (e) {
          // Ignorar si el marcador ya fue eliminado
        }
      });
      cameraMarkers = [];
    }

    // üéØ Leer estado de los filtros
    var showAvailable = document.getElementById('filterAvailable')?.checked !== false;
    var showBusy = document.getElementById('filterBusy')?.checked !== false;

    // ‚úÖ Renderizar agentes seg√∫n filtros activos
    agentsData.forEach(function (agent) {
      var isAvailable = agent.status === 'Disponible' && !agent.assignedTicket;
      var isBusy = !isAvailable;

      // üîç Aplicar filtro: solo mostrar si el filtro correspondiente est√° activo
      if ((isAvailable && !showAvailable) || (isBusy && !showBusy)) {
        return; // Saltar este agente
      }

      // üé® Iconos diferentes seg√∫n estado
      var agentIcon;
      var statusColor;
      var statusText;
      var statusDot;

      if (isAvailable) {
        // üü¢ LIBRE - Verde
        statusColor = '#22c55e';
        statusText = 'Disponible';
        statusDot = '‚óè';
        agentIcon = L.divIcon({
          className: 'agent-marker-icon',
          html: '<div style="background: #22c55e; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);">üëÆ</div>',
          iconSize: [32, 32],
          iconAnchor: [16, 16]
        });
      } else {
        // üü° OCUPADO - Amarillo/Naranja
        statusColor = '#f59e0b';
        statusText = 'Ocupado';
        statusDot = '‚óè';
        agentIcon = L.divIcon({
          className: 'agent-marker-icon-busy',
          html: '<div style="background: #f59e0b; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3); opacity: 0.7;">üëÆ</div>',
          iconSize: [32, 32],
          iconAnchor: [16, 16]
        });
      }

      // üìç Crear popup seg√∫n estado
      var popupContent = '<div style="min-width: 200px;">' +
        '<strong style="font-size: 15px;">' + agent.name + '</strong><br>' +
        '<span style="color: #6b7280; font-size: 13px;">üöó ' + agent.transporte + '</span><br>' +
        '<span style="color: ' + statusColor + '; font-size: 13px; font-weight: 600;">' + statusDot + ' ' + statusText + '</span><br>' +
        '<span style="color: #6b7280; font-size: 12px;">üìç ' + agent.distancia + '</span><br>';

      // Si est√° ocupado, mostrar qu√© ticket est√° atendiendo
      if (agent.assignedTicket) {
        popupContent += '<div style="margin-top: 8px; padding: 6px; background: #fef3c7; border-left: 3px solid #f59e0b; border-radius: 4px;">' +
          '<span style="color: #92400e; font-size: 11px; font-weight: 600;">üìã Atendiendo:</span><br>' +
          '<span style="color: #92400e; font-size: 12px; font-weight: 700;">' + agent.assignedTicket + '</span>' +
          '</div>';
      } else {
        // Solo si est√° disponible, mostrar bot√≥n de asignar
        popupContent += '<button onclick="assignAgentFromMap(\'' + agent.id + '\')" class="btn btn-accent btn-sm" style="margin-top: 8px; width: 100%; font-size: 12px;">Asignar Ticket</button>';
      }

      popupContent += '</div>';

      // Agregar marcador al mapa
      var marker = L.marker(agent.coords, { icon: agentIcon })
        .addTo(cadMap)
        .bindPopup(popupContent);

      agentMarkers.push(marker);
    });
  }

  // Funci√≥n para asignar un ticket desde el mapa
  function assignAgentFromMap(agentId) {
    if (!ticketsState.activeTicketId) {
      showNotification('Debe seleccionar un ticket primero', 'warning');
      return;
    }

    var agent = agentsData.find(function (a) { return a.id === agentId; });
    if (!agent) return;

    var ticket = ticketsState.tickets.find(function (t) { return t.id === ticketsState.activeTicketId; });
    if (!ticket) return;

    // Asignar ticket al agente
    agent.assignedTicket = ticket.id;
    agent.status = 'Ocupado';

    // Agregar evento al chat del ticket
    var now = new Date();
    var timeString = now.getHours() + ':' + String(now.getMinutes()).padStart(2, '0');

    var assignEvent = {
      type: 'event',
      icon: 'üëÆ',
      title: 'Agente asignado',
      detail: agent.name + ' ‚Ä¢ ' + agent.transporte,
      timestamp: timeString
    };

    if (!ticket.chatMessages) {
      ticket.chatMessages = [];
    }
    ticket.chatMessages.push(assignEvent);

    // Actualizar estado del ticket
    ticket.status = 'asignado';

    // Recargar chat y mapa
    loadTicketChat(ticket);
    renderAgentsOnMap();
    renderAssignedAgentsList();
    renderTicketAssignedAgents();

    showNotification('Agente ' + agent.name + ' asignado al ticket ' + ticket.id, 'success');
  }

  // Hacer funci√≥n global
  window.assignAgentFromMap = assignAgentFromMap;

  // Funci√≥n para inicializar tabs del mapa
  // Variable global para controlar el tab activo
  var activeMapTab = 'agents';

  function initializeMapTabs() {
    var mapTabs = document.querySelectorAll('.map-tab');

    mapTabs.forEach(function (tab) {
      tab.addEventListener('click', function () {
        var tabType = this.getAttribute('data-tab');

        // Actualizar estilos de tabs
        mapTabs.forEach(function (t) {
          t.classList.remove('active');
          t.style.background = 'transparent';
          t.style.opacity = '0.6';
        });

        this.classList.add('active');
        this.style.background = '#252525';
        this.style.opacity = '1';

        // Actualizar variable global
        activeMapTab = tabType;

        // Cambiar placeholder y funcionalidad del buscador
        var mapSearchInput = document.getElementById('mapSearchInput');
        var mapTitle = document.getElementById('mapTitle');
        var plateSearchInfo = document.getElementById('plateSearchInfo');

        if (tabType === 'agents') {
          mapSearchInput.placeholder = 'Buscar direcci√≥n...';
          mapTitle.textContent = 'Mapa Interactivo - Agentes';
          if (plateSearchInfo) plateSearchInfo.style.display = 'none';

          // üî• Mostrar filtro de agentes, ocultar filtro de c√°maras
          var filterAgentsSection = document.getElementById('filterAgentsSection');
          var filterCamerasSection = document.getElementById('filterCamerasSection');
          if (filterAgentsSection) filterAgentsSection.style.display = 'block';
          if (filterCamerasSection) filterCamerasSection.style.display = 'none';

          // üî• LIMPIAR C√ÅMARAS ANTES DE MOSTRAR AGENTES
          if (typeof cameraMarkers !== 'undefined' && cameraMarkers.length > 0) {
            cameraMarkers.forEach(function(marker) {
              if (cadMap) cadMap.removeLayer(marker);
            });
            cameraMarkers = [];
          }

          // Renderizar agentes
          renderAgentsOnMap();

        } else if (tabType === 'cameras') {
          mapSearchInput.placeholder = 'Buscar c√°mara por nombre o zona...';
          mapSearchInput.value = '';
          mapTitle.textContent = 'Mapa Interactivo - C√°maras';
          if (plateSearchInfo) plateSearchInfo.style.display = 'block';

          // üî• Ocultar filtro de agentes, mostrar filtro de c√°maras
          var filterAgentsSection = document.getElementById('filterAgentsSection');
          var filterCamerasSection = document.getElementById('filterCamerasSection');
          if (filterAgentsSection) filterAgentsSection.style.display = 'none';
          if (filterCamerasSection) filterCamerasSection.style.display = 'block';

          // üî• LIMPIAR AGENTES ANTES DE MOSTRAR C√ÅMARAS
          if (typeof agentMarkers !== 'undefined' && agentMarkers.length > 0) {
            agentMarkers.forEach(function(marker) {
              if (cadMap) cadMap.removeLayer(marker);
            });
            // No vaciar el array de agentMarkers para que se puedan volver a renderizar
          }

          // Renderizar c√°maras (si la funci√≥n existe)
          if (typeof renderCamerasOnMap === 'function') {
            renderCamerasOnMap();
          } else {
            // Si a√∫n no se ha cargado, cargar c√°maras
            if (typeof loadCamerasFromAPI === 'function') {
              loadCamerasFromAPI();
            } else {
              console.warn('‚ö†Ô∏è M√≥dulo de c√°maras a√∫n no cargado');
            }
          }
        }
      });
    });
  }

  // Funci√≥n para renderizar lista de agentes asignados
  function renderAssignedAgentsList() {
    var container = document.getElementById('assignedAgentsList');
    if (!container) return;

    // Filtrar agentes que tienen tickets asignados
    var assignedAgents = agentsData.filter(function (agent) {
      return agent.assignedTicket !== null;
    });

    // Limpiar contenedor
    container.innerHTML = '';

    if (assignedAgents.length === 0) {
      container.innerHTML = '<div style="padding: 20px; text-align: center; color: #9ca3af; font-size: 13px;">No hay agentes asignados</div>';
      return;
    }

    // Renderizar cada agente asignado
    assignedAgents.forEach(function (agent) {
      var ticket = ticketsState.tickets.find(function (t) { return t.id === agent.assignedTicket; });
      var ticketInfo = ticket ? ticket.id : agent.assignedTicket;
      var ticketStatus = ticket ? ticket.status : 'desconocido';

      var agentCard = document.createElement('div');
      agentCard.style.cssText = 'padding: 12px 15px; border-bottom: 1px solid #1e293b; cursor: pointer; transition: background 0.2s;';
      agentCard.onmouseenter = function () { this.style.background = '#0f172a'; };
      agentCard.onmouseleave = function () { this.style.background = 'transparent'; };

      agentCard.innerHTML =
        '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">' +
        '<strong style="font-size: 14px; color: #e5e7eb;">' + agent.name + '</strong>' +
        '<span style="font-size: 11px; padding: 2px 6px; background: #1e3a1e; border-radius: 4px; color: #22c55e;">Ocupado</span>' +
        '</div>' +
        '<div style="font-size: 12px; color: #9ca3af; margin-bottom: 4px;">üöó ' + agent.transporte + '</div>' +
        '<div style="font-size: 12px; color: #9ca3af; margin-bottom: 4px;">üìã Ticket: <span style="color: #f67200; font-weight: 600;">' + ticketInfo + '</span></div>' +
        '<div style="font-size: 11px; color: #6b7280;">Estado: ' + ticketStatus + '</div>' +
        '<button onclick="releaseAgentFromTicket(\'' + agent.id + '\')" class="btn btn-sm" style="margin-top: 8px; width: 100%; padding: 6px; font-size: 11px; background: #dc2626; color: white; border: none;">Liberar Agente</button>';

      agentCard.addEventListener('click', function (e) {
        // No hacer nada al hacer click en el bot√≥n
        if (e.target.tagName === 'BUTTON') return;

        // Ir al ticket del agente
        if (ticket) {
          selectTicket(ticket.id);
        }
      });

      container.appendChild(agentCard);
    });
  }

  // Funci√≥n para liberar un agente de su ticket
  function releaseAgentFromTicket(agentId) {
    var agent = agentsData.find(function (a) { return a.id === agentId; });
    if (!agent) return;

    var ticketId = agent.assignedTicket;

    if (typeof Swal !== 'undefined') {
      Swal.fire({
        title: '¬øLiberar agente?',
        text: '¬øEst√° seguro que desea liberar a ' + agent.name + ' del ticket ' + ticketId + '?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#dc2626',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'S√≠, liberar',
        cancelButtonText: 'Cancelar'
      }).then(function (result) {
        if (result.isConfirmed) {
          // Liberar agente
          agent.assignedTicket = null;
          agent.status = 'Disponible';

          // Actualizar ticket si existe
          var ticket = ticketsState.tickets.find(function (t) { return t.id === ticketId; });
          if (ticket) {
            ticket.status = 'abierto';

            // Agregar evento al chat
            var now = new Date();
            var timeString = now.getHours() + ':' + String(now.getMinutes()).padStart(2, '0');

            var releaseEvent = {
              type: 'event',
              icon: 'üîì',
              title: 'Agente liberado',
              detail: agent.name + ' fue liberado del ticket',
              timestamp: timeString
            };

            if (!ticket.chatMessages) {
              ticket.chatMessages = [];
            }
            ticket.chatMessages.push(releaseEvent);

            // Recargar chat si es el ticket activo
            if (ticketsState.activeTicketId === ticketId) {
              loadTicketChat(ticket);
            }
          }

          // Actualizar mapa y lista
          renderAgentsOnMap();
          renderAssignedAgentsList();
          renderTicketAssignedAgents();

          showNotification('Agente ' + agent.name + ' liberado exitosamente', 'success');
        }
      });
    } else {
      if (confirm('¬øEst√° seguro que desea liberar a ' + agent.name + ' del ticket ' + ticketId + '?')) {
        // Liberar agente
        agent.assignedTicket = null;
        agent.status = 'Disponible';

        // Actualizar mapa y lista
        renderAgentsOnMap();
        renderAssignedAgentsList();
        renderTicketAssignedAgents();

        showNotification('Agente ' + agent.name + ' liberado exitosamente', 'success');
      }
    }
  }

  // Hacer funci√≥n global
  window.releaseAgentFromTicket = releaseAgentFromTicket;
</script>
<script>
  // General tab renderer (read-only context)
  (function () {
    function byId(id) { return document.getElementById(id); }
    var data = {
      id: 'INC-2025-001',
      titulo: 'Accidente de tr√°nsito en Av. Primavera',
      estado: 'Clasificado',
      origen: 'Llamada 105',
      severidad: 'Media',
      prioridad: 'Alta',
      fechaCreacion: '12/01/2025 10:30',
      tiempoTranscurrido: '18.50 h',
      slaPorcentaje: 82,
      direccion: 'Av. Primavera 123, Santiago de Surco',
      coords: '-12.117500, -76.999000',
      clasificacion: 'Tr√°nsito',
      tipo: 'Accidente de tr√°nsito',
      subtipo: 'Choque',
      descripcion: 'Colisi√≥n entre dos veh√≠culos. Sin heridos de gravedad reportados. Congesti√≥n en carril derecho.',
      denunciante: {
        nombre: 'Mario Salazar',
        telefono: '+51 999 123 456',
        documento: 'DNI 12345678'
      },
      agentes: [{ nombre: 'A. Ram√≠rez' }, { nombre: 'B. Torres' }],
      personas: [{ nombre: 'Juan P√©rez', rol: 'Afectado' }, { nombre: 'Mar√≠a L√≥pez', rol: 'Testigo' }],
      camaras: [
        { id: 'CAM-014', estado: 'online', ubicacion: 'Primavera x Central', distancia: '120m' },
        { id: 'CAM-021', estado: 'offline', ubicacion: 'Primavera x Velasco', distancia: '350m' }
      ]
    };
    const incidentTabsData = [
      { id: 'INC-2025-001', title: 'Accidente en Av. Primavera', summary: 'Colisi√≥n de veh√≠culos; tr√°nsito lento', unread: 3 },
      { id: 'INC-2025-014', title: 'Robo en Plaza Central', summary: 'Sospechoso huy√≥ hacia Av. Grau', unread: 1 },
      { id: 'INC-2025-022', title: 'Manifestaci√≥n no autorizada', summary: 'Grupo de 50 personas frente a municipalidad', unread: 0 },
      { id: 'INC-2025-027', title: 'Corte de electricidad', summary: 'Sector Los √Ålamos sin servicio', unread: 8 },
    ];
    let activeIncidentTab = incidentTabsData[0].id;

    const assignedAgents = [
      { shortName: 'A. Ram√≠rez', transporte: 'Camioneta', status: 'Disponible' },
      { shortName: 'B. Torres', transporte: 'Motocicleta', status: 'En ruta' },
    ];
    const availableAgents = [
      { id: 'ramirez', name: 'Agente Ram√≠rez', shortName: 'A. Ram√≠rez', transporte: 'Camioneta', status: 'Disponible', distancia: '0.8 km', incidenteActual: null },
      { id: 'vega', name: 'Agente Vega', shortName: 'C. Vega', transporte: 'Bicicleta', status: 'Disponible', distancia: '1.2 km', incidenteActual: null },
      { id: 'suarez', name: 'Agente Su√°rez', shortName: 'D. Su√°rez', transporte: 'Camioneta', status: 'Ocupado', distancia: '5.3 km', incidenteActual: '#2051' },
      { id: 'torres', name: 'Agente Torres', shortName: 'E. Torres', transporte: 'Camioneta', status: 'Ocupado', distancia: '3.7 km', incidenteActual: '#2053' },
      { id: 'lopez', name: 'Agente L√≥pez', shortName: 'F. L√≥pez', transporte: 'A pie', status: 'Disponible', distancia: '2.1 km', incidenteActual: null },
      { id: 'garcia', name: 'Agente Garc√≠a', shortName: 'G. Garc√≠a', transporte: 'Camioneta', status: 'Disponible', distancia: '0.5 km', incidenteActual: null },
      { id: 'martinez', name: 'Agente Mart√≠nez', shortName: 'H. Mart√≠nez', transporte: 'Bicicleta', status: 'Disponible', distancia: '1.8 km', incidenteActual: null },
      { id: 'fernandez', name: 'Agente Fern√°ndez', shortName: 'I. Fern√°ndez', transporte: 'Camioneta', status: 'Disponible', distancia: '4.2 km', incidenteActual: null },
      { id: 'diaz', name: 'Agente D√≠az', shortName: 'J. D√≠az', transporte: 'A pie', status: 'Ocupado', distancia: '8.1 km', incidenteActual: '#2048' }
    ];


    function openAssignAgentModal() {
      var modal = byId('assignAgentModal');
      if (!modal) return;
      currentAgentSearchTerm = '';
      var input = byId('agentSearchInput');
      if (input) input.value = '';
      renderAgentList(false, '');
      modal.classList.add('active');
      setTimeout(function () { if (input) input.focus(); }, 100);
    }

    function closeAssignAgentModal() {
      var modal = byId('assignAgentModal');
      if (modal) modal.classList.remove('active');
    }

    function filterAgents() {
      var input = byId('agentSearchInput');
      currentAgentSearchTerm = input ? input.value.trim() : '';
      var includeOccupied = currentAgentSearchTerm.length > 0;
      renderAgentList(includeOccupied, currentAgentSearchTerm);
    }

    function renderAgentList(includeOccupied, searchTerm) {
      if (includeOccupied === undefined) includeOccupied = false;
      if (searchTerm === undefined) searchTerm = '';
      var container = byId('agentListContainer');
      if (!container) return;
      var agentsToShow = availableAgents.filter(function (agent) {
        return !assignedAgents.some(function (a) { return a.shortName === agent.shortName; });
      });
      if (!includeOccupied && !searchTerm) {
        agentsToShow = agentsToShow.filter(function (agent) { return agent.status === 'Disponible'; });
      }
      if (searchTerm) {
        agentsToShow = agentsToShow.filter(function (agent) {
          return agent.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
            agent.transporte.toLowerCase().includes(searchTerm.toLowerCase());
        });
      }
      agentsToShow.sort(function (a, b) {
        return parseFloat(a.distancia) - parseFloat(b.distancia);
      });
      container.innerHTML = '';
      if (!agentsToShow.length) {
        container.innerHTML = '<div class="no-results">No se encontraron agentes disponibles</div>';
        return;
      }
      agentsToShow.forEach(function (agent) {
        var item = document.createElement('div');
        item.className = 'agent-list-item' + (agent.status === 'Ocupado' ? ' ocupado' : '');
        if (agent.status !== 'Ocupado') {
          item.addEventListener('click', function () { assignAgent(agent); });
        }
        var info = document.createElement('div');
        info.className = 'agent-info';
        var name = document.createElement('div');
        name.className = 'agent-list-name';
        name.textContent = agent.name;
        var role = document.createElement('div');
        role.className = 'agent-list-role';
        role.textContent = formatTransportLabel(agent.transporte || '');
        info.appendChild(name);
        info.appendChild(role);
        if (agent.status === 'Ocupado' && agent.incidenteActual) {
          var tag = document.createElement('div');
          tag.className = 'agent-incident-tag';
          tag.textContent = 'Atendiendo incidente ' + agent.incidenteActual;
          info.appendChild(tag);
        }
        var meta = document.createElement('div');
        meta.style.textAlign = 'right';
        var statusMark = document.createElement('div');
        statusMark.style.fontSize = '1.2rem';
        statusMark.textContent = agent.status === 'Ocupado' ? '‚è∏' : '‚úì';
        if (agent.status === 'Ocupado') statusMark.style.color = '#999';
        var distance = document.createElement('div');
        distance.className = 'agent-distance';
        distance.textContent = 'üìç ' + agent.distancia;
        meta.appendChild(statusMark);
        meta.appendChild(distance);
        item.appendChild(info);
        item.appendChild(meta);
        container.appendChild(item);
      });
    }

    function assignAgent(agent) {
      if (assignedAgents.some(function (a) { return a.shortName === agent.shortName; })) return;
      assignedAgents.push({
        shortName: agent.shortName,
        transporte: agent.transporte,
        status: agent.status
      });
      renderAssignedAgents();
      renderAgentList(currentAgentSearchTerm.length > 0, currentAgentSearchTerm);
      addChatEvent(activeIncidentTab, {
        icon: 'üëÆ',
        title: 'Agente asignado',
        detail: agent.shortName + ' (' + formatTransportLabel(agent.transporte || '') + ') incorporado.'
      });
      closeAssignAgentModal();
    }
    function releaseAllAgents() {
      if (!assignedAgents.length) return;
      var released = assignedAgents.length;
      assignedAgents.length = 0;
      renderAssignedAgents();
      renderAgentList(currentAgentSearchTerm.length > 0, currentAgentSearchTerm);
      addChatEvent(activeIncidentTab, {
        icon: '‚Ü©Ô∏è',
        title: 'Agentes liberados',
        detail: released + ' ' + (released === 1 ? 'agente liberado del incidente.' : 'agentes liberados del incidente.')
      });
    }

    document.addEventListener('click', function (e) {
      if (e.target.classList && e.target.classList.contains('modal-overlay')) {
        closeAssignAgentModal();
      }
    });
    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape') closeAssignAgentModal();
    });
    window.openAssignAgentModal = openAssignAgentModal;
    window.closeAssignAgentModal = closeAssignAgentModal;
    window.filterAgents = filterAgents;
    window.releaseAllAgents = releaseAllAgents;
  })();
</script>
<script>
  (function attachNuevoIncidenteModal() {
    function ensureLeaflet(cb) {
      if (typeof L !== 'undefined') {
        if (cb) cb();
        return;
      }
      var existing = document.querySelector('script[data-leaflet]');
      if (existing) {
        if (cb) existing.addEventListener('load', cb, { once: true });
        return;
      }
      var script = document.createElement('script');
      script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
      script.defer = true;
      script.setAttribute('data-leaflet', '1');
      if (cb) script.addEventListener('load', cb, { once: true });
      document.head.appendChild(script);
    }

    function initNuevoIncidenteMap() {
      var modal = document.getElementById('modalIncidenteNuevo');
      if (!modal) return;
      var mapEl = modal.querySelector('#incn-inline-map');
      if (!mapEl || mapEl.dataset.leaflet === '1') return;
      var hint = modal.querySelector('#incn-map-hint');
      ensureLeaflet(function () {
        try {
          var latInput = modal.querySelector('#incn-lat');
          var lngInput = modal.querySelector('#incn-lng');
          var map = L.map(mapEl, { zoomControl: true, attributionControl: true });
          var center = [-12.1175, -76.9990];
          map.setView(center, 14);
          L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            maxZoom: 20,
            attribution: '&copy; OpenStreetMap contributors &copy; CARTO'
          }).addTo(map);
          var marker;
          function placeMarker(latlng) {
            if (marker) marker.setLatLng(latlng);
            else marker = L.marker(latlng).addTo(map);
            if (latInput) latInput.value = latlng.lat.toFixed(6);
            if (lngInput) lngInput.value = latlng.lng.toFixed(6);
            if (hint) hint.style.display = 'none';
          }
          mapEl.addEventListener('mouseenter', function () { if (hint) hint.style.display = 'none'; }, { once: true });
          map.on('click', function (evt) { placeMarker(evt.latlng); });
          var defaultLatLng = L.latLng(center[0], center[1]);
          marker = L.marker(defaultLatLng).addTo(map).bindPopup('<b>Incidente</b><br>Av. Primavera 123').openPopup();
          if (latInput) latInput.value = defaultLatLng.lat.toFixed(6);
          if (lngInput) lngInput.value = defaultLatLng.lng.toFixed(6);
          setTimeout(function () { map.invalidateSize(); }, 60);
          mapEl.dataset.leaflet = '1';
          mapEl._leafletMap = map;
        } catch (error) {
        }
      });
    }

    function showNuevoIncidenteModal() {
      var modal = document.getElementById('modalIncidenteNuevo');
      if (!modal) return;
      if (window.$ && typeof window.$('#modalIncidenteNuevo').modal === 'function') {
        window.$('#modalIncidenteNuevo')
          .one('shown.bs.modal', function () { initNuevoIncidenteMap(); })
          .modal('show');
      } else {
        modal.style.display = 'block';
        modal.classList.add('in');
        modal.setAttribute('aria-hidden', 'false');
        setTimeout(initNuevoIncidenteMap, 50);
      }
    }

    function bindNuevoIncidenteButton() {
      var trigger = document.getElementById('addticket');
      if (!trigger || trigger.dataset.niBound === '1') return;
      trigger.dataset.niBound = '1';
      trigger.addEventListener('click', showNuevoIncidenteModal);
    }

    document.addEventListener('DOMContentLoaded', bindNuevoIncidenteButton);
  })();
</script>


<!-- Modales de registro r√°pido -->
{{persona_desaparecida}}

{{vehiculo_robado}}

{{agentes}}

{{catalogos}}

{{formulario}}

{{general}}

{{mapa}}

{{camaras}}

{{sistema_tickets}}

{{telegram}}

{{selector_incidencia}}
