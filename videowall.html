<style>
:root{
  --bg:#0b1f2a; --panel:#0f2532; --ink:#b5d6df; --ink-strong:#e8fbff;
  --teal:#1ABC9C; --orange:#E67E22; --line:#143241;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;padding:0}
body{background:#0b1f2a;color:var(--ink);font:14px/1.45 system-ui,Segoe UI,Roboto,Arial,sans-serif;overflow:hidden;}

.container{width:100%;height:100%;padding:12px;display:none;gap:12px}

.col-3{flex:0 0 25%}
.col-9{flex:1;display:flex;flex-direction:column}

.panel{background:var(--panel);border:1px solid rgba(26,188,156,.12);border-radius:12px;padding:12px;display:flex;flex-direction:column;height:100%}

.hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.hdr h3{margin:0;font-size:15px;color:var(--teal)}
/* Grid 4x4 ocupa todo el espacio disponible */
.grid-wall{
  flex:1;
  display:grid;
  grid-template-columns:repeat(4,1fr);
  grid-template-rows:repeat(4,1fr);
  gap:8px;
}
.slot{
  position:relative;background:#061922;border:1px dashed #204a59;border-radius:10px;
  display:flex;align-items:center;justify-content:center;color:#89aab5;cursor:move;overflow:hidden;
}
.slot:hover{border-color:var(--teal)}
.slot .label{position:absolute;top:6px;left:8px;font-size:12px;color:#87cfd6}
.slot .video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;display:none}
.slot.filled .video{display:block}
.slot.filled .placeholder{display:none}
.placeholder .name{color:var(--ink-strong);font-size:13px}
/* Botones dentro de cada slot */
.full-btn, .select-btn{
  position:absolute;
  background:rgba(0,0,0,0.5);color:white;
  border:none;border-radius:4px;
  cursor:pointer;font-size:12px;z-index:10;padding:2px 6px;
}
.full-btn{top:4px;right:6px;}
.select-btn{bottom:6px;right:6px;}
.full-btn:hover,.select-btn:hover{background:rgba(0,0,0,0.8)}

/* Modal */
.modal-backdrop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.7);z-index:1000}
.modal{width:min(700px,95vw);background:var(--panel);border-radius:12px;padding:12px;max-height:90vh;overflow:auto}
.modal .hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.modal .hdr h4{margin:0;color:var(--orange)}
.modal .x{cursor:pointer;color:var(--ink-strong);font-size:20px}
.cam-list{list-style:none;margin:0;padding:0;max-height:300px;overflow:auto}
.cam-item{padding:10px;border:1px solid var(--line);border-radius:8px;margin-bottom:8px;cursor:pointer;background:#0b1f2a}
.cam-item:hover{outline:2px solid rgba(26,188,156,.35)}
.cam-name{color:var(--ink-strong);font-weight:600}
.cam-id{font-size:12px;color:#87cfd6}

.btn{border:none;border-radius:6px;padding:10px 16px;cursor:pointer;font-weight:600;font-size:16px}
.btn-teal{background:var(--teal);color:#083238}

/* Pantalla inicial centrada */
#startScreen{
  width:100%;height:100%;
  display:flex;align-items:center;justify-content:center;
}

.modal-backdrop2{
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.7);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
}
.modal2{
  background:var(--panel);
  border-radius:12px;
  padding:16px;
  max-width:600px;
  width:90%;
  max-height:80vh;
  overflow:auto;
  box-shadow:0 8px 20px rgba(0,0,0,0.6);
  animation:fadeIn 0.25s ease-in-out;
}
.modal2 .hdr{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:12px;
}
.modal2 .hdr h4{margin:0;color:var(--orange)}
.modal2 .x{cursor:pointer;color:var(--ink-strong);font-size:22px;font-weight:bold}
@keyframes fadeIn{
  from{opacity:0;transform:scale(0.9);}
  to{opacity:1;transform:scale(1);}
}

/* TIMELINE STYLES - Aplicando estilos de civix-neo */
.alert-list {
    padding: 8px;
    overflow: auto;
  list-style: none; 
  margin: 0;
}

.alert-list li {
  cursor: pointer;
  margin: 0;
  padding: 12px 15px 12px 25px;
  position: relative;
  border-left: 2px solid rgba(34,230,217,.2);
  transition: all 0.3s ease;
  background: rgba(11, 31, 42, 0.7);
  border-radius: 0;
  margin-bottom: 0;
}

.alert-list li:hover {
  background: rgba(34, 230, 217, 0.1);
  transform: translateX(5px);
}

.alert-list li::before {
  content: "";
  position: absolute;
  left: -7px;
  top: 16px;
  width: 12px;
  height: 12px;
  border-radius: 50%;
  background: #22e6d9;
  box-shadow: 0 0 10px #22e6d9;
  transition: all 0.3s ease;
}

.alert-list li[data-type*="accidente"]::before {
  background: red;
  box-shadow: 0 0 12px red;
}

.alert-list li[data-type*="aglomeracion"]::before,
.alert-list li[data-type*="restringida"]::before,
.alert-list li[data-type*="zona"]::before {
  background: #ff7a2f;
  box-shadow: 0 0 12px #ff7a2f;
}

.alert-list strong {
  color: #e8fbff;
  display: block;
  margin-bottom: 5px;
  font-weight: 600;
}

.alert-list time {
  display: block;
  color: #84a9b3;
  font-size: 12px;
  margin-top: 4px;
}

/* Ajustes espec√≠ficos para el video wall */
.col-3.panel {
  background: #0b1f2a;
  border: 1px solid rgba(34,230,217,.12);
}

.hdr h3 {
  color: #22e6d9;
}

.btn-refresh {
  background: transparent;
  border: 1px solid #22e6d9;
  color: #22e6d9;
  border-radius: 4px;
  padding: 4px 8px;
  cursor: pointer;
  font-size: 12px;
}

.btn-refresh:hover {
  background: rgba(34, 230, 217, 0.1);
}

/* Estilos para el modal de detalles de alerta */
.alert-details {
    padding: 10px 0;
}

.detail-item {
    margin-bottom: 8px;
    font-size: 14px;
}

.detail-label {
    color: #22e6d9;
    font-weight: bold;
    margin-right: 5px;
}

/* Asegurar que los modales tengan los colores correctos */
.modal-backdrop2 {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    background: rgba(0,0,0,0.85) !important;
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10000 !important;
}

.modal2 {
    z-index: 10001 !important;
    position: relative !important;
}

/* Asegurar que los modales sean visibles en fullscreen */
:fullscreen .modal-backdrop2,
:-webkit-full-screen .modal-backdrop2,
:-moz-full-screen .modal-backdrop2,
:-ms-fullscreen .modal-backdrop2 {
    z-index: 10000 !important;
}

.modal2 .hdr h4 {
    color: #ff7a2f;
}

.btn-teal {
    background: #22e6d9;
    color: #083238;
}

/* Bot√≥n de salida */
.btn-exit {
  position: fixed;
  top: 20px;
  right: 20px;
  background: rgba(230, 126, 34, 0.2);
  border: 1px solid var(--orange);
  color: var(--orange);
  border-radius: 6px;
  padding: 8px 16px;
  cursor: pointer;
  font-weight: 600;
  z-index: 100;
}

.btn-exit:hover {
  background: rgba(230, 126, 34, 0.3);
}

/* Bot√≥n de entrada */
.btn-accent {
  background: var(--teal);
  color: #083238;
  border: none;
  border-radius: 6px;
  padding: 12px 24px;
  cursor: pointer;
  font-weight: 600;
  font-size: 16px;
}
</style>

<!-- Pantalla inicial -->
<div id="startScreen">
  <button class="btn btn-accent" onclick="startWall()">Ir al Dashboard</button>
</div>

<!-- Layout oculto - ESTE es el que va a fullscreen -->
<div class="container" id="app">
  <!-- Bot√≥n de salir -->
  <button class="btn-exit" onclick="exitWall()">Salir</button>
  
  <!-- Columna de alertas -->
  <section class="col-3 panel">
    <div class="hdr">
      <h3>Alertas en tiempo real</h3>
      <button class="btn-refresh" onclick="getAlertas()" title="Actualizar">‚Üª</button>
    </div>
    <ul class="alert-list" id="timelineList">
      <div class="loading">Cargando alertas...</div>
    </ul>
  </section>

  <!-- Grid 4x4 -->
  <section class="col-9 panel">
    <div class="hdr"><h3>Video Wall (4x4)</h3></div>
    <div class="grid-wall" id="gridWall"></div>
  </section>

  <!-- Modales DENTRO del contenedor #app para que sean visibles en fullscreen -->
  <div class="modal-backdrop2" id="camModal" onclick="backdropClick(event)">
    <div class="modal2">
      <div class="hdr">
        <h4>Seleccionar c√°mara</h4>
        <span class="x" onclick="closeCameraModal()">‚úï</span>
      </div>
      <ul class="cam-list" id="camList"></ul>
      <div style="margin-top:10px;text-align:right">
        <button class="btn btn-teal" id="btnAssign" disabled onclick="assignSelected()">Asignar</button>
      </div>
    </div>
  </div>

  <div class="modal-backdrop2" id="alertModal" onclick="backdropClickAlert(event)">
    <div class="modal2">
      <div class="hdr">
        <h4>Detalles de la Alerta</h4>
        <span class="x" onclick="closeAlertModal()">‚úï</span>
      </div>
      <div id="alertModalContent">
        <!-- Aqu√≠ se cargar√°n los detalles de la alerta -->
      </div>
      <div style="margin-top:10px;text-align:right">
        <button class="btn btn-teal" id="btnViewVideo">Ver Video</button>
      </div>
    </div>
  </div>
</div>

<script>
// Variables globales
const cameras = [
  {id:'CAM-001',name:'Esquina Principal',address:'Av. Principal 123',demo:'https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4'},
  {id:'CAM-002',name:'Parque Central',address:'Calle Lima 456',demo:'https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.webm'},
  {id:'CAM-003',name:'Av. Pardo',address:'Av. Pardo 789',demo:'https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4'},
  {id:'CAM-004',name:'Malec√≥n',address:'Malec√≥n Cisneros 321',demo:'https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.webm'}
];

let currentSlotEl = null;
let selectedCamera = null;
let alertas = [];
let selectedAlert = null;
let dragged = null;

// Funciones de utilidad
function backdropClick(ev){
  if(ev.target.id === "camModal"){ 
    closeCameraModal(); 
  }
  if(ev.target.id === "alertModal") {
    closeAlertModal();
  }
}

function backdropClickAlert(ev) {
  if(ev.target.id === "alertModal") {
    closeAlertModal();
  }
}

// Construir grid
function buildGrid(){
  const grid = document.getElementById('gridWall');
  grid.innerHTML = "";
  const saved = localStorage.getItem("videowallState");
  let state = saved ? JSON.parse(saved) : [];
  if(state.length > 0){ 
    restoreState(state); 
    return; 
  }
  for(let r = 1; r <= 16; r++){ 
    createSlot("S" + r, grid); 
  }
}

function createSlot(label, container, content = "", video = ""){
  const slot = document.createElement('div');
  slot.className = 'slot';
  slot.dataset.slot = label;
  slot.draggable = true;
  slot.innerHTML = `<span class="label">${label}</span>
    <button class="full-btn" onclick="slotFullscreen(event,this)">‚õ∂</button>
    <button class="select-btn" onclick="openCameraModal(this.closest('.slot'))">üé•</button>
    <div class="placeholder"><div class="name">${content || "Selecciona c√°mara"}</div></div>
    <video class="video" autoplay muted loop playsinline ${video ? 'src="' + video + '"' : ""}></video>`;
  if(video) slot.classList.add("filled");
  slot.addEventListener('dragstart', dragStart);
  slot.addEventListener('dragover', dragOver);
  slot.addEventListener('drop', dropSlot);
  container.appendChild(slot);
}

// Modal functions
function openCameraModal(slotEl){
  currentSlotEl = slotEl;
  selectedCamera = null;
  document.getElementById('btnAssign').disabled = true;
  
  const ul = document.getElementById('camList'); 
  ul.innerHTML = '';
  
      callAPI({
        method:"gestion/getcamarasall",
        ok:(data)=>{
            //showresultsearch(data);
                const li = document.createElement('li'); 
            li.className = 'cam-item';
            li.innerHTML = `<span class="cam-name">${c.camera_id}</span> - <span class="cam-id">${c.location}</span>`;
            li.onclick = () => {
              selectedCamera = c.id;
              document.getElementById('btnAssign').disabled = false;
            };
            ul.appendChild(li);
        }
    });
  
  /*cameras.forEach(c => {
    const li = document.createElement('li'); 
    li.className = 'cam-item';
    li.innerHTML = `<span class="cam-name">${c.name}</span> - <span class="cam-id">${c.address}</span>`;
    li.onclick = () => {
      selectedCamera = c;
      document.getElementById('btnAssign').disabled = false;
    };
    ul.appendChild(li);
  });*/
  
  document.getElementById('camModal').style.display = 'flex';
}

function closeCameraModal(){
  document.getElementById('camModal').style.display = 'none';
}

function assignSelected(){
  if(!currentSlotEl || !selectedCamera) return;
  
  const vid = currentSlotEl.querySelector('video.video');
  vid.src = selectedCamera.demo; 
  currentSlotEl.classList.add('filled');
  
  const lbl = currentSlotEl.querySelector('.label');
  lbl.textContent = `${selectedCamera.name} - ${selectedCamera.address}`;
  
  const ph = currentSlotEl.querySelector('.placeholder .name');
  if(ph) ph.textContent = selectedCamera.id;
  
  closeCameraModal();
  saveState();
}

// Fullscreen functions
function startWall(){
  const app = document.getElementById("app");
  const start = document.getElementById("startScreen");
  
  app.style.display = "flex";
  start.style.display = "none";
  buildGrid();
  
  // Cargar alertas al iniciar
  getAlertas();
  
  // Solicitar fullscreen
  if(!document.fullscreenElement){
    app.requestFullscreen().catch(err => {
      console.log(`Error en fullscreen: ${err.message}`);
    });
  }
}

function exitWall() {
  if (document.fullscreenElement) {
    document.exitFullscreen();
  }
}

// Detect exit fullscreen
document.addEventListener("fullscreenchange", () => {
  const app = document.getElementById("app");
  const start = document.getElementById("startScreen");
  
  if(!document.fullscreenElement){
    app.style.display = "none";
    start.style.display = "flex";
  }
});

// Drag & Drop functions
function dragStart(e){ 
  dragged = this; 
}

function dragOver(e){ 
  e.preventDefault(); 
}

function dropSlot(e){
  e.preventDefault();
  if(dragged && dragged !== this){
    this.parentNode.insertBefore(dragged, this);
    saveState();
  }
}

// Guardar y restaurar estado
function saveState(){
  const slots = [...document.querySelectorAll('#gridWall .slot')].map(slot => {
    return {
      label: slot.querySelector('.label')?.textContent || "",
      content: slot.querySelector('.placeholder .name')?.textContent || "",
      video: slot.querySelector('video.video')?.src || ""
    };
  });
  localStorage.setItem("videowallState", JSON.stringify(slots));
}

function restoreState(state){
  const grid = document.getElementById('gridWall');
  grid.innerHTML = "";
  state.forEach((s, i) => {
    createSlot("S" + (i + 1), grid, s.content, s.video);
    const slot = grid.lastChild;
    if(s.label) slot.querySelector('.label').textContent = s.label;
  });
}

// Fullscreen individual por c√°mara
function slotFullscreen(ev, btn){
  ev.stopPropagation();
  const slot = btn.closest(".slot");
  if(document.fullscreenElement === slot){
    document.exitFullscreen();
  } else {
    slot.requestFullscreen();
  }
}

// TIMELINE LOGIC
function getAlertas(item = null) {
    const timelineList = document.getElementById('timelineList');
    
    // Mostrar loader
    if (timelineList) {
        timelineList.innerHTML = '<div class="loading"><div class="spinner"></div>Cargando alertas...</div>';
    }

    // Par√°metros base
    let params = {

    };

    callAPI({
        method: 'gestion/getalerts',
        ok: function (vals) {
            alertas = vals.data || [];
            renderTimelineList(alertas);
        },
        error: function (error) {
            console.error("Error al obtener alertas:", error);
            // Datos de ejemplo en caso de error
            const alertasEjemplo = [
                {
                    id: 1,
                    type_event_name: "Movimiento sospechoso",
                    camera_name: "CAM-001",
                    location: "Entrada principal",
                    init_time_frame: new Date().toISOString()
                },
                {
                    id: 2,
                    type_event_name: "Persona no identificada",
                    camera_name: "CAM-002",
                    location: "Estacionamiento S1",
                    init_time_frame: new Date(Date.now() - 300000).toISOString()
                },
                {
                    id: 3,
                    type_event_name: "Veh√≠culo en √°rea restringida",
                    camera_name: "CAM-003",
                    location: "Zona de carga",
                    init_time_frame: new Date(Date.now() - 600000).toISOString()
                }
            ];
            
            alertas = alertasEjemplo;
            renderTimelineList(alertasEjemplo);
        }
    });
}

function renderTimelineList(data) {
  const timelineList = document.getElementById('timelineList');
  if (!data || data.length === 0) {
    timelineList.innerHTML = '<div class="loading">No hay alertas disponibles</div>';
    return;
  }
  
  timelineList.innerHTML = '';
  const sortedData = [...data].sort((a, b) => new Date(b.init_time_frame) - new Date(a.init_time_frame));
  
  sortedData.forEach(item => {
    const li = document.createElement('li');
    li.setAttribute('data-id', item.id);
    li.setAttribute('data-type', item.type_event_name.toLowerCase());
    
    const time = new Date(item.init_time_frame);
    const formattedTime = time.toLocaleString('es-PE');
    
    li.innerHTML = `
      <strong>${item.id} - ${formattedTime}</strong>
      <strong>${item.type_event_name}</strong>
      ${item.camera_name} ¬∑ ${item.location}
    `;
    
    timelineList.appendChild(li);
    
    li.addEventListener('click', () => {
      showAlertDetails(item);
    });
  });
}

// Funci√≥n para mostrar detalles de alerta
function showAlertDetails(alert) {
  selectedAlert = alert;
  const modalContent = document.getElementById('alertModalContent');
  
  const time = new Date(alert.init_time_frame);
  const formattedTime = time.toLocaleString('es-PE');
  
  modalContent.innerHTML = `
    <div class="alert-details">
      <div class="detail-item">
        <span class="detail-label">ID:</span> ${alert.id}
      </div>
      <div class="detail-item">
        <span class="detail-label">Tipo:</span> ${alert.type_event_name}
      </div>
      <div class="detail-item">
        <span class="detail-label">C√°mara:</span> ${alert.camera_name}
      </div>
      <div class="detail-item">
        <span class="detail-label">Ubicaci√≥n:</span> ${alert.location || 'No especificada'}
      </div>
      <div class="detail-item">
        <span class="detail-label">Fecha y Hora:</span> ${formattedTime}
      </div>
    </div>
  `;
  
  document.getElementById('alertModal').style.display = 'flex';
}

function closeAlertModal() {
  document.getElementById('alertModal').style.display = 'none';
  selectedAlert = null;
}

// Asignar evento al bot√≥n "Ver Video"
document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('btnViewVideo').addEventListener('click', function() {
    if (selectedAlert) {
      verVideo(selectedAlert);
    }
  });
});

function verVideo(alert) {
  const cameraId = alert.camera_name;
  
  const existingSlot = findSlotWithCamera(cameraId);
  if (existingSlot) {
    highlightSlot(existingSlot);
  } else {
    assignAlertToEmptySlot(alert);
  }
  
  closeAlertModal();
}

// Funciones auxiliares para el video wall
function findSlotWithCamera(cameraId) {
  const slots = document.querySelectorAll('.slot');
  for (let slot of slots) {
    const label = slot.querySelector('.label');
    if (label && label.textContent.includes(cameraId)) {
      return slot;
    }
  }
  return null;
}

function highlightSlot(slot) {
  // Remover highlight previo
  document.querySelectorAll('.slot').forEach(s => {
    s.style.border = '1px dashed #204a59';
  });
  
  // Aplicar highlight al slot
  slot.style.border = '2px solid var(--orange)';
  slot.style.boxShadow = '0 0 10px rgba(230, 126, 34, 0.5)';
  
  // Quitar highlight despu√©s de 3 segundos
  setTimeout(() => {
    slot.style.border = '1px dashed #204a59';
    slot.style.boxShadow = 'none';
  }, 3000);
}

function assignAlertToEmptySlot(alert) {
  const emptySlot = document.querySelector('.slot:not(.filled)');
  if (emptySlot) {
    const cameraId = alert.camera_name;
    const cameraInfo = findCameraInfo(cameraId);
    
    if (cameraInfo) {
      const vid = emptySlot.querySelector('video.video');
      const label = emptySlot.querySelector('.label');
      const placeholder = emptySlot.querySelector('.placeholder .name');
      
      vid.src = cameraInfo.demo;
      emptySlot.classList.add("filled");
      label.textContent = `${cameraInfo.name} - ${cameraInfo.address}`;
      if (placeholder) placeholder.textContent = cameraInfo.id;
      
      saveState();
      highlightSlot(emptySlot);
    }
  } else {
    alert('No hay slots vac√≠os disponibles. Libera un slot para asignar esta c√°mara.');
  }
}

function findCameraInfo(cameraId) {
  return cameras.find(cam => cam.id === cameraId);
}

// Manejo de tecla Escape para salir
document.addEventListener('keydown', e => {
  if(e.key === 'Escape' && document.fullscreenElement){ 
    exitWall(); 
  }
});

// Inicializaci√≥n
document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("camModal").style.display = "none";
  document.getElementById("alertModal").style.display = "none";
});
</script>